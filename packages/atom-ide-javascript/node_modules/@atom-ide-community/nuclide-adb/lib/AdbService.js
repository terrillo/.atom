"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getDeviceInfo = getDeviceInfo;
exports.getProcesses = getProcesses;
exports.stopProcess = stopProcess;
exports.trackDevices = trackDevices;
exports.getDeviceList = getDeviceList;
exports.getPidFromPackageName = getPidFromPackageName;
exports.installPackage = installPackage;
exports.uninstallPackage = uninstallPackage;
exports.forwardJdwpPortToPid = forwardJdwpPortToPid;
exports.removeJdwpForwardSpec = removeJdwpForwardSpec;
exports.launchActivity = launchActivity;
exports.launchMainActivity = launchMainActivity;
exports.launchService = launchService;
exports.activityExists = activityExists;
exports.getAllAvailablePackages = getAllAvailablePackages;
exports.getJavaProcesses = getJavaProcesses;
exports.dumpsysPackage = dumpsysPackage;
exports.touchFile = touchFile;
exports.removeFile = removeFile;
exports.getAPIVersion = getAPIVersion;
exports.getDeviceArchitecture = getDeviceArchitecture;
exports.getInstalledPackages = getInstalledPackages;
exports.killServer = killServer;
exports.getApkManifest = getApkManifest;
exports.getVersion = getVersion;
exports.checkMuxStatus = checkMuxStatus;
exports.checkInMuxPort = checkInMuxPort;
exports.checkOutMuxPort = checkOutMuxPort;

var _fsPromise = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/fsPromise"));

var _nuclideUri = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/nuclideUri"));

var _rxjsCompatUmdMin = require("rxjs-compat/bundles/rxjs-compat.umd.min.js");

var _Adb = require("./Adb");

var _Processes = require("./common/Processes");

var _process = require("@atom-ide-community/nuclide-commons/process");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */
function getDeviceInfo(serial) {
  return new _Adb.Adb(serial).getDeviceInfo().publish();
}

function getProcesses(serial, timeout) {
  return new _Processes.Processes(new _Adb.Adb(serial)).fetch(timeout).publish();
}

async function stopProcess(serial, packageName, pid) {
  return new _Adb.Adb(serial).stopProcess(packageName, pid);
}

function trackDevices() {
  return (0, _process.observeProcessRaw)('adb', ['track-devices']).filter(event => event.kind !== 'stderr' || !event.data.startsWith('* daemon not running')).distinctUntilChanged() // track-devices doesn't provide the full output
  // we use its output as events to trigger an actual devices -l call
  .switchMap(() => getDeviceList()).publish();
}

function getDeviceList() {
  return _Adb.Adb.getDevices();
}

async function getPidFromPackageName(serial, packageName) {
  return new _Processes.Processes(new _Adb.Adb(serial)).getPidFromPackageName(packageName);
}

function installPackage(serial, packagePath) {
  return new _Adb.Adb(serial).installPackage(packagePath).publish();
}

function uninstallPackage(serial, packageName) {
  // TODO(T17463635)
  return new _Adb.Adb(serial).uninstallPackage(packageName).publish();
}

async function forwardJdwpPortToPid(serial, tcpPort, pid) {
  return new _Adb.Adb(serial).forwardJdwpPortToPid(tcpPort, pid);
}

async function removeJdwpForwardSpec(serial, spec) {
  return new _Adb.Adb(serial).removeJdwpForwardSpec(spec);
}

async function launchActivity(serial, packageName, activity, debug, action, parameters) {
  return new _Adb.Adb(serial).launchActivity(packageName, activity, debug, action, parameters);
}

async function launchMainActivity(serial, packageName, debug) {
  return new _Adb.Adb(serial).launchMainActivity(packageName, debug);
}

async function launchService(serial, packageName, serviceName, debug) {
  return new _Adb.Adb(serial).launchService(packageName, serviceName, debug);
}

async function activityExists(serial, packageName, activity) {
  return new _Adb.Adb(serial).activityExists(packageName, activity);
}

async function getAllAvailablePackages(serial) {
  return new _Adb.Adb(serial).getAllAvailablePackages();
}

function getJavaProcesses(serial) {
  return new _Adb.Adb(serial).getJavaProcesses().publish();
}

async function dumpsysPackage(serial, identifier) {
  return new _Adb.Adb(serial).dumpsysPackage(identifier);
}

async function touchFile(serial, path) {
  return new _Adb.Adb(serial).touchFile(path);
}

async function removeFile(serial, path) {
  return new _Adb.Adb(serial).removeFile(path);
}

async function getAPIVersion(serial) {
  return new _Adb.Adb(serial).getAPIVersion().toPromise();
}

async function getDeviceArchitecture(serial) {
  return new _Adb.Adb(serial).getDeviceArchitecture().toPromise();
}

async function getInstalledPackages(serial) {
  return new _Adb.Adb(serial).getInstalledPackages();
}

async function killServer() {
  return _Adb.Adb.killServer();
}

async function getAaptBinary(buildToolsVersion) {
  if (process.env.ANDROID_SDK == null || buildToolsVersion == null) {
    return 'aapt';
  } else {
    const allBuildToolsPath = _nuclideUri.default.join(process.env.ANDROID_SDK, 'build-tools');

    const exactBuildToolPath = _nuclideUri.default.join(allBuildToolsPath, buildToolsVersion);

    const aaptPath = _nuclideUri.default.join(exactBuildToolPath, 'aapt');

    if (await _fsPromise.default.exists(aaptPath)) {
      return aaptPath;
    } else {
      return 'aapt';
    }
  }
}

async function getApkManifest(apkPath, buildToolsVersion) {
  const aaptBinary = await getAaptBinary(buildToolsVersion);
  return (0, _process.runCommand)(aaptBinary, ['dump', 'badging', apkPath]).toPromise();
}

async function getVersion() {
  return _Adb.Adb.getVersion();
}

async function checkMuxStatus() {
  try {
    await (0, _process.runCommand)('adbmux', ['status']).ignoreElements().toPromise();
  } catch (_) {
    return false;
  }

  return true;
}

function checkInMuxPort(port) {
  return (0, _process.runCommand)('adbmux', ['checkin', `${port}`]).ignoreElements().toPromise();
}

function checkOutMuxPort(port) {
  return (0, _process.runCommand)('adbmux', ['checkout', `${port}`]).ignoreElements().toPromise();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL251Y2xpZGUvbnVjbGlkZS1hZGIvbGliL0FkYlNlcnZpY2UuanMiXSwibmFtZXMiOlsiZ2V0RGV2aWNlSW5mbyIsInNlcmlhbCIsIkFkYiIsInB1Ymxpc2giLCJnZXRQcm9jZXNzZXMiLCJ0aW1lb3V0IiwiUHJvY2Vzc2VzIiwiZmV0Y2giLCJzdG9wUHJvY2VzcyIsInBhY2thZ2VOYW1lIiwicGlkIiwidHJhY2tEZXZpY2VzIiwiZmlsdGVyIiwiZXZlbnQiLCJraW5kIiwiZGF0YSIsInN0YXJ0c1dpdGgiLCJkaXN0aW5jdFVudGlsQ2hhbmdlZCIsInN3aXRjaE1hcCIsImdldERldmljZUxpc3QiLCJnZXREZXZpY2VzIiwiZ2V0UGlkRnJvbVBhY2thZ2VOYW1lIiwiaW5zdGFsbFBhY2thZ2UiLCJwYWNrYWdlUGF0aCIsInVuaW5zdGFsbFBhY2thZ2UiLCJmb3J3YXJkSmR3cFBvcnRUb1BpZCIsInRjcFBvcnQiLCJyZW1vdmVKZHdwRm9yd2FyZFNwZWMiLCJzcGVjIiwibGF1bmNoQWN0aXZpdHkiLCJhY3Rpdml0eSIsImRlYnVnIiwiYWN0aW9uIiwicGFyYW1ldGVycyIsImxhdW5jaE1haW5BY3Rpdml0eSIsImxhdW5jaFNlcnZpY2UiLCJzZXJ2aWNlTmFtZSIsImFjdGl2aXR5RXhpc3RzIiwiZ2V0QWxsQXZhaWxhYmxlUGFja2FnZXMiLCJnZXRKYXZhUHJvY2Vzc2VzIiwiZHVtcHN5c1BhY2thZ2UiLCJpZGVudGlmaWVyIiwidG91Y2hGaWxlIiwicGF0aCIsInJlbW92ZUZpbGUiLCJnZXRBUElWZXJzaW9uIiwidG9Qcm9taXNlIiwiZ2V0RGV2aWNlQXJjaGl0ZWN0dXJlIiwiZ2V0SW5zdGFsbGVkUGFja2FnZXMiLCJraWxsU2VydmVyIiwiZ2V0QWFwdEJpbmFyeSIsImJ1aWxkVG9vbHNWZXJzaW9uIiwicHJvY2VzcyIsImVudiIsIkFORFJPSURfU0RLIiwiYWxsQnVpbGRUb29sc1BhdGgiLCJudWNsaWRlVXJpIiwiam9pbiIsImV4YWN0QnVpbGRUb29sUGF0aCIsImFhcHRQYXRoIiwiZnNQcm9taXNlIiwiZXhpc3RzIiwiZ2V0QXBrTWFuaWZlc3QiLCJhcGtQYXRoIiwiYWFwdEJpbmFyeSIsImdldFZlcnNpb24iLCJjaGVja011eFN0YXR1cyIsImlnbm9yZUVsZW1lbnRzIiwiXyIsImNoZWNrSW5NdXhQb3J0IiwicG9ydCIsImNoZWNrT3V0TXV4UG9ydCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQW1CQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQXhCQTs7Ozs7Ozs7Ozs7QUEyQk8sU0FBU0EsYUFBVCxDQUNMQyxNQURLLEVBRXVDO0FBQzVDLFNBQU8sSUFBSUMsUUFBSixDQUFRRCxNQUFSLEVBQWdCRCxhQUFoQixHQUFnQ0csT0FBaEMsRUFBUDtBQUNEOztBQUVNLFNBQVNDLFlBQVQsQ0FDTEgsTUFESyxFQUVMSSxPQUZLLEVBR2tDO0FBQ3ZDLFNBQU8sSUFBSUMsb0JBQUosQ0FBYyxJQUFJSixRQUFKLENBQVFELE1BQVIsQ0FBZCxFQUErQk0sS0FBL0IsQ0FBcUNGLE9BQXJDLEVBQThDRixPQUE5QyxFQUFQO0FBQ0Q7O0FBRU0sZUFBZUssV0FBZixDQUNMUCxNQURLLEVBRUxRLFdBRkssRUFHTEMsR0FISyxFQUlVO0FBQ2YsU0FBTyxJQUFJUixRQUFKLENBQVFELE1BQVIsRUFBZ0JPLFdBQWhCLENBQTRCQyxXQUE1QixFQUF5Q0MsR0FBekMsQ0FBUDtBQUNEOztBQUVNLFNBQVNDLFlBQVQsR0FBaUU7QUFDdEUsU0FDRSxnQ0FBa0IsS0FBbEIsRUFBeUIsQ0FBQyxlQUFELENBQXpCLEVBQ0dDLE1BREgsQ0FFSUMsS0FBSyxJQUNIQSxLQUFLLENBQUNDLElBQU4sS0FBZSxRQUFmLElBQ0EsQ0FBQ0QsS0FBSyxDQUFDRSxJQUFOLENBQVdDLFVBQVgsQ0FBc0Isc0JBQXRCLENBSlAsRUFNR0Msb0JBTkgsR0FPRTtBQUNBO0FBUkYsR0FTR0MsU0FUSCxDQVNhLE1BQU1DLGFBQWEs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IEluYy5cclxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuICpcclxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgQlNELXN0eWxlIGxpY2Vuc2UgZm91bmQgaW4gdGhlXHJcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4gQW4gYWRkaXRpb25hbCBncmFudFxyXG4gKiBvZiBwYXRlbnQgcmlnaHRzIGNhbiBiZSBmb3VuZCBpbiB0aGUgUEFURU5UUyBmaWxlIGluIHRoZSBzYW1lIGRpcmVjdG9yeS5cclxuICpcclxuICogQGZsb3dcclxuICogQGZvcm1hdFxyXG4gKi9cclxuXHJcbmltcG9ydCB0eXBlIHtOdWNsaWRlVXJpfSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy9udWNsaWRlVXJpJztcclxuaW1wb3J0IHR5cGUge1xyXG4gIExlZ2FjeVByb2Nlc3NNZXNzYWdlLFxyXG4gIFByb2Nlc3NNZXNzYWdlLFxyXG59IGZyb20gJ0BhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1jb21tb25zL3Byb2Nlc3MnO1xyXG5pbXBvcnQgdHlwZSB7QWRiRGV2aWNlLCBBbmRyb2lkSmF2YVByb2Nlc3MsIFByb2Nlc3N9IGZyb20gJy4vdHlwZXMnO1xyXG5cclxuaW1wb3J0IGZzUHJvbWlzZSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy9mc1Byb21pc2UnO1xyXG5pbXBvcnQgbnVjbGlkZVVyaSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy9udWNsaWRlVXJpJztcclxuaW1wb3J0IHtDb25uZWN0YWJsZU9ic2VydmFibGV9IGZyb20gJ3J4anMtY29tcGF0L2J1bmRsZXMvcnhqcy1jb21wYXQudW1kLm1pbi5qcyc7XHJcbmltcG9ydCB7QWRifSBmcm9tICcuL0FkYic7XHJcbmltcG9ydCB7UHJvY2Vzc2VzfSBmcm9tICcuL2NvbW1vbi9Qcm9jZXNzZXMnO1xyXG5pbXBvcnQge3J1bkNvbW1hbmR9IGZyb20gJ0BhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1jb21tb25zL3Byb2Nlc3MnO1xyXG5pbXBvcnQge29ic2VydmVQcm9jZXNzUmF3fSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy9wcm9jZXNzJztcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXREZXZpY2VJbmZvKFxyXG4gIHNlcmlhbDogc3RyaW5nLFxyXG4pOiBDb25uZWN0YWJsZU9ic2VydmFibGU8TWFwPHN0cmluZywgc3RyaW5nPj4ge1xyXG4gIHJldHVybiBuZXcgQWRiKHNlcmlhbCkuZ2V0RGV2aWNlSW5mbygpLnB1Ymxpc2goKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldFByb2Nlc3NlcyhcclxuICBzZXJpYWw6IHN0cmluZyxcclxuICB0aW1lb3V0OiBudW1iZXIsXHJcbik6IENvbm5lY3RhYmxlT2JzZXJ2YWJsZTxBcnJheTxQcm9jZXNzPj4ge1xyXG4gIHJldHVybiBuZXcgUHJvY2Vzc2VzKG5ldyBBZGIoc2VyaWFsKSkuZmV0Y2godGltZW91dCkucHVibGlzaCgpO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gc3RvcFByb2Nlc3MoXHJcbiAgc2VyaWFsOiBzdHJpbmcsXHJcbiAgcGFja2FnZU5hbWU6IHN0cmluZyxcclxuICBwaWQ6IG51bWJlcixcclxuKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgcmV0dXJuIG5ldyBBZGIoc2VyaWFsKS5zdG9wUHJvY2VzcyhwYWNrYWdlTmFtZSwgcGlkKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHRyYWNrRGV2aWNlcygpOiBDb25uZWN0YWJsZU9ic2VydmFibGU8QXJyYXk8QWRiRGV2aWNlPj4ge1xyXG4gIHJldHVybiAoXHJcbiAgICBvYnNlcnZlUHJvY2Vzc1JhdygnYWRiJywgWyd0cmFjay1kZXZpY2VzJ10pXHJcbiAgICAgIC5maWx0ZXIoXHJcbiAgICAgICAgZXZlbnQgPT5cclxuICAgICAgICAgIGV2ZW50LmtpbmQgIT09ICdzdGRlcnInIHx8XHJcbiAgICAgICAgICAhZXZlbnQuZGF0YS5zdGFydHNXaXRoKCcqIGRhZW1vbiBub3QgcnVubmluZycpLFxyXG4gICAgICApXHJcbiAgICAgIC5kaXN0aW5jdFVudGlsQ2hhbmdlZCgpXHJcbiAgICAgIC8vIHRyYWNrLWRldmljZXMgZG9lc24ndCBwcm92aWRlIHRoZSBmdWxsIG91dHB1dFxyXG4gICAgICAvLyB3ZSB1c2UgaXRzIG91dHB1dCBhcyBldmVudHMgdG8gdHJpZ2dlciBhbiBhY3R1YWwgZGV2aWNlcyAtbCBjYWxsXHJcbiAgICAgIC5zd2l0Y2hNYXAoKCkgPT4gZ2V0RGV2aWNlTGlzdCgpKVxyXG4gICAgICAucHVibGlzaCgpXHJcbiAgKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldERldmljZUxpc3QoKTogUHJvbWlzZTxBcnJheTxBZGJEZXZpY2U+PiB7XHJcbiAgcmV0dXJuIEFkYi5nZXREZXZpY2VzKCk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRQaWRGcm9tUGFja2FnZU5hbWUoXHJcbiAgc2VyaWFsOiBzdHJpbmcsXHJcbiAgcGFja2FnZU5hbWU6IHN0cmluZyxcclxuKTogUHJvbWlzZTxudW1iZXI+IHtcclxuICByZXR1cm4gbmV3IFByb2Nlc3NlcyhuZXcgQWRiKHNlcmlhbCkpLmdldFBpZEZyb21QYWNrYWdlTmFtZShwYWNrYWdlTmFtZSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpbnN0YWxsUGFja2FnZShcclxuICBzZXJpYWw6IHN0cmluZyxcclxuICBwYWNrYWdlUGF0aDogTnVjbGlkZVVyaSxcclxuKTogQ29ubmVjdGFibGVPYnNlcnZhYmxlPFByb2Nlc3NNZXNzYWdlPiB7XHJcbiAgcmV0dXJuIG5ldyBBZGIoc2VyaWFsKS5pbnN0YWxsUGFja2FnZShwYWNrYWdlUGF0aCkucHVibGlzaCgpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdW5pbnN0YWxsUGFja2FnZShcclxuICBzZXJpYWw6IHN0cmluZyxcclxuICBwYWNrYWdlTmFtZTogc3RyaW5nLFxyXG4pOiBDb25uZWN0YWJsZU9ic2VydmFibGU8TGVnYWN5UHJvY2Vzc01lc3NhZ2U+IHtcclxuICAvLyBUT0RPKFQxNzQ2MzYzNSlcclxuICByZXR1cm4gbmV3IEFkYihzZXJpYWwpLnVuaW5zdGFsbFBhY2thZ2UocGFja2FnZU5hbWUpLnB1Ymxpc2goKTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGZvcndhcmRKZHdwUG9ydFRvUGlkKFxyXG4gIHNlcmlhbDogc3RyaW5nLFxyXG4gIHRjcFBvcnQ6IG51bWJlcixcclxuICBwaWQ6IG51bWJlcixcclxuKTogUHJvbWlzZTw/c3RyaW5nPiB7XHJcbiAgcmV0dXJuIG5ldyBBZGIoc2VyaWFsKS5mb3J3YXJkSmR3cFBvcnRUb1BpZCh0Y3BQb3J0LCBwaWQpO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVtb3ZlSmR3cEZvcndhcmRTcGVjKFxyXG4gIHNlcmlhbDogc3RyaW5nLFxyXG4gIHNwZWM6ID9zdHJpbmcsXHJcbik6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgcmV0dXJuIG5ldyBBZGIoc2VyaWFsKS5yZW1vdmVKZHdwRm9yd2FyZFNwZWMoc3BlYyk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsYXVuY2hBY3Rpdml0eShcclxuICBzZXJpYWw6IHN0cmluZyxcclxuICBwYWNrYWdlTmFtZTogc3RyaW5nLFxyXG4gIGFjdGl2aXR5OiBzdHJpbmcsXHJcbiAgZGVidWc6IGJvb2xlYW4sXHJcbiAgYWN0aW9uOiA/c3RyaW5nLFxyXG4gIHBhcmFtZXRlcnM6ID9NYXA8c3RyaW5nLCBzdHJpbmc+LFxyXG4pOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gIHJldHVybiBuZXcgQWRiKHNlcmlhbCkubGF1bmNoQWN0aXZpdHkoXHJcbiAgICBwYWNrYWdlTmFtZSxcclxuICAgIGFjdGl2aXR5LFxyXG4gICAgZGVidWcsXHJcbiAgICBhY3Rpb24sXHJcbiAgICBwYXJhbWV0ZXJzLFxyXG4gICk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsYXVuY2hNYWluQWN0aXZpdHkoXHJcbiAgc2VyaWFsOiBzdHJpbmcsXHJcbiAgcGFja2FnZU5hbWU6IHN0cmluZyxcclxuICBkZWJ1ZzogYm9vbGVhbixcclxuKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICByZXR1cm4gbmV3IEFkYihzZXJpYWwpLmxhdW5jaE1haW5BY3Rpdml0eShwYWNrYWdlTmFtZSwgZGVidWcpO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbGF1bmNoU2VydmljZShcclxuICBzZXJpYWw6IHN0cmluZyxcclxuICBwYWNrYWdlTmFtZTogc3RyaW5nLFxyXG4gIHNlcnZpY2VOYW1lOiBzdHJpbmcsXHJcbiAgZGVidWc6IGJvb2xlYW4sXHJcbik6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgcmV0dXJuIG5ldyBBZGIoc2VyaWFsKS5sYXVuY2hTZXJ2aWNlKHBhY2thZ2VOYW1lLCBzZXJ2aWNlTmFtZSwgZGVidWcpO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYWN0aXZpdHlFeGlzdHMoXHJcbiAgc2VyaWFsOiBzdHJpbmcsXHJcbiAgcGFja2FnZU5hbWU6IHN0cmluZyxcclxuICBhY3Rpdml0eTogc3RyaW5nLFxyXG4pOiBQcm9taXNlPGJvb2xlYW4+IHtcclxuICByZXR1cm4gbmV3IEFkYihzZXJpYWwpLmFjdGl2aXR5RXhpc3RzKHBhY2thZ2VOYW1lLCBhY3Rpdml0eSk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRBbGxBdmFpbGFibGVQYWNrYWdlcyhcclxuICBzZXJpYWw6IHN0cmluZyxcclxuKTogUHJvbWlzZTxBcnJheTxzdHJpbmc+PiB7XHJcbiAgcmV0dXJuIG5ldyBBZGIoc2VyaWFsKS5nZXRBbGxBdmFpbGFibGVQYWNrYWdlcygpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0SmF2YVByb2Nlc3NlcyhcclxuICBzZXJpYWw6IHN0cmluZyxcclxuKTogQ29ubmVjdGFibGVPYnNlcnZhYmxlPEFycmF5PEFuZHJvaWRKYXZhUHJvY2Vzcz4+IHtcclxuICByZXR1cm4gbmV3IEFkYihzZXJpYWwpLmdldEphdmFQcm9jZXNzZXMoKS5wdWJsaXNoKCk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkdW1wc3lzUGFja2FnZShcclxuICBzZXJpYWw6IHN0cmluZyxcclxuICBpZGVudGlmaWVyOiBzdHJpbmcsXHJcbik6IFByb21pc2U8P3N0cmluZz4ge1xyXG4gIHJldHVybiBuZXcgQWRiKHNlcmlhbCkuZHVtcHN5c1BhY2thZ2UoaWRlbnRpZmllcik7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB0b3VjaEZpbGUoc2VyaWFsOiBzdHJpbmcsIHBhdGg6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgcmV0dXJuIG5ldyBBZGIoc2VyaWFsKS50b3VjaEZpbGUocGF0aCk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZW1vdmVGaWxlKFxyXG4gIHNlcmlhbDogc3RyaW5nLFxyXG4gIHBhdGg6IHN0cmluZyxcclxuKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICByZXR1cm4gbmV3IEFkYihzZXJpYWwpLnJlbW92ZUZpbGUocGF0aCk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRBUElWZXJzaW9uKHNlcmlhbDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICByZXR1cm4gbmV3IEFkYihzZXJpYWwpLmdldEFQSVZlcnNpb24oKS50b1Byb21pc2UoKTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldERldmljZUFyY2hpdGVjdHVyZShzZXJpYWw6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgcmV0dXJuIG5ldyBBZGIoc2VyaWFsKS5nZXREZXZpY2VBcmNoaXRlY3R1cmUoKS50b1Byb21pc2UoKTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEluc3RhbGxlZFBhY2thZ2VzKFxyXG4gIHNlcmlhbDogc3RyaW5nLFxyXG4pOiBQcm9taXNlPEFycmF5PHN0cmluZz4+IHtcclxuICByZXR1cm4gbmV3IEFkYihzZXJpYWwpLmdldEluc3RhbGxlZFBhY2thZ2VzKCk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBraWxsU2VydmVyKCk6IFByb21pc2U8dm9pZD4ge1xyXG4gIHJldHVybiBBZGIua2lsbFNlcnZlcigpO1xyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBnZXRBYXB0QmluYXJ5KGJ1aWxkVG9vbHNWZXJzaW9uOiA/c3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICBpZiAocHJvY2Vzcy5lbnYuQU5EUk9JRF9TREsgPT0gbnVsbCB8fCBidWlsZFRvb2xzVmVyc2lvbiA9PSBudWxsKSB7XHJcbiAgICByZXR1cm4gJ2FhcHQnO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBjb25zdCBhbGxCdWlsZFRvb2xzUGF0aCA9IG51Y2xpZGVVcmkuam9pbihcclxuICAgICAgcHJvY2Vzcy5lbnYuQU5EUk9JRF9TREssXHJcbiAgICAgICdidWlsZC10b29scycsXHJcbiAgICApO1xyXG4gICAgY29uc3QgZXhhY3RCdWlsZFRvb2xQYXRoID0gbnVjbGlkZVVyaS5qb2luKFxyXG4gICAgICBhbGxCdWlsZFRvb2xzUGF0aCxcclxuICAgICAgYnVpbGRUb29sc1ZlcnNpb24sXHJcbiAgICApO1xyXG4gICAgY29uc3QgYWFwdFBhdGggPSBudWNsaWRlVXJpLmpvaW4oZXhhY3RCdWlsZFRvb2xQYXRoLCAnYWFwdCcpO1xyXG4gICAgaWYgKGF3YWl0IGZzUHJvbWlzZS5leGlzdHMoYWFwdFBhdGgpKSB7XHJcbiAgICAgIHJldHVybiBhYXB0UGF0aDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiAnYWFwdCc7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0QXBrTWFuaWZlc3QoXHJcbiAgYXBrUGF0aDogc3RyaW5nLFxyXG4gIGJ1aWxkVG9vbHNWZXJzaW9uOiA/c3RyaW5nLFxyXG4pOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gIGNvbnN0IGFhcHRCaW5hcnkgPSBhd2FpdCBnZXRBYXB0QmluYXJ5KGJ1aWxkVG9vbHNWZXJzaW9uKTtcclxuICByZXR1cm4gcnVuQ29tbWFuZChhYXB0QmluYXJ5LCBbJ2R1bXAnLCAnYmFkZ2luZycsIGFwa1BhdGhdKS50b1Byb21pc2UoKTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFZlcnNpb24oKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICByZXR1cm4gQWRiLmdldFZlcnNpb24oKTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNoZWNrTXV4U3RhdHVzKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gIHRyeSB7XHJcbiAgICBhd2FpdCBydW5Db21tYW5kKCdhZGJtdXgnLCBbJ3N0YXR1cyddKVxyXG4gICAgICAuaWdub3JlRWxlbWVudHMoKVxyXG4gICAgICAudG9Qcm9taXNlKCk7XHJcbiAgfSBjYXRjaCAoXykge1xyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxuICByZXR1cm4gdHJ1ZTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGNoZWNrSW5NdXhQb3J0KHBvcnQ6IG51bWJlcik6IFByb21pc2U8dm9pZD4ge1xyXG4gIHJldHVybiBydW5Db21tYW5kKCdhZGJtdXgnLCBbJ2NoZWNraW4nLCBgJHtwb3J0fWBdKVxyXG4gICAgLmlnbm9yZUVsZW1lbnRzKClcclxuICAgIC50b1Byb21pc2UoKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGNoZWNrT3V0TXV4UG9ydChwb3J0OiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+IHtcclxuICByZXR1cm4gcnVuQ29tbWFuZCgnYWRibXV4JywgWydjaGVja291dCcsIGAke3BvcnR9YF0pXHJcbiAgICAuaWdub3JlRWxlbWVudHMoKVxyXG4gICAgLnRvUHJvbWlzZSgpO1xyXG59XHJcbiJdfQ==