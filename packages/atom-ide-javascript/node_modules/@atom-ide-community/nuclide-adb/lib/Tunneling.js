"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.startTunnelingAdb = startTunnelingAdb;
exports.stopTunnelingAdb = stopTunnelingAdb;
exports.isAdbTunneled = isAdbTunneled;
exports.VERSION_MISMATCH_ERROR = exports.MISSING_ADB_ERROR = void 0;

var _assert = _interopRequireDefault(require("assert"));

var _electron = require("electron");

var _log4js = require("log4js");

var _SimpleCache = require("@atom-ide-community/nuclide-commons/SimpleCache");

var _nuclideUri = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/nuclideUri"));

var _rxjsCompatUmdMin = require("rxjs-compat/bundles/rxjs-compat.umd.min.js");

var _consumeFirstProvider = _interopRequireDefault(require("@atom-ide-community/nuclide-commons-atom/consumeFirstProvider"));

var _utils = require("./utils");

var _analytics = require("@atom-ide-community/nuclide-commons/analytics");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */
let passesGK = async _ => false;

try {
  const fbPassesGK = // eslint-disable-next-line nuclide-internal/modules-dependencies
  require('@atom-ide-community/nuclide-commons/passesGK');

  passesGK = fbPassesGK.default;
} catch (e) {}

const MISSING_ADB_ERROR = 'MissingAdbError';
exports.MISSING_ADB_ERROR = MISSING_ADB_ERROR;
const VERSION_MISMATCH_ERROR = 'VersionMismatchError'; // 1. Starts adb tunneling immediately (does not care if you subscribe)
// 2. Tunneling stays turned on even after you unsubscribe (to prevent too much on/off toggling)
// 3. Sends a value when everything is ready (if already active, it sends 'ready' immediately)
// 4. Guarantees that tunneling is active as long as the observable is not complete (or errored)

exports.VERSION_MISMATCH_ERROR = VERSION_MISMATCH_ERROR;

function startTunnelingAdb(uri, options = {}) {
  if (!_nuclideUri.default.isRemote(uri)) {
    return _rxjsCompatUmdMin.Observable.of('ready').concat(_rxjsCompatUmdMin.Observable.never());
  }

  const {
    tunnels
  } = activeTunnels.getOrCreate(uri, (_, serviceUri) => {
    (0, _assert.default)(typeof serviceUri === 'string');
    const adbService = (0, _utils.getAdbServiceByNuclideUri)(serviceUri);
    const localAdbService = (0, _utils.getAdbServiceByNuclideUri)('');

    const observable = _rxjsCompatUmdMin.Observable.defer(async () => {
      try {
        const [adbVersion, localAdbVersion] = await Promise.all([adbService.getVersion().catch(e => {
          e.host = serviceUri;
          throw e;
        }), localAdbService.getVersion().catch(e => {
          e.host = '';
          throw e;
        })]);

        if (adbVersion !== localAdbVersion) {
          const versionMismatchError = new Error(`Your remote adb version differs from the local one: ${adbVersion} (remote) != ${localAdbVersion} (local)`);
          versionMismatchError.name = VERSION_MISMATCH_ERROR;
          throw versionMismatchError;
        }
      } catch (e) {
        if (e.code === 'ENOENT' && e.host != null) {
          const missingAdbError = new Error(`'adb' not found in ${e.host === '' ? 'local' : 'remote'} $PATH.`);
          missingAdbError.name = MISSING_ADB_ERROR;
          throw missingAdbError;
        } else {
          throw e;
        }
      }

      return adbService.checkMuxStatus();
    }).switchMap(useAdbmux => useAdbmux ? checkInToAdbmux(serviceUri) : openTunnelsManually(serviceUri)).publishReplay(1);

    let adbmuxPort;
    const subscription = observable.subscribe({
      next: port => adbmuxPort = port,
      error: e => {
        (0, _log4js.getLogger)('@atom-ide-community/nuclide-adb:tunneling').error(e);
        (0, _analytics.track)('@atom-ide-community/nuclide-adb:tunneling:error', {
          host: uri,
          error: e
        });

        if (e.name === MISSING_ADB_ERROR) {
          return;
        }

        let detail;
        const buttons = [];

        if (e.name === VERSION_MISMATCH_ERROR) {
          detail = e.message;
          const {
            adbUpgradeLink
          } = options;

          if (e.name === VERSION_MISMATCH_ERROR && adbUpgradeLink != null) {
            buttons.push({
              text: 'View upgrade instructions',
              onDidClick: () => _electron.shell.openExternal(adbUpgradeLink)
            });
          }
        } else {
          detail = "Your local devices won't be available on this host." + (e.name != null && e.name !== 'Error' ? `\n \n${e.name}` : '');
        }

        atom.notifications.addError('Failed to tunnel Android devices', {
          dismissable: true,
          detail,
          buttons
        });
      }
    }); // .add returns a Subscription, the teardown logic of which doesn't seem to get disposed on unsubscribe

    subscription.add(() => {
      if (adbmuxPort != null) {
        adbService.checkOutMuxPort(adbmuxPort);
        adbmuxPort = null;
      }

      stopTunnelingAdb(uri);
    }) // Start everything!
    .add(observable.connect());
    return {
      subscription,
      tunnels: observable
    };
  });
  changes.next();
  return tunnels.mapTo('ready');
}

function stopTunnelingAdb(uri) {
  activeTunnels.delete(uri);
  changes.next();
}

function isAdbTunneled(uri) {
  return changes.startWith(undefined).map(() => activeTunnels.get(uri) != null).distinctUntilChanged();
}

const activeTunnels = new _SimpleCache.SimpleCache({
  keyFactory: uri => _nuclideUri.default.createRemoteUri(_nuclideUri.default.getHostname(uri), '/'),
  dispose: value => value.subscription.unsubscribe()
});
const changes = new _rxjsCompatUmdMin.Subject();

function checkInToAdbmux(host) {
  return _rxjsCompatUmdMin.Observable.defer(async () => {
    const getService = (0, _consumeFirstProvider.default)('nuclide.ssh-tunnel');
    const [service, avoidPrecreatingExopackageTunnel] = await Promise.all([getService, passesGK('nuclide_adb_exopackage_tunnel')]);
    (0, _assert.default)(service);
    return {
      service,
      avoidPrecreatingExopackageTunnel
    };
  }).switchMap(({
    service,
    avoidPrecreatingExopackageTunnel
  }) => {
    const tunnels = [{
      description: 'adbmux',
      from: {
        host,
        port: 'any_available',
        family: 4
      },
      to: {
        host: 'localhost',
        port: 5037,
        family: 4
      }
    }];

    if (!avoidPrecreatingExopackageTunnel) {
      tunnels.push({
        description: 'exopackage',
        from: {
          host,
          port: 2829,
          family: 4
        },
        to: {
          host: 'localhost',
          port: 2829,
          family: 4
        }
      });
    }

    return service.openTunnels(tunnels).map(resolved => resolved[0].from.port);
  }).switchMap(async port => {
    const service = (0, _utils.getAdbServiceByNuclideUri)(host);
    await service.checkInMuxPort(port);
    return port;
  });
}

function openTunnelsManually(host) {
  let retries = 3;
  return _rxjsCompatUmdMin.Observable.defer(async () => {
    await (0, _utils.getAdbServiceByNuclideUri)(host).killServer();
    const service = await (0, _consumeFirstProvider.default)('nuclide.ssh-tunnel');
    (0, _assert.default)(service);
    return service;
  }).timeout(5000).switchMap(service => service.openTunnels([{
    description: 'adb',
    from: {
      host,
      port: 5037,
      family: 4
    },
    to: {
      host: 'localhost',
      port: 5037,
      family: 4
    }
  }, {
    description: 'emulator console',
    from: {
      host,
      port: 5554,
      family: 4
    },
    to: {
      host: 'localhost',
      port: 5554,
      family: 4
    }
  }, {
    description: 'emulator adb',
    from: {
      host,
      port: 5555,
      family: 4
    },
    to: {
      host: 'localhost',
      port: 5555,
      family: 4
    }
  }, {
    description: 'exopackage',
    from: {
      host,
      port: 2829,
      family: 4
    },
    to: {
      host: 'localhost',
      port: 2829,
      family: 4
    }
  }])).retryWhen(errors => {
    return errors.do(error => {
      if (retries-- <= 0) {
        throw error;
      }
    });
  }).mapTo(null);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL251Y2xpZGUvbnVjbGlkZS1hZGIvbGliL1R1bm5lbGluZy5qcyJdLCJuYW1lcyI6WyJwYXNzZXNHSyIsIl8iLCJmYlBhc3Nlc0dLIiwicmVxdWlyZSIsImRlZmF1bHQiLCJlIiwiTUlTU0lOR19BREJfRVJST1IiLCJWRVJTSU9OX01JU01BVENIX0VSUk9SIiwic3RhcnRUdW5uZWxpbmdBZGIiLCJ1cmkiLCJvcHRpb25zIiwibnVjbGlkZVVyaSIsImlzUmVtb3RlIiwiT2JzZXJ2YWJsZSIsIm9mIiwiY29uY2F0IiwibmV2ZXIiLCJ0dW5uZWxzIiwiYWN0aXZlVHVubmVscyIsImdldE9yQ3JlYXRlIiwic2VydmljZVVyaSIsImFkYlNlcnZpY2UiLCJsb2NhbEFkYlNlcnZpY2UiLCJvYnNlcnZhYmxlIiwiZGVmZXIiLCJhZGJWZXJzaW9uIiwibG9jYWxBZGJWZXJzaW9uIiwiUHJvbWlzZSIsImFsbCIsImdldFZlcnNpb24iLCJjYXRjaCIsImhvc3QiLCJ2ZXJzaW9uTWlzbWF0Y2hFcnJvciIsIkVycm9yIiwibmFtZSIsImNvZGUiLCJtaXNzaW5nQWRiRXJyb3IiLCJjaGVja011eFN0YXR1cyIsInN3aXRjaE1hcCIsInVzZUFkYm11eCIsImNoZWNrSW5Ub0FkYm11eCIsIm9wZW5UdW5uZWxzTWFudWFsbHkiLCJwdWJsaXNoUmVwbGF5IiwiYWRibXV4UG9ydCIsInN1YnNjcmlwdGlvbiIsInN1YnNjcmliZSIsIm5leHQiLCJwb3J0IiwiZXJyb3IiLCJkZXRhaWwiLCJidXR0b25zIiwibWVzc2FnZSIsImFkYlVwZ3JhZGVMaW5rIiwicHVzaCIsInRleHQiLCJvbkRpZENsaWNrIiwic2hlbGwiLCJvcGVuRXh0ZXJuYWwiLCJhdG9tIiwibm90aWZpY2F0aW9ucyIsImFkZEVycm9yIiwiZGlzbWlzc2FibGUiLCJhZGQiLCJjaGVja091dE11eFBvcnQiLCJzdG9wVHVubmVsaW5nQWRiIiwiY29ubmVjdCIsImNoYW5nZXMiLCJtYXBUbyIsImRlbGV0ZSIsImlzQWRiVHVubmVsZWQiLCJzdGFydFdpdGgiLCJ1bmRlZmluZWQiLCJtYXAiLCJnZXQiLCJkaXN0aW5jdFVudGlsQ2hhbmdlZCIsIlNpbXBsZUNhY2hlIiwia2V5RmFjdG9yeSIsImNyZWF0ZVJlbW90ZVVyaSIsImdldEhvc3RuYW1lIiwiZGlzcG9zZSIsInZhbHVlIiwidW5zdWJzY3JpYmUiLCJTdWJqZWN0IiwiZ2V0U2VydmljZSIsInNlcnZpY2UiLCJhdm9pZFByZWNyZWF0aW5nRXhvcGFja2FnZVR1bm5lbCIsImRlc2NyaXB0aW9uIiwiZnJvbSIsImZhbWlseSIsInRvIiwib3BlblR1bm5lbHMiLCJyZXNvbHZlZCIsImNoZWNrSW5NdXhQb3J0IiwicmV0cmllcyIsImtpbGxTZXJ2ZXIiLCJ0aW1lb3V0IiwicmV0cnlXaGVuIiwiZXJyb3JzIiwiZG8iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFnQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUF4QkE7Ozs7Ozs7Ozs7O0FBOEJBLElBQUlBLFFBQVEsR0FBRyxNQUFNQyxDQUFOLElBQVcsS0FBMUI7O0FBQ0EsSUFBSTtBQUNGLFFBQU1DLFVBQVUsR0FDZDtBQUNBQyxFQUFBQSxPQUFPLENBQUMsOENBQUQsQ0FGVDs7QUFHQUgsRUFBQUEsUUFBUSxHQUFHRSxVQUFVLENBQUNFLE9BQXRCO0FBQ0QsQ0FMRCxDQUtFLE9BQU9DLENBQVAsRUFBVSxDQUFFOztBQUVQLE1BQU1DLGlCQUFpQixHQUFHLGlCQUExQjs7QUFDQSxNQUFNQyxzQkFBc0IsR0FBRyxzQkFBL0IsQyxDQUVQO0FBQ0E7QUFDQTtBQUNBOzs7O0FBQ08sU0FBU0MsaUJBQVQsQ0FDTEMsR0FESyxFQUVMQyxPQUE2QixHQUFHLEVBRjNCLEVBR2dCO0FBQ3JCLE1BQUksQ0FBQ0Msb0JBQVdDLFFBQVgsQ0FBb0JILEdBQXBCLENBQUwsRUFBK0I7QUFDN0IsV0FBT0ksNkJBQVdDLEVBQVgsQ0FBYyxPQUFkLEVBQXVCQyxNQUF2QixDQUE4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O0FBQW9CZ0IsTUFBQUEsSUFBSSxFQUFFLElBQTFCO0FBQWdDeUMsTUFBQUEsTUFBTSxFQUFFO0FBQXhDO0FBSE4sR0FOa0IsRUFXbEI7QUFDRUYsSUFBQUEsV0FBVyxFQUFFLGNBRGY7QUFFRUMsSUFBQUEsSUFBSSxFQUFFO0FBQUN4RCxNQUFBQSxJQUFEO0FBQU9nQixNQUFBQSxJQUFJLEVBQUUsSUFBYjtBQUFtQnlDLE1BQUFBLE1BQU0sRUFBRTtBQUEzQixLQUZSO0FBR0VDLElBQUFBLEVBQUUsRUFBRTtBQUFDMUQsTUFBQUEsSUFBSSxFQUFFLFdBQVA7QUFBb0JnQixNQUFBQSxJQUFJLEVBQUUsSUFBMUI7QUFBZ0N5QyxNQUFBQSxNQUFNLEVBQUU7QUFBeEM7QUFITixHQVhrQixFQWdCbEI7QUFDRUYsSUFBQUEsV0FBVyxFQUFFLFlBRGY7QUFFRUMsSUFBQUEsSUFBSSxFQUFFO0FBQUN4RCxNQUFBQSxJQUFEO0FBQU9nQixNQUFBQSxJQUFJLEVBQUUsSUFBYjtBQUFtQnlDLE1BQUFBLE1BQU0sRUFBRTtBQUEzQixLQUZSO0FBR0VDLElBQUFBLEVBQUUsRUFBRTtBQUFDMUQsTUFBQUEsSUFBSSxFQUFFLFdBQVA7QUFBb0JnQixNQUFBQSxJQUFJLEVBQUUsSUFBMUI7QUFBZ0N5QyxNQUFBQSxNQUFNLEVBQUU7QUFBeEM7QUFITixHQWhCa0IsQ0FBcEIsQ0FYRyxFQWtDSlEsU0FsQ0ksQ0FrQ01DLE1BQU0sSUFBSTtBQUNuQixXQUFPQSxNQUFNLENBQUNDLEVBQVAsQ0FBVWxELEtBQUssSUFBSTtBQUN4QixVQUFJNkMsT0FBTyxNQUFNLENBQWpCLEVBQW9CO0FBQ2xCLGNBQU03QyxLQUFOO0FBQ0Q7QUFDRixLQUpNLENBQVA7QUFLRCxHQXhDSSxFQXlDSm1CLEtBekNJLENBeUNFLElBekNGLENBQVA7QUEwQ0QiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQ29weXJpZ2h0IChjKSAyMDE3LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXHJcbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbiAqXHJcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIEJTRC1zdHlsZSBsaWNlbnNlIGZvdW5kIGluIHRoZVxyXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuIEFuIGFkZGl0aW9uYWwgZ3JhbnRcclxuICogb2YgcGF0ZW50IHJpZ2h0cyBjYW4gYmUgZm91bmQgaW4gdGhlIFBBVEVOVFMgZmlsZSBpbiB0aGUgc2FtZSBkaXJlY3RvcnkuXHJcbiAqXHJcbiAqIEBmbG93IHN0cmljdC1sb2NhbFxyXG4gKiBAZm9ybWF0XHJcbiAqL1xyXG5cclxuaW1wb3J0IHR5cGUge1NzaFR1bm5lbFNlcnZpY2V9IGZyb20gJ0BhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1hZGIvbGliL3R5cGVzJztcclxuaW1wb3J0IHR5cGUge051Y2xpZGVVcml9IGZyb20gJ0BhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1jb21tb25zL251Y2xpZGVVcmknO1xyXG5pbXBvcnQgdHlwZSB7U3Vic2NyaXB0aW9ufSBmcm9tICdyeGpzLWNvbXBhdC9idW5kbGVzL3J4anMtY29tcGF0LnVtZC5taW4uanMnO1xyXG5cclxuaW1wb3J0IGludmFyaWFudCBmcm9tICdhc3NlcnQnO1xyXG5pbXBvcnQge3NoZWxsfSBmcm9tICdlbGVjdHJvbic7XHJcbmltcG9ydCB7Z2V0TG9nZ2VyfSBmcm9tICdsb2c0anMnO1xyXG5pbXBvcnQge1NpbXBsZUNhY2hlfSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy9TaW1wbGVDYWNoZSc7XHJcbmltcG9ydCBudWNsaWRlVXJpIGZyb20gJ0BhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1jb21tb25zL251Y2xpZGVVcmknO1xyXG5pbXBvcnQge09ic2VydmFibGUsIFN1YmplY3R9IGZyb20gJ3J4anMtY29tcGF0L2J1bmRsZXMvcnhqcy1jb21wYXQudW1kLm1pbi5qcyc7XHJcbmltcG9ydCBjb25zdW1lRmlyc3RQcm92aWRlciBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy1hdG9tL2NvbnN1bWVGaXJzdFByb3ZpZGVyJztcclxuaW1wb3J0IHtnZXRBZGJTZXJ2aWNlQnlOdWNsaWRlVXJpfSBmcm9tICcuL3V0aWxzJztcclxuaW1wb3J0IHt0cmFja30gZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvYW5hbHl0aWNzJztcclxuXHJcbmV4cG9ydCB0eXBlIEFkYlR1bm5lbGluZ09wdGlvbnMgPSB7XHJcbiAgYWRiVXBncmFkZUxpbms/OiBzdHJpbmcsXHJcbn07XHJcblxyXG5sZXQgcGFzc2VzR0sgPSBhc3luYyBfID0+IGZhbHNlO1xyXG50cnkge1xyXG4gIGNvbnN0IGZiUGFzc2VzR0sgPVxyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG51Y2xpZGUtaW50ZXJuYWwvbW9kdWxlcy1kZXBlbmRlbmNpZXNcclxuICAgIHJlcXVpcmUoJ0BhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1jb21tb25zL3Bhc3Nlc0dLJyk7XHJcbiAgcGFzc2VzR0sgPSBmYlBhc3Nlc0dLLmRlZmF1bHQ7XHJcbn0gY2F0Y2ggKGUpIHt9XHJcblxyXG5leHBvcnQgY29uc3QgTUlTU0lOR19BREJfRVJST1IgPSAnTWlzc2luZ0FkYkVycm9yJztcclxuZXhwb3J0IGNvbnN0IFZFUlNJT05fTUlTTUFUQ0hfRVJST1IgPSAnVmVyc2lvbk1pc21hdGNoRXJyb3InO1xyXG5cclxuLy8gMS4gU3RhcnRzIGFkYiB0dW5uZWxpbmcgaW1tZWRpYXRlbHkgKGRvZXMgbm90IGNhcmUgaWYgeW91IHN1YnNjcmliZSlcclxuLy8gMi4gVHVubmVsaW5nIHN0YXlzIHR1cm5lZCBvbiBldmVuIGFmdGVyIHlvdSB1bnN1YnNjcmliZSAodG8gcHJldmVudCB0b28gbXVjaCBvbi9vZmYgdG9nZ2xpbmcpXHJcbi8vIDMuIFNlbmRzIGEgdmFsdWUgd2hlbiBldmVyeXRoaW5nIGlzIHJlYWR5IChpZiBhbHJlYWR5IGFjdGl2ZSwgaXQgc2VuZHMgJ3JlYWR5JyBpbW1lZGlhdGVseSlcclxuLy8gNC4gR3VhcmFudGVlcyB0aGF0IHR1bm5lbGluZyBpcyBhY3RpdmUgYXMgbG9uZyBhcyB0aGUgb2JzZXJ2YWJsZSBpcyBub3QgY29tcGxldGUgKG9yIGVycm9yZWQpXHJcbmV4cG9ydCBmdW5jdGlvbiBzdGFydFR1bm5lbGluZ0FkYihcclxuICB1cmk6IE51Y2xpZGVVcmksXHJcbiAgb3B0aW9ucz86IEFkYlR1bm5lbGluZ09wdGlvbnMgPSB7fSxcclxuKTogT2JzZXJ2YWJsZTwncmVhZHknPiB7XHJcbiAgaWYgKCFudWNsaWRlVXJpLmlzUmVtb3RlKHVyaSkpIHtcclxuICAgIHJldHVybiBPYnNlcnZhYmxlLm9mKCdyZWFkeScpLmNvbmNhdChPYnNlcnZhYmxlLm5ldmVyKCkpO1xyXG4gIH1cclxuICBjb25zdCB7dHVubmVsc30gPSBhY3RpdmVUdW5uZWxzLmdldE9yQ3JlYXRlKHVyaSwgKF8sIHNlcnZpY2VVcmkpID0+IHtcclxuICAgIGludmFyaWFudCh0eXBlb2Ygc2VydmljZVVyaSA9PT0gJ3N0cmluZycpO1xyXG4gICAgY29uc3QgYWRiU2VydmljZSA9IGdldEFkYlNlcnZpY2VCeU51Y2xpZGVVcmkoc2VydmljZVVyaSk7XHJcbiAgICBjb25zdCBsb2NhbEFkYlNlcnZpY2UgPSBnZXRBZGJTZXJ2aWNlQnlOdWNsaWRlVXJpKCcnKTtcclxuXHJcbiAgICBjb25zdCBvYnNlcnZhYmxlID0gT2JzZXJ2YWJsZS5kZWZlcihhc3luYyAoKSA9PiB7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgW2FkYlZlcnNpb24sIGxvY2FsQWRiVmVyc2lvbl0gPSBhd2FpdCBQcm9taXNlLmFsbChbXHJcbiAgICAgICAgICBhZGJTZXJ2aWNlLmdldFZlcnNpb24oKS5jYXRjaChlID0+IHtcclxuICAgICAgICAgICAgZS5ob3N0ID0gc2VydmljZVVyaTtcclxuICAgICAgICAgICAgdGhyb3cgZTtcclxuICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgbG9jYWxBZGJTZXJ2aWNlLmdldFZlcnNpb24oKS5jYXRjaChlID0+IHtcclxuICAgICAgICAgICAgZS5ob3N0ID0gJyc7XHJcbiAgICAgICAgICAgIHRocm93IGU7XHJcbiAgICAgICAgICB9KSxcclxuICAgICAgICBdKTtcclxuXHJcbiAgICAgICAgaWYgKGFkYlZlcnNpb24gIT09IGxvY2FsQWRiVmVyc2lvbikge1xyXG4gICAgICAgICAgY29uc3QgdmVyc2lvbk1pc21hdGNoRXJyb3IgPSBuZXcgRXJyb3IoXHJcbiAgICAgICAgICAgIGBZb3VyIHJlbW90ZSBhZGIgdmVyc2lvbiBkaWZmZXJzIGZyb20gdGhlIGxvY2FsIG9uZTogJHthZGJWZXJzaW9ufSAocmVtb3RlKSAhPSAke2xvY2FsQWRiVmVyc2lvbn0gKGxvY2FsKWAsXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgICAgdmVyc2lvbk1pc21hdGNoRXJyb3IubmFtZSA9IFZFUlNJT05fTUlTTUFUQ0hfRVJST1I7XHJcbiAgICAgICAgICB0aHJvdyB2ZXJzaW9uTWlzbWF0Y2hFcnJvcjtcclxuICAgICAgICB9XHJcbiAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICBpZiAoZS5jb2RlID09PSAnRU5PRU5UJyAmJiBlLmhvc3QgIT0gbnVsbCkge1xyXG4gICAgICAgICAgY29uc3QgbWlzc2luZ0FkYkVycm9yID0gbmV3IEVycm9yKFxyXG4gICAgICAgICAgICBgJ2FkYicgbm90IGZvdW5kIGluICR7ZS5ob3N0ID09PSAnJyA/ICdsb2NhbCcgOiAncmVtb3RlJ30gJFBBVEguYCxcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgICBtaXNzaW5nQWRiRXJyb3IubmFtZSA9IE1JU1NJTkdfQURCX0VSUk9SO1xyXG4gICAgICAgICAgdGhyb3cgbWlzc2luZ0FkYkVycm9yO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aHJvdyBlO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIGFkYlNlcnZpY2UuY2hlY2tNdXhTdGF0dXMoKTtcclxuICAgIH0pXHJcbiAgICAgIC5zd2l0Y2hNYXAoXHJcbiAgICAgICAgdXNlQWRibXV4ID0+XHJcbiAgICAgICAgICB1c2VBZGJtdXhcclxuICAgICAgICAgICAgPyBjaGVja0luVG9BZGJtdXgoc2VydmljZVVyaSlcclxuICAgICAgICAgICAgOiBvcGVuVHVubmVsc01hbnVhbGx5KHNlcnZpY2VVcmkpLFxyXG4gICAgICApXHJcbiAgICAgIC5wdWJsaXNoUmVwbGF5KDEpO1xyXG5cclxuICAgIGxldCBhZGJtdXhQb3J0O1xyXG4gICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gb2JzZXJ2YWJsZS5zdWJzY3JpYmUoe1xyXG4gICAgICBuZXh0OiBwb3J0ID0+IChhZGJtdXhQb3J0ID0gcG9ydCksXHJcbiAgICAgIGVycm9yOiBlID0+IHtcclxuICAgICAgICBnZXRMb2dnZXIoJ0BhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1hZGI6dHVubmVsaW5nJykuZXJyb3IoZSk7XHJcbiAgICAgICAgdHJhY2soJ0BhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1hZGI6dHVubmVsaW5nOmVycm9yJywge2hvc3Q6IHVyaSwgZXJyb3I6IGV9KTtcclxuICAgICAgICBpZiAoZS5uYW1lID09PSBNSVNTSU5HX0FEQl9FUlJPUikge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgZGV0YWlsO1xyXG4gICAgICAgIGNvbnN0IGJ1dHRvbnMgPSBbXTtcclxuICAgICAgICBpZiAoZS5uYW1lID09PSBWRVJTSU9OX01JU01BVENIX0VSUk9SKSB7XHJcbiAgICAgICAgICBkZXRhaWwgPSBlLm1lc3NhZ2U7XHJcbiAgICAgICAgICBjb25zdCB7YWRiVXBncmFkZUxpbmt9ID0gb3B0aW9ucztcclxuICAgICAgICAgIGlmIChlLm5hbWUgPT09IFZFUlNJT05fTUlTTUFUQ0hfRVJST1IgJiYgYWRiVXBncmFkZUxpbmsgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICBidXR0b25zLnB1c2goe1xyXG4gICAgICAgICAgICAgIHRleHQ6ICdWaWV3IHVwZ3JhZGUgaW5zdHJ1Y3Rpb25zJyxcclxuICAgICAgICAgICAgICBvbkRpZENsaWNrOiAoKSA9PiBzaGVsbC5vcGVuRXh0ZXJuYWwoYWRiVXBncmFkZUxpbmspLFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgZGV0YWlsID1cclxuICAgICAgICAgICAgXCJZb3VyIGxvY2FsIGRldmljZXMgd29uJ3QgYmUgYXZhaWxhYmxlIG9uIHRoaXMgaG9zdC5cIiArXHJcbiAgICAgICAgICAgIChlLm5hbWUgIT0gbnVsbCAmJiBlLm5hbWUgIT09ICdFcnJvcicgPyBgXFxuIFxcbiR7ZS5uYW1lfWAgOiAnJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcignRmFpbGVkIHRvIHR1bm5lbCBBbmRyb2lkIGRldmljZXMnLCB7XHJcbiAgICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcclxuICAgICAgICAgIGRldGFpbCxcclxuICAgICAgICAgIGJ1dHRvbnMsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0sXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyAuYWRkIHJldHVybnMgYSBTdWJzY3JpcHRpb24sIHRoZSB0ZWFyZG93biBsb2dpYyBvZiB3aGljaCBkb2Vzbid0IHNlZW0gdG8gZ2V0IGRpc3Bvc2VkIG9uIHVuc3Vic2NyaWJlXHJcbiAgICBzdWJzY3JpcHRpb25cclxuICAgICAgLmFkZCgoKSA9PiB7XHJcbiAgICAgICAgaWYgKGFkYm11eFBvcnQgIT0gbnVsbCkge1xyXG4gICAgICAgICAgYWRiU2VydmljZS5jaGVja091dE11eFBvcnQoYWRibXV4UG9ydCk7XHJcbiAgICAgICAgICBhZGJtdXhQb3J0ID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICAgICAgc3RvcFR1bm5lbGluZ0FkYih1cmkpO1xyXG4gICAgICB9KVxyXG4gICAgICAvLyBTdGFydCBldmVyeXRoaW5nIVxyXG4gICAgICAuYWRkKG9ic2VydmFibGUuY29ubmVjdCgpKTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBzdWJzY3JpcHRpb24sXHJcbiAgICAgIHR1bm5lbHM6IG9ic2VydmFibGUsXHJcbiAgICB9O1xyXG4gIH0pO1xyXG4gIGNoYW5nZXMubmV4dCgpO1xyXG5cclxuICByZXR1cm4gdHVubmVscy5tYXBUbygncmVhZHknKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHN0b3BUdW5uZWxpbmdBZGIodXJpOiBOdWNsaWRlVXJpKSB7XHJcbiAgYWN0aXZlVHVubmVscy5kZWxldGUodXJpKTtcclxuICBjaGFuZ2VzLm5leHQoKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzQWRiVHVubmVsZWQodXJpOiBOdWNsaWRlVXJpKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XHJcbiAgcmV0dXJuIGNoYW5nZXNcclxuICAgIC5zdGFydFdpdGgodW5kZWZpbmVkKVxyXG4gICAgLm1hcCgoKSA9PiBhY3RpdmVUdW5uZWxzLmdldCh1cmkpICE9IG51bGwpXHJcbiAgICAuZGlzdGluY3RVbnRpbENoYW5nZWQoKTtcclxufVxyXG5cclxuY29uc3QgYWN0aXZlVHVubmVsczogU2ltcGxlQ2FjaGU8XHJcbiAgTnVjbGlkZVVyaSxcclxuICB7dHVubmVsczogT2JzZXJ2YWJsZTw/bnVtYmVyPiwgc3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb259LFxyXG4+ID0gbmV3IFNpbXBsZUNhY2hlKHtcclxuICBrZXlGYWN0b3J5OiB1cmkgPT5cclxuICAgIG51Y2xpZGVVcmkuY3JlYXRlUmVtb3RlVXJpKG51Y2xpZGVVcmkuZ2V0SG9zdG5hbWUodXJpKSwgJy8nKSxcclxuICBkaXNwb3NlOiB2YWx1ZSA9PiB2YWx1ZS5zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKSxcclxufSk7XHJcbmNvbnN0IGNoYW5nZXM6IFN1YmplY3Q8dm9pZD4gPSBuZXcgU3ViamVjdCgpO1xyXG5cclxuZnVuY3Rpb24gY2hlY2tJblRvQWRibXV4KGhvc3Q6IE51Y2xpZGVVcmkpOiBPYnNlcnZhYmxlPD9udW1iZXI+IHtcclxuICByZXR1cm4gT2JzZXJ2YWJsZS5kZWZlcihhc3luYyAoKSA9PiB7XHJcbiAgICBjb25zdCBnZXRTZXJ2aWNlOiBQcm9taXNlPFNzaFR1bm5lbFNlcnZpY2U+ID0gY29uc3VtZUZpcnN0UHJvdmlkZXIoXHJcbiAgICAgICdudWNsaWRlLnNzaC10dW5uZWwnLFxyXG4gICAgKTtcclxuICAgIGNvbnN0IFtzZXJ2aWNlLCBhdm9pZFByZWNyZWF0aW5nRXhvcGFja2FnZVR1bm5lbF0gPSBhd2FpdCBQcm9taXNlLmFsbChbXHJcbiAgICAgIGdldFNlcnZpY2UsXHJcbiAgICAgIHBhc3Nlc0dLKCdudWNsaWRlX2FkYl9leG9wYWNrYWdlX3R1bm5lbCcpLFxyXG4gICAgXSk7XHJcbiAgICBpbnZhcmlhbnQoc2VydmljZSk7XHJcbiAgICByZXR1cm4ge3NlcnZpY2UsIGF2b2lkUHJlY3JlYXRpbmdFeG9wYWNrYWdlVHVubmVsfTtcclxuICB9KVxyXG4gICAgLnN3aXRjaE1hcCgoe3NlcnZpY2UsIGF2b2lkUHJlY3JlYXRpbmdFeG9wYWNrYWdlVHVubmVsfSkgPT4ge1xyXG4gICAgICBjb25zdCB0dW5uZWxzID0gW1xyXG4gICAgICAgIHtcclxuICAgICAgICAgIGRlc2NyaXB0aW9uOiAnYWRibXV4JyxcclxuICAgICAgICAgIGZyb206IHtob3N0LCBwb3J0OiAnYW55X2F2YWlsYWJsZScsIGZhbWlseTogNH0sXHJcbiAgICAgICAgICB0bzoge2hvc3Q6ICdsb2NhbGhvc3QnLCBwb3J0OiA1MDM3LCBmYW1pbHk6IDR9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgIF07XHJcbiAgICAgIGlmICghYXZvaWRQcmVjcmVhdGluZ0V4b3BhY2thZ2VUdW5uZWwpIHtcclxuICAgICAgICB0dW5uZWxzLnB1c2goe1xyXG4gICAgICAgICAgZGVzY3JpcHRpb246ICdleG9wYWNrYWdlJyxcclxuICAgICAgICAgIGZyb206IHtob3N0LCBwb3J0OiAyODI5LCBmYW1pbHk6IDR9LFxyXG4gICAgICAgICAgdG86IHtob3N0OiAnbG9jYWxob3N0JywgcG9ydDogMjgyOSwgZmFtaWx5OiA0fSxcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gc2VydmljZVxyXG4gICAgICAgIC5vcGVuVHVubmVscyh0dW5uZWxzKVxyXG4gICAgICAgIC5tYXAocmVzb2x2ZWQgPT4gcmVzb2x2ZWRbMF0uZnJvbS5wb3J0KTtcclxuICAgIH0pXHJcbiAgICAuc3dpdGNoTWFwKGFzeW5jIHBvcnQgPT4ge1xyXG4gICAgICBjb25zdCBzZXJ2aWNlID0gZ2V0QWRiU2VydmljZUJ5TnVjbGlkZVVyaShob3N0KTtcclxuICAgICAgYXdhaXQgc2VydmljZS5jaGVja0luTXV4UG9ydChwb3J0KTtcclxuICAgICAgcmV0dXJuIHBvcnQ7XHJcbiAgICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gb3BlblR1bm5lbHNNYW51YWxseShob3N0OiBOdWNsaWRlVXJpKTogT2JzZXJ2YWJsZTw/bnVtYmVyPiB7XHJcbiAgbGV0IHJldHJpZXMgPSAzO1xyXG4gIHJldHVybiBPYnNlcnZhYmxlLmRlZmVyKGFzeW5jICgpID0+IHtcclxuICAgIGF3YWl0IGdldEFkYlNlcnZpY2VCeU51Y2xpZGVVcmkoaG9zdCkua2lsbFNlcnZlcigpO1xyXG5cclxuICAgIGNvbnN0IHNlcnZpY2U6IFNzaFR1bm5lbFNlcnZpY2UgPSBhd2FpdCBjb25zdW1lRmlyc3RQcm92aWRlcihcclxuICAgICAgJ251Y2xpZGUuc3NoLXR1bm5lbCcsXHJcbiAgICApO1xyXG4gICAgaW52YXJpYW50KHNlcnZpY2UpO1xyXG4gICAgcmV0dXJuIHNlcnZpY2U7XHJcbiAgfSlcclxuICAgIC50aW1lb3V0KDUwMDApXHJcbiAgICAuc3dpdGNoTWFwKHNlcnZpY2UgPT5cclxuICAgICAgc2VydmljZS5vcGVuVHVubmVscyhbXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgZGVzY3JpcHRpb246ICdhZGInLFxyXG4gICAgICAgICAgZnJvbToge2hvc3QsIHBvcnQ6IDUwMzcsIGZhbWlseTogNH0sXHJcbiAgICAgICAgICB0bzoge2hvc3Q6ICdsb2NhbGhvc3QnLCBwb3J0OiA1MDM3LCBmYW1pbHk6IDR9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgZGVzY3JpcHRpb246ICdlbXVsYXRvciBjb25zb2xlJyxcclxuICAgICAgICAgIGZyb206IHtob3N0LCBwb3J0OiA1NTU0LCBmYW1pbHk6IDR9LFxyXG4gICAgICAgICAgdG86IHtob3N0OiAnbG9jYWxob3N0JywgcG9ydDogNTU1NCwgZmFtaWx5OiA0fSxcclxuICAgICAgICB9LFxyXG4gICAgICAgIHtcclxuICAgICAgICAgIGRlc2NyaXB0aW9uOiAnZW11bGF0b3IgYWRiJyxcclxuICAgICAgICAgIGZyb206IHtob3N0LCBwb3J0OiA1NTU1LCBmYW1pbHk6IDR9LFxyXG4gICAgICAgICAgdG86IHtob3N0OiAnbG9jYWxob3N0JywgcG9ydDogNTU1NSwgZmFtaWx5OiA0fSxcclxuICAgICAgICB9LFxyXG4gICAgICAgIHtcclxuICAgICAgICAgIGRlc2NyaXB0aW9uOiAnZXhvcGFja2FnZScsXHJcbiAgICAgICAgICBmcm9tOiB7aG9zdCwgcG9ydDogMjgyOSwgZmFtaWx5OiA0fSxcclxuICAgICAgICAgIHRvOiB7aG9zdDogJ2xvY2FsaG9zdCcsIHBvcnQ6IDI4MjksIGZhbWlseTogNH0sXHJcbiAgICAgICAgfSxcclxuICAgICAgXSksXHJcbiAgICApXHJcbiAgICAucmV0cnlXaGVuKGVycm9ycyA9PiB7XHJcbiAgICAgIHJldHVybiBlcnJvcnMuZG8oZXJyb3IgPT4ge1xyXG4gICAgICAgIGlmIChyZXRyaWVzLS0gPD0gMCkge1xyXG4gICAgICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pXHJcbiAgICAubWFwVG8obnVsbCk7XHJcbn1cclxuIl19