"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _assert = _interopRequireDefault(require("assert"));

var _rxjsCompatUmdMin = require("rxjs-compat/bundles/rxjs-compat.umd.min.js");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */

/**
 * A wrapper over the specified Atom's config functions.
 * Each individual loaded package's config is a subconfig of the root package.
 */
class ConfigManager {
  constructor(config) {
    this._packageName = void 0;
    this._config = void 0;
    this._config = config;
  }

  getConfig() {
    return this._config;
  }
  /**
   * Sets the root package name.
   * This gets automatically called from FeatureLoader.
   */


  setPackageName(name) {
    this._packageName = name;
  }

  getPackageName() {
    (0, _assert.default)(this._packageName != null, 'No package name available');
    return this._packageName;
  }

  formatKeyPath(keyPath) {
    if (this._packageName == null) {
      return keyPath;
    }

    return `${this._packageName}.${keyPath}`;
  }
  /*
   * Returns the value of a setting for a Nuclide feature key. Takes and returns the same types as
   * `atom.config.get` except `keyPath` is not optional. To get the entire config object, use
   * `atom.config.get`.
   *
   * Note: This is intentionally typed as mixed, this way each call site has to
   * first cast it as any and it is obvious that this is an area that is not safe
   * and flow will not proceed if the callsite doesn't do it.
   *
   * Example:
   *   const config: MyConfigType = (featureConfig.get('config-name'): any);
   */


  get(keyPath, options) {
    // atom.config.get will crash if the second arg is present and undefined.
    // It does not crash if the second arg is missing.
    return this._config.get(this.formatKeyPath(keyPath), ...(options == null ? [] : [options]));
  }

  getWithDefaults(keyPath, defaults, options) {
    const current = this.get(keyPath, options);
    return current == null ? defaults : current;
  }
  /*
   * Gets the schema of a setting for a Nuclide feature key. Takes and returns the same types as
   * `atom.config.getSchema`.
   */


  getSchema(keyPath) {
    return this._config.getSchema(this.formatKeyPath(keyPath));
  }
  /*
   * Similar to `atom.config.observe` except arguments are required, and options cannot be given.
   *
   * To observe changes on the entire config, use `atom.config.observe`.
   */


  observe(keyPath, optionsOrCallback, callback) {
    return this._config.observe(this.formatKeyPath(keyPath), ...Array.prototype.slice.call(arguments, 1));
  }
  /*
   * Behaves similarly to the `observe` function, but returns a stream of values, rather
   * than receiving a callback.
   */


  observeAsStream(keyPath, options = {}) {
    return _rxjsCompatUmdMin.Observable.create(observer => {
      const disposable = this.observe(keyPath, options, observer.next.bind(observer));
      return disposable.dispose.bind(disposable);
    });
  }
  /*
   * Takes and returns the same types as `atom.config.onDidChange` except `keyPath` is not optional.
   * To listen to changes on all key paths, use `atom.config.onDidChange`.
   */


  onDidChange(keyPath, optionsOrCallback, callback) {
    return this._config.onDidChange(this.formatKeyPath(keyPath), ...Array.prototype.slice.call(arguments, 1));
  }
  /*
   * Sets the value of a setting for a Nuclide feature key. Takes and returns the same types as
   * `atom.config.set`.
   */


  set(keyPath, value, options) {
    return this._config.set(this.formatKeyPath(keyPath), ...Array.prototype.slice.call(arguments, 1));
  }
  /*
   * Sets the schema of a setting for a Nuclide feature key. Takes and returns the same types as
   * `atom.config.setSchema`.
   */


  setSchema(keyPath, schema) {
    return this._config.setSchema(this.formatKeyPath(keyPath), ...Array.prototype.slice.call(arguments, 1));
  }
  /*
   * Restores a setting for a Nuclide feature key to its default value. Takes and returns the same
   * types as `atom.config.set`.
   */


  unset(keyPath, options) {
    return this._config.unset(this.formatKeyPath(keyPath), ...Array.prototype.slice.call(arguments, 1));
  }
  /**
   * Returns `true` if the feature with the given name is disabled either directly or because the
   * container package itself is disabled.
   */


  isFeatureDisabled(name) {
    if (this._packageName == null) {
      return atom.packages.isPackageDisabled(name);
    }

    return atom.packages.isPackageDisabled(this._packageName) || // $FlowFixMe flow doesn't register this._packageName as non-null here
    !this._config.get(`${this._packageName}.use.${name}`);
  }

}

exports.default = ConfigManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1jb21tb25zLWF0b20vQ29uZmlnTWFuYWdlci5qcyJdLCJuYW1lcyI6WyJDb25maWdNYW5hZ2VyIiwiY29uc3RydWN0b3IiLCJjb25maWciLCJfcGFja2FnZU5hbWUiLCJfY29uZmlnIiwiZ2V0Q29uZmlnIiwic2V0UGFja2FnZU5hbWUiLCJuYW1lIiwiZ2V0UGFja2FnZU5hbWUiLCJmb3JtYXRLZXlQYXRoIiwia2V5UGF0aCIsImdldCIsIm9wdGlvbnMiLCJnZXRXaXRoRGVmYXVsdHMiLCJkZWZhdWx0cyIsImN1cnJlbnQiLCJnZXRTY2hlbWEiLCJvYnNlcnZlIiwib3B0aW9uc09yQ2FsbGJhY2siLCJjYWxsYmFjayIsIkFycmF5IiwicHJvdG90eXBlIiwic2xpY2UiLCJjYWxsIiwiYXJndW1lbnRzIiwib2JzZXJ2ZUFzU3RyZWFtIiwiT2JzZXJ2YWJsZSIsImNyZWF0ZSIsIm9ic2VydmVyIiwiZGlzcG9zYWJsZSIsIm5leHQiLCJiaW5kIiwiZGlzcG9zZSIsIm9uRGlkQ2hhbmdlIiwic2V0IiwidmFsdWUiLCJzZXRTY2hlbWEiLCJzY2hlbWEiLCJ1bnNldCIsImlzRmVhdHVyZURpc2FibGVkIiwiYXRvbSIsInBhY2thZ2VzIiwiaXNQYWNrYWdlRGlzYWJsZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFZQTs7QUFDQTs7OztBQWJBOzs7Ozs7Ozs7Ozs7QUFlQTs7OztBQUtlLE1BQU1BLGFBQU4sQ0FBb0I7QUFJakNDLEVBQUFBLFdBQVcsQ0FBQ0MsTUFBRCxFQUFzQjtBQUFBLFNBSGpDQyxZQUdpQztBQUFBLFNBRmpDQyxPQUVpQztBQUMvQixTQUFLQSxPQUFMLEdBQWVGLE1BQWY7QUFDRDs7QUFFREcsRUFBQUEsU0FBUyxHQUFnQjtBQUN2QixXQUFPLEtBQUtELE9BQVo7QUFDRDtBQUVEOzs7Ozs7QUFJQUUsRUFBQUEsY0FBYyxDQUFDQyxJQUFELEVBQXFCO0FBQ2pDLFNBQUtKLFlBQUwsR0FBb0JJLElBQXBCO0FB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QXdDO0FBQy9DLFdBQU8sS0FBS2pDLE9BQUwsQ0FBYWdDLFNBQWIsQ0FDTCxLQUFLM0IsYUFBTCxDQUFtQkMsT0FBbkIsQ0FESyxFQUVMLEdBQUdVLEtBQUssQ0FBQ0MsU0FBTixDQUFnQkMsS0FBaEIsQ0FBc0JDLElBQXRCLENBQTJCQyxTQUEzQixFQUFzQyxDQUF0QyxDQUZFLENBQVA7QUFJRDtBQUVEOzs7Ozs7QUFJQWMsRUFBQUEsS0FBSyxDQUNINUIsT0FERyxFQUVIRSxPQUZHLEVBTUc7QUFDTixXQUFPLEtBQUtSLE9BQUwsQ0FBYWtDLEtBQWIsQ0FDTCxLQUFLN0IsYUFBTCxDQUFtQkMsT0FBbkIsQ0FESyxFQUVMLEdBQUdVLEtBQUssQ0FBQ0MsU0FBTixDQUFnQkMsS0FBaEIsQ0FBc0JDLElBQXRCLENBQTJCQyxTQUEzQixFQUFzQyxDQUF0QyxDQUZFLENBQVA7QUFJRDtBQUVEOzs7Ozs7QUFJQWUsRUFBQUEsaUJBQWlCLENBQUNoQyxJQUFELEVBQXdCO0FBQ3ZDLFFBQUksS0FBS0osWUFBTCxJQUFxQixJQUF6QixFQUErQjtBQUM3QixhQUFPcUMsSUFBSSxDQUFDQyxRQUFMLENBQWNDLGlCQUFkLENBQWdDbkMsSUFBaEMsQ0FBUDtBQUNEOztBQUNELFdBQ0VpQyxJQUFJLENBQUNDLFFBQUwsQ0FBY0MsaUJBQWQsQ0FBZ0MsS0FBS3ZDLFlBQXJDLEtBQ0E7QUFDQSxLQUFDLEtBQUtDLE9BQUwsQ0FBYU8sR0FBYixDQUFrQixHQUFFLEtBQUtSLFlBQWEsUUFBT0ksSUFBSyxFQUFsRCxDQUhIO0FBS0Q7O0FBak1nQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTctcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cclxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuICpcclxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgQlNELXN0eWxlIGxpY2Vuc2UgZm91bmQgaW4gdGhlXHJcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4gQW4gYWRkaXRpb25hbCBncmFudFxyXG4gKiBvZiBwYXRlbnQgcmlnaHRzIGNhbiBiZSBmb3VuZCBpbiB0aGUgUEFURU5UUyBmaWxlIGluIHRoZSBzYW1lIGRpcmVjdG9yeS5cclxuICpcclxuICogQGZsb3dcclxuICogQGZvcm1hdFxyXG4gKi9cclxuXHJcbmltcG9ydCBpbnZhcmlhbnQgZnJvbSAnYXNzZXJ0JztcclxuaW1wb3J0IHtPYnNlcnZhYmxlfSBmcm9tICdyeGpzLWNvbXBhdC9idW5kbGVzL3J4anMtY29tcGF0LnVtZC5taW4uanMnO1xyXG5cclxuLyoqXHJcbiAqIEEgd3JhcHBlciBvdmVyIHRoZSBzcGVjaWZpZWQgQXRvbSdzIGNvbmZpZyBmdW5jdGlvbnMuXHJcbiAqIEVhY2ggaW5kaXZpZHVhbCBsb2FkZWQgcGFja2FnZSdzIGNvbmZpZyBpcyBhIHN1YmNvbmZpZyBvZiB0aGUgcm9vdCBwYWNrYWdlLlxyXG4gKi9cclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENvbmZpZ01hbmFnZXIge1xyXG4gIF9wYWNrYWdlTmFtZTogP3N0cmluZztcclxuICBfY29uZmlnOiBhdG9tJENvbmZpZztcclxuXHJcbiAgY29uc3RydWN0b3IoY29uZmlnOiBhdG9tJENvbmZpZykge1xyXG4gICAgdGhpcy5fY29uZmlnID0gY29uZmlnO1xyXG4gIH1cclxuXHJcbiAgZ2V0Q29uZmlnKCk6IGF0b20kQ29uZmlnIHtcclxuICAgIHJldHVybiB0aGlzLl9jb25maWc7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZXRzIHRoZSByb290IHBhY2thZ2UgbmFtZS5cclxuICAgKiBUaGlzIGdldHMgYXV0b21hdGljYWxseSBjYWxsZWQgZnJvbSBGZWF0dXJlTG9hZGVyLlxyXG4gICAqL1xyXG4gIHNldFBhY2thZ2VOYW1lKG5hbWU6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy5fcGFja2FnZU5hbWUgPSBuYW1lO1xyXG4gIH1cclxuXHJcbiAgZ2V0UGFja2FnZU5hbWUoKTogc3RyaW5nIHtcclxuICAgIGludmFyaWFudCh0aGlzLl9wYWNrYWdlTmFtZSAhPSBudWxsLCAnTm8gcGFja2FnZSBuYW1lIGF2YWlsYWJsZScpO1xyXG4gICAgcmV0dXJuIHRoaXMuX3BhY2thZ2VOYW1lO1xyXG4gIH1cclxuXHJcbiAgZm9ybWF0S2V5UGF0aChrZXlQYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgaWYgKHRoaXMuX3BhY2thZ2VOYW1lID09IG51bGwpIHtcclxuICAgICAgcmV0dXJuIGtleVBhdGg7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gYCR7dGhpcy5fcGFja2FnZU5hbWV9LiR7a2V5UGF0aH1gO1xyXG4gIH1cclxuXHJcbiAgLypcclxuICAgKiBSZXR1cm5zIHRoZSB2YWx1ZSBvZiBhIHNldHRpbmcgZm9yIGEgTnVjbGlkZSBmZWF0dXJlIGtleS4gVGFrZXMgYW5kIHJldHVybnMgdGhlIHNhbWUgdHlwZXMgYXNcclxuICAgKiBgYXRvbS5jb25maWcuZ2V0YCBleGNlcHQgYGtleVBhdGhgIGlzIG5vdCBvcHRpb25hbC4gVG8gZ2V0IHRoZSBlbnRpcmUgY29uZmlnIG9iamVjdCwgdXNlXHJcbiAgICogYGF0b20uY29uZmlnLmdldGAuXHJcbiAgICpcclxuICAgKiBOb3RlOiBUaGlzIGlzIGludGVudGlvbmFsbHkgdHlwZWQgYXMgbWl4ZWQsIHRoaXMgd2F5IGVhY2ggY2FsbCBzaXRlIGhhcyB0b1xyXG4gICAqIGZpcnN0IGNhc3QgaXQgYXMgYW55IGFuZCBpdCBpcyBvYnZpb3VzIHRoYXQgdGhpcyBpcyBhbiBhcmVhIHRoYXQgaXMgbm90IHNhZmVcclxuICAgKiBhbmQgZmxvdyB3aWxsIG5vdCBwcm9jZWVkIGlmIHRoZSBjYWxsc2l0ZSBkb2Vzbid0IGRvIGl0LlxyXG4gICAqXHJcbiAgICogRXhhbXBsZTpcclxuICAgKiAgIGNvbnN0IGNvbmZpZzogTXlDb25maWdUeXBlID0gKGZlYXR1cmVDb25maWcuZ2V0KCdjb25maWctbmFtZScpOiBhbnkpO1xyXG4gICAqL1xyXG4gIGdldChcclxuICAgIGtleVBhdGg6IHN0cmluZyxcclxuICAgIG9wdGlvbnM/OiB7XHJcbiAgICAgIGV4Y2x1ZGVTb3VyY2VzPzogQXJyYXk8c3RyaW5nPixcclxuICAgICAgc291cmNlcz86IEFycmF5PHN0cmluZz4sXHJcbiAgICAgIHNjb3BlPzogYXRvbSRTY29wZURlc2NyaXB0b3JMaWtlLFxyXG4gICAgfSxcclxuICApOiBtaXhlZCB7XHJcbiAgICAvLyBhdG9tLmNvbmZpZy5nZXQgd2lsbCBjcmFzaCBpZiB0aGUgc2Vjb25kIGFyZyBpcyBwcmVzZW50IGFuZCB1bmRlZmluZWQuXHJcbiAgICAvLyBJdCBkb2VzIG5vdCBjcmFzaCBpZiB0aGUgc2Vjb25kIGFyZyBpcyBtaXNzaW5nLlxyXG4gICAgcmV0dXJuIHRoaXMuX2NvbmZpZy5nZXQoXHJcbiAgICAgIHRoaXMuZm9ybWF0S2V5UGF0aChrZXlQYXRoKSxcclxuICAgICAgLi4uKG9wdGlvbnMgPT0gbnVsbCA/IFtdIDogW29wdGlvbnNdKSxcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBnZXRXaXRoRGVmYXVsdHM8VD4oXHJcbiAgICBrZXlQYXRoOiBzdHJpbmcsXHJcbiAgICBkZWZhdWx0czogVCxcclxuICAgIG9wdGlvbnM/OiB7XHJcbiAgICAgIGV4Y2x1ZGVTb3VyY2VzPzogQXJyYXk8c3RyaW5nPixcclxuICAgICAgc291cmNlcz86IEFycmF5PHN0cmluZz4sXHJcbiAgICAgIHNjb3BlPzogYXRvbSRTY29wZURlc2NyaXB0b3JMaWtlLFxyXG4gICAgfSxcclxuICApOiBUIHtcclxuICAgIGNvbnN0IGN1cnJlbnQ6IGFueSA9IHRoaXMuZ2V0KGtleVBhdGgsIG9wdGlvbnMpO1xyXG4gICAgcmV0dXJuIGN1cnJlbnQgPT0gbnVsbCA/IGRlZmF1bHRzIDogY3VycmVudDtcclxuICB9XHJcblxyXG4gIC8qXHJcbiAgICogR2V0cyB0aGUgc2NoZW1hIG9mIGEgc2V0dGluZyBmb3IgYSBOdWNsaWRlIGZlYXR1cmUga2V5LiBUYWtlcyBhbmQgcmV0dXJucyB0aGUgc2FtZSB0eXBlcyBhc1xyXG4gICAqIGBhdG9tLmNvbmZpZy5nZXRTY2hlbWFgLlxyXG4gICAqL1xyXG4gIGdldFNjaGVtYShrZXlQYXRoOiBzdHJpbmcpOiBhdG9tJENvbmZpZ1NjaGVtYSB7XHJcbiAgICByZXR1cm4gdGhpcy5fY29uZmlnLmdldFNjaGVtYSh0aGlzLmZvcm1hdEtleVBhdGgoa2V5UGF0aCkpO1xyXG4gIH1cclxuXHJcbiAgLypcclxuICAgKiBTaW1pbGFyIHRvIGBhdG9tLmNvbmZpZy5vYnNlcnZlYCBleGNlcHQgYXJndW1lbnRzIGFyZSByZXF1aXJlZCwgYW5kIG9wdGlvbnMgY2Fubm90IGJlIGdpdmVuLlxyXG4gICAqXHJcbiAgICogVG8gb2JzZXJ2ZSBjaGFuZ2VzIG9uIHRoZSBlbnRpcmUgY29uZmlnLCB1c2UgYGF0b20uY29uZmlnLm9ic2VydmVgLlxyXG4gICAqL1xyXG4gIG9ic2VydmUoXHJcbiAgICBrZXlQYXRoOiBzdHJpbmcsXHJcbiAgICBvcHRpb25zT3JDYWxsYmFjaz86XHJcbiAgICAgIHwge3Njb3BlPzogYXRvbSRTY29wZURlc2NyaXB0b3JMaWtlfVxyXG4gICAgICB8ICgodmFsdWU6IGFueSkgPT4gbWl4ZWQpLFxyXG4gICAgY2FsbGJhY2s/OiAodmFsdWU6IGFueSkgPT4gbWl4ZWQsXHJcbiAgKTogSURpc3Bvc2FibGUge1xyXG4gICAgcmV0dXJuIHRoaXMuX2NvbmZpZy5vYnNlcnZlKFxyXG4gICAgICB0aGlzLmZvcm1hdEtleVBhdGgoa2V5UGF0aCksXHJcbiAgICAgIC4uLkFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSksXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLypcclxuICAgKiBCZWhhdmVzIHNpbWlsYXJseSB0byB0aGUgYG9ic2VydmVgIGZ1bmN0aW9uLCBidXQgcmV0dXJucyBhIHN0cmVhbSBvZiB2YWx1ZXMsIHJhdGhlclxyXG4gICAqIHRoYW4gcmVjZWl2aW5nIGEgY2FsbGJhY2suXHJcbiAgICovXHJcbiAgb2JzZXJ2ZUFzU3RyZWFtKFxyXG4gICAga2V5UGF0aDogc3RyaW5nLFxyXG4gICAgb3B0aW9ucz86IHtzY29wZT86IGF0b20kU2NvcGVEZXNjcmlwdG9yTGlrZX0gPSB7fSxcclxuICApOiBPYnNlcnZhYmxlPG1peGVkPiB7XHJcbiAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUob2JzZXJ2ZXIgPT4ge1xyXG4gICAgICBjb25zdCBkaXNwb3NhYmxlID0gdGhpcy5vYnNlcnZlKFxyXG4gICAgICAgIGtleVBhdGgsXHJcbiAgICAgICAgb3B0aW9ucyxcclxuICAgICAgICBvYnNlcnZlci5uZXh0LmJpbmQob2JzZXJ2ZXIpLFxyXG4gICAgICApO1xyXG4gICAgICByZXR1cm4gZGlzcG9zYWJsZS5kaXNwb3NlLmJpbmQoZGlzcG9zYWJsZSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qXHJcbiAgICogVGFrZXMgYW5kIHJldHVybnMgdGhlIHNhbWUgdHlwZXMgYXMgYGF0b20uY29uZmlnLm9uRGlkQ2hhbmdlYCBleGNlcHQgYGtleVBhdGhgIGlzIG5vdCBvcHRpb25hbC5cclxuICAgKiBUbyBsaXN0ZW4gdG8gY2hhbmdlcyBvbiBhbGwga2V5IHBhdGhzLCB1c2UgYGF0b20uY29uZmlnLm9uRGlkQ2hhbmdlYC5cclxuICAgKi9cclxuICBvbkRpZENoYW5nZShcclxuICAgIGtleVBhdGg6IHN0cmluZyxcclxuICAgIG9wdGlvbnNPckNhbGxiYWNrPzpcclxuICAgICAgfCB7c2NvcGU/OiBhdG9tJFNjb3BlRGVzY3JpcHRvckxpa2V9XHJcbiAgICAgIHwgKChldmVudDoge29sZFZhbHVlOiBtaXhlZCwgbmV3VmFsdWU6IG1peGVkfSkgPT4gbWl4ZWQpLFxyXG4gICAgY2FsbGJhY2s/OiAoZXZlbnQ6IHtvbGRWYWx1ZTogbWl4ZWQsIG5ld1ZhbHVlOiBtaXhlZH0pID0+IG1peGVkLFxyXG4gICk6IElEaXNwb3NhYmxlIHtcclxuICAgIHJldHVybiB0aGlzLl9jb25maWcub25EaWRDaGFuZ2UoXHJcbiAgICAgIHRoaXMuZm9ybWF0S2V5UGF0aChrZXlQYXRoKSxcclxuICAgICAgLi4uQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSxcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKlxyXG4gICAqIFNldHMgdGhlIHZhbHVlIG9mIGEgc2V0dGluZyBmb3IgYSBOdWNsaWRlIGZlYXR1cmUga2V5LiBUYWtlcyBhbmQgcmV0dXJucyB0aGUgc2FtZSB0eXBlcyBhc1xyXG4gICAqIGBhdG9tLmNvbmZpZy5zZXRgLlxyXG4gICAqL1xyXG4gIHNldChcclxuICAgIGtleVBhdGg6IHN0cmluZyxcclxuICAgIHZhbHVlOiA/bWl4ZWQsXHJcbiAgICBvcHRpb25zPzoge1xyXG4gICAgICBzY29wZVNlbGVjdG9yPzogc3RyaW5nLFxyXG4gICAgICBzb3VyY2U/OiBzdHJpbmcsXHJcbiAgICB9LFxyXG4gICk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHRoaXMuX2NvbmZpZy5zZXQoXHJcbiAgICAgIHRoaXMuZm9ybWF0S2V5UGF0aChrZXlQYXRoKSxcclxuICAgICAgLi4uQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSxcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKlxyXG4gICAqIFNldHMgdGhlIHNjaGVtYSBvZiBhIHNldHRpbmcgZm9yIGEgTnVjbGlkZSBmZWF0dXJlIGtleS4gVGFrZXMgYW5kIHJldHVybnMgdGhlIHNhbWUgdHlwZXMgYXNcclxuICAgKiBgYXRvbS5jb25maWcuc2V0U2NoZW1hYC5cclxuICAgKi9cclxuICBzZXRTY2hlbWEoa2V5UGF0aDogc3RyaW5nLCBzY2hlbWE6IE9iamVjdCk6IHZvaWQge1xyXG4gICAgcmV0dXJuIHRoaXMuX2NvbmZpZy5zZXRTY2hlbWEoXHJcbiAgICAgIHRoaXMuZm9ybWF0S2V5UGF0aChrZXlQYXRoKSxcclxuICAgICAgLi4uQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSxcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKlxyXG4gICAqIFJlc3RvcmVzIGEgc2V0dGluZyBmb3IgYSBOdWNsaWRlIGZlYXR1cmUga2V5IHRvIGl0cyBkZWZhdWx0IHZhbHVlLiBUYWtlcyBhbmQgcmV0dXJucyB0aGUgc2FtZVxyXG4gICAqIHR5cGVzIGFzIGBhdG9tLmNvbmZpZy5zZXRgLlxyXG4gICAqL1xyXG4gIHVuc2V0KFxyXG4gICAga2V5UGF0aDogc3RyaW5nLFxyXG4gICAgb3B0aW9ucz86IHtcclxuICAgICAgc2NvcGVTZWxlY3Rvcj86IHN0cmluZyxcclxuICAgICAgc291cmNlPzogc3RyaW5nLFxyXG4gICAgfSxcclxuICApOiB2b2lkIHtcclxuICAgIHJldHVybiB0aGlzLl9jb25maWcudW5zZXQoXHJcbiAgICAgIHRoaXMuZm9ybWF0S2V5UGF0aChrZXlQYXRoKSxcclxuICAgICAgLi4uQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSxcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgZmVhdHVyZSB3aXRoIHRoZSBnaXZlbiBuYW1lIGlzIGRpc2FibGVkIGVpdGhlciBkaXJlY3RseSBvciBiZWNhdXNlIHRoZVxyXG4gICAqIGNvbnRhaW5lciBwYWNrYWdlIGl0c2VsZiBpcyBkaXNhYmxlZC5cclxuICAgKi9cclxuICBpc0ZlYXR1cmVEaXNhYmxlZChuYW1lOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgIGlmICh0aGlzLl9wYWNrYWdlTmFtZSA9PSBudWxsKSB7XHJcbiAgICAgIHJldHVybiBhdG9tLnBhY2thZ2VzLmlzUGFja2FnZURpc2FibGVkKG5hbWUpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIChcclxuICAgICAgYXRvbS5wYWNrYWdlcy5pc1BhY2thZ2VEaXNhYmxlZCh0aGlzLl9wYWNrYWdlTmFtZSkgfHxcclxuICAgICAgLy8gJEZsb3dGaXhNZSBmbG93IGRvZXNuJ3QgcmVnaXN0ZXIgdGhpcy5fcGFja2FnZU5hbWUgYXMgbm9uLW51bGwgaGVyZVxyXG4gICAgICAhdGhpcy5fY29uZmlnLmdldChgJHt0aGlzLl9wYWNrYWdlTmFtZX0udXNlLiR7bmFtZX1gKVxyXG4gICAgKTtcclxuICB9XHJcbn1cclxuIl19