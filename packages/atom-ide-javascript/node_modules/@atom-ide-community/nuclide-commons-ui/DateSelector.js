"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.DateSelector = void 0;

var _classnames = _interopRequireDefault(require("classnames"));

var _rxjsCompatUmdMin = require("rxjs-compat/bundles/rxjs-compat.umd.min.js");

var _UniversalDisposable = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/UniversalDisposable"));

var React = _interopRequireWildcard(require("react"));

var _dateRangePicker = require("tiny-date-picker/dist/date-range-picker");

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */

/* global Node */
class DateSelector extends React.Component {
  constructor(props) {
    super(props);
    this._refEl = void 0;
    this._datePicker = void 0;
    this._disposable = void 0;

    this._openDatePicker = () => {
      this.setState({
        isOpen: true
      });
    };

    this._closeDatePicker = () => {
      this.setState({
        isOpen: false
      });
      this._datePicker = null;
    };

    this._handleWindowClick = e => {
      if (!(e.target instanceof Node)) {
        return;
      }

      if (this._refEl.current && !this._refEl.current.contains(e.target)) {
        this._closeDatePicker();
      }
    };

    this._handleLostFocus = e => {
      if (!Boolean(this.props.showOnlyOnFocus)) {
        return;
      }

      const {
        target,
        relatedTarget
      } = e;

      if (!(target instanceof Node && (relatedTarget instanceof Node || relatedTarget == null))) {
        return;
      }

      if (this._refEl.current && !this._refEl.current.contains(target) && !this._refEl.current.contains(relatedTarget)) {
        this._closeDatePicker();
      }
    };

    this._checkDatesAreEqual = (date1, date2) => {
      const time1 = date1 ? date1.getTime() : null;
      const time2 = date2 ? date2.getTime() : null;
      return time1 === time2;
    };

    this._createDatePicker = hilightedDate => {
      if (!this._refEl.current) {
        return;
      }

      let {
        start,
        end
      } = this.props;
      const {
        earliestDate,
        latestDate
      } = this.props; // DateRangePicker can never have end without start

      if (start == null) {
        start = end;
        end = null;
      }

      this._datePicker = (0, _dateRangePicker.DateRangePicker)(this._refEl.current, {
        startOpts: {
          hilightedDate: hilightedDate || start || new Date(),
          min: earliestDate,
          max: latestDate,
          shouldFocusOnRender: false,
          dayOffset: 1
        }
      }).on('statechange', (_, dp) => {
        const newStart = dp.state.start;
        const newEnd = dp.state.end;

        if (!Boolean(this.props.selectRange)) {
          if (!this._checkDatesAreEqual(newStart, newEnd)) {
            dp.setState({
              start: newStart,
              end: newStart
            });
            return;
          }
        } // Call onDatesChange if new date was selected


        const prevEnd = Boolean(this.props.selectRange) ? this.props.end : this.props.start;

        if (!this._checkDatesAreEqual(this.props.start, newStart) || Boolean(this.props.selectRange) && !this._checkDatesAreEqual(this.props.end, newEnd)) {
          if (newEnd < newStart) {
            this.props.onDatesChange(newEnd, newStart);
          } else {
            this.props.onDatesChange(newStart, newEnd);
          }
        }

        if (Boolean(this.props.showOnlyOnFocus) && newEnd != null && !this._checkDatesAreEqual(newEnd, prevEnd)) {
          this._closeDatePicker();
        }
      });

      this._datePicker.setState({
        start,
        end
      });
    };

    this.state = {
      isOpen: Boolean(props.defaultOpen) || !props.showOnlyOnFocus
    };
    this._refEl = /*#__PURE__*/React.createRef();
  }

  componentDidMount() {
    if (Boolean(this.props.showOnlyOnFocus)) {
      this._disposable = new _UniversalDisposable.default(_rxjsCompatUmdMin.Observable.fromEvent(window, 'mousedown').subscribe(this._handleWindowClick));
    }

    this._createDatePicker();
  }

  componentDidUpdate(prevProps, prevState) {
    if (!this.state.isOpen) {
      return;
    }

    const {
      start,
      end
    } = this.props;

    if (!this._checkDatesAreEqual(start, prevProps.start)) {
      this._createDatePicker(start);
    } else if (!this._checkDatesAreEqual(end, prevProps.end)) {
      this._createDatePicker(end);
    } else if (!this._datePicker) {
      this._createDatePicker();
    }
  }

  componentWillUnmount() {
    if (this._disposable) {
      this._disposable.dispose();
    }
  }

  render() {
    const classname = (0, _classnames.default)(this.props.className, 'nuclide-ui-date-selector', {
      'nuclide-ui-dropdown-date-selector': this.props.showOnlyOnFocus
    });
    return /*#__PURE__*/React.createElement("div", {
      onFocus: this._openDatePicker,
      onBlur: this._handleLostFocus
    }, this.props.children, this.state.isOpen ? /*#__PURE__*/React.createElement("div", {
      className: classname,
      ref: this._refEl
    }) : null);
  }

}

exports.DateSelector = DateSelector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1jb21tb25zLXVpL0RhdGVTZWxlY3Rvci5qcyJdLCJuYW1lcyI6WyJEYXRlU2VsZWN0b3IiLCJSZWFjdCIsIkNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJfcmVmRWwiLCJfZGF0ZVBpY2tlciIsIl9kaXNwb3NhYmxlIiwiX29wZW5EYXRlUGlja2VyIiwic2V0U3RhdGUiLCJpc09wZW4iLCJfY2xvc2VEYXRlUGlja2VyIiwiX2hhbmRsZVdpbmRvd0NsaWNrIiwiZSIsInRhcmdldCIsIk5vZGUiLCJjdXJyZW50IiwiY29udGFpbnMiLCJfaGFuZGxlTG9zdEZvY3VzIiwiQm9vbGVhbiIsInNob3dPbmx5T25Gb2N1cyIsInJlbGF0ZWRUYXJnZXQiLCJfY2hlY2tEYXRlc0FyZUVxdWFsIiwiZGF0ZTEiLCJkYXRlMiIsInRpbWUxIiwiZ2V0VGltZSIsInRpbWUyIiwiX2NyZWF0ZURhdGVQaWNrZXIiLCJoaWxpZ2h0ZWREYXRlIiwic3RhcnQiLCJlbmQiLCJlYXJsaWVzdERhdGUiLCJsYXRlc3REYXRlIiwic3RhcnRPcHRzIiwiRGF0ZSIsIm1pbiIsIm1heCIsInNob3VsZEZvY3VzT25SZW5kZXIiLCJkYXlPZmZzZXQiLCJvbiIsIl8iLCJkcCIsIm5ld1N0YXJ0Iiwic3RhdGUiLCJuZXdFbmQiLCJzZWxlY3RSYW5nZSIsInByZXZFbmQiLCJvbkRhdGVzQ2hhbmdlIiwiZGVmYXVsdE9wZW4iLCJjcmVhdGVSZWYiLCJjb21wb25lbnREaWRNb3VudCIsIlVuaXZlcnNhbERpc3Bvc2FibGUiLCJPYnNlcnZhYmxlIiwiZnJvbUV2ZW50Iiwid2luZG93Iiwic3Vic2NyaWJlIiwiY29tcG9uZW50RGlkVXBkYXRlIiwicHJldlByb3BzIiwicHJldlN0YXRlIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJkaXNwb3NlIiwicmVuZGVyIiwiY2xhc3NuYW1lIiwiY2xhc3NOYW1lIiwiY2hpbGRyZW4iXSwibWFwcGluZ3MiOiI7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QURGO0FBUUQ7O0FBbks2RCIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTctcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cclxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuICpcclxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgQlNELXN0eWxlIGxpY2Vuc2UgZm91bmQgaW4gdGhlXHJcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4gQW4gYWRkaXRpb25hbCBncmFudFxyXG4gKiBvZiBwYXRlbnQgcmlnaHRzIGNhbiBiZSBmb3VuZCBpbiB0aGUgUEFURU5UUyBmaWxlIGluIHRoZSBzYW1lIGRpcmVjdG9yeS5cclxuICpcclxuICogQGZsb3dcclxuICogQGZvcm1hdFxyXG4gKi9cclxuXHJcbi8qIGdsb2JhbCBOb2RlICovXHJcblxyXG5pbXBvcnQgY2xhc3NuYW1lcyBmcm9tICdjbGFzc25hbWVzJztcclxuaW1wb3J0IHtPYnNlcnZhYmxlfSBmcm9tICdyeGpzLWNvbXBhdC9idW5kbGVzL3J4anMtY29tcGF0LnVtZC5taW4uanMnO1xyXG5pbXBvcnQgVW5pdmVyc2FsRGlzcG9zYWJsZSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy9Vbml2ZXJzYWxEaXNwb3NhYmxlJztcclxuaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnO1xyXG5pbXBvcnQge0RhdGVSYW5nZVBpY2tlcn0gZnJvbSAndGlueS1kYXRlLXBpY2tlci9kaXN0L2RhdGUtcmFuZ2UtcGlja2VyJztcclxuXHJcbnR5cGUgUHJvcHMgPSB7fFxyXG4gIC8vIFNlbGVjdGVkIHN0YXJ0IGRhdGVcclxuICBzdGFydDogP0RhdGUsXHJcbiAgLy8gU2VsZWN0ZWQgZW5kIGRhdGUsIGlnbm9yZWQgaWYgc2VsZWN0UmFuZ2UgaXMgZmFsc2VcclxuICBlbmQ/OiA/RGF0ZSxcclxuICAvLyBFYXJsaWVzdCBkYXRlIHRoYXQgY2FuIGJlIHNlbGVjdGVkXHJcbiAgZWFybGllc3REYXRlPzogRGF0ZSxcclxuICAvLyBMYXRlc3QgZGF0ZSB0aGF0IGNhbiBiZSBzZWxlY3RlZFxyXG4gIGxhdGVzdERhdGU/OiBEYXRlLFxyXG4gIC8vIE9ubHkgZGlzcGxheSBjYWxlbmRhciB3aGVuIGluIGZvY3VzXHJcbiAgc2hvd09ubHlPbkZvY3VzPzogYm9vbGVhbixcclxuICBkZWZhdWx0T3Blbj86IGJvb2xlYW4sXHJcbiAgLy8gQWxsb3cgdXNlciB0byBzZWxlY3QgYSByYW5nZSBvZiBkYXRlc1xyXG4gIHNlbGVjdFJhbmdlPzogYm9vbGVhbixcclxuICBvbkRhdGVzQ2hhbmdlOiAoc3RhcnQ6ID9EYXRlLCBlbmQ6ID9EYXRlKSA9PiB2b2lkLFxyXG4gIGNoaWxkcmVuPzogUmVhY3QuTm9kZSxcclxuICBjbGFzc05hbWU/OiBzdHJpbmcsXHJcbnx9O1xyXG5cclxudHlwZSBTdGF0ZSA9IHt8XHJcbiAgaXNPcGVuOiBib29sZWFuLFxyXG58fTtcclxuXHJcbmV4cG9ydCBjbGFzcyBEYXRlU2VsZWN0b3IgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8UHJvcHMsIFN0YXRlPiB7XHJcbiAgX3JlZkVsOiBSZWFjdC5FbGVtZW50UmVmPGFueT47XHJcbiAgX2RhdGVQaWNrZXI6IGFueTtcclxuICBfZGlzcG9zYWJsZTogP0lEaXNwb3NhYmxlO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcm9wczogUHJvcHMpIHtcclxuICAgIHN1cGVyKHByb3BzKTtcclxuICAgIHRoaXMuc3RhdGUgPSB7aXNPcGVuOiBCb29sZWFuKHByb3BzLmRlZmF1bHRPcGVuKSB8fCAhcHJvcHMuc2hvd09ubHlPbkZvY3VzfTtcclxuICAgIHRoaXMuX3JlZkVsID0gUmVhY3QuY3JlYXRlUmVmKCk7XHJcbiAgfVxyXG5cclxuICBjb21wb25lbnREaWRNb3VudCgpIHtcclxuICAgIGlmIChCb29sZWFuKHRoaXMucHJvcHMuc2hvd09ubHlPbkZvY3VzKSkge1xyXG4gICAgICB0aGlzLl9kaXNwb3NhYmxlID0gbmV3IFVuaXZlcnNhbERpc3Bvc2FibGUoXHJcbiAgICAgICAgT2JzZXJ2YWJsZS5mcm9tRXZlbnQod2luZG93LCAnbW91c2Vkb3duJykuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgdGhpcy5faGFuZGxlV2luZG93Q2xpY2ssXHJcbiAgICAgICAgKSxcclxuICAgICAgKTtcclxuICAgIH1cclxuICAgIHRoaXMuX2NyZWF0ZURhdGVQaWNrZXIoKTtcclxuICB9XHJcblxyXG4gIGNvbXBvbmVudERpZFVwZGF0ZShwcmV2UHJvcHM6IFByb3BzLCBwcmV2U3RhdGU6IFN0YXRlKSB7XHJcbiAgICBpZiAoIXRoaXMuc3RhdGUuaXNPcGVuKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IHtzdGFydCwgZW5kfSA9IHRoaXMucHJvcHM7XHJcbiAgICBpZiAoIXRoaXMuX2NoZWNrRGF0ZXNBcmVFcXVhbChzdGFydCwgcHJldlByb3BzLnN0YXJ0KSkge1xyXG4gICAgICB0aGlzLl9jcmVhdGVEYXRlUGlja2VyKHN0YXJ0KTtcclxuICAgIH0gZWxzZSBpZiAoIXRoaXMuX2NoZWNrRGF0ZXNBcmVFcXVhbChlbmQsIHByZXZQcm9wcy5lbmQpKSB7XHJcbiAgICAgIHRoaXMuX2NyZWF0ZURhdGVQaWNrZXIoZW5kKTtcclxuICAgIH0gZWxzZSBpZiAoIXRoaXMuX2RhdGVQaWNrZXIpIHtcclxuICAgICAgdGhpcy5fY3JlYXRlRGF0ZVBpY2tlcigpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XHJcbiAgICBpZiAodGhpcy5fZGlzcG9zYWJsZSkge1xyXG4gICAgICB0aGlzLl9kaXNwb3NhYmxlLmRpc3Bvc2UoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIF9vcGVuRGF0ZVBpY2tlciA9ICgpOiB2b2lkID0+IHtcclxuICAgIHRoaXMuc2V0U3RhdGUoe2lzT3BlbjogdHJ1ZX0pO1xyXG4gIH07XHJcblxyXG4gIF9jbG9zZURhdGVQaWNrZXIgPSAoKTogdm9pZCA9PiB7XHJcbiAgICB0aGlzLnNldFN0YXRlKHtpc09wZW46IGZhbHNlfSk7XHJcbiAgICB0aGlzLl9kYXRlUGlja2VyID0gbnVsbDtcclxuICB9O1xyXG5cclxuICBfaGFuZGxlV2luZG93Q2xpY2sgPSAoZTogU3ludGhldGljTW91c2VFdmVudDw+KTogdm9pZCA9PiB7XHJcbiAgICBpZiAoIShlLnRhcmdldCBpbnN0YW5jZW9mIE5vZGUpKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLl9yZWZFbC5jdXJyZW50ICYmICF0aGlzLl9yZWZFbC5jdXJyZW50LmNvbnRhaW5zKGUudGFyZ2V0KSkge1xyXG4gICAgICB0aGlzLl9jbG9zZURhdGVQaWNrZXIoKTtcclxuICAgIH1cclxuICB9O1xyXG5cclxuICBfaGFuZGxlTG9zdEZvY3VzID0gKGU6IFN5bnRoZXRpY0ZvY3VzRXZlbnQ8PikgPT4ge1xyXG4gICAgaWYgKCFCb29sZWFuKHRoaXMucHJvcHMuc2hvd09ubHlPbkZvY3VzKSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qge3RhcmdldCwgcmVsYXRlZFRhcmdldH0gPSBlO1xyXG4gICAgaWYgKFxyXG4gICAgICAhKFxyXG4gICAgICAgIHRhcmdldCBpbnN0YW5jZW9mIE5vZGUgJiZcclxuICAgICAgICAocmVsYXRlZFRhcmdldCBpbnN0YW5jZW9mIE5vZGUgfHwgcmVsYXRlZFRhcmdldCA9PSBudWxsKVxyXG4gICAgICApXHJcbiAgICApIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKFxyXG4gICAgICB0aGlzLl9yZWZFbC5jdXJyZW50ICYmXHJcbiAgICAgICF0aGlzLl9yZWZFbC5jdXJyZW50LmNvbnRhaW5zKHRhcmdldCkgJiZcclxuICAgICAgIXRoaXMuX3JlZkVsLmN1cnJlbnQuY29udGFpbnMocmVsYXRlZFRhcmdldClcclxuICAgICkge1xyXG4gICAgICB0aGlzLl9jbG9zZURhdGVQaWNrZXIoKTtcclxuICAgIH1cclxuICB9O1xyXG5cclxuICBfY2hlY2tEYXRlc0FyZUVxdWFsID0gKGRhdGUxOiA/RGF0ZSwgZGF0ZTI6ID9EYXRlKSA9PiB7XHJcbiAgICBjb25zdCB0aW1lMSA9IGRhdGUxID8gZGF0ZTEuZ2V0VGltZSgpIDogbnVsbDtcclxuICAgIGNvbnN0IHRpbWUyID0gZGF0ZTIgPyBkYXRlMi5nZXRUaW1lKCkgOiBudWxsO1xyXG4gICAgcmV0dXJuIHRpbWUxID09PSB0aW1lMjtcclxuICB9O1xyXG5cclxuICBfY3JlYXRlRGF0ZVBpY2tlciA9IChoaWxpZ2h0ZWREYXRlOiA/RGF0ZSk6IHZvaWQgPT4ge1xyXG4gICAgaWYgKCF0aGlzLl9yZWZFbC5jdXJyZW50KSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBsZXQge3N0YXJ0LCBlbmR9ID0gdGhpcy5wcm9wcztcclxuICAgIGNvbnN0IHtlYXJsaWVzdERhdGUsIGxhdGVzdERhdGV9ID0gdGhpcy5wcm9wcztcclxuICAgIC8vIERhdGVSYW5nZVBpY2tlciBjYW4gbmV2ZXIgaGF2ZSBlbmQgd2l0aG91dCBzdGFydFxyXG4gICAgaWYgKHN0YXJ0ID09IG51bGwpIHtcclxuICAgICAgc3RhcnQgPSBlbmQ7XHJcbiAgICAgIGVuZCA9IG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5fZGF0ZVBpY2tlciA9IERhdGVSYW5nZVBpY2tlcih0aGlzLl9yZWZFbC5jdXJyZW50LCB7XHJcbiAgICAgIHN0YXJ0T3B0czoge1xyXG4gICAgICAgIGhpbGlnaHRlZERhdGU6IGhpbGlnaHRlZERhdGUgfHwgc3RhcnQgfHwgbmV3IERhdGUoKSxcclxuICAgICAgICBtaW46IGVhcmxpZXN0RGF0ZSxcclxuICAgICAgICBtYXg6IGxhdGVzdERhdGUsXHJcbiAgICAgICAgc2hvdWxkRm9jdXNPblJlbmRlcjogZmFsc2UsXHJcbiAgICAgICAgZGF5T2Zmc2V0OiAxLFxyXG4gICAgICB9LFxyXG4gICAgfSkub24oJ3N0YXRlY2hhbmdlJywgKF8sIGRwKSA9PiB7XHJcbiAgICAgIGNvbnN0IG5ld1N0YXJ0ID0gZHAuc3RhdGUuc3RhcnQ7XHJcbiAgICAgIGNvbnN0IG5ld0VuZCA9IGRwLnN0YXRlLmVuZDtcclxuICAgICAgaWYgKCFCb29sZWFuKHRoaXMucHJvcHMuc2VsZWN0UmFuZ2UpKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLl9jaGVja0RhdGVzQXJlRXF1YWwobmV3U3RhcnQsIG5ld0VuZCkpIHtcclxuICAgICAgICAgIGRwLnNldFN0YXRlKHtzdGFydDogbmV3U3RhcnQsIGVuZDogbmV3U3RhcnR9KTtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIENhbGwgb25EYXRlc0NoYW5nZSBpZiBuZXcgZGF0ZSB3YXMgc2VsZWN0ZWRcclxuICAgICAgY29uc3QgcHJldkVuZCA9IEJvb2xlYW4odGhpcy5wcm9wcy5zZWxlY3RSYW5nZSlcclxuICAgICAgICA/IHRoaXMucHJvcHMuZW5kXHJcbiAgICAgICAgOiB0aGlzLnByb3BzLnN0YXJ0O1xyXG4gICAgICBpZiAoXHJcbiAgICAgICAgIXRoaXMuX2NoZWNrRGF0ZXNBcmVFcXVhbCh0aGlzLnByb3BzLnN0YXJ0LCBuZXdTdGFydCkgfHxcclxuICAgICAgICAoQm9vbGVhbih0aGlzLnByb3BzLnNlbGVjdFJhbmdlKSAmJlxyXG4gICAgICAgICAgIXRoaXMuX2NoZWNrRGF0ZXNBcmVFcXVhbCh0aGlzLnByb3BzLmVuZCwgbmV3RW5kKSlcclxuICAgICAgKSB7XHJcbiAgICAgICAgaWYgKG5ld0VuZCA8IG5ld1N0YXJ0KSB7XHJcbiAgICAgICAgICB0aGlzLnByb3BzLm9uRGF0ZXNDaGFuZ2UobmV3RW5kLCBuZXdTdGFydCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHRoaXMucHJvcHMub25EYXRlc0NoYW5nZShuZXdTdGFydCwgbmV3RW5kKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmIChcclxuICAgICAgICBCb29sZWFuKHRoaXMucHJvcHMuc2hvd09ubHlPbkZvY3VzKSAmJlxyXG4gICAgICAgIG5ld0VuZCAhPSBudWxsICYmXHJcbiAgICAgICAgIXRoaXMuX2NoZWNrRGF0ZXNBcmVFcXVhbChuZXdFbmQsIHByZXZFbmQpXHJcbiAgICAgICkge1xyXG4gICAgICAgIHRoaXMuX2Nsb3NlRGF0ZVBpY2tlcigpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICB0aGlzLl9kYXRlUGlja2VyLnNldFN0YXRlKHtzdGFydCwgZW5kfSk7XHJcbiAgfTtcclxuXHJcbiAgcmVuZGVyKCk6IFJlYWN0Lk5vZGUge1xyXG4gICAgY29uc3QgY2xhc3NuYW1lID0gY2xhc3NuYW1lcyhcclxuICAgICAgdGhpcy5wcm9wcy5jbGFzc05hbWUsXHJcbiAgICAgICdudWNsaWRlLXVpLWRhdGUtc2VsZWN0b3InLFxyXG4gICAgICB7J251Y2xpZGUtdWktZHJvcGRvd24tZGF0ZS1zZWxlY3Rvcic6IHRoaXMucHJvcHMuc2hvd09ubHlPbkZvY3VzfSxcclxuICAgICk7XHJcblxyXG4gICAgcmV0dXJuIChcclxuICAgICAgPGRpdiBvbkZvY3VzPXt0aGlzLl9vcGVuRGF0ZVBpY2tlcn0gb25CbHVyPXt0aGlzLl9oYW5kbGVMb3N0Rm9jdXN9PlxyXG4gICAgICAgIHt0aGlzLnByb3BzLmNoaWxkcmVufVxyXG4gICAgICAgIHt0aGlzLnN0YXRlLmlzT3BlbiA/IChcclxuICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPXtjbGFzc25hbWV9IHJlZj17dGhpcy5fcmVmRWx9IC8+XHJcbiAgICAgICAgKSA6IG51bGx9XHJcbiAgICAgIDwvZGl2PlxyXG4gICAgKTtcclxuICB9XHJcbn1cclxuIl19