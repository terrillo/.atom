"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _assert = _interopRequireDefault(require("assert"));

var _classnames = _interopRequireDefault(require("classnames"));

var _getFragmentGrammar = _interopRequireDefault(require("@atom-ide-community/nuclide-commons-atom/getFragmentGrammar"));

var _HighlightedCode = require("./HighlightedCode");

var _HighlightedText = _interopRequireDefault(require("./HighlightedText"));

var React = _interopRequireWildcard(require("react"));

var _PathWithFileIcon = _interopRequireDefault(require("./PathWithFileIcon"));

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */

/* globals getSelection, requestAnimationFrame */
// $FlowIgnore: Not an official API yet.
const ConcurrentMode = React.unstable_ConcurrentMode; // Asynchronously highlight any results with a lot of lines.

const ASYNC_LINE_LIMIT = 5; // Must match value defined in FileResults.less.

const TAB_SIZE = 8; // Return the number of leading tabs in the line.

function countLeadingTabs(line) {
  let tabsSeen = 0;

  for (let index = 0; index < line.length; index++) {
    if (line.charAt(index) === '\t') {
      tabsSeen++;
    } else {
      break;
    }
  }

  return tabsSeen;
} // Renders highlights for matches in the current line.
// Highlights are designed to be superimposed on the actual code.


function renderHighlights(line, matches) {
  const pieces = [];
  const leadingTabs = countLeadingTabs(line);
  let curChar = 0;
  matches.forEach((match, i) => {
    if (match.start.column > line.length) {
      // This occasionally happens when lines are truncated server-side. Ignore.
      return;
    }

    if (match.start.column > curChar) {
      // If we picked up any leading tabs, convert them to spaces.
      const tabDifference = Math.max(leadingTabs - curChar, 0);
      const tabExtraSpaces = (TAB_SIZE - 1) * tabDifference;
      pieces.push(' '.repeat(tabExtraSpaces + match.start.column - curChar));
    }

    const matchStart = Math.max(curChar, match.start.column); // Note that matches can overlap.

    if (matchStart < match.end.column) {
      pieces.push( /*#__PURE__*/React.createElement("span", {
        key: match.end.column,
        "data-column": match.start.column,
        className: "highlight-info"
      }, line.substring(matchStart, match.end.column)));
    }

    curChar = Math.max(curChar, match.end.column);
  });
  pieces.push('\n');
  return pieces;
}

function selectGrammar(path) {
  let bestMatch = null;
  let highestScore = -Infinity;
  atom.grammars.forEachGrammar(grammar => {
    // TODO: tree-sitter grammars are not supported yet.
    if (!('tokenizeLine' in grammar)) {
      return;
    }

    const score = atom.grammars.getGrammarScore(grammar, path, '');

    if (score > highestScore || bestMatch == null) {
      bestMatch = grammar;
      highestScore = score;
    }
  });
  (0, _assert.default)(bestMatch != null, 'no grammars found');
  return (0, _getFragmentGrammar.default)(bestMatch);
}

class FileResultsComponent extends React.Component {
  constructor(props) {
    super(props);

    this._onLineColumnClick = event => {
      const line = event.target.dataset.line;

      if (line != null) {
        this.props.onClick(this.props.fileResults.path, parseInt(line, 10));
      }
    };

    this._onCodeClick = (event, startLine, lineCount) => {
      let column = undefined;

      if (event.target instanceof HTMLElement && event.target.className === 'highlight-info') {
        // Highlights have columns attached as data-column.
        // (We could get this from the client coords as well, but it's harder.)
        column = parseInt(event.target.dataset.column, 10);
      } else {
        // Don't trigger if the user is trying to select something.
        const selection = getSelection();

        if (selection == null || selection.type === 'Range') {
          return;
        }
      }

      const {
        currentTarget,
        clientY
      } = event;

      if (!(currentTarget instanceof HTMLElement)) {
        return;
      } // Determine the line number via the relative click coordinates.


      const {
        top,
        height
      } = currentTarget.getBoundingClientRect();
      const relativeY = clientY - top;

      if (relativeY <= height) {
        const lineNumber = startLine + Math.floor(lineCount * relativeY / height);
        this.props.onClick(this.props.fileResults.path, lineNumber - 1, column);
      }
    };

    this._onToggle = () => {
      this.props.onToggle(this.props.fileResults.path);
    };

    this._onFileClick = event => {
      const {
        groups
      } = this.props.fileResults;

      if (groups.length === 0) {
        this.props.onClick(this.props.fileResults.path);
      } else {
        this.props.onClick(this.props.fileResults.path, groups[0].matches[0].start.row, groups[0].matches[0].start.column);
      }

      event.stopPropagation();
    };

    const totalLines = props.fileResults.groups.reduce((acc, group) => acc + group.lines.length, 0);
    this.state = {
      highlighted: totalLines < ASYNC_LINE_LIMIT
    };
  }

  componentDidMount() {
    if (!this.state.highlighted) {
      this._startHighlighting();
    }
  }

  _startHighlighting() {
    // TODO(pelmers): Use react deferred update API when facebook/react/issues/13306 is ready
    requestAnimationFrame(() => {
      this.setState({
        highlighted: true
      });
    });
  }

  shouldComponentUpdate(nextProps, nextState) {
    return this.props.fileResults !== nextProps.fileResults || this.props.collapsed !== nextProps.collapsed || this.state.highlighted !== nextState.highlighted;
  } // Register event callbacks on the line number / code containers.
  // We can then use the data attributes to find the line numbers.


  render() {
    const {
      fileResults
    } = this.props;
    const {
      path,
      pathMatch,
      groups
    } = fileResults;
    let displayPath = path;

    if (pathMatch != null) {
      displayPath = /*#__PURE__*/React.createElement(_HighlightedText.default, {
        text: path,
        highlightedRanges: [[pathMatch[0], pathMatch[1]]]
      });
    }

    const grammar = selectGrammar(path);
    return /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
      // Show the full path in a tooltip if it overflows.
      title: fileResults.path,
      className: "file-results-filename",
      onClick: this._onToggle
    }, /*#__PURE__*/React.createElement("span", {
      className: (0, _classnames.default)('icon', this.props.collapsed ? 'icon-chevron-right' : 'icon-chevron-down')
    }), /*#__PURE__*/React.createElement("span", {
      onClick: this._onFileClick
    }, /*#__PURE__*/React.createElement(_PathWithFileIcon.default, {
      path: fileResults.path,
      children: []
    }), displayPath)), /*#__PURE__*/React.createElement("div", null, !this.props.collapsed && groups.map((group, groupKey) => {
      const lineNumbers = [];
      const highlights = [];
      const code = group.lines.join('\n');
      let matchIndex = 0;

      for (let i = 0; i < group.lines.length; i++) {
        const lineNum = i + group.startLine; // Extract all matches that are on the current line.

        const lineMatches = [];

        while (matchIndex < group.matches.length) {
          const curMatch = group.matches[matchIndex];
          const curLine = curMatch.start.row + 1;

          if (curLine < lineNum) {
            continue;
          } else if (curLine === lineNum) {
            lineMatches.push(curMatch);
          } else {
            break;
          }

          matchIndex++;
        }

        lineNumbers.push( /*#__PURE__*/React.createElement("div", {
          key: lineNum,
          "data-line": lineNum - 1
        }, lineNum));
        highlights.push(renderHighlights(group.lines[i], lineMatches));
      }

      return /*#__PURE__*/React.createElement("div", {
        key: groupKey,
        className: "file-results-snippet"
      }, /*#__PURE__*/React.createElement("div", {
        onClick: this._onLineColumnClick,
        className: "file-results-line-numbers"
      }, lineNumbers), /*#__PURE__*/React.createElement("div", {
        onClick: evt => this._onCodeClick(evt, group.startLine, group.lines.length),
        className: "file-results-code"
      }, this.state.highlighted ? /*#__PURE__*/React.createElement(ConcurrentMode, null, /*#__PURE__*/React.createElement(_HighlightedCode.HighlightedLines, {
        grammar: grammar,
        code: code
      })) : code, /*#__PURE__*/React.createElement("div", {
        className: "file-results-highlights"
      }, highlights)));
    })));
  }

}

exports.default = FileResultsComponent;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1jb21tb25zLXVpL0ZpbGVSZXN1bHRzQ29tcG9uZW50LmpzIl0sIm5hbWVzIjpbIkNvbmN1cnJlbnRNb2RlIiwiUmVhY3QiLCJ1bnN0YWJsZV9Db25jdXJyZW50TW9kZSIsIkFTWU5DX0xJTkVfTElNSVQiLCJUQUJfU0laRSIsImNvdW50TGVhZGluZ1RhYnMiLCJsaW5lIiwidGFic1NlZW4iLCJpbmRleCIsImxlbmd0aCIsImNoYXJBdCIsInJlbmRlckhpZ2hsaWdodHMiLCJtYXRjaGVzIiwicGllY2VzIiwibGVhZGluZ1RhYnMiLCJjdXJDaGFyIiwiZm9yRWFjaCIsIm1hdGNoIiwiaSIsInN0YXJ0IiwiY29sdW1uIiwidGFiRGlmZmVyZW5jZSIsIk1hdGgiLCJtYXgiLCJ0YWJFeHRyYVNwYWNlcyIsInB1c2giLCJyZXBlYXQiLCJtYXRjaFN0YXJ0IiwiZW5kIiwic3Vic3RyaW5nIiwic2VsZWN0R3JhbW1hciIsInBhdGgiLCJiZXN0TWF0Y2giLCJoaWdoZXN0U2NvcmUiLCJJbmZpbml0eSIsImF0b20iLCJncmFtbWFycyIsImZvckVhY2hHcmFtbWFyIiwiZ3JhbW1hciIsInNjb3JlIiwiZ2V0R3JhbW1hclNjb3JlIiwiRmlsZVJlc3VsdHNDb21wb25lbnQiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwiX29uTGluZUNvbHVtbkNsaWNrIiwiZXZlbnQiLCJ0YXJnZXQiLCJkYXRhc2V0Iiwib25DbGljayIsImZpbGVSZXN1bHRzIiwicGFyc2VJbnQiLCJfb25Db2RlQ2xpY2siLCJzdGFydExpbmUiLCJsaW5lQ291bnQiLCJ1bmRlZmluZWQiLCJIVE1MRWxlbWVudCIsImNsYXNzTmFtZSIsInNlbGVjdGlvbiIsImdldFNlbGVjdGlvbiIsInR5cGUiLCJjdXJyZW50VGFyZ2V0IiwiY2xpZW50WSIsInRvcCIsImhlaWdodCIsImdldEJvdW5kaW5nQ2xpZW50UmVjdCIsInJlbGF0aXZlWSIsImxpbmVOdW1iZXIiLCJmbG9vciIsIl9vblRvZ2dsZSIsIm9uVG9nZ2xlIiwiX29uRmlsZUNsaWNrIiwiZ3JvdXBzIiwicm93Iiwic3RvcFByb3BhZ2F0aW9uIiwidG90YWxMaW5lcyIsInJlZHVjZSIsImFjYyIsImdyb3VwIiwibGluZXMiLCJzdGF0ZSIsImhpZ2hsaWdodGVkIiwiY29tcG9uZW50RGlkTW91bnQiLCJfc3RhcnRIaWdobGlnaHRpbmciLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJzZXRTdGF0ZSIsInNob3VsZENvbXBvbmVudFVwZGF0ZSIsIm5leHRQcm9wcyIsIm5leHRTdGF0ZSIsImNvbGxhcHNlZCIsInJlbmRlciIsInBhdGhNYXRjaCIsImRpc3BsYXlQYXRoIiwibWFwIiwiZ3JvdXBLZXkiLCJsaW5lTnVtYmVycyIsImhpZ2hsaWdodHMiLCJjb2RlIiwiam9pbiIsIm1hdGNoSW5kZXgiLCJsaW5lTnVtIiwibGluZU1hdGNoZXMiLCJjdXJNYXRjaCIsImN1ckxpbmUiLCJldnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFnQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7O0FBdEJBOzs7Ozs7Ozs7Ozs7QUFZQTtBQVlBO0FBQ0EsTUFBTUEsY0FBYyxHQUFHQyxLQUFLLENBQUNDLHVCQUE3QixDLENBRUE7O0FBQ0EsTUFBTUMsZ0JBQWdCLEdBQUcsQ0FBekIsQyxDQUVBOztBQUNBLE1BQU1DLFFBQVEsR0FBRyxDQUFqQixDLENBRUE7O0FBQ0EsU0FBU0MsZ0JBQVQsQ0FBMEJDLElBQTFCLEVBQWdEO0FBQzlDLE1BQUlDLFFBQVEsR0FBRyxDQUFmOztBQUNBLE9BQUssSUFBSUMsS0FBSyxHQUFHLENBQWpCLEVBQW9CQSxLQUFLLEdBQUdGLElBQUksQ0FBQ0csTUFBakMsRUFBeUNELEtBQUssRUFBOUMsRUFBa0Q7QUFDaEQsUUFBSUYsSUFBSSxDQUFDSSxNQUFMLENBQVlGLEtBQVosTUFBdUIsSUFBM0IsRUFBaUM7QUFDL0JELE1BQUFBLFFBQVE7QUFDVCxLQUZELE1B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RlosU0FHR2tELFdBSEgsQ0FERixlQU1FO0FBQ0UsUUFBQSxPQUFPLEVBQUVTLEdBQUcsSUFDVixLQUFLcEQsWUFBTCxDQUNFb0QsR0FERixFQUVFMUIsS0FBSyxDQUFDekIsU0FGUixFQUdFeUIsS0FBSyxDQUFDQyxLQUFOLENBQVl0RSxNQUhkLENBRko7QUFRRSxRQUFBLFNBQVMsRUFBQztBQVJaLFNBU0csS0FBS3VFLEtBQUwsQ0FBV0MsV0FBWCxnQkFDQyxvQkFBQyxjQUFELHFCQUNFLG9CQUFDLGlDQUFEO0FBQWtCLFFBQUEsT0FBTyxFQUFFM0MsT0FBM0I7QUFBb0MsUUFBQSxJQUFJLEVBQUUyRDtBQUExQyxRQURGLENBREQsR0FLQ0EsSUFkSixlQWdCRTtBQUFLLFFBQUEsU0FBUyxFQUFDO0FBQWYsU0FBMENELFVBQTFDLENBaEJGLENBTkYsQ0FERjtBQTJCRCxLQXZERCxDQUZKLENBakJGLENBREY7QUErRUQ7O0FBdExEIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIENvcHlyaWdodCAoYykgMjAxNy1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxyXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4gKlxyXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBCU0Qtc3R5bGUgbGljZW5zZSBmb3VuZCBpbiB0aGVcclxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLiBBbiBhZGRpdGlvbmFsIGdyYW50XHJcbiAqIG9mIHBhdGVudCByaWdodHMgY2FuIGJlIGZvdW5kIGluIHRoZSBQQVRFTlRTIGZpbGUgaW4gdGhlIHNhbWUgZGlyZWN0b3J5LlxyXG4gKlxyXG4gKiBAZmxvd1xyXG4gKiBAZm9ybWF0XHJcbiAqL1xyXG5cclxuLyogZ2xvYmFscyBnZXRTZWxlY3Rpb24sIHJlcXVlc3RBbmltYXRpb25GcmFtZSAqL1xyXG5cclxuaW1wb3J0IHR5cGUge0ZpbGVSZXN1bHRzfSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy9GaWxlUmVzdWx0cyc7XHJcblxyXG5pbXBvcnQgaW52YXJpYW50IGZyb20gJ2Fzc2VydCc7XHJcbmltcG9ydCBjbGFzc25hbWVzIGZyb20gJ2NsYXNzbmFtZXMnO1xyXG5pbXBvcnQgZ2V0RnJhZ21lbnRHcmFtbWFyIGZyb20gJ0BhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1jb21tb25zLWF0b20vZ2V0RnJhZ21lbnRHcmFtbWFyJztcclxuaW1wb3J0IHtIaWdobGlnaHRlZExpbmVzfSBmcm9tICcuL0hpZ2hsaWdodGVkQ29kZSc7XHJcbmltcG9ydCBIaWdobGlnaHRlZFRleHQgZnJvbSAnLi9IaWdobGlnaHRlZFRleHQnO1xyXG5pbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XHJcbmltcG9ydCBQYXRoV2l0aEZpbGVJY29uIGZyb20gJy4vUGF0aFdpdGhGaWxlSWNvbic7XHJcblxyXG4vLyAkRmxvd0lnbm9yZTogTm90IGFuIG9mZmljaWFsIEFQSSB5ZXQuXHJcbmNvbnN0IENvbmN1cnJlbnRNb2RlID0gUmVhY3QudW5zdGFibGVfQ29uY3VycmVudE1vZGU7XHJcblxyXG4vLyBBc3luY2hyb25vdXNseSBoaWdobGlnaHQgYW55IHJlc3VsdHMgd2l0aCBhIGxvdCBvZiBsaW5lcy5cclxuY29uc3QgQVNZTkNfTElORV9MSU1JVCA9IDU7XHJcblxyXG4vLyBNdXN0IG1hdGNoIHZhbHVlIGRlZmluZWQgaW4gRmlsZVJlc3VsdHMubGVzcy5cclxuY29uc3QgVEFCX1NJWkUgPSA4O1xyXG5cclxuLy8gUmV0dXJuIHRoZSBudW1iZXIgb2YgbGVhZGluZyB0YWJzIGluIHRoZSBsaW5lLlxyXG5mdW5jdGlvbiBjb3VudExlYWRpbmdUYWJzKGxpbmU6IHN0cmluZyk6IG51bWJlciB7XHJcbiAgbGV0IHRhYnNTZWVuID0gMDtcclxuICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgbGluZS5sZW5ndGg7IGluZGV4KyspIHtcclxuICAgIGlmIChsaW5lLmNoYXJBdChpbmRleCkgPT09ICdcXHQnKSB7XHJcbiAgICAgIHRhYnNTZWVuKys7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBicmVhaztcclxuICAgIH1cclxuICB9XHJcbiAgcmV0dXJuIHRhYnNTZWVuO1xyXG59XHJcblxyXG4vLyBSZW5kZXJzIGhpZ2hsaWdodHMgZm9yIG1hdGNoZXMgaW4gdGhlIGN1cnJlbnQgbGluZS5cclxuLy8gSGlnaGxpZ2h0cyBhcmUgZGVzaWduZWQgdG8gYmUgc3VwZXJpbXBvc2VkIG9uIHRoZSBhY3R1YWwgY29kZS5cclxuZnVuY3Rpb24gcmVuZGVySGlnaGxpZ2h0cyhcclxuICBsaW5lOiBzdHJpbmcsXHJcbiAgbWF0Y2hlczogQXJyYXk8YXRvbSRSYW5nZT4sXHJcbik6IEFycmF5PHN0cmluZyB8IFJlYWN0LkVsZW1lbnQ8YW55Pj4ge1xyXG4gIGNvbnN0IHBpZWNlcyA9IFtdO1xyXG4gIGNvbnN0IGxlYWRpbmdUYWJzID0gY291bnRMZWFkaW5nVGFicyhsaW5lKTtcclxuICBsZXQgY3VyQ2hhciA9IDA7XHJcbiAgbWF0Y2hlcy5mb3JFYWNoKChtYXRjaCwgaSkgPT4ge1xyXG4gICAgaWYgKG1hdGNoLnN0YXJ0LmNvbHVtbiA+IGxpbmUubGVuZ3RoKSB7XHJcbiAgICAgIC8vIFRoaXMgb2NjYXNpb25hbGx5IGhhcHBlbnMgd2hlbiBsaW5lcyBhcmUgdHJ1bmNhdGVkIHNlcnZlci1zaWRlLiBJZ25vcmUuXHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmIChtYXRjaC5zdGFydC5jb2x1bW4gPiBjdXJDaGFyKSB7XHJcbiAgICAgIC8vIElmIHdlIHBpY2tlZCB1cCBhbnkgbGVhZGluZyB0YWJzLCBjb252ZXJ0IHRoZW0gdG8gc3BhY2VzLlxyXG4gICAgICBjb25zdCB0YWJEaWZmZXJlbmNlID0gTWF0aC5tYXgobGVhZGluZ1RhYnMgLSBjdXJDaGFyLCAwKTtcclxuICAgICAgY29uc3QgdGFiRXh0cmFTcGFjZXMgPSAoVEFCX1NJWkUgLSAxKSAqIHRhYkRpZmZlcmVuY2U7XHJcbiAgICAgIHBpZWNlcy5wdXNoKCcgJy5yZXBlYXQodGFiRXh0cmFTcGFjZXMgKyBtYXRjaC5zdGFydC5jb2x1bW4gLSBjdXJDaGFyKSk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBtYXRjaFN0YXJ0ID0gTWF0aC5tYXgoY3VyQ2hhciwgbWF0Y2guc3RhcnQuY29sdW1uKTtcclxuICAgIC8vIE5vdGUgdGhhdCBtYXRjaGVzIGNhbiBvdmVybGFwLlxyXG4gICAgaWYgKG1hdGNoU3RhcnQgPCBtYXRjaC5lbmQuY29sdW1uKSB7XHJcbiAgICAgIHBpZWNlcy5wdXNoKFxyXG4gICAgICAgIDxzcGFuXHJcbiAgICAgICAgICBrZXk9e21hdGNoLmVuZC5jb2x1bW59XHJcbiAgICAgICAgICBkYXRhLWNvbHVtbj17bWF0Y2guc3RhcnQuY29sdW1ufVxyXG4gICAgICAgICAgY2xhc3NOYW1lPVwiaGlnaGxpZ2h0LWluZm9cIj5cclxuICAgICAgICAgIHtsaW5lLnN1YnN0cmluZyhtYXRjaFN0YXJ0LCBtYXRjaC5lbmQuY29sdW1uKX1cclxuICAgICAgICA8L3NwYW4+LFxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gICAgY3VyQ2hhciA9IE1hdGgubWF4KGN1ckNoYXIsIG1hdGNoLmVuZC5jb2x1bW4pO1xyXG4gIH0pO1xyXG4gIHBpZWNlcy5wdXNoKCdcXG4nKTtcclxuICByZXR1cm4gcGllY2VzO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzZWxlY3RHcmFtbWFyKHBhdGg6IHN0cmluZyk6IGF0b20kR3JhbW1hciB7XHJcbiAgbGV0IGJlc3RNYXRjaCA9IG51bGw7XHJcbiAgbGV0IGhpZ2hlc3RTY29yZSA9IC1JbmZpbml0eTtcclxuICBhdG9tLmdyYW1tYXJzLmZvckVhY2hHcmFtbWFyKGdyYW1tYXIgPT4ge1xyXG4gICAgLy8gVE9ETzogdHJlZS1zaXR0ZXIgZ3JhbW1hcnMgYXJlIG5vdCBzdXBwb3J0ZWQgeWV0LlxyXG4gICAgaWYgKCEoJ3Rva2VuaXplTGluZScgaW4gZ3JhbW1hcikpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3Qgc2NvcmUgPSBhdG9tLmdyYW1tYXJzLmdldEdyYW1tYXJTY29yZShncmFtbWFyLCBwYXRoLCAnJyk7XHJcbiAgICBpZiAoc2NvcmUgPiBoaWdoZXN0U2NvcmUgfHwgYmVzdE1hdGNoID09IG51bGwpIHtcclxuICAgICAgYmVzdE1hdGNoID0gZ3JhbW1hcjtcclxuICAgICAgaGlnaGVzdFNjb3JlID0gc2NvcmU7XHJcbiAgICB9XHJcbiAgfSk7XHJcbiAgaW52YXJpYW50KGJlc3RNYXRjaCAhPSBudWxsLCAnbm8gZ3JhbW1hcnMgZm91bmQnKTtcclxuICByZXR1cm4gZ2V0RnJhZ21lbnRHcmFtbWFyKGJlc3RNYXRjaCk7XHJcbn1cclxuXHJcbnR5cGUgUHJvcHMgPSB7XHJcbiAgZmlsZVJlc3VsdHM6IEZpbGVSZXN1bHRzLFxyXG4gIGNvbGxhcHNlZDogYm9vbGVhbixcclxuICBvbkNsaWNrOiAocGF0aDogc3RyaW5nLCBsaW5lPzogbnVtYmVyLCBjb2x1bW4/OiBudW1iZXIpID0+IG1peGVkLFxyXG4gIG9uVG9nZ2xlOiAocGF0aDogc3RyaW5nKSA9PiBtaXhlZCxcclxufTtcclxuXHJcbnR5cGUgU3RhdGUgPSB7XHJcbiAgaGlnaGxpZ2h0ZWQ6IGJvb2xlYW4sXHJcbn07XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBGaWxlUmVzdWx0c0NvbXBvbmVudCBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxcclxuICBQcm9wcyxcclxuICBTdGF0ZSxcclxuPiB7XHJcbiAgY29uc3RydWN0b3IocHJvcHM6IFByb3BzKSB7XHJcbiAgICBzdXBlcihwcm9wcyk7XHJcbiAgICBjb25zdCB0b3RhbExpbmVzID0gcHJvcHMuZmlsZVJlc3VsdHMuZ3JvdXBzLnJlZHVjZShcclxuICAgICAgKGFjYywgZ3JvdXApID0+IGFjYyArIGdyb3VwLmxpbmVzLmxlbmd0aCxcclxuICAgICAgMCxcclxuICAgICk7XHJcbiAgICB0aGlzLnN0YXRlID0ge1xyXG4gICAgICBoaWdobGlnaHRlZDogdG90YWxMaW5lcyA8IEFTWU5DX0xJTkVfTElNSVQsXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgY29tcG9uZW50RGlkTW91bnQoKSB7XHJcbiAgICBpZiAoIXRoaXMuc3RhdGUuaGlnaGxpZ2h0ZWQpIHtcclxuICAgICAgdGhpcy5fc3RhcnRIaWdobGlnaHRpbmcoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIF9zdGFydEhpZ2hsaWdodGluZygpIHtcclxuICAgIC8vIFRPRE8ocGVsbWVycyk6IFVzZSByZWFjdCBkZWZlcnJlZCB1cGRhdGUgQVBJIHdoZW4gZmFjZWJvb2svcmVhY3QvaXNzdWVzLzEzMzA2IGlzIHJlYWR5XHJcbiAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xyXG4gICAgICB0aGlzLnNldFN0YXRlKHtoaWdobGlnaHRlZDogdHJ1ZX0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBzaG91bGRDb21wb25lbnRVcGRhdGUobmV4dFByb3BzOiBQcm9wcywgbmV4dFN0YXRlOiBTdGF0ZSk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIChcclxuICAgICAgdGhpcy5wcm9wcy5maWxlUmVzdWx0cyAhPT0gbmV4dFByb3BzLmZpbGVSZXN1bHRzIHx8XHJcbiAgICAgIHRoaXMucHJvcHMuY29sbGFwc2VkICE9PSBuZXh0UHJvcHMuY29sbGFwc2VkIHx8XHJcbiAgICAgIHRoaXMuc3RhdGUuaGlnaGxpZ2h0ZWQgIT09IG5leHRTdGF0ZS5oaWdobGlnaHRlZFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8vIFJlZ2lzdGVyIGV2ZW50IGNhbGxiYWNrcyBvbiB0aGUgbGluZSBudW1iZXIgLyBjb2RlIGNvbnRhaW5lcnMuXHJcbiAgLy8gV2UgY2FuIHRoZW4gdXNlIHRoZSBkYXRhIGF0dHJpYnV0ZXMgdG8gZmluZCB0aGUgbGluZSBudW1iZXJzLlxyXG4gIF9vbkxpbmVDb2x1bW5DbGljayA9IChldmVudDogYW55KSA9PiB7XHJcbiAgICBjb25zdCBsaW5lID0gKGV2ZW50LnRhcmdldDogSFRNTEVsZW1lbnQpLmRhdGFzZXQubGluZTtcclxuICAgIGlmIChsaW5lICE9IG51bGwpIHtcclxuICAgICAgdGhpcy5wcm9wcy5vbkNsaWNrKHRoaXMucHJvcHMuZmlsZVJlc3VsdHMucGF0aCwgcGFyc2VJbnQobGluZSwgMTApKTtcclxuICAgIH1cclxuICB9O1xyXG5cclxuICBfb25Db2RlQ2xpY2sgPSAoZXZlbnQ6IE1vdXNlRXZlbnQsIHN0YXJ0TGluZTogbnVtYmVyLCBsaW5lQ291bnQ6IG51bWJlcikgPT4ge1xyXG4gICAgbGV0IGNvbHVtbiA9IHVuZGVmaW5lZDtcclxuICAgIGlmIChcclxuICAgICAgZXZlbnQudGFyZ2V0IGluc3RhbmNlb2YgSFRNTEVsZW1lbnQgJiZcclxuICAgICAgZXZlbnQudGFyZ2V0LmNsYXNzTmFtZSA9PT0gJ2hpZ2hsaWdodC1pbmZvJ1xyXG4gICAgKSB7XHJcbiAgICAgIC8vIEhpZ2hsaWdodHMgaGF2ZSBjb2x1bW5zIGF0dGFjaGVkIGFzIGRhdGEtY29sdW1uLlxyXG4gICAgICAvLyAoV2UgY291bGQgZ2V0IHRoaXMgZnJvbSB0aGUgY2xpZW50IGNvb3JkcyBhcyB3ZWxsLCBidXQgaXQncyBoYXJkZXIuKVxyXG4gICAgICBjb2x1bW4gPSBwYXJzZUludChldmVudC50YXJnZXQuZGF0YXNldC5jb2x1bW4sIDEwKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIERvbid0IHRyaWdnZXIgaWYgdGhlIHVzZXIgaXMgdHJ5aW5nIHRvIHNlbGVjdCBzb21ldGhpbmcuXHJcbiAgICAgIGNvbnN0IHNlbGVjdGlvbiA9IGdldFNlbGVjdGlvbigpO1xyXG4gICAgICBpZiAoc2VsZWN0aW9uID09IG51bGwgfHwgc2VsZWN0aW9uLnR5cGUgPT09ICdSYW5nZScpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGNvbnN0IHtjdXJyZW50VGFyZ2V0LCBjbGllbnRZfSA9IGV2ZW50O1xyXG4gICAgaWYgKCEoY3VycmVudFRhcmdldCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICAvLyBEZXRlcm1pbmUgdGhlIGxpbmUgbnVtYmVyIHZpYSB0aGUgcmVsYXRpdmUgY2xpY2sgY29vcmRpbmF0ZXMuXHJcbiAgICBjb25zdCB7dG9wLCBoZWlnaHR9ID0gY3VycmVudFRhcmdldC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgIGNvbnN0IHJlbGF0aXZlWSA9IGNsaWVudFkgLSB0b3A7XHJcbiAgICBpZiAocmVsYXRpdmVZIDw9IGhlaWdodCkge1xyXG4gICAgICBjb25zdCBsaW5lTnVtYmVyID1cclxuICAgICAgICBzdGFydExpbmUgKyBNYXRoLmZsb29yKChsaW5lQ291bnQgKiByZWxhdGl2ZVkpIC8gaGVpZ2h0KTtcclxuICAgICAgdGhpcy5wcm9wcy5vbkNsaWNrKHRoaXMucHJvcHMuZmlsZVJlc3VsdHMucGF0aCwgbGluZU51bWJlciAtIDEsIGNvbHVtbik7XHJcbiAgICB9XHJcbiAgfTtcclxuXHJcbiAgX29uVG9nZ2xlID0gKCkgPT4ge1xyXG4gICAgdGhpcy5wcm9wcy5vblRvZ2dsZSh0aGlzLnByb3BzLmZpbGVSZXN1bHRzLnBhdGgpO1xyXG4gIH07XHJcblxyXG4gIF9vbkZpbGVDbGljayA9IChldmVudDogTW91c2VFdmVudCkgPT4ge1xyXG4gICAgY29uc3Qge2dyb3Vwc30gPSB0aGlzLnByb3BzLmZpbGVSZXN1bHRzO1xyXG4gICAgaWYgKGdyb3Vwcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgdGhpcy5wcm9wcy5vbkNsaWNrKHRoaXMucHJvcHMuZmlsZVJlc3VsdHMucGF0aCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLnByb3BzLm9uQ2xpY2soXHJcbiAgICAgICAgdGhpcy5wcm9wcy5maWxlUmVzdWx0cy5wYXRoLFxyXG4gICAgICAgIGdyb3Vwc1swXS5tYXRjaGVzWzBdLnN0YXJ0LnJvdyxcclxuICAgICAgICBncm91cHNbMF0ubWF0Y2hlc1swXS5zdGFydC5jb2x1bW4sXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICB9O1xyXG5cclxuICByZW5kZXIoKTogUmVhY3QuTm9kZSB7XHJcbiAgICBjb25zdCB7ZmlsZVJlc3VsdHN9ID0gdGhpcy5wcm9wcztcclxuICAgIGNvbnN0IHtwYXRoLCBwYXRoTWF0Y2gsIGdyb3Vwc30gPSBmaWxlUmVzdWx0cztcclxuICAgIGxldCBkaXNwbGF5UGF0aCA9IHBhdGg7XHJcbiAgICBpZiAocGF0aE1hdGNoICE9IG51bGwpIHtcclxuICAgICAgZGlzcGxheVBhdGggPSAoXHJcbiAgICAgICAgPEhpZ2hsaWdodGVkVGV4dFxyXG4gICAgICAgICAgdGV4dD17cGF0aH1cclxuICAgICAgICAgIGhpZ2hsaWdodGVkUmFuZ2VzPXtbW3BhdGhNYXRjaFswXSwgcGF0aE1hdGNoWzFdXV19XHJcbiAgICAgICAgLz5cclxuICAgICAgKTtcclxuICAgIH1cclxuICAgIGNvbnN0IGdyYW1tYXIgPSBzZWxlY3RHcmFtbWFyKHBhdGgpO1xyXG4gICAgcmV0dXJuIChcclxuICAgICAgPGRpdj5cclxuICAgICAgICA8ZGl2XHJcbiAgICAgICAgICAvLyBTaG93IHRoZSBmdWxsIHBhdGggaW4gYSB0b29sdGlwIGlmIGl0IG92ZXJmbG93cy5cclxuICAgICAgICAgIHRpdGxlPXtmaWxlUmVzdWx0cy5wYXRofVxyXG4gICAgICAgICAgY2xhc3NOYW1lPVwiZmlsZS1yZXN1bHRzLWZpbGVuYW1lXCJcclxuICAgICAgICAgIG9uQ2xpY2s9e3RoaXMuX29uVG9nZ2xlfT5cclxuICAgICAgICAgIDxzcGFuXHJcbiAgICAgICAgICAgIGNsYXNzTmFtZT17Y2xhc3NuYW1lcyhcclxuICAgICAgICAgICAgICAnaWNvbicsXHJcbiAgICAgICAgICAgICAgdGhpcy5wcm9wcy5jb2xsYXBzZWQgPyAnaWNvbi1jaGV2cm9uLXJpZ2h0JyA6ICdpY29uLWNoZXZyb24tZG93bicsXHJcbiAgICAgICAgICAgICl9XHJcbiAgICAgICAgICAvPlxyXG4gICAgICAgICAgPHNwYW4gb25DbGljaz17dGhpcy5fb25GaWxlQ2xpY2t9PlxyXG4gICAgICAgICAgICA8UGF0aFdpdGhGaWxlSWNvbiBwYXRoPXtmaWxlUmVzdWx0cy5wYXRofSBjaGlsZHJlbj17W119IC8+XHJcbiAgICAgICAgICAgIHtkaXNwbGF5UGF0aH1cclxuICAgICAgICAgIDwvc3Bhbj5cclxuICAgICAgICA8L2Rpdj5cclxuICAgICAgICA8ZGl2PlxyXG4gICAgICAgICAgeyF0aGlzLnByb3BzLmNvbGxhcHNlZCAmJlxyXG4gICAgICAgICAgICBncm91cHMubWFwKChncm91cCwgZ3JvdXBLZXkpID0+IHtcclxuICAgICAgICAgICAgICBjb25zdCBsaW5lTnVtYmVycyA9IFtdO1xyXG4gICAgICAgICAgICAgIGNvbnN0IGhpZ2hsaWdodHMgPSBbXTtcclxuICAgICAgICAgICAgICBjb25zdCBjb2RlID0gZ3JvdXAubGluZXMuam9pbignXFxuJyk7XHJcbiAgICAgICAgICAgICAgbGV0IG1hdGNoSW5kZXggPSAwO1xyXG4gICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZ3JvdXAubGluZXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGxpbmVOdW0gPSBpICsgZ3JvdXAuc3RhcnRMaW5lO1xyXG4gICAgICAgICAgICAgICAgLy8gRXh0cmFjdCBhbGwgbWF0Y2hlcyB0aGF0IGFyZSBvbiB0aGUgY3VycmVudCBsaW5lLlxyXG4gICAgICAgICAgICAgICAgY29uc3QgbGluZU1hdGNoZXMgPSBbXTtcclxuICAgICAgICAgICAgICAgIHdoaWxlIChtYXRjaEluZGV4IDwgZ3JvdXAubWF0Y2hlcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgY29uc3QgY3VyTWF0Y2ggPSBncm91cC5tYXRjaGVzW21hdGNoSW5kZXhdO1xyXG4gICAgICAgICAgICAgICAgICBjb25zdCBjdXJMaW5lID0gY3VyTWF0Y2guc3RhcnQucm93ICsgMTtcclxuICAgICAgICAgICAgICAgICAgaWYgKGN1ckxpbmUgPCBsaW5lTnVtKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY3VyTGluZSA9PT0gbGluZU51bSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGxpbmVNYXRjaGVzLnB1c2goY3VyTWF0Y2gpO1xyXG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgIG1hdGNoSW5kZXgrKztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGxpbmVOdW1iZXJzLnB1c2goXHJcbiAgICAgICAgICAgICAgICAgIDxkaXYga2V5PXtsaW5lTnVtfSBkYXRhLWxpbmU9e2xpbmVOdW0gLSAxfT5cclxuICAgICAgICAgICAgICAgICAgICB7bGluZU51bX1cclxuICAgICAgICAgICAgICAgICAgPC9kaXY+LFxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgIGhpZ2hsaWdodHMucHVzaChyZW5kZXJIaWdobGlnaHRzKGdyb3VwLmxpbmVzW2ldLCBsaW5lTWF0Y2hlcykpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICByZXR1cm4gKFxyXG4gICAgICAgICAgICAgICAgPGRpdiBrZXk9e2dyb3VwS2V5fSBjbGFzc05hbWU9XCJmaWxlLXJlc3VsdHMtc25pcHBldFwiPlxyXG4gICAgICAgICAgICAgICAgICA8ZGl2XHJcbiAgICAgICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5fb25MaW5lQ29sdW1uQ2xpY2t9XHJcbiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwiZmlsZS1yZXN1bHRzLWxpbmUtbnVtYmVyc1wiPlxyXG4gICAgICAgICAgICAgICAgICAgIHtsaW5lTnVtYmVyc31cclxuICAgICAgICAgICAgICAgICAgPC9kaXY+XHJcbiAgICAgICAgICAgICAgICAgIDxkaXZcclxuICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXtldnQgPT5cclxuICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX29uQ29kZUNsaWNrKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBldnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwLnN0YXJ0TGluZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXAubGluZXMubGVuZ3RoLFxyXG4gICAgICAgICAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJmaWxlLXJlc3VsdHMtY29kZVwiPlxyXG4gICAgICAgICAgICAgICAgICAgIHt0aGlzLnN0YXRlLmhpZ2hsaWdodGVkID8gKFxyXG4gICAgICAgICAgICAgICAgICAgICAgPENvbmN1cnJlbnRNb2RlPlxyXG4gICAgICAgICAgICAgICAgICAgICAgICA8SGlnaGxpZ2h0ZWRMaW5lcyBncmFtbWFyPXtncmFtbWFyfSBjb2RlPXtjb2RlfSAvPlxyXG4gICAgICAgICAgICAgICAgICAgICAgPC9Db25jdXJyZW50TW9kZT5cclxuICAgICAgICAgICAgICAgICAgICApIDogKFxyXG4gICAgICAgICAgICAgICAgICAgICAgY29kZVxyXG4gICAgICAgICAgICAgICAgICAgICl9XHJcbiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJmaWxlLXJlc3VsdHMtaGlnaGxpZ2h0c1wiPntoaWdobGlnaHRzfTwvZGl2PlxyXG4gICAgICAgICAgICAgICAgICA8L2Rpdj5cclxuICAgICAgICAgICAgICAgIDwvZGl2PlxyXG4gICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIH0pfVxyXG4gICAgICAgIDwvZGl2PlxyXG4gICAgICA8L2Rpdj5cclxuICAgICk7XHJcbiAgfVxyXG59XHJcbiJdfQ==