"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ModalMultiSelect = void 0;

var _Button = require("./Button");

var _ButtonGroup = require("./ButtonGroup");

var _Modal = require("./Modal");

var _MultiSelectList = require("./MultiSelectList");

var _classnames = _interopRequireDefault(require("classnames"));

var React = _interopRequireWildcard(require("react"));

var _reactDom = _interopRequireDefault(require("react-dom"));

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */

/**
 * A `<select>`-like control that uses an Atom modal for its options. This component uses an API as
 * similar to `Dropdown` as possible, with extra props for customizing display options.
 */
class ModalMultiSelect extends React.Component {
  constructor(props) {
    super(props);
    this._modal = void 0;

    this._selectAll = () => {
      const allValues = this.props.options.map(option => option.value);
      this.setState({
        activeValues: allValues
      });
    };

    this._selectNone = () => {
      this.setState({
        activeValues: []
      });
    };

    this._resetSelection = () => {
      this.setState({
        activeValues: this.props.value
      });
    };

    this._showModal = () => {
      this.setState({
        showModal: true,
        // When you show the modal, the initial selection should match the actually selected values.
        activeValues: this.props.value
      });
    };

    this._dismissModal = () => {
      this.setState({
        showModal: false
      });
    };

    this._confirmValues = () => {
      // TODO (matthewwithanm): Use ctrl-enter to confirm
      this._dismissModal();

      this.props.onChange(this.state.activeValues);
    };

    this.state = {
      activeValues: props.value,
      showModal: false
    };
  }

  render() {
    const LabelComponent = this.props.labelComponent || DefaultLabelComponent;
    const selectedOptions = this.props.options.filter(option => this.props.value.indexOf(option.value) !== -1);
    const className = (0, _classnames.default)(this.props.className, {
      'btn-warning': this.props.value.length === 0
    });
    return /*#__PURE__*/React.createElement(_Button.Button, {
      className: className,
      disabled: this.props.disabled,
      size: this.props.size,
      onClick: event => {
        // Because of how Portals work in React, this handler will actually be triggered for all
        // clicks within the modal! We need to filter those out to separate button clicks.
        // (see https://reactjs.org/docs/portals.html#event-bubbling-through-portals)
        const modalElement = this._modal && _reactDom.default.findDOMNode(this._modal);

        if (modalElement == null || !modalElement.contains(event.target)) {
          this._showModal();
        }
      }
    }, /*#__PURE__*/React.createElement(LabelComponent, {
      selectedOptions: selectedOptions
    }), this._renderModal());
  }

  _renderModal() {
    if (!this.state.showModal) {
      return;
    }

    return /*#__PURE__*/React.createElement(_Modal.Modal, {
      ref: c => {
        this._modal = c;
      },
      onDismiss: this._dismissModal
    }, /*#__PURE__*/React.createElement(_MultiSelectList.MultiSelectList, {
      commandScope: atom.views.getView(atom.workspace),
      value: this.state.activeValues,
      options: this.props.options,
      optionComponent: this.props.optionComponent,
      onChange: activeValues => this.setState({
        activeValues
      })
    }), /*#__PURE__*/React.createElement("div", {
      className: "nuclide-modal-multi-select-actions"
    }, /*#__PURE__*/React.createElement(_ButtonGroup.ButtonGroup, null, /*#__PURE__*/React.createElement(_Button.Button, {
      onClick: this._selectNone
    }, "None"), /*#__PURE__*/React.createElement(_Button.Button, {
      onClick: this._selectAll
    }, "All"), /*#__PURE__*/React.createElement(_Button.Button, {
      onClick: this._resetSelection
    }, "Reset")), /*#__PURE__*/React.createElement(_ButtonGroup.ButtonGroup, null, /*#__PURE__*/React.createElement(_Button.Button, {
      onClick: this._dismissModal
    }, "Cancel"), /*#__PURE__*/React.createElement(_Button.Button, {
      buttonType: _Button.ButtonTypes.PRIMARY,
      onClick: this._confirmValues
    }, "Confirm"))));
  }

}

exports.ModalMultiSelect = ModalMultiSelect;
ModalMultiSelect.defaultProps = {
  className: '',
  disabled: false,
  labelComponent: DefaultLabelComponent,
  onChange: value => {},
  options: [],
  value: [],
  size: _Button.ButtonSizes.SMALL
};

function DefaultLabelComponent(props) {
  const count = props.selectedOptions.length;
  const noun = count === 1 ? 'Item' : 'Items';
  return /*#__PURE__*/React.createElement("span", null, `${count} ${noun} Selected`);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1jb21tb25zLXVpL01vZGFsTXVsdGlTZWxlY3QuanMiXSwibmFtZXMiOlsiTW9kYWxNdWx0aVNlbGVjdCIsIlJlYWN0IiwiQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsIl9tb2RhbCIsIl9zZWxlY3RBbGwiLCJhbGxWYWx1ZXMiLCJvcHRpb25zIiwibWFwIiwib3B0aW9uIiwidmFsdWUiLCJzZXRTdGF0ZSIsImFjdGl2ZVZhbHVlcyIsIl9zZWxlY3ROb25lIiwiX3Jlc2V0U2VsZWN0aW9uIiwiX3Nob3dNb2RhbCIsInNob3dNb2RhbCIsIl9kaXNtaXNzTW9kYWwiLCJfY29uZmlybVZhbHVlcyIsIm9uQ2hhbmdlIiwic3RhdGUiLCJyZW5kZXIiLCJMYWJlbENvbXBvbmVudCIsImxhYmVsQ29tcG9uZW50IiwiRGVmYXVsdExhYmVsQ29tcG9uZW50Iiwic2VsZWN0ZWRPcHRpb25zIiwiZmlsdGVyIiwiaW5kZXhPZiIsImNsYXNzTmFtZSIsImxlbmd0aCIsImRpc2FibGVkIiwic2l6ZSIsImV2ZW50IiwibW9kYWxFbGVtZW50IiwiUmVhY3RET00iLCJmaW5kRE9NTm9kZSIsImNvbnRhaW5zIiwidGFyZ2V0IiwiX3JlbmRlck1vZGFsIiwiYyIsImF0b20iLCJ2aWV3cyIsImdldFZpZXciLCJ3b3Jrc3BhY2UiLCJvcHRpb25Db21wb25lbnQiLCJCdXR0b25UeXBlcyIsIlBSSU1BUlkiLCJkZWZhdWx0UHJvcHMiLCJCdXR0b25TaXplcyIsIlNNQUxMIiwiY291bnQiLCJub3VuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBZUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7O0FBckJBOzs7Ozs7Ozs7Ozs7QUE2Q0E7Ozs7QUFJTyxNQUFNQSxnQkFBTixTQUErQkMsS0FBSyxDQUFDQyxTQUFyQyxDQUE2RDtBQWFsRUMsRUFBQUEsV0FBVyxDQUFDQyxLQUFELEVBQWU7QUFDeEIsVUFBTUEs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bkIsRUFBQUEsU0FBUyxFQUFFLEVBRFM7QUFFcEJFLEVBQUFBLFFBQVEsRUFBRSxLQUZVO0FBR3BCUCxFQUFBQSxjQUFjLEVBQUVDLHFCQUhJO0FBSXBCTCxFQUFBQSxRQUFRLEVBQUdULEtBQUQsSUFBdUIsQ0FBRSxDQUpmO0FBS3BCSCxFQUFBQSxPQUFPLEVBQUUsRUFMVztBQU1wQkcsRUFBQUEsS0FBSyxFQUFFLEVBTmE7QUFPcEJxQixFQUFBQSxJQUFJLEVBQUVpQixvQkFBWUM7QUFQRSxDOztBQXVIeEIsU0FBU3pCLHFCQUFULENBQStCckIsS0FBL0IsRUFBMkQ7QUFDekQsUUFBTStDLEtBQUssR0FBRy9DLEtBQUssQ0FBQ3NCLGVBQU4sQ0FBc0JJLE1BQXBDO0FBQ0EsUUFBTXNCLElBQUksR0FBR0QsS0FBSyxLQUFLLENBQVYsR0FBYyxNQUFkLEdBQXVCLE9BQXBDO0FBQ0Esc0JBQU8sa0NBQVEsR0FBRUEsS0FBTSxJQUFHQyxJQUFLLFdBQXhCLENBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTctcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cclxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuICpcclxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgQlNELXN0eWxlIGxpY2Vuc2UgZm91bmQgaW4gdGhlXHJcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4gQW4gYWRkaXRpb25hbCBncmFudFxyXG4gKiBvZiBwYXRlbnQgcmlnaHRzIGNhbiBiZSBmb3VuZCBpbiB0aGUgUEFURU5UUyBmaWxlIGluIHRoZSBzYW1lIGRpcmVjdG9yeS5cclxuICpcclxuICogQGZsb3dcclxuICogQGZvcm1hdFxyXG4gKi9cclxuXHJcbmltcG9ydCB0eXBlIHtCdXR0b25TaXplfSBmcm9tICcuL0J1dHRvbic7XHJcbmltcG9ydCB0eXBlIHtPcHRpb25Db21wb25lbnRQcm9wc30gZnJvbSAnLi9NdWx0aVNlbGVjdExpc3QnO1xyXG5cclxuaW1wb3J0IHtCdXR0b24sIEJ1dHRvblNpemVzLCBCdXR0b25UeXBlc30gZnJvbSAnLi9CdXR0b24nO1xyXG5pbXBvcnQge0J1dHRvbkdyb3VwfSBmcm9tICcuL0J1dHRvbkdyb3VwJztcclxuaW1wb3J0IHtNb2RhbH0gZnJvbSAnLi9Nb2RhbCc7XHJcbmltcG9ydCB7TXVsdGlTZWxlY3RMaXN0fSBmcm9tICcuL011bHRpU2VsZWN0TGlzdCc7XHJcbmltcG9ydCBjbGFzc25hbWVzIGZyb20gJ2NsYXNzbmFtZXMnO1xyXG5pbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XHJcbmltcG9ydCBSZWFjdERPTSBmcm9tICdyZWFjdC1kb20nO1xyXG5cclxudHlwZSBPcHRpb24gPSB7XHJcbiAgLy8gJEZsb3dGaXhNZSg+PTAuNTMuMCkgRmxvdyBzdXBwcmVzc1xyXG4gIGxhYmVsOiBSZWFjdC5DaGlsZHJlbixcclxuICB2YWx1ZTogYW55LFxyXG59O1xyXG5cclxudHlwZSBQcm9wcyA9IHtcclxuICBsYWJlbENvbXBvbmVudD86IChwcm9wczogTGFiZWxDb21wb25lbnRQcm9wcykgPT4gUmVhY3QuRWxlbWVudDxhbnk+LFxyXG4gIG9wdGlvbkNvbXBvbmVudD86IChwcm9wczogT3B0aW9uQ29tcG9uZW50UHJvcHMpID0+IFJlYWN0LkVsZW1lbnQ8YW55PixcclxuICBjbGFzc05hbWU/OiBzdHJpbmcsXHJcbiAgZGlzYWJsZWQ/OiBib29sZWFuLFxyXG4gIG9wdGlvbnM6IEFycmF5PE9wdGlvbj4sXHJcbiAgdmFsdWU6IEFycmF5PGFueT4sXHJcbiAgb25DaGFuZ2U6ICh2YWx1ZTogQXJyYXk8YW55PikgPT4gdm9pZCxcclxuICBzaXplPzogQnV0dG9uU2l6ZSwgLy8gVE9ETzogV2UgcmVhbGx5IG5lZWQgdG8gYmUgY29uc2lzdGVudCBhYm91dCB0aGVzZS4gU01BTEwgb3Igc20/P1xyXG59O1xyXG5cclxudHlwZSBTdGF0ZSA9IHtcclxuICBhY3RpdmVWYWx1ZXM6IEFycmF5PGFueT4sXHJcbiAgc2hvd01vZGFsOiBib29sZWFuLFxyXG59O1xyXG5cclxuLyoqXHJcbiAqIEEgYDxzZWxlY3Q+YC1saWtlIGNvbnRyb2wgdGhhdCB1c2VzIGFuIEF0b20gbW9kYWwgZm9yIGl0cyBvcHRpb25zLiBUaGlzIGNvbXBvbmVudCB1c2VzIGFuIEFQSSBhc1xyXG4gKiBzaW1pbGFyIHRvIGBEcm9wZG93bmAgYXMgcG9zc2libGUsIHdpdGggZXh0cmEgcHJvcHMgZm9yIGN1c3RvbWl6aW5nIGRpc3BsYXkgb3B0aW9ucy5cclxuICovXHJcbmV4cG9ydCBjbGFzcyBNb2RhbE11bHRpU2VsZWN0IGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PFByb3BzLCBTdGF0ZT4ge1xyXG4gIF9tb2RhbDogP01vZGFsO1xyXG5cclxuICBzdGF0aWMgZGVmYXVsdFByb3BzID0ge1xyXG4gICAgY2xhc3NOYW1lOiAnJyxcclxuICAgIGRpc2FibGVkOiBmYWxzZSxcclxuICAgIGxhYmVsQ29tcG9uZW50OiBEZWZhdWx0TGFiZWxDb21wb25lbnQsXHJcbiAgICBvbkNoYW5nZTogKHZhbHVlOiBBcnJheTxhbnk+KSA9PiB7fSxcclxuICAgIG9wdGlvbnM6IFtdLFxyXG4gICAgdmFsdWU6IFtdLFxyXG4gICAgc2l6ZTogQnV0dG9uU2l6ZXMuU01BTEwsXHJcbiAgfTtcclxuXHJcbiAgY29uc3RydWN0b3IocHJvcHM6IFByb3BzKSB7XHJcbiAgICBzdXBlcihwcm9wcyk7XHJcbiAgICB0aGlzLnN0YXRlID0ge1xyXG4gICAgICBhY3RpdmVWYWx1ZXM6IHByb3BzLnZhbHVlLFxyXG4gICAgICBzaG93TW9kYWw6IGZhbHNlLFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIHJlbmRlcigpOiBSZWFjdC5Ob2RlIHtcclxuICAgIGNvbnN0IExhYmVsQ29tcG9uZW50ID0gdGhpcy5wcm9wcy5sYWJlbENvbXBvbmVudCB8fCBEZWZhdWx0TGFiZWxDb21wb25lbnQ7XHJcbiAgICBjb25zdCBzZWxlY3RlZE9wdGlvbnMgPSB0aGlzLnByb3BzLm9wdGlvbnMuZmlsdGVyKFxyXG4gICAgICBvcHRpb24gPT4gdGhpcy5wcm9wcy52YWx1ZS5pbmRleE9mKG9wdGlvbi52YWx1ZSkgIT09IC0xLFxyXG4gICAgKTtcclxuICAgIGNvbnN0IGNsYXNzTmFtZSA9IGNsYXNzbmFtZXModGhpcy5wcm9wcy5jbGFzc05hbWUsIHtcclxuICAgICAgJ2J0bi13YXJuaW5nJzogdGhpcy5wcm9wcy52YWx1ZS5sZW5ndGggPT09IDAsXHJcbiAgICB9KTtcclxuICAgIHJldHVybiAoXHJcbiAgICAgIDxCdXR0b25cclxuICAgICAgICBjbGFzc05hbWU9e2NsYXNzTmFtZX1cclxuICAgICAgICBkaXNhYmxlZD17dGhpcy5wcm9wcy5kaXNhYmxlZH1cclxuICAgICAgICBzaXplPXt0aGlzLnByb3BzLnNpemV9XHJcbiAgICAgICAgb25DbGljaz17ZXZlbnQgPT4ge1xyXG4gICAgICAgICAgLy8gQmVjYXVzZSBvZiBob3cgUG9ydGFscyB3b3JrIGluIFJlYWN0LCB0aGlzIGhhbmRsZXIgd2lsbCBhY3R1YWxseSBiZSB0cmlnZ2VyZWQgZm9yIGFsbFxyXG4gICAgICAgICAgLy8gY2xpY2tzIHdpdGhpbiB0aGUgbW9kYWwhIFdlIG5lZWQgdG8gZmlsdGVyIHRob3NlIG91dCB0byBzZXBhcmF0ZSBidXR0b24gY2xpY2tzLlxyXG4gICAgICAgICAgLy8gKHNlZSBodHRwczovL3JlYWN0anMub3JnL2RvY3MvcG9ydGFscy5odG1sI2V2ZW50LWJ1YmJsaW5nLXRocm91Z2gtcG9ydGFscylcclxuICAgICAgICAgIGNvbnN0IG1vZGFsRWxlbWVudCA9IHRoaXMuX21vZGFsICYmIFJlYWN0RE9NLmZpbmRET01Ob2RlKHRoaXMuX21vZGFsKTtcclxuICAgICAgICAgIGlmIChtb2RhbEVsZW1lbnQgPT0gbnVsbCB8fCAhbW9kYWxFbGVtZW50LmNvbnRhaW5zKGV2ZW50LnRhcmdldCkpIHtcclxuICAgICAgICAgICAgdGhpcy5fc2hvd01vZGFsKCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfX0+XHJcbiAgICAgICAgPExhYmVsQ29tcG9uZW50IHNlbGVjdGVkT3B0aW9ucz17c2VsZWN0ZWRPcHRpb25zfSAvPlxyXG4gICAgICAgIHt0aGlzLl9yZW5kZXJNb2RhbCgpfVxyXG4gICAgICA8L0J1dHRvbj5cclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBfc2VsZWN0QWxsID0gKCk6IHZvaWQgPT4ge1xyXG4gICAgY29uc3QgYWxsVmFsdWVzID0gdGhpcy5wcm9wcy5vcHRpb25zLm1hcChvcHRpb24gPT4gb3B0aW9uLnZhbHVlKTtcclxuICAgIHRoaXMuc2V0U3RhdGUoe2FjdGl2ZVZhbHVlczogYWxsVmFsdWVzfSk7XHJcbiAgfTtcclxuXHJcbiAgX3NlbGVjdE5vbmUgPSAoKTogdm9pZCA9PiB7XHJcbiAgICB0aGlzLnNldFN0YXRlKHthY3RpdmVWYWx1ZXM6IFtdfSk7XHJcbiAgfTtcclxuXHJcbiAgX3Jlc2V0U2VsZWN0aW9uID0gKCk6IHZvaWQgPT4ge1xyXG4gICAgdGhpcy5zZXRTdGF0ZSh7YWN0aXZlVmFsdWVzOiB0aGlzLnByb3BzLnZhbHVlfSk7XHJcbiAgfTtcclxuXHJcbiAgX3Nob3dNb2RhbCA9ICgpOiB2b2lkID0+IHtcclxuICAgIHRoaXMuc2V0U3RhdGUoe1xyXG4gICAgICBzaG93TW9kYWw6IHRydWUsXHJcbiAgICAgIC8vIFdoZW4geW91IHNob3cgdGhlIG1vZGFsLCB0aGUgaW5pdGlhbCBzZWxlY3Rpb24gc2hvdWxkIG1hdGNoIHRoZSBhY3R1YWxseSBzZWxlY3RlZCB2YWx1ZXMuXHJcbiAgICAgIGFjdGl2ZVZhbHVlczogdGhpcy5wcm9wcy52YWx1ZSxcclxuICAgIH0pO1xyXG4gIH07XHJcblxyXG4gIF9kaXNtaXNzTW9kYWwgPSAoKTogdm9pZCA9PiB7XHJcbiAgICB0aGlzLnNldFN0YXRlKHtzaG93TW9kYWw6IGZhbHNlfSk7XHJcbiAgfTtcclxuXHJcbiAgX2NvbmZpcm1WYWx1ZXMgPSAoKTogdm9pZCA9PiB7XHJcbiAgICAvLyBUT0RPIChtYXR0aGV3d2l0aGFubSk6IFVzZSBjdHJsLWVudGVyIHRvIGNvbmZpcm1cclxuICAgIHRoaXMuX2Rpc21pc3NNb2RhbCgpO1xyXG4gICAgdGhpcy5wcm9wcy5vbkNoYW5nZSh0aGlzLnN0YXRlLmFjdGl2ZVZhbHVlcyk7XHJcbiAgfTtcclxuXHJcbiAgX3JlbmRlck1vZGFsKCk6ID9SZWFjdC5FbGVtZW50PGFueT4ge1xyXG4gICAgaWYgKCF0aGlzLnN0YXRlLnNob3dNb2RhbCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIChcclxuICAgICAgPE1vZGFsXHJcbiAgICAgICAgcmVmPXtjID0+IHtcclxuICAgICAgICAgIHRoaXMuX21vZGFsID0gYztcclxuICAgICAgICB9fVxyXG4gICAgICAgIG9uRGlzbWlzcz17dGhpcy5fZGlzbWlzc01vZGFsfT5cclxuICAgICAgICA8TXVsdGlTZWxlY3RMaXN0XHJcbiAgICAgICAgICBjb21tYW5kU2NvcGU9e2F0b20udmlld3MuZ2V0VmlldyhhdG9tLndvcmtzcGFjZSl9XHJcbiAgICAgICAgICB2YWx1ZT17dGhpcy5zdGF0ZS5hY3RpdmVWYWx1ZXN9XHJcbiAgICAgICAgICBvcHRpb25zPXt0aGlzLnByb3BzLm9wdGlvbnN9XHJcbiAgICAgICAgICBvcHRpb25Db21wb25lbnQ9e3RoaXMucHJvcHMub3B0aW9uQ29tcG9uZW50fVxyXG4gICAgICAgICAgb25DaGFuZ2U9e2FjdGl2ZVZhbHVlcyA9PiB0aGlzLnNldFN0YXRlKHthY3RpdmVWYWx1ZXN9KX1cclxuICAgICAgICAvPlxyXG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibnVjbGlkZS1tb2RhbC1tdWx0aS1zZWxlY3QtYWN0aW9uc1wiPlxyXG4gICAgICAgICAgPEJ1dHRvbkdyb3VwPlxyXG4gICAgICAgICAgICA8QnV0dG9uIG9uQ2xpY2s9e3RoaXMuX3NlbGVjdE5vbmV9Pk5vbmU8L0J1dHRvbj5cclxuICAgICAgICAgICAgPEJ1dHRvbiBvbkNsaWNrPXt0aGlzLl9zZWxlY3RBbGx9PkFsbDwvQnV0dG9uPlxyXG4gICAgICAgICAgICA8QnV0dG9uIG9uQ2xpY2s9e3RoaXMuX3Jlc2V0U2VsZWN0aW9ufT5SZXNldDwvQnV0dG9uPlxyXG4gICAgICAgICAgPC9CdXR0b25Hcm91cD5cclxuICAgICAgICAgIDxCdXR0b25Hcm91cD5cclxuICAgICAgICAgICAgPEJ1dHRvbiBvbkNsaWNrPXt0aGlzLl9kaXNtaXNzTW9kYWx9PkNhbmNlbDwvQnV0dG9uPlxyXG4gICAgICAgICAgICA8QnV0dG9uXHJcbiAgICAgICAgICAgICAgYnV0dG9uVHlwZT17QnV0dG9uVHlwZXMuUFJJTUFSWX1cclxuICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLl9jb25maXJtVmFsdWVzfT5cclxuICAgICAgICAgICAgICBDb25maXJtXHJcbiAgICAgICAgICAgIDwvQnV0dG9uPlxyXG4gICAgICAgICAgPC9CdXR0b25Hcm91cD5cclxuICAgICAgICA8L2Rpdj5cclxuICAgICAgPC9Nb2RhbD5cclxuICAgICk7XHJcbiAgfVxyXG59XHJcblxyXG50eXBlIExhYmVsQ29tcG9uZW50UHJvcHMgPSB7XHJcbiAgc2VsZWN0ZWRPcHRpb25zOiBBcnJheTxhbnk+LFxyXG59O1xyXG5cclxuZnVuY3Rpb24gRGVmYXVsdExhYmVsQ29tcG9uZW50KHByb3BzOiBMYWJlbENvbXBvbmVudFByb3BzKSB7XHJcbiAgY29uc3QgY291bnQgPSBwcm9wcy5zZWxlY3RlZE9wdGlvbnMubGVuZ3RoO1xyXG4gIGNvbnN0IG5vdW4gPSBjb3VudCA9PT0gMSA/ICdJdGVtJyA6ICdJdGVtcyc7XHJcbiAgcmV0dXJuIDxzcGFuPntgJHtjb3VudH0gJHtub3VufSBTZWxlY3RlZGB9PC9zcGFuPjtcclxufVxyXG4iXX0=