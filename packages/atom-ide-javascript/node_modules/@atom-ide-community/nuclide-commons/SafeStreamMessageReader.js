"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _vscodeJsonrpc = require("vscode-jsonrpc");

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */

/**
 * vscode-jsonrpc's StreamMessageReader has a fatal flaw of throwing exceptions!
 * It's hard to catch asynchronous exceptions, and it crashes the Nuclide server.
 * Until this is addressed, this captures exceptions and emits errors instead.
 *
 * https://github.com/Microsoft/vscode-languageserver-node/issues/270
 */
class SafeStreamMessageReader extends _vscodeJsonrpc.StreamMessageReader {
  onData(data) {
    try {
      super.onData(data);
    } catch (err) {
      this.fireError(err); // Stop handling events, as stream errors are unrecoverable.
      // The owner of the reader should tear itself down as well.

      this.dispose();
      this.readable.removeAllListeners();
    }
  }

}

exports.default = SafeStreamMessageReader;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1jb21tb25zL1NhZmVTdHJlYW1NZXNzYWdlUmVhZGVyLmpzIl0sIm5hbWVzIjpbIlNhZmVTdHJlYW1NZXNzYWdlUmVhZGVyIiwiU3RyZWFtTWVzc2FnZVJlYWRlciIsIm9uRGF0YSIsImRhdGEiLCJlcnIiLCJmaXJlRXJyb3IiLCJkaXNwb3NlIiwicmVhZGFibGUiLCJyZW1vdmVBbGxMaXN0ZW5lcnMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFZQTs7QUFaQTs7Ozs7Ozs7Ozs7O0FBY0E7Ozs7Ozs7QUFPZSxNQUFNQSx1QkFBTixTQUFzQ0Msa0NBQXRDLENBQTBEO0FBQ3ZFQyxFQUFBQSxNQUFNLENBQUNDLElBQUQsRUFBd0I7QUFDNUIsUUFBSTtBQUNGLFlBQU1ELE1BQU4sQ0FBYUMsSUFBYjtBQUNELEtBRkQsQ0FFRSxPQUFPQyxHQUFQLEVBQVk7QUFDWixXQUFLQyxTQUFMLENBQWVELEdBQWYsRUFEWSxDQUVaO0FBQ0E7O0FBQ0EsV0FBS0UsT0FBTDtBQUNBLFdBQUtDLFFBQUwsQ0FBY0Msa0JBQWQ7QUFDRDtBQUNGOztBQVhzRSIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTctcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cclxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuICpcclxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgQlNELXN0eWxlIGxpY2Vuc2UgZm91bmQgaW4gdGhlXHJcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4gQW4gYWRkaXRpb25hbCBncmFudFxyXG4gKiBvZiBwYXRlbnQgcmlnaHRzIGNhbiBiZSBmb3VuZCBpbiB0aGUgUEFURU5UUyBmaWxlIGluIHRoZSBzYW1lIGRpcmVjdG9yeS5cclxuICpcclxuICogQGZsb3cgc3RyaWN0XHJcbiAqIEBmb3JtYXRcclxuICovXHJcblxyXG5pbXBvcnQge1N0cmVhbU1lc3NhZ2VSZWFkZXJ9IGZyb20gJ3ZzY29kZS1qc29ucnBjJztcclxuXHJcbi8qKlxyXG4gKiB2c2NvZGUtanNvbnJwYydzIFN0cmVhbU1lc3NhZ2VSZWFkZXIgaGFzIGEgZmF0YWwgZmxhdyBvZiB0aHJvd2luZyBleGNlcHRpb25zIVxyXG4gKiBJdCdzIGhhcmQgdG8gY2F0Y2ggYXN5bmNocm9ub3VzIGV4Y2VwdGlvbnMsIGFuZCBpdCBjcmFzaGVzIHRoZSBOdWNsaWRlIHNlcnZlci5cclxuICogVW50aWwgdGhpcyBpcyBhZGRyZXNzZWQsIHRoaXMgY2FwdHVyZXMgZXhjZXB0aW9ucyBhbmQgZW1pdHMgZXJyb3JzIGluc3RlYWQuXHJcbiAqXHJcbiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9NaWNyb3NvZnQvdnNjb2RlLWxhbmd1YWdlc2VydmVyLW5vZGUvaXNzdWVzLzI3MFxyXG4gKi9cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU2FmZVN0cmVhbU1lc3NhZ2VSZWFkZXIgZXh0ZW5kcyBTdHJlYW1NZXNzYWdlUmVhZGVyIHtcclxuICBvbkRhdGEoZGF0YTogQnVmZmVyIHwgc3RyaW5nKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICBzdXBlci5vbkRhdGEoZGF0YSk7XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgdGhpcy5maXJlRXJyb3IoZXJyKTtcclxuICAgICAgLy8gU3RvcCBoYW5kbGluZyBldmVudHMsIGFzIHN0cmVhbSBlcnJvcnMgYXJlIHVucmVjb3ZlcmFibGUuXHJcbiAgICAgIC8vIFRoZSBvd25lciBvZiB0aGUgcmVhZGVyIHNob3VsZCB0ZWFyIGl0c2VsZiBkb3duIGFzIHdlbGwuXHJcbiAgICAgIHRoaXMuZGlzcG9zZSgpO1xyXG4gICAgICB0aGlzLnJlYWRhYmxlLnJlbW92ZUFsbExpc3RlbmVycygpO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=