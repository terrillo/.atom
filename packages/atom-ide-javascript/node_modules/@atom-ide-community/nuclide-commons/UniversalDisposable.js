"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */

/**
 * Like a CompositeDisposable, but in addition to Disposable instances it can
 * also accept plain functions and Rx subscriptions.
 */
class UniversalDisposable {
  constructor(...teardowns) {
    this.disposed = void 0;
    this.teardowns = void 0;
    this.teardowns = new Set();
    this.disposed = false;

    if (teardowns.length) {
      this.add(...teardowns);
    }
  }

  add(...teardowns) {
    if (this.disposed) {
      throw new Error('Cannot add to an already disposed UniversalDisposable!');
    }

    for (let i = 0; i < teardowns.length; i++) {
      assertTeardown(teardowns[i]);
      this.teardowns.add(teardowns[i]);
    }
  }
  /**
   * Adds a list of teardowns but also ties them to the lifetime of `destructible`.
   * When `destructible` is destroyed (or `this.dispose()` gets called, whichever comes first),
   * all `teardowns` provided are also disposed.
   *
   * This is a subtle pattern to get right because of two factors:
   * - we need to make sure that all teardowns are also removed on destroy
   * - we also need to ensure that we don't leak the onDidDestroy disposable
   */


  addUntilDestroyed(destructible, ...teardowns) {
    if (this.disposed) {
      throw new Error('Cannot add to an already disposed UniversalDisposable!');
    }

    const destroyDisposable = new UniversalDisposable(...teardowns, destructible.onDidDestroy(() => {
      destroyDisposable.dispose();
      this.remove(destroyDisposable);
    }));
    this.add(destroyDisposable);
  }

  remove(teardown) {
    if (!this.disposed) {
      this.teardowns.delete(teardown);
    }
  }

  dispose() {
    if (!this.disposed) {
      this.disposed = true;
      this.teardowns.forEach(teardown => {
        if (typeof teardown.dispose === 'function') {
          teardown.dispose();
        } else if (typeof teardown.unsubscribe === 'function') {
          teardown.unsubscribe();
        } else if (typeof teardown.destroy === 'function') {
          teardown.destroy();
        } else if (typeof teardown === 'function') {
          teardown();
        }
      });
      this.teardowns = null;
    }
  }

  unsubscribe() {
    this.dispose();
  }

  clear() {
    if (!this.disposed) {
      this.teardowns.clear();
    }
  }

}

exports.default = UniversalDisposable;

function assertTeardown(teardown) {
  if (typeof teardown.dispose === 'function' || typeof teardown.unsubscribe === 'function' || typeof teardown.destroy === 'function' || typeof teardown === 'function') {
    return;
  }

  throw new TypeError('Arguments to UniversalDisposable.add must be disposable');
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1jb21tb25zL1VuaXZlcnNhbERpc3Bvc2FibGUuanMiXSwibmFtZXMiOlsiVW5pdmVyc2FsRGlzcG9zYWJsZSIsImNvbnN0cnVjdG9yIiwidGVhcmRvd25zIiwiZGlzcG9zZWQiLCJTZXQiLCJsZW5ndGgiLCJhZGQiLCJFcnJvciIsImkiLCJhc3NlcnRUZWFyZG93biIsImFkZFVudGlsRGVzdHJveWVkIiwiZGVzdHJ1Y3RpYmxlIiwiZGVzdHJveURpc3Bvc2FibGUiLCJvbkRpZERlc3Ryb3kiLCJkaXNwb3NlIiwicmVtb3ZlIiwidGVhcmRvd24iLCJkZWxldGUiLCJmb3JFYWNoIiwidW5zdWJzY3JpYmUiLCJkZXN0cm95IiwiY2xlYXIiLCJUeXBlRXJyb3IiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7Ozs7Ozs7Ozs7O0FBdUJBOzs7O0FBSWUsTUFBTUEsbUJBQU4sQ0FBMEI7QUFJdkNDLEVBQUFBLFdBQVcsQ0FBQyxHQUFHQyxTQUFKLEVBQW1DO0FBQUEsU0FIOUNDLFFBRzhDO0FBQUEsU0FGOUNELFNBRThDO0FBQzVDLFNBQUtBLFNBQUwsR0FBaUIsSUFBSUUsR0FBSixFQUFqQjtBQUNBLFNBQUtELFFBQUwsR0FBZ0IsS0FBaEI7O0FBQ0EsUUFBSUQsU0FBUyxDQUFDRyxNQUFkLEVBQXNCO0FBQ3BCLFdBQUtDLEdBQUwsQ0FBUyxHQUFHSixTQUFaO0FBQ0Q7QUFDRjs7QUFFREksRUFBQUEsR0FBRyxDQUFDLEdBQUdKLFNBQUosRUFBeUM7QUFDMUMsUUFBSSxLQUFLQyxRQUFULEVBQW1CO0FBQ2pCLFlBQU0sSUFBSUksS0FBSixDQUFVLHdEQUFWLENBQU47QUFDRDs7QUFDRCxTQUFLLElBQUlDLENBQUMsR0FBRyxDQUFiLEVBQWdCQSxDQUFDLEdBQUdOLFNBQVMsQ0FBQ0csTUFBOUIsRUFBc0NHLENBQUMsRUFBdkMsRUFBMkM7QUFDekNDLE1BQUFBLGNBQWMsQ0FBQ1AsU0FBUyxDQUFDTSxDQUFELENBQVYsQ0FBZDtBQUNBLFdBQUtOLFNBQUwsQ0FBZUksR0FBZixDQUFtQkosU0FBUyxDQUFDTSxDQUFELENBQTVCO0FBQ0Q7QUFDRjtBQUVEOzs7Ozs7Ozs7OztBQVNBRSxFQUFBQSxpQkFBaUIsQ0FDZkMsWUFEZSxFQUVmLEdBQUdULFNBRlksRUFHZjtBQUNBLFFBQUksS0FBS0MsUUFBVCxFQUFtQjtBQUNqQixZQUFNLElBQUlJLEtBQUosQ0FBVSx3REFBVixDQUFOO0FBQ0Q7O0FBQ0QsVUFBTUssaUJBQWlCLEdBQUcsSUFBSVosbUJBQUosQ0FDeEIsR0FBR0UsU0FEcUIsRUFFeEJTLFlBQVksQ0FBQ0UsWUFBYixDQUEwQixNQUFNO0FBQzlCRCxNQUFBQSxpQkFBaUIsQ0FBQ0UsT0FBbEI7QUFDQSxXQUFLQyxNQUFMLENBQVlILGlCQUFaO0FBQ0QsS0FIRCxDQUZ3QixDQUExQjtBQU9BLFNBQUtOLEdBQUwsQ0FBU00saUJBQVQ7QUFDRDs7QUFFREcsRUFBQUEsTUFBTSxDQUFDQyxRQUFELEVBQThCO0FBQ2xDLFFBQUksQ0FBQyxLQUFLYixRQUFWLEVBQW9CO0FBQ2xCLFdBQUtELFNBQUwsQ0FBZWUsTUFBZixDQUFzQkQsUUFBdEI7QUFDRDtBQUNGOztBQUVERixFQUFBQSxPQUFPLEdBQVM7QUFDZCxRQUFJLENBQUMsS0FBS1gsUUFBVixFQUFvQjtBQUNsQixXQUFLQSxRQUFMLEdBQWdCLElBQWhCO0FBQ0EsV0FBS0QsU0FBTCxDQUFlZ0IsT0FBZixDQUF1QkYsUUFBUSxJQUFJO0FBQ2pDLFlBQUksT0FBT0EsUUFBUSxDQUFDRixPQUFoQixLQUE0QixVQUFoQyxFQUE0QztBQUMxQ0UsVUFBQUEsUUFBUSxDQUFDRixPQUFUO0FBQ0QsU0FGRCxNQUVPLElBQUksT0FBT0UsUUFBUSxDQUFDRyxXQUFoQixLQUFnQyxVQUFwQyxFQUFnRDtBQUNyREgsVUFBQUEsUUFBUSxDQUFDRyxXQUFUO0FBQ0QsU0FGTSxNQUVBLElBQUksT0FBT0gsUUFBUSxDQUFDSSxPQUFoQixLQUE0QixVQUFoQyxFQUE0QztBQUNqREosVUFBQUEsUUFBUSxDQUFDSSxPQUFUO0FBQ0QsU0FGTSxNQUVBLElBQUksT0FBT0osUUFBUCxLQUFvQixVQUF4QixFQUFvQztBQUN6Q0EsVUFBQUEsUUFBUTtBQUNUO0FBQ0YsT0FWRDtBQVdBLFdBQUtkLFNBQUwsR0FBa0IsSUFBbEI7QUFDRDtBQUNGOztBQUVEaUIsRUFBQUEsV0FBVyxHQUFTO0FBQ2xCLFNBQUtMLE9BQUw7QUFDRDs7QUFFRE8sRUFBQUEsS0FBSyxHQUFTO0FBQ1osUUFBSSxDQUFDLEtBQUtsQixRQUFWLEVBQW9CO0FBQ2xCLFdBQUtELFNBQUwsQ0FBZW1CLEtBQWY7QUFDRDtBQUNGOztBQWhGc0M7Ozs7QUFtRnpDLFNBQVNaLGNBQVQsQ0FBd0JPLFFBQXhCLEVBQXFEO0FBQ25ELE1BQ0UsT0FBT0EsUUFBUSxDQUFDRixPQUFoQixLQUE0QixVQUE1QixJQUNBLE9BQU9FLFFBQVEsQ0FBQ0csV0FBaEIsS0FBZ0MsVUFEaEMsSUFFQSxPQUFPSCxRQUFRLENBQUNJLE9BQWhCLEtBQTRCLFVBRjVCLElBR0EsT0FBT0osUUFBUCxLQUFvQixVQUp0QixFQUtFO0FBQ0E7QUFDRDs7QUFDRCxRQUFNLElBQUlNLFNBQUosQ0FDSix5REFESSxDQUFOO0FBR0QiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQ29weXJpZ2h0IChjKSAyMDE3LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXHJcbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbiAqXHJcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIEJTRC1zdHlsZSBsaWNlbnNlIGZvdW5kIGluIHRoZVxyXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuIEFuIGFkZGl0aW9uYWwgZ3JhbnRcclxuICogb2YgcGF0ZW50IHJpZ2h0cyBjYW4gYmUgZm91bmQgaW4gdGhlIFBBVEVOVFMgZmlsZSBpbiB0aGUgc2FtZSBkaXJlY3RvcnkuXHJcbiAqXHJcbiAqIEBmbG93XHJcbiAqIEBmb3JtYXRcclxuICovXHJcblxyXG5leHBvcnQgdHlwZSBJRGVzdHJ1Y3RpYmxlID0ge1xyXG4gIGRlc3Ryb3koKTogdm9pZCxcclxuICBvbkRpZERlc3Ryb3koY2FsbGJhY2s6ICgpID0+IG1peGVkKTogSURpc3Bvc2FibGUsXHJcbn07XHJcblxyXG5leHBvcnQgdHlwZSBBbnlUZWFyZG93biA9XHJcbiAgfCAoKCkgPT4gbWl4ZWQpXHJcbiAgfCByeGpzJElTdWJzY3JpcHRpb25cclxuICB8IElEaXNwb3NhYmxlXHJcbiAgfCBJRGVzdHJ1Y3RpYmxlO1xyXG5cclxuLyoqXHJcbiAqIExpa2UgYSBDb21wb3NpdGVEaXNwb3NhYmxlLCBidXQgaW4gYWRkaXRpb24gdG8gRGlzcG9zYWJsZSBpbnN0YW5jZXMgaXQgY2FuXHJcbiAqIGFsc28gYWNjZXB0IHBsYWluIGZ1bmN0aW9ucyBhbmQgUnggc3Vic2NyaXB0aW9ucy5cclxuICovXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFVuaXZlcnNhbERpc3Bvc2FibGUge1xyXG4gIGRpc3Bvc2VkOiBib29sZWFuO1xyXG4gIHRlYXJkb3duczogU2V0PEFueVRlYXJkb3duPjtcclxuXHJcbiAgY29uc3RydWN0b3IoLi4udGVhcmRvd25zOiBBcnJheTxBbnlUZWFyZG93bj4pIHtcclxuICAgIHRoaXMudGVhcmRvd25zID0gbmV3IFNldCgpO1xyXG4gICAgdGhpcy5kaXNwb3NlZCA9IGZhbHNlO1xyXG4gICAgaWYgKHRlYXJkb3ducy5sZW5ndGgpIHtcclxuICAgICAgdGhpcy5hZGQoLi4udGVhcmRvd25zKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFkZCguLi50ZWFyZG93bnM6IEFycmF5PEFueVRlYXJkb3duPik6IHZvaWQge1xyXG4gICAgaWYgKHRoaXMuZGlzcG9zZWQpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgYWRkIHRvIGFuIGFscmVhZHkgZGlzcG9zZWQgVW5pdmVyc2FsRGlzcG9zYWJsZSEnKTtcclxuICAgIH1cclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGVhcmRvd25zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIGFzc2VydFRlYXJkb3duKHRlYXJkb3duc1tpXSk7XHJcbiAgICAgIHRoaXMudGVhcmRvd25zLmFkZCh0ZWFyZG93bnNbaV0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQWRkcyBhIGxpc3Qgb2YgdGVhcmRvd25zIGJ1dCBhbHNvIHRpZXMgdGhlbSB0byB0aGUgbGlmZXRpbWUgb2YgYGRlc3RydWN0aWJsZWAuXHJcbiAgICogV2hlbiBgZGVzdHJ1Y3RpYmxlYCBpcyBkZXN0cm95ZWQgKG9yIGB0aGlzLmRpc3Bvc2UoKWAgZ2V0cyBjYWxsZWQsIHdoaWNoZXZlciBjb21lcyBmaXJzdCksXHJcbiAgICogYWxsIGB0ZWFyZG93bnNgIHByb3ZpZGVkIGFyZSBhbHNvIGRpc3Bvc2VkLlxyXG4gICAqXHJcbiAgICogVGhpcyBpcyBhIHN1YnRsZSBwYXR0ZXJuIHRvIGdldCByaWdodCBiZWNhdXNlIG9mIHR3byBmYWN0b3JzOlxyXG4gICAqIC0gd2UgbmVlZCB0byBtYWtlIHN1cmUgdGhhdCBhbGwgdGVhcmRvd25zIGFyZSBhbHNvIHJlbW92ZWQgb24gZGVzdHJveVxyXG4gICAqIC0gd2UgYWxzbyBuZWVkIHRvIGVuc3VyZSB0aGF0IHdlIGRvbid0IGxlYWsgdGhlIG9uRGlkRGVzdHJveSBkaXNwb3NhYmxlXHJcbiAgICovXHJcbiAgYWRkVW50aWxEZXN0cm95ZWQoXHJcbiAgICBkZXN0cnVjdGlibGU6IElEZXN0cnVjdGlibGUsXHJcbiAgICAuLi50ZWFyZG93bnM6IEFycmF5PEFueVRlYXJkb3duPlxyXG4gICkge1xyXG4gICAgaWYgKHRoaXMuZGlzcG9zZWQpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgYWRkIHRvIGFuIGFscmVhZHkgZGlzcG9zZWQgVW5pdmVyc2FsRGlzcG9zYWJsZSEnKTtcclxuICAgIH1cclxuICAgIGNvbnN0IGRlc3Ryb3lEaXNwb3NhYmxlID0gbmV3IFVuaXZlcnNhbERpc3Bvc2FibGUoXHJcbiAgICAgIC4uLnRlYXJkb3ducyxcclxuICAgICAgZGVzdHJ1Y3RpYmxlLm9uRGlkRGVzdHJveSgoKSA9PiB7XHJcbiAgICAgICAgZGVzdHJveURpc3Bvc2FibGUuZGlzcG9zZSgpO1xyXG4gICAgICAgIHRoaXMucmVtb3ZlKGRlc3Ryb3lEaXNwb3NhYmxlKTtcclxuICAgICAgfSksXHJcbiAgICApO1xyXG4gICAgdGhpcy5hZGQoZGVzdHJveURpc3Bvc2FibGUpO1xyXG4gIH1cclxuXHJcbiAgcmVtb3ZlKHRlYXJkb3duOiBBbnlUZWFyZG93bik6IHZvaWQge1xyXG4gICAgaWYgKCF0aGlzLmRpc3Bvc2VkKSB7XHJcbiAgICAgIHRoaXMudGVhcmRvd25zLmRlbGV0ZSh0ZWFyZG93bik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBkaXNwb3NlKCk6IHZvaWQge1xyXG4gICAgaWYgKCF0aGlzLmRpc3Bvc2VkKSB7XHJcbiAgICAgIHRoaXMuZGlzcG9zZWQgPSB0cnVlO1xyXG4gICAgICB0aGlzLnRlYXJkb3ducy5mb3JFYWNoKHRlYXJkb3duID0+IHtcclxuICAgICAgICBpZiAodHlwZW9mIHRlYXJkb3duLmRpc3Bvc2UgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgIHRlYXJkb3duLmRpc3Bvc2UoKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0ZWFyZG93bi51bnN1YnNjcmliZSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgdGVhcmRvd24udW5zdWJzY3JpYmUoKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0ZWFyZG93bi5kZXN0cm95ID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICB0ZWFyZG93bi5kZXN0cm95KCk7XHJcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdGVhcmRvd24gPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgIHRlYXJkb3duKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgdGhpcy50ZWFyZG93bnMgPSAobnVsbDogYW55KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHVuc3Vic2NyaWJlKCk6IHZvaWQge1xyXG4gICAgdGhpcy5kaXNwb3NlKCk7XHJcbiAgfVxyXG5cclxuICBjbGVhcigpOiB2b2lkIHtcclxuICAgIGlmICghdGhpcy5kaXNwb3NlZCkge1xyXG4gICAgICB0aGlzLnRlYXJkb3ducy5jbGVhcigpO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gYXNzZXJ0VGVhcmRvd24odGVhcmRvd246IEFueVRlYXJkb3duKTogdm9pZCB7XHJcbiAgaWYgKFxyXG4gICAgdHlwZW9mIHRlYXJkb3duLmRpc3Bvc2UgPT09ICdmdW5jdGlvbicgfHxcclxuICAgIHR5cGVvZiB0ZWFyZG93bi51bnN1YnNjcmliZSA9PT0gJ2Z1bmN0aW9uJyB8fFxyXG4gICAgdHlwZW9mIHRlYXJkb3duLmRlc3Ryb3kgPT09ICdmdW5jdGlvbicgfHxcclxuICAgIHR5cGVvZiB0ZWFyZG93biA9PT0gJ2Z1bmN0aW9uJ1xyXG4gICkge1xyXG4gICAgcmV0dXJuO1xyXG4gIH1cclxuICB0aHJvdyBuZXcgVHlwZUVycm9yKFxyXG4gICAgJ0FyZ3VtZW50cyB0byBVbml2ZXJzYWxEaXNwb3NhYmxlLmFkZCBtdXN0IGJlIGRpc3Bvc2FibGUnLFxyXG4gICk7XHJcbn1cclxuIl19