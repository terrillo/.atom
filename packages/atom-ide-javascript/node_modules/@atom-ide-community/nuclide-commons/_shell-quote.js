"use strict";

/**
Modified from https://github.com/substack/node-shell-quote/commit/72fb5a8.
Includes https://github.com/substack/node-shell-quote/pull/29, with minor
modifications to remove the unnecessary Array polyfills.

Use the typed wrappers in ./string.js to access these functions.

The MIT License

Copyright (c) 2013 James Halliday (mail@substack.net)

Permission is hereby granted, free of charge,
to any person obtaining a copy of this software and
associated documentation files (the "Software"), to
deal in the Software without restriction, including
without limitation the rights to use, copy, modify,
merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom
the Software is furnished to do so,
subject to the following conditions:

The above copyright notice and this permission notice
shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR
ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.


*/

/* eslint-disable */
exports.quote = function (xs) {
  return xs.map(function (s) {
    if (s && typeof s === 'object') {
      return s.op.replace(/(.)/g, '\\$1');
    } else if (/["\s]/.test(s) && !/'/.test(s)) {
      return "'" + s.replace(/(['\\])/g, '\\$1') + "'";
    } else if (/["'\s]/.test(s)) {
      return '"' + s.replace(/(["\\$`!])/g, '\\$1') + '"';
    } else {
      return String(s).replace(/([#!"$&'()*,:;<=>?@\[\\\]^`{|}])/g, '\\$1');
    }
  }).join(' ');
};

var CONTROL = '(?:' + ['\\|\\|', '\\&\\&', ';;', '\\|\\&', '[&;()|<>]'].join('|') + ')';
var META = '|&;()<> \\t';
var BAREWORD = '(\\\\[\'"' + META + ']|[^\\s\'"' + META + '])+';
var SINGLE_QUOTE = '"((\\\\"|[^"])*?)"';
var DOUBLE_QUOTE = '\'((\\\\\'|[^\'])*?)\'';
var TOKEN = '';

for (var i = 0; i < 4; i++) {
  TOKEN += (Math.pow(16, 8) * Math.random()).toString(16);
}

exports.parse = function (s, env, opts) {
  var mapped = parse(s, env, opts);
  if (typeof env !== 'function') return mapped;
  return mapped.reduce(function (acc, s) {
    if (typeof s === 'object') return acc.concat(s);
    var xs = s.split(RegExp('(' + TOKEN + '.*?' + TOKEN + ')', 'g'));
    if (xs.length === 1) return acc.concat(xs[0]);
    return acc.concat(xs.filter(Boolean).map(function (x) {
      if (RegExp('^' + TOKEN).test(x)) {
        return JSON.parse(x.split(TOKEN)[1]);
      } else return x;
    }));
  }, []);
};

function parse(s, env, opts) {
  var chunker = new RegExp(['(' + CONTROL + ')', // control chars
  '(' + BAREWORD + '|' + SINGLE_QUOTE + '|' + DOUBLE_QUOTE + ')*'].join('|'), 'g');
  var match = s.match(chunker).filter(Boolean);
  var commented = false;
  if (!match) return [];
  if (!env) env = {};
  if (!opts) opts = {};
  return match.map(function (s, j) {
    if (commented) {
      return;
    }

    if (s.charAt(0) === '#') {
      commented = true;
      return {
        comment: s.substr(1) + match.slice(j + 1).join(' ')
      };
    }

    if (RegExp('^' + CONTROL + '$').test(s)) {
      return {
        op: s
      };
    } // Hand-written scanner/parser for Bash quoting rules:
    //
    //  1. inside single quotes, all characters are printed literally.
    //  2. inside double quotes, all characters are printed literally
    //     except variables prefixed by '$' and backslashes followed by
    //     either a double quote or another backslash.
    //  3. outside of any quotes, backslashes are treated as escape
    //     characters and not printed (unless they are themselves escaped)
    //  4. quote context can switch mid-token if there is no whitespace
    //     between the two quote contexts (e.g. all'one'"token" parses as
    //     "allonetoken")


    var SQ = "'";
    var DQ = '"';
    var DS = '$';
    var BS = opts.escape || '\\';
    var quote = false;
    var esc = false;
    var out = '';
    var isGlob = false;

    for (var i = 0, len = s.length; i < len; i++) {
      var c = s.charAt(i);
      isGlob = isGlob || !quote && (c === '*' || c === '?');

      if (esc) {
        out += c;
        esc = false;
      } else if (quote) {
        if (c === quote) {
          quote = false;
        } else if (quote == SQ) {
          out += c;
        } else {
          // Double quote
          if (c === BS) {
            i += 1;
            c = s.charAt(i);

            if (c === DQ || c === BS || c === DS) {
              out += c;
            } else {
              out += BS + c;
            }
          } else if (c === DS) {
            out += parseEnvVar();
          } else {
            out += c;
          }
        }
      } else if (c === DQ || c === SQ) {
        quote = c;
      } else if (RegExp('^' + CONTROL + '$').test(c)) {
        return {
          op: s
        };
      } else if (c === BS) {
        esc = true;
      } else if (c === DS) {
        out += parseEnvVar();
      } else out += c;
    }

    if (isGlob) return {
      op: 'glob',
      pattern: out
    };
    return out;

    function parseEnvVar() {
      i += 1;
      var varend, varname; //debugger

      if (s.charAt(i) === '{') {
        i += 1;

        if (s.charAt(i) === '}') {
          throw new Error("Bad substitution: " + s.substr(i - 2, 3));
        }

        varend = s.indexOf('}', i);

        if (varend < 0) {
          throw new Error("Bad substitution: " + s.substr(i));
        }

        varname = s.substr(i, varend - i);
        i = varend;
      } else if (/[*@#?$!_\-]/.test(s.charAt(i))) {
        varname = s.charAt(i);
        i += 1;
      } else {
        varend = s.substr(i).match(/[^\w\d_]/);

        if (!varend) {
          varname = s.substr(i);
          i = s.length;
        } else {
          varname = s.substr(i, varend.index);
          i += varend.index - 1;
        }
      }

      return getVar(null, '', varname);
    }
  }) // finalize parsed aruments
  .reduce(function (prev, arg) {
    if (arg === undefined) {
      return prev;
    }

    return prev.concat(arg);
  }, []);

  function getVar(_, pre, key) {
    var r = typeof env === 'function' ? env(key) : env[key];
    if (r === undefined) r = '';

    if (typeof r === 'object') {
      return pre + TOKEN + JSON.stringify(r) + TOKEN;
    } else return pre + r;
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1jb21tb25zL19zaGVsbC1xdW90ZS5qcyJdLCJuYW1lcyI6WyJleHBvcnRzIiwicXVvdGUiLCJ4cyIsIm1hcCIsInMiLCJvcCIsInJlcGxhY2UiLCJ0ZXN0IiwiU3RyaW5nIiwiam9pbiIsIkNPTlRST0wiLCJNRVRBIiwiQkFSRVdPUkQiLCJTSU5HTEVfUVVPVEUiLCJET1VCTEVfUVVPVEUiLCJUT0tFTiIsImkiLCJNYXRoIiwicG93IiwicmFuZG9tIiwidG9TdHJpbmciLCJwYXJzZSIsImVudiIsIm9wdHMiLCJtYXBwZWQiLCJyZWR1Y2UiLCJhY2MiLCJjb25jYXQiLCJzcGxpdCIsIlJlZ0V4cCIsImxlbmd0aCIsImZpbHRlciIsIkJvb2xlYW4iLCJ4IiwiSlNPTiIsImNodW5rZXIiLCJtYXRjaCIsImNvbW1lbnRlZCIsImoiLCJjaGFyQXQiLCJjb21tZW50Iiwic3Vic3RyIiwic2xpY2UiLCJTUSIsIkRRIiwiRFMiLCJCUyIsImVzY2FwZSIsImVzYyIsIm91dCIsImlzR2xvYiIsImxlbiIsImMiLCJwYXJzZUVudlZhciIsInBhdHRlcm4iLCJ2YXJlbmQiLCJ2YXJuYW1lIiwiRXJyb3IiLCJpbmRleE9mIiwiaW5kZXgiLCJnZXRWYXIiLCJwcmV2IiwiYXJnIiwidW5kZWZpbmVkIiwiXyIsInByZSIsImtleSIsInIiLCJzdHJpbmdpZnkiXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBbUNBO0FBRUFBLE9BQU8sQ0FBQ0MsS0FBUixHQUFnQixVQUFVQyxFQUFWLEVBQWM7QUFDMUIsU0FBT0EsRUFBRSxDQUFDQyxHQUFILENBQU8sVUFBVUMsQ0FBVixFQUFhO0FBQ3ZCLFFBQUlBLENBQUMsSUFBSSxPQUFPQSxDQUFQLEtBQWEsUUFBdEIsRUFBZ0M7QUFDNUIsYUFBT0EsQ0FBQyxDQUFDQyxFQUFGLENBQUtDLE9BQUwsQ0FBYSxNQUFiLEVBQXFCLE1BQXJCLENBQVA7QUFDSCxLQUZELE1BR0ssSUFBSSxRQUFRQyxJQUFSLENBQWFILENBQWIsS0FBbUIsQ0FBQyxJQUFJRyxJQUFKLENBQVNILENBQVQsQ0FBeEIsRUFBcUM7QUFDdEMsYUFBTyxNQUFNQSxDQUFDLENBQUNFLE9BQUYsQ0FBVSxVQUFWLEVBQXNCLE1BQXRCLENBQU4sR0FBc0MsR0FBN0M7QUFDSCxLQUZJLE1BR0EsSUFBSSxTQUFTQyxJQUFULENBQWNILENBQWQsQ0FBSixFQUFzQjtBQUN2QixhQUFPLE1BQU1BLENBQUMsQ0FBQ0UsT0FBRixDQUFVLGFBQVYsRUFBeUIsTUFBekIsQ0FBTixHQUF5QyxHQUFoRDtBQUNILEtBRkksTUFHQTtBQUNELGFBQU9FLE1BQU0sQ0FBQ0osQ0FBRCxDQUFOLENBQVVFLE9BQVYsQ0FBa0IsbUNBQWxCLEVBQXVELE1BQXZELENBQVA7QUFDSDtBQUNKLEdBYk0sRUFhSkcsSUFiSSxDQWFDLEdBYkQsQ0FBUDtBQWNILENBZkQ7O0FBaUJBLElBQUlDLE9BQU8sR0FBRyxRQUFRLENBQ2xCLFFBRGtCLEVBQ1IsUUFEUSxFQUNFLElBREYsRUFDUSxRQURSLEVBQ2tCLFdBRGxCLEVBRXBCRCxJQUZvQixDQUVmLEdBRmUsQ0FBUixHQUVBLEdBRmQ7QUFHQSxJQUFJRSxJQUFJLEdBQUcsYUFBWDtBQUNBLElBQUlDLFFBQVEsR0FBRyxjQUFjRCxJQUFkLEdBQXFCLFlBQXJCLEdBQW9DQSxJQUFwQyxHQUEyQyxLQUExRDtBQUNBLElBQUlFLFlBQVksR0FBRyxvQkFBbkI7QUFDQSxJQUFJQyxZQUFZLEdBQUcsd0JBQW5CO0FBRUEsSUFBSUMsS0FBSyxHQUFHLEVBQVo7O0FBQ0EsS0FBSyxJQUFJQyxDQUFDLEdBQUcsQ0FBYixFQUFnQkEsQ0FBQyxHQUFHLENBQXBCLEVBQXVCQSxDQUFDLEVBQXhCLEVBQTRCO0FBQ3hCRCxFQUFBQSxLQUFLLElBQUksQ0FBQ0UsSUFBSSxDQUFDQyxHQUFMLENBQVMsRUFBVCxFQUFZLENBQVosSUFBZUQsSUFBSSxDQUFDRSxNQUFMLEVBQWhCLEVBQStCQyxRQUEvQixDQUF3QyxFQUF4QyxDQUFUO0FBQ0g7O0FBRURwQixPQUFPLENBQUNxQixLQUFSLEdBQWdCLFVBQVVqQixDQUFWLEVBQWFrQixHQUFiLEVBQWtCQyxJQUFsQixFQUF3QjtBQUNwQyxNQUFJQyxNQUFNLEdBQUdILEtBQUssQ0FBQ2pCLENBQUQsRUFBSWtCLEdBQUosRUFBU0MsSUFBVCxDQUFsQjtBQUNBLE1BQUksT0FBT0QsR0FBUCxLQUFlLFVBQW5CLEVBQStCLE9BQU9FLE1BQVA7QUFDL0IsU0FBT0EsTUFBTSxDQUFDQyxNQUFQLENBQWMsVUFBVUMsR0FBVixFQUFldEIsQ0FBZixFQUFrQjtBQUNuQyxRQUFJLE9BQU9BLENBQVAsS0FBYSxRQUFqQixFQUEyQixPQUFPc0IsR0FBRyxDQUFDQyxNQUFKLENBQVd2QixDQUFYLENBQVA7QUFDM0IsUUFBSUYsRUFBRSxHQUFHRSxDQUFDLENBQUN3QixLQUFGLENBQVFDLE1BQU0sQ0FBQyxNQUFNZCxLQUFOLEdBQWMsS0FBZCxHQUFzQkEsS0FBdEIsR0FBOEIsR0FBL0IsRUFBb0MsR0FBcEMsQ0FBZCxDQUFUO0FBQ0EsUUFBSWIsRUFBRSxDQUFDNEIsTUFBSCxLQUFjLENBQWxCLEVBQXFCLE9BQU9KLEdBQUcsQ0FBQ0MsTUFBSixDQUFXekIsRUFBRSxDQUFDLENBQUQsQ0FBYixDQUFQO0FBQ3JCLFdBQU93QixHQUFHLENBQUNDLE1BQUosQ0FBV3pCLEVBQUUsQ0FBQzZCLE1BQUgsQ0FBVUMsT0FBVixFQUFtQjdCLEdBQW5CLENBQXVCLFVBQVU4QixDQUFWLEVBQWE7QUFDbEQsVUFBSUosTUFBTSxDQUFDLE1BQU1kLEtBQVAsQ0FBTixDQUFvQlIsSUFBcEIsQ0FBeUIwQixDQUF6QixDQUFKLEVBQWlDO0FBQzdCLGVBQU9DLElBQUksQ0FBQ2IsS0FBTCxDQUFXWSxDQUFDLENBQUNMLEtBQUYsQ0FBUWIsS0FBUixFQUFlLENBQWYsQ0FBWCxDQUFQO0FBQXVDLE9BRDNDLE1BRUssT0FBT2tCLENBQVA7QUFDUixLQUppQixDQUFYLENBQVA7QUFLSCxHQVRNLEVBU0osRUFUSSxDQUFQO0FBVUgsQ0FiRDs7QUFlQSxTQUFTWixLQUFULENBQWdCakIsQ0FBaEIsRUFBbUJrQixHQUFuQixFQUF3QkMsSUFBeEIsRUFBOEI7QUFDMUIsTUFBSVksT0FBTyxHQUFHLElBQUlOLE1BQUosQ0FBVyxDQUNyQixNQUFNbkIsT0FBTixHQUFnQixHQURLLEVBQ0E7QUFDckIsUUFBTUUsUUFBTixHQUFpQixHQUFqQixHQUF1QkMsWUFBdkIsR0FBc0MsR0FBdEMsR0FBNENDLFlBQTVDLEdBQTJELElBRnRDLEVBR3ZCTCxJQUh1QixDQUdsQixHQUhrQixDQUFYLEVBR0QsR0FIQyxDQUFkO0FBSUEsTUFBSTJCLEtBQUssR0FBR2hDLENBQUMsQ0FBQ2dDLEtBQUYsQ0FBUUQsT0FBUixFQUFpQkosTUFBakIsQ0FBd0JDLE9BQXhCLENBQVo7QUFDQSxNQUFJSyxTQUFTLEdBQUcsS0FBaEI7QUFFQSxNQUFJLENBQUNELEtBQUwsRUFBWSxPQUFPLEVBQVA7QUFDWixNQUFJLENBQUNkLEdBQUwsRUFBVUEsR0FBRyxHQUFHLEVBQU47QUFDVixNQUFJLENBQUNDLElBQUwsRUFBV0EsSUFBSSxHQUFHLEVBQVA7QUFDWCxTQUFPYSxLQUFLLENBQUNqQyxHQUFOLENBQVUsVUFBVUMsQ0FBVixFQUFha0MsQ0FBYixFQUFnQjtBQUM3QixRQUFJRCxTQUFKLEVBQWU7QUFDWDtBQUNIOztBQUNELFFBQUlqQyxDQUFDLENBQUNtQyxNQUFGLENBQVMsQ0FBVCxNQUFnQixHQUFwQixFQUF5QjtBQUNyQkYsTUFBQUEsU0FBUyxHQUFHLElBQVo7QUFDQSxhQUFPO0FBQUVHLFFBQUFBLE9BQU8sRUFBRXBDLENBQUMsQ0FBQ3FDLE1BQUYsQ0FBUyxDQUFULElBQWNMLEtBQUssQ0FBQ00sS0FBTixDQUFZSixDQUFDLEdBQUMsQ0FBZCxFQUFpQjdCLElBQWpCLENBQXNCLEdBQXRCO0FBQXpCLE9BQVA7QUFDSDs7QUFDRCxRQUFJb0IsTUFBTSxDQUFDLE1BQU1uQixPQUFOLEdBQWdCLEdBQWpCLENBQU4sQ0FBNEJILElBQTVCLENBQWlDSCxDQUFqQyxDQUFKLEVBQXlDO0FBQ3JDLGFBQU87QUFBRUMsUUFBQUEsRUFBRSxFQUFFRDtBQUFOLE9BQVA7QUFDSCxLQVY0QixDQVk3QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUFDQSxRQUFJdUMsRUFBRSxHQUFHLEdBQVQ7QUFDQSxRQUFJQyxFQUFFLEdBQUcsR0FBVDtBQUNBLFFBQUlDLEVBQUUsR0FBRyxHQUFUO0FBQ0EsUUFBSUMsRUFBRSxHQUFHdkIsSUFBSSxDQUFDd0IsTUFBTCxJQUFlLElBQXhCO0FBQ0EsUUFBSTlDLEtBQUssR0FBRyxLQUFaO0FBQ0EsUUFBSStDLEdBQUcsR0FBRyxLQUFWO0FBQ0EsUUFBSUMsR0FBRyxHQUFHLEVBQVY7QUFDQSxRQUFJQyxNQUFNLEdBQUcsS0FBYjs7QUFFQSxTQUFLLElBQUlsQyxDQUFDLEdBQUcsQ0FBUixFQUFXbUMsR0FBRyxHQUFHL0MsQ0FBQyxDQUFDMEIsTUFBeEIsRUFBZ0NkLENBQUMsR0FBR21DLEdBQXBDLEVBQXlDbkMsQ0FBQyxFQUExQyxFQUE4QztBQUMxQyxVQUFJb0MsQ0FBQyxHQUFHaEQsQ0FBQyxDQUFDbUMsTUFBRixDQUFTdkIsQ0FBVCxDQUFSO0FBQ0FrQyxNQUFBQSxNQUFNLEdBQUdBLE1BQU0sSUFBSyxDQUFDakQsS0FBRCxLQUFXbUQsQ0FBQyxLQUFLLEdBQU4sSUFBYUEsQ0FBQyxLQUFLLEdBQTlCLENBQXBCOztBQUNBLFVBQUlKLEdBQUosRUFBUztBQUNMQyxRQUFBQSxHQUFHLElBQUlHLENBQVA7QUFDQUosUUFBQUEsR0FBRyxHQUFHLEtBQU47QUFDSCxPQUhELE1BSUssSUFBSS9DLEtBQUosRUFBVztBQUNaLFlBQUltRCxDQUFDLEtBQUtuRCxLQUFWLEVBQWlCO0FBQ2JBLFVBQUFBLEtBQUssR0FBRyxLQUFSO0FBQ0gsU0FGRCxNQUdLLElBQUlBLEtBQUssSUFBSTBDLEVBQWIsRUFBaUI7QUFDbEJNLFVBQUFBLEdBQUcsSUFBSUcsQ0FBUDtBQUNILFNBRkksTUFHQTtBQUFFO0FBQ0gsY0FBSUEsQ0FBQyxLQUFLTixFQUFWLEVBQWM7QUFDVjlCLFlBQUFBLENBQUMsSUFBSSxDQUFMO0FBQ0FvQyxZQUFBQSxDQUFDLEdBQUdoRCxDQUFDLENBQUNtQyxNQUFGLENBQVN2QixDQUFULENBQUo7O0FBQ0EsZ0JBQUlvQyxDQUFDLEtBQUtSLEVBQU4sSUFBWVEsQ0FBQyxLQUFLTixFQUFsQixJQUF3Qk0sQ0FBQyxLQUFLUCxFQUFsQyxFQUFzQztBQUNsQ0ksY0FBQUEsR0FBRyxJQUFJRyxDQUFQO0FBQ0gsYUFGRCxNQUVPO0FBQ0hILGNBQUFBLEdBQUcsSUFBSUgsRUFBRSxHQUFHTSxDQUFaO0FBQ0g7QUFDSixXQVJELE1BU0ssSUFBSUEsQ0FBQyxLQUFLUCxFQUFWLEVBQWM7QUFDZkksWUFBQUEsR0FBRyxJQUFJSSxXQUFXLEVBQWxCO0FBQ0gsV0FGSSxNQUdBO0FBQ0RKLFlBQUFBLEdBQUcsSUFBSUcsQ0FBUDtBQUNIO0FBQ0o7QUFDSixPQXhCSSxNQXlCQSxJQUFJQSxDQUFDLEtBQUtSLEVBQU4sSUFBWVEsQ0FBQyxLQUFLVCxFQUF0QixFQUEwQjtBQUMzQjFDLFFBQUFBLEtBQUssR0FBR21ELENBQVI7QUFDSCxPQUZJLE1BR0EsSUFBSXZCLE1BQU0sQ0FBQyxNQUFNbkIsT0FBTixHQUFnQixHQUFqQixDQUFOLENBQTRCSCxJQUE1QixDQUFpQzZDLENBQWpDLENBQUosRUFBeUM7QUFDMUMsZUFBTztBQUFFL0MsVUFBQUEsRUFBRSxFQUFFRDtBQUFOLFNBQVA7QUFDSCxPQUZJLE1BR0EsSUFBSWdELENBQUMsS0FBS04sRUFBVixFQUFjO0FBQ2ZFLFFBQUFBLEdBQUcsR0FBRyxJQUFOO0FBQ0gsT0FGSSxNQUdBLElBQUlJLENBQUMsS0FBS1AsRUFBVixFQUFjO0FBQ2ZJLFFBQUFBLEdBQUcsSUFBSUksV0FBVyxFQUFsQjtBQUNILE9BRkksTUFHQUosR0FBRyxJQUFJRyxDQUFQO0FBQ1I7O0FBRUQsUUFBSUYsTUFBSixFQUFZLE9BQU87QUFBQzdDLE1BQUFBLEVBQUUsRUFBRSxNQUFMO0FBQWFpRCxNQUFBQSxPQUFPLEVBQUVMO0FBQXRCLEtBQVA7QUFFWixXQUFPQSxHQUFQOztBQUVBLGFBQVNJLFdBQVQsR0FBdUI7QUFDbkJyQyxNQUFBQSxDQUFDLElBQUksQ0FBTDtBQUNBLFVBQUl1QyxNQUFKLEVBQVlDLE9BQVosQ0FGbUIsQ0FHbkI7O0FBQ0EsVUFBSXBELENBQUMsQ0FBQ21DLE1BQUYsQ0FBU3ZCLENBQVQsTUFBZ0IsR0FBcEIsRUFBeUI7QUFDckJBLFFBQUFBLENBQUMsSUFBSSxDQUFMOztBQUNBLFlBQUlaLENBQUMsQ0FBQ21DLE1BQUYsQ0FBU3ZCLENBQVQsTUFBZ0IsR0FBcEIsRUFBeUI7QUFDckIsZ0JBQU0sSUFBSXlDLEtBQUosQ0FBVSx1QkFBdUJyRCxDQUFDLENBQUNxQyxNQUFGLENBQVN6QixDQUFDLEdBQUcsQ0FBYixFQUFnQixDQUFoQixDQUFqQyxDQUFOO0FBQ0g7O0FBQ0R1QyxRQUFBQSxNQUFNLEdBQUduRCxDQUFDLENBQUNzRCxPQUFGLENBQVUsR0FBVixFQUFlMUMsQ0FBZixDQUFUOztBQUNBLFlBQUl1QyxNQUFNLEdBQUcsQ0FBYixFQUFnQjtBQUNaLGdCQUFNLElBQUlFLEtBQUosQ0FBVSx1QkFBdUJyRCxDQUFDLENBQUNxQyxNQUFGLENBQVN6QixDQUFULENBQWpDLENBQU47QUFDSDs7QUFDRHdDLFFBQUFBLE9BQU8sR0FBR3BELENBQUMsQ0FBQ3FDLE1BQUYsQ0FBU3pCLENBQVQsRUFBWXVDLE1BQU0sR0FBR3ZDLENBQXJCLENBQVY7QUFDQUEsUUFBQUEsQ0FBQyxHQUFHdUMsTUFBSjtBQUNILE9BWEQsTUFZSyxJQUFJLGNBQWNoRCxJQUFkLENBQW1CSCxDQUFDLENBQUNtQyxNQUFGLENBQVN2QixDQUFULENBQW5CLENBQUosRUFBcUM7QUFDdEN3QyxRQUFBQSxPQUFPLEdBQUdwRCxDQUFDLENBQUNtQyxNQUFGLENBQVN2QixDQUFULENBQVY7QUFDQUEsUUFBQUEsQ0FBQyxJQUFJLENBQUw7QUFDSCxPQUhJLE1BSUE7QUFDRHVDLFFBQUFBLE1BQU0sR0FBR25ELENBQUMsQ0FBQ3FDLE1BQUYsQ0FBU3pCLENBQVQsRUFBWW9CLEtBQVosQ0FBa0IsVUFBbEIsQ0FBVDs7QUFDQSxZQUFJLENBQUNtQixNQUFMLEVBQWE7QUFDVEMsVUFBQUEsT0FBTyxHQUFHcEQsQ0FBQyxDQUFDcUMsTUFBRixDQUFTekIsQ0FBVCxDQUFWO0FBQ0FBLFVBQUFBLENBQUMsR0FBR1osQ0FBQyxDQUFDMEIsTUFBTjtBQUNILFNBSEQsTUFHTztBQUNIMEIsVUFBQUEsT0FBTyxHQUFHcEQsQ0FBQyxDQUFDcUMsTUFBRixDQUFTekIsQ0FBVCxFQUFZdUMsTUFBTSxDQUFDSSxLQUFuQixDQUFWO0FBQ0EzQyxVQUFBQSxDQUFDLElBQUl1QyxNQUFNLENBQUNJLEtBQVAsR0FBZSxDQUFwQjtBQUNIO0FBQ0o7O0FBQ0QsYUFBT0MsTUFBTSxDQUFDLElBQUQsRUFBTyxFQUFQLEVBQVdKLE9BQVgsQ0FBYjtBQUNIO0FBQ0osR0FuSE0sRUFvSFA7QUFwSE8sR0FxSE4vQixNQXJITSxDQXFIQyxVQUFTb0MsSUFBVCxFQUFlQyxHQUFmLEVBQW1CO0FBQ3ZCLFFBQUlBLEdBQUcsS0FBS0MsU0FBWixFQUFzQjtBQUNsQixhQUFPRixJQUFQO0FBQ0g7O0FBQ0QsV0FBT0EsSUFBSSxDQUFDbEMsTUFBTCxDQUFZbUMsR0FBWixDQUFQO0FBQ0gsR0ExSE0sRUEwSEwsRUExSEssQ0FBUDs7QUE0SEEsV0FBU0YsTUFBVCxDQUFpQkksQ0FBakIsRUFBb0JDLEdBQXBCLEVBQXlCQyxHQUF6QixFQUE4QjtBQUMxQixRQUFJQyxDQUFDLEdBQUcsT0FBTzdDLEdBQVAsS0FBZSxVQUFmLEdBQTRCQSxHQUFHLENBQUM0QyxHQUFELENBQS9CLEdBQXVDNUMsR0FBRyxDQUFDNEMsR0FBRCxDQUFsRDtBQUNBLFFBQUlDLENBQUMsS0FBS0osU0FBVixFQUFxQkksQ0FBQyxHQUFHLEVBQUo7O0FBRXJCLFFBQUksT0FBT0EsQ0FBUCxLQUFhLFFBQWpCLEVBQTJCO0FBQ3ZCLGFBQU9GLEdBQUcsR0FBR2xELEtBQU4sR0FBY21CLElBQUksQ0FBQ2tDLFNBQUwsQ0FBZUQsQ0FBZixDQUFkLEdBQWtDcEQsS0FBekM7QUFDSCxLQUZELE1BR0ssT0FBT2tELEdBQUcsR0FBR0UsQ0FBYjtBQUNSO0FBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuTW9kaWZpZWQgZnJvbSBodHRwczovL2dpdGh1Yi5jb20vc3Vic3RhY2svbm9kZS1zaGVsbC1xdW90ZS9jb21taXQvNzJmYjVhOC5cclxuSW5jbHVkZXMgaHR0cHM6Ly9naXRodWIuY29tL3N1YnN0YWNrL25vZGUtc2hlbGwtcXVvdGUvcHVsbC8yOSwgd2l0aCBtaW5vclxyXG5tb2RpZmljYXRpb25zIHRvIHJlbW92ZSB0aGUgdW5uZWNlc3NhcnkgQXJyYXkgcG9seWZpbGxzLlxyXG5cclxuVXNlIHRoZSB0eXBlZCB3cmFwcGVycyBpbiAuL3N0cmluZy5qcyB0byBhY2Nlc3MgdGhlc2UgZnVuY3Rpb25zLlxyXG5cclxuVGhlIE1JVCBMaWNlbnNlXHJcblxyXG5Db3B5cmlnaHQgKGMpIDIwMTMgSmFtZXMgSGFsbGlkYXkgKG1haWxAc3Vic3RhY2submV0KVxyXG5cclxuUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsXHJcbnRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZFxyXG5hc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0b1xyXG5kZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmdcclxud2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksXHJcbm1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxyXG5jb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbVxyXG50aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLFxyXG5zdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcclxuXHJcblRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlXHJcbnNoYWxsIGJlIGluY2x1ZGVkIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxyXG5cclxuVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCxcclxuRVhQUkVTUyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTXHJcbk9GIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC5cclxuSU4gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUlxyXG5BTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCxcclxuVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEVcclxuU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuXHJcblxyXG5Abm9mbG93XHJcbiovXHJcblxyXG4vKiBlc2xpbnQtZGlzYWJsZSAqL1xyXG5cclxuZXhwb3J0cy5xdW90ZSA9IGZ1bmN0aW9uICh4cykge1xyXG4gICAgcmV0dXJuIHhzLm1hcChmdW5jdGlvbiAocykge1xyXG4gICAgICAgIGlmIChzICYmIHR5cGVvZiBzID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICByZXR1cm4gcy5vcC5yZXBsYWNlKC8oLikvZywgJ1xcXFwkMScpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmICgvW1wiXFxzXS8udGVzdChzKSAmJiAhLycvLnRlc3QocykpIHtcclxuICAgICAgICAgICAgcmV0dXJuIFwiJ1wiICsgcy5yZXBsYWNlKC8oWydcXFxcXSkvZywgJ1xcXFwkMScpICsgXCInXCI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgaWYgKC9bXCInXFxzXS8udGVzdChzKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gJ1wiJyArIHMucmVwbGFjZSgvKFtcIlxcXFwkYCFdKS9nLCAnXFxcXCQxJykgKyAnXCInO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIFN0cmluZyhzKS5yZXBsYWNlKC8oWyMhXCIkJicoKSosOjs8PT4/QFxcW1xcXFxcXF1eYHt8fV0pL2csICdcXFxcJDEnKTtcclxuICAgICAgICB9XHJcbiAgICB9KS5qb2luKCcgJyk7XHJcbn07XHJcblxyXG52YXIgQ09OVFJPTCA9ICcoPzonICsgW1xyXG4gICAgJ1xcXFx8XFxcXHwnLCAnXFxcXCZcXFxcJicsICc7OycsICdcXFxcfFxcXFwmJywgJ1smOygpfDw+XSdcclxuXS5qb2luKCd8JykgKyAnKSc7XHJcbnZhciBNRVRBID0gJ3wmOygpPD4gXFxcXHQnO1xyXG52YXIgQkFSRVdPUkQgPSAnKFxcXFxcXFxcW1xcJ1wiJyArIE1FVEEgKyAnXXxbXlxcXFxzXFwnXCInICsgTUVUQSArICddKSsnO1xyXG52YXIgU0lOR0xFX1FVT1RFID0gJ1wiKChcXFxcXFxcXFwifFteXCJdKSo/KVwiJztcclxudmFyIERPVUJMRV9RVU9URSA9ICdcXCcoKFxcXFxcXFxcXFwnfFteXFwnXSkqPylcXCcnO1xyXG5cclxudmFyIFRPS0VOID0gJyc7XHJcbmZvciAodmFyIGkgPSAwOyBpIDwgNDsgaSsrKSB7XHJcbiAgICBUT0tFTiArPSAoTWF0aC5wb3coMTYsOCkqTWF0aC5yYW5kb20oKSkudG9TdHJpbmcoMTYpO1xyXG59XHJcblxyXG5leHBvcnRzLnBhcnNlID0gZnVuY3Rpb24gKHMsIGVudiwgb3B0cykge1xyXG4gICAgdmFyIG1hcHBlZCA9IHBhcnNlKHMsIGVudiwgb3B0cyk7XHJcbiAgICBpZiAodHlwZW9mIGVudiAhPT0gJ2Z1bmN0aW9uJykgcmV0dXJuIG1hcHBlZDtcclxuICAgIHJldHVybiBtYXBwZWQucmVkdWNlKGZ1bmN0aW9uIChhY2MsIHMpIHtcclxuICAgICAgICBpZiAodHlwZW9mIHMgPT09ICdvYmplY3QnKSByZXR1cm4gYWNjLmNvbmNhdChzKTtcclxuICAgICAgICB2YXIgeHMgPSBzLnNwbGl0KFJlZ0V4cCgnKCcgKyBUT0tFTiArICcuKj8nICsgVE9LRU4gKyAnKScsICdnJykpO1xyXG4gICAgICAgIGlmICh4cy5sZW5ndGggPT09IDEpIHJldHVybiBhY2MuY29uY2F0KHhzWzBdKTtcclxuICAgICAgICByZXR1cm4gYWNjLmNvbmNhdCh4cy5maWx0ZXIoQm9vbGVhbikubWFwKGZ1bmN0aW9uICh4KSB7XHJcbiAgICAgICAgICAgIGlmIChSZWdFeHAoJ14nICsgVE9LRU4pLnRlc3QoeCkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKHguc3BsaXQoVE9LRU4pWzFdKTsgfVxyXG4gICAgICAgICAgICBlbHNlIHJldHVybiB4O1xyXG4gICAgICAgIH0pKTtcclxuICAgIH0sIFtdKTtcclxufTtcclxuXHJcbmZ1bmN0aW9uIHBhcnNlIChzLCBlbnYsIG9wdHMpIHtcclxuICAgIHZhciBjaHVua2VyID0gbmV3IFJlZ0V4cChbXHJcbiAgICAgICAgJygnICsgQ09OVFJPTCArICcpJywgLy8gY29udHJvbCBjaGFyc1xyXG4gICAgICAgICcoJyArIEJBUkVXT1JEICsgJ3wnICsgU0lOR0xFX1FVT1RFICsgJ3wnICsgRE9VQkxFX1FVT1RFICsgJykqJ1xyXG4gICAgXS5qb2luKCd8JyksICdnJyk7XHJcbiAgICB2YXIgbWF0Y2ggPSBzLm1hdGNoKGNodW5rZXIpLmZpbHRlcihCb29sZWFuKTtcclxuICAgIHZhciBjb21tZW50ZWQgPSBmYWxzZTtcclxuXHJcbiAgICBpZiAoIW1hdGNoKSByZXR1cm4gW107XHJcbiAgICBpZiAoIWVudikgZW52ID0ge307XHJcbiAgICBpZiAoIW9wdHMpIG9wdHMgPSB7fTtcclxuICAgIHJldHVybiBtYXRjaC5tYXAoZnVuY3Rpb24gKHMsIGopIHtcclxuICAgICAgICBpZiAoY29tbWVudGVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHMuY2hhckF0KDApID09PSAnIycpIHtcclxuICAgICAgICAgICAgY29tbWVudGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgcmV0dXJuIHsgY29tbWVudDogcy5zdWJzdHIoMSkgKyBtYXRjaC5zbGljZShqKzEpLmpvaW4oJyAnKSB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoUmVnRXhwKCdeJyArIENPTlRST0wgKyAnJCcpLnRlc3QocykpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHsgb3A6IHMgfTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIEhhbmQtd3JpdHRlbiBzY2FubmVyL3BhcnNlciBmb3IgQmFzaCBxdW90aW5nIHJ1bGVzOlxyXG4gICAgICAgIC8vXHJcbiAgICAgICAgLy8gIDEuIGluc2lkZSBzaW5nbGUgcXVvdGVzLCBhbGwgY2hhcmFjdGVycyBhcmUgcHJpbnRlZCBsaXRlcmFsbHkuXHJcbiAgICAgICAgLy8gIDIuIGluc2lkZSBkb3VibGUgcXVvdGVzLCBhbGwgY2hhcmFjdGVycyBhcmUgcHJpbnRlZCBsaXRlcmFsbHlcclxuICAgICAgICAvLyAgICAgZXhjZXB0IHZhcmlhYmxlcyBwcmVmaXhlZCBieSAnJCcgYW5kIGJhY2tzbGFzaGVzIGZvbGxvd2VkIGJ5XHJcbiAgICAgICAgLy8gICAgIGVpdGhlciBhIGRvdWJsZSBxdW90ZSBvciBhbm90aGVyIGJhY2tzbGFzaC5cclxuICAgICAgICAvLyAgMy4gb3V0c2lkZSBvZiBhbnkgcXVvdGVzLCBiYWNrc2xhc2hlcyBhcmUgdHJlYXRlZCBhcyBlc2NhcGVcclxuICAgICAgICAvLyAgICAgY2hhcmFjdGVycyBhbmQgbm90IHByaW50ZWQgKHVubGVzcyB0aGV5IGFyZSB0aGVtc2VsdmVzIGVzY2FwZWQpXHJcbiAgICAgICAgLy8gIDQuIHF1b3RlIGNvbnRleHQgY2FuIHN3aXRjaCBtaWQtdG9rZW4gaWYgdGhlcmUgaXMgbm8gd2hpdGVzcGFjZVxyXG4gICAgICAgIC8vICAgICBiZXR3ZWVuIHRoZSB0d28gcXVvdGUgY29udGV4dHMgKGUuZy4gYWxsJ29uZSdcInRva2VuXCIgcGFyc2VzIGFzXHJcbiAgICAgICAgLy8gICAgIFwiYWxsb25ldG9rZW5cIilcclxuICAgICAgICB2YXIgU1EgPSBcIidcIjtcclxuICAgICAgICB2YXIgRFEgPSAnXCInO1xyXG4gICAgICAgIHZhciBEUyA9ICckJztcclxuICAgICAgICB2YXIgQlMgPSBvcHRzLmVzY2FwZSB8fCAnXFxcXCc7XHJcbiAgICAgICAgdmFyIHF1b3RlID0gZmFsc2U7XHJcbiAgICAgICAgdmFyIGVzYyA9IGZhbHNlO1xyXG4gICAgICAgIHZhciBvdXQgPSAnJztcclxuICAgICAgICB2YXIgaXNHbG9iID0gZmFsc2U7XHJcblxyXG4gICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XHJcbiAgICAgICAgICAgIHZhciBjID0gcy5jaGFyQXQoaSk7XHJcbiAgICAgICAgICAgIGlzR2xvYiA9IGlzR2xvYiB8fCAoIXF1b3RlICYmIChjID09PSAnKicgfHwgYyA9PT0gJz8nKSk7XHJcbiAgICAgICAgICAgIGlmIChlc2MpIHtcclxuICAgICAgICAgICAgICAgIG91dCArPSBjO1xyXG4gICAgICAgICAgICAgICAgZXNjID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAocXVvdGUpIHtcclxuICAgICAgICAgICAgICAgIGlmIChjID09PSBxdW90ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHF1b3RlID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIGlmIChxdW90ZSA9PSBTUSkge1xyXG4gICAgICAgICAgICAgICAgICAgIG91dCArPSBjO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7IC8vIERvdWJsZSBxdW90ZVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjID09PSBCUykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpICs9IDE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGMgPSBzLmNoYXJBdChpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGMgPT09IERRIHx8IGMgPT09IEJTIHx8IGMgPT09IERTKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXQgKz0gYztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dCArPSBCUyArIGM7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYyA9PT0gRFMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb3V0ICs9IHBhcnNlRW52VmFyKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvdXQgKz0gYztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAoYyA9PT0gRFEgfHwgYyA9PT0gU1EpIHtcclxuICAgICAgICAgICAgICAgIHF1b3RlID0gYztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmIChSZWdFeHAoJ14nICsgQ09OVFJPTCArICckJykudGVzdChjKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgb3A6IHMgfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmIChjID09PSBCUykge1xyXG4gICAgICAgICAgICAgICAgZXNjID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmIChjID09PSBEUykge1xyXG4gICAgICAgICAgICAgICAgb3V0ICs9IHBhcnNlRW52VmFyKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBvdXQgKz0gYztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChpc0dsb2IpIHJldHVybiB7b3A6ICdnbG9iJywgcGF0dGVybjogb3V0fTtcclxuXHJcbiAgICAgICAgcmV0dXJuIG91dDtcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gcGFyc2VFbnZWYXIoKSB7XHJcbiAgICAgICAgICAgIGkgKz0gMTtcclxuICAgICAgICAgICAgdmFyIHZhcmVuZCwgdmFybmFtZTtcclxuICAgICAgICAgICAgLy9kZWJ1Z2dlclxyXG4gICAgICAgICAgICBpZiAocy5jaGFyQXQoaSkgPT09ICd7Jykge1xyXG4gICAgICAgICAgICAgICAgaSArPSAxO1xyXG4gICAgICAgICAgICAgICAgaWYgKHMuY2hhckF0KGkpID09PSAnfScpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJCYWQgc3Vic3RpdHV0aW9uOiBcIiArIHMuc3Vic3RyKGkgLSAyLCAzKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB2YXJlbmQgPSBzLmluZGV4T2YoJ30nLCBpKTtcclxuICAgICAgICAgICAgICAgIGlmICh2YXJlbmQgPCAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQmFkIHN1YnN0aXR1dGlvbjogXCIgKyBzLnN1YnN0cihpKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB2YXJuYW1lID0gcy5zdWJzdHIoaSwgdmFyZW5kIC0gaSk7XHJcbiAgICAgICAgICAgICAgICBpID0gdmFyZW5kO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKC9bKkAjPyQhX1xcLV0vLnRlc3Qocy5jaGFyQXQoaSkpKSB7XHJcbiAgICAgICAgICAgICAgICB2YXJuYW1lID0gcy5jaGFyQXQoaSk7XHJcbiAgICAgICAgICAgICAgICBpICs9IDE7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB2YXJlbmQgPSBzLnN1YnN0cihpKS5tYXRjaCgvW15cXHdcXGRfXS8pO1xyXG4gICAgICAgICAgICAgICAgaWYgKCF2YXJlbmQpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXJuYW1lID0gcy5zdWJzdHIoaSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaSA9IHMubGVuZ3RoO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXJuYW1lID0gcy5zdWJzdHIoaSwgdmFyZW5kLmluZGV4KTtcclxuICAgICAgICAgICAgICAgICAgICBpICs9IHZhcmVuZC5pbmRleCAtIDE7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGdldFZhcihudWxsLCAnJywgdmFybmFtZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSlcclxuICAgIC8vIGZpbmFsaXplIHBhcnNlZCBhcnVtZW50c1xyXG4gICAgLnJlZHVjZShmdW5jdGlvbihwcmV2LCBhcmcpe1xyXG4gICAgICAgIGlmIChhcmcgPT09IHVuZGVmaW5lZCl7XHJcbiAgICAgICAgICAgIHJldHVybiBwcmV2O1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcHJldi5jb25jYXQoYXJnKTtcclxuICAgIH0sW10pO1xyXG5cclxuICAgIGZ1bmN0aW9uIGdldFZhciAoXywgcHJlLCBrZXkpIHtcclxuICAgICAgICB2YXIgciA9IHR5cGVvZiBlbnYgPT09ICdmdW5jdGlvbicgPyBlbnYoa2V5KSA6IGVudltrZXldO1xyXG4gICAgICAgIGlmIChyID09PSB1bmRlZmluZWQpIHIgPSAnJztcclxuXHJcbiAgICAgICAgaWYgKHR5cGVvZiByID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICByZXR1cm4gcHJlICsgVE9LRU4gKyBKU09OLnN0cmluZ2lmeShyKSArIFRPS0VOO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHJldHVybiBwcmUgKyByO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==