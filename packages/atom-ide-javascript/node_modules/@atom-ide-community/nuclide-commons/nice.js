"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.niceSafeSpawn = niceSafeSpawn;
exports.niceObserveProcess = niceObserveProcess;

var _lruCache = _interopRequireDefault(require("lru-cache"));

var _rxjsCompatUmdMin = require("rxjs-compat/bundles/rxjs-compat.umd.min.js");

var _which = _interopRequireDefault(require("./which"));

var _process = require("./process");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */
const NICE_COMMAND = 'nice';
const IONICE_COMMAND = 'ionice';

async function niceSafeSpawn(command, args, execOptions) {
  const nicified = await nicifyCommand(command, args, execOptions);
  const processStream = (0, _process.spawn)(...nicified).publish();
  const processPromise = processStream.take(1).toPromise();
  processStream.connect();
  return processPromise;
}
/**
 * Takes the arguments that you would normally pass to `spawn()` and returns an array of new
 * arguments to use to run the command under `nice`.
 *
 * Example:
 *
 * ```js
 * observeProcess(...(await nicifyCommand('hg', ['diff']))).subscribe(...);
 * ```
 *
 * See also `scriptifyCommand()` which does a similar thing but for `script`.
 */


async function nicifyCommand(command, args, options) {
  const fullArgs = [command, ...(args || [])];

  if (await hasNiceCommand()) {
    fullArgs.unshift(NICE_COMMAND);
  }

  if (await hasIoniceCommand()) {
    // Leave the process in the Best Effort class (default), but set it to the lowest priority for
    // that class. Priorities range from 0-7 with 4 as the default and lower numbers representing
    // higher priorities.
    //
    // See `man ionice` or http://linux.die.net/man/1/ionice
    //
    // It's not specified by POSIX like `nice` is but since it is included in util-linux which is
    // relatively core
    // (https://git.kernel.org/cgit/utils/util-linux/util-linux.git/tree/schedutils/ionice.c), I
    // think we can assume that it uses this interface if it exists.
    fullArgs.unshift(IONICE_COMMAND, '-n', '7');
  }

  return [fullArgs[0], fullArgs.slice(1), options];
}

const commandAvailabilityCache = (0, _lruCache.default)({
  max: 10,
  // Realistically this will not change very often so we can cache for long periods of time. We
  // probably could just check at startup and get away with it, but maybe someone will install
  // `ionice` and it would be nice to pick that up.
  maxAge: 1000 * 60 * 5 // 5 minutes

});

function hasNiceCommand() {
  return hasCommand(NICE_COMMAND);
}

function hasIoniceCommand() {
  return hasCommand(IONICE_COMMAND);
}

function hasCommand(command) {
  let result = commandAvailabilityCache.get(command);

  if (result == null) {
    result = (0, _which.default)(command).then(x => x != null);
    commandAvailabilityCache.set(command, result);
  }

  return result;
}

function niceObserveProcess(command, args, options) {
  return _rxjsCompatUmdMin.Observable.defer(() => nicifyCommand(command, args, options)).switchMap(spawnArgs => (0, _process.observeProcess)(...spawnArgs));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1jb21tb25zL25pY2UuanMiXSwibmFtZXMiOlsiTklDRV9DT01NQU5EIiwiSU9OSUNFX0NPTU1BTkQiLCJuaWNlU2FmZVNwYXduIiwiY29tbWFuZCIsImFyZ3MiLCJleGVjT3B0aW9ucyIsIm5pY2lmaWVkIiwibmljaWZ5Q29tbWFuZCIsInByb2Nlc3NTdHJlYW0iLCJwdWJsaXNoIiwicHJvY2Vzc1Byb21pc2UiLCJ0YWtlIiwidG9Qcm9taXNlIiwiY29ubmVjdCIsIm9wdGlvbnMiLCJmdWxsQXJncyIsImhhc05pY2VDb21tYW5kIiwidW5zaGlmdCIsImhhc0lvbmljZUNvbW1hbmQiLCJzbGljZSIsImNvbW1hbmRBdmFpbGFiaWxpdHlDYWNoZSIsIm1heCIsIm1heEFnZSIsImhhc0NvbW1hbmQiLCJyZXN1bHQiLCJnZXQiLCJ0aGVuIiwieCIsInNldCIsIm5pY2VPYnNlcnZlUHJvY2VzcyIsIk9ic2VydmFibGUiLCJkZWZlciIsInN3aXRjaE1hcCIsInNwYXduQXJncyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFlQTs7QUFDQTs7QUFFQTs7QUFDQTs7OztBQW5CQTs7Ozs7Ozs7Ozs7QUFxQkEsTUFBTUEsWUFBWSxHQUFHLE1BQXJCO0FBQ0EsTUFBTUMsY0FBYyxHQUFHLFFBQXZCOztBQUVPLGVBQWVDLGFBQWYsQ0FDTEMsT0FESyxFQUVMQyxJQUZLLEVBR0xDLFdBSEssRUFJZ0M7QUFDckMsUUFBTUMsUUFBUSxHQUFHLE1BQU1DLGFBQWEsQ0FBQ0osT0FBRCxFQUFVQyxJQUFWLEVBQWdCQyxXQUFoQixDQUFwQztBQUNBLFFBQU1HLGFBQWEsR0FBRyxvQkFBTSxHQUFHRixRQUFULEVBQW1CRyxPQUFuQixFQUF0QjtBQUNBLFFBQU1DLGNBQWMsR0FBR0YsYUFBYSxDQUFDRyxJQUFkLENBQW1CLENBQW5CLEVBQXNCQyxTQUF0QixFQUF2QjtBQUNBSixFQUFBQSxhQUFhLENBQUNLLE9BQWQ7QUFDQSxTQUFPSCxjQUFQO0FBQ0Q7QUFFRDs7Ozs7Ozs7Ozs7Ozs7QUFZQSxlQUFlSCxhQUFmLENBQ0VKLE9BREYsRUFFRUMsSUFGRixFQUdFVSxPQUhGLEVBSXVDO0FBQ3JDLFFBQU1DLFFBQVEsR0FBRyxDQUFDWixPQUFELEVBQVUsSUFBSUMsSUFBSSxJQUFJLEVBQVosQ0FBVixDQUFqQjs7QUFDQSxNQUFJLE1BQU1ZLGNBQWMsRUFBeEIsRUFBNEI7QUFDMUJELElBQUFBLFFBQVEsQ0FBQ0UsT0FBVCxDQUFpQmpCLFlBQWpCO0FBQ0Q7O0FBQ0QsTUFBSSxNQUFNa0IsZ0JBQWdCLEVBQTFCLEVBQThCO0FBQzVCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0FILElBQUFBLFFBQVEsQ0FBQ0UsT0FBVCxDQUFpQmhCLGNBQWpCLEVBQWlDLElBQWpDLEVBQXVDLEdBQXZDO0FBQ0Q7O0FBQ0QsU0FBTyxDQUFDYyxRQUFRLENBQUMsQ0FBRCxDQUFULEVBQWNBLFFBQVEsQ0FBQ0ksS0FBVCxDQUFlLENBQWYsQ0FBZCxFQUFpQ0wsT0FBakMsQ0FBUDtBQUNEOztBQUVELE1BQU1NLHdCQUE0RCxHQUFHLHVCQUFJO0FBQ3ZFQyxFQUFBQSxHQUFHLEVBQUUsRUFEa0U7QUFFdkU7QUFDQTtBQUNBO0FBQ0FDLEVBQUFBLE1BQU0sRUFBRSxPQUFPLEVBQVAsR0FBWSxDQUxtRCxDQUtoRDs7QUFMZ0QsQ0FBSixDQUFyRTs7QUFRQSxTQUFTTixjQUFULEdBQTRDO0FBQzFDLFNBQU9PLFVBQVUsQ0FBQ3ZCLFlBQUQsQ0FBakI7QUFDRDs7QUFFRCxTQUFTa0IsZ0JBQVQsR0FBOEM7QUFDNUMsU0FBT0ssVUFBVSxDQUFDdEIsY0FBRCxDQUFqQjtBQUNEOztBQUVELFNBQVNzQixVQUFULENBQW9CcEIsT0FBcEIsRUFBdUQ7QUFDckQsTUFBSXFCLE1BQXlCLEdBQUdKLHdCQUF3QixDQUFDSyxHQUF6QixDQUE2QnRCLE9BQTdCLENBQWhDOztBQUNBLE1BQUlxQixNQUFNLElBQUksSUFBZCxFQUFvQjtBQUNsQkEsSUFBQUEsTUFBTSxHQUFHLG9CQUFNckIsT0FBTixFQUFldUIsSUFBZixDQUFvQkMsQ0FBQyxJQUFJQSxDQUFDLElBQUksSUFBOUIsQ0FBVDtBQUNBUCxJQUFBQSx3QkFBd0IsQ0FBQ1EsR0FBekIsQ0FBNkJ6QixPQUE3QixFQUFzQ3FCLE1BQXRDO0FBQ0Q7O0FBQ0QsU0FBT0EsTUFBUDtBQUNEOztBQUVNLFNBQVNLLGtCQUFULENBQ0wxQixPQURLLEVBRUxDLElBRkssRUFHTFUsT0FISyxFQUl1QjtBQUM1QixTQUFPZ0IsNkJBQVdDLEtBQVgsQ0FBaUIsTUFDdEJ4QixhQUFhLENBQUNKLE9BQUQsRUFBVUMsSUFBVixFQUFnQlUsT0FBaEIsQ0FEUixFQUVMa0IsU0FGSyxDQUVLQyxTQUFTLElBQUksNkJBQWUsR0FBR0EsU0FBbEIsQ0FGbEIsQ0FBUDtBQUdEIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIENvcHlyaWdodCAoYykgMjAxNy1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxyXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4gKlxyXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBCU0Qtc3R5bGUgbGljZW5zZSBmb3VuZCBpbiB0aGVcclxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLiBBbiBhZGRpdGlvbmFsIGdyYW50XHJcbiAqIG9mIHBhdGVudCByaWdodHMgY2FuIGJlIGZvdW5kIGluIHRoZSBQQVRFTlRTIGZpbGUgaW4gdGhlIHNhbWUgZGlyZWN0b3J5LlxyXG4gKlxyXG4gKiBAZmxvd1xyXG4gKiBAZm9ybWF0XHJcbiAqL1xyXG5cclxuaW1wb3J0IHR5cGUge0xSVUNhY2hlfSBmcm9tICdscnUtY2FjaGUnO1xyXG5pbXBvcnQgdHlwZSB7T2JzZXJ2ZVByb2Nlc3NPcHRpb25zLCBQcm9jZXNzTWVzc2FnZX0gZnJvbSAnLi9wcm9jZXNzJztcclxuXHJcbmltcG9ydCBMUlUgZnJvbSAnbHJ1LWNhY2hlJztcclxuaW1wb3J0IHtPYnNlcnZhYmxlfSBmcm9tICdyeGpzLWNvbXBhdC9idW5kbGVzL3J4anMtY29tcGF0LnVtZC5taW4uanMnO1xyXG5cclxuaW1wb3J0IHdoaWNoIGZyb20gJy4vd2hpY2gnO1xyXG5pbXBvcnQge3NwYXduLCBvYnNlcnZlUHJvY2Vzc30gZnJvbSAnLi9wcm9jZXNzJztcclxuXHJcbmNvbnN0IE5JQ0VfQ09NTUFORCA9ICduaWNlJztcclxuY29uc3QgSU9OSUNFX0NPTU1BTkQgPSAnaW9uaWNlJztcclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBuaWNlU2FmZVNwYXduKFxyXG4gIGNvbW1hbmQ6IHN0cmluZyxcclxuICBhcmdzOiBBcnJheTxzdHJpbmc+LFxyXG4gIGV4ZWNPcHRpb25zPzogT2JqZWN0LFxyXG4pOiBQcm9taXNlPGNoaWxkX3Byb2Nlc3MkQ2hpbGRQcm9jZXNzPiB7XHJcbiAgY29uc3QgbmljaWZpZWQgPSBhd2FpdCBuaWNpZnlDb21tYW5kKGNvbW1hbmQsIGFyZ3MsIGV4ZWNPcHRpb25zKTtcclxuICBjb25zdCBwcm9jZXNzU3RyZWFtID0gc3Bhd24oLi4ubmljaWZpZWQpLnB1Ymxpc2goKTtcclxuICBjb25zdCBwcm9jZXNzUHJvbWlzZSA9IHByb2Nlc3NTdHJlYW0udGFrZSgxKS50b1Byb21pc2UoKTtcclxuICBwcm9jZXNzU3RyZWFtLmNvbm5lY3QoKTtcclxuICByZXR1cm4gcHJvY2Vzc1Byb21pc2U7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBUYWtlcyB0aGUgYXJndW1lbnRzIHRoYXQgeW91IHdvdWxkIG5vcm1hbGx5IHBhc3MgdG8gYHNwYXduKClgIGFuZCByZXR1cm5zIGFuIGFycmF5IG9mIG5ld1xyXG4gKiBhcmd1bWVudHMgdG8gdXNlIHRvIHJ1biB0aGUgY29tbWFuZCB1bmRlciBgbmljZWAuXHJcbiAqXHJcbiAqIEV4YW1wbGU6XHJcbiAqXHJcbiAqIGBgYGpzXHJcbiAqIG9ic2VydmVQcm9jZXNzKC4uLihhd2FpdCBuaWNpZnlDb21tYW5kKCdoZycsIFsnZGlmZiddKSkpLnN1YnNjcmliZSguLi4pO1xyXG4gKiBgYGBcclxuICpcclxuICogU2VlIGFsc28gYHNjcmlwdGlmeUNvbW1hbmQoKWAgd2hpY2ggZG9lcyBhIHNpbWlsYXIgdGhpbmcgYnV0IGZvciBgc2NyaXB0YC5cclxuICovXHJcbmFzeW5jIGZ1bmN0aW9uIG5pY2lmeUNvbW1hbmQ8VD4oXHJcbiAgY29tbWFuZDogc3RyaW5nLFxyXG4gIGFyZ3M/OiBBcnJheTxzdHJpbmc+LFxyXG4gIG9wdGlvbnM6IFQsXHJcbik6IFByb21pc2U8W3N0cmluZywgQXJyYXk8c3RyaW5nPiwgVF0+IHtcclxuICBjb25zdCBmdWxsQXJncyA9IFtjb21tYW5kLCAuLi4oYXJncyB8fCBbXSldO1xyXG4gIGlmIChhd2FpdCBoYXNOaWNlQ29tbWFuZCgpKSB7XHJcbiAgICBmdWxsQXJncy51bnNoaWZ0KE5JQ0VfQ09NTUFORCk7XHJcbiAgfVxyXG4gIGlmIChhd2FpdCBoYXNJb25pY2VDb21tYW5kKCkpIHtcclxuICAgIC8vIExlYXZlIHRoZSBwcm9jZXNzIGluIHRoZSBCZXN0IEVmZm9ydCBjbGFzcyAoZGVmYXVsdCksIGJ1dCBzZXQgaXQgdG8gdGhlIGxvd2VzdCBwcmlvcml0eSBmb3JcclxuICAgIC8vIHRoYXQgY2xhc3MuIFByaW9yaXRpZXMgcmFuZ2UgZnJvbSAwLTcgd2l0aCA0IGFzIHRoZSBkZWZhdWx0IGFuZCBsb3dlciBudW1iZXJzIHJlcHJlc2VudGluZ1xyXG4gICAgLy8gaGlnaGVyIHByaW9yaXRpZXMuXHJcbiAgICAvL1xyXG4gICAgLy8gU2VlIGBtYW4gaW9uaWNlYCBvciBodHRwOi8vbGludXguZGllLm5ldC9tYW4vMS9pb25pY2VcclxuICAgIC8vXHJcbiAgICAvLyBJdCdzIG5vdCBzcGVjaWZpZWQgYnkgUE9TSVggbGlrZSBgbmljZWAgaXMgYnV0IHNpbmNlIGl0IGlzIGluY2x1ZGVkIGluIHV0aWwtbGludXggd2hpY2ggaXNcclxuICAgIC8vIHJlbGF0aXZlbHkgY29yZVxyXG4gICAgLy8gKGh0dHBzOi8vZ2l0Lmtlcm5lbC5vcmcvY2dpdC91dGlscy91dGlsLWxpbnV4L3V0aWwtbGludXguZ2l0L3RyZWUvc2NoZWR1dGlscy9pb25pY2UuYyksIElcclxuICAgIC8vIHRoaW5rIHdlIGNhbiBhc3N1bWUgdGhhdCBpdCB1c2VzIHRoaXMgaW50ZXJmYWNlIGlmIGl0IGV4aXN0cy5cclxuICAgIGZ1bGxBcmdzLnVuc2hpZnQoSU9OSUNFX0NPTU1BTkQsICctbicsICc3Jyk7XHJcbiAgfVxyXG4gIHJldHVybiBbZnVsbEFyZ3NbMF0sIGZ1bGxBcmdzLnNsaWNlKDEpLCBvcHRpb25zXTtcclxufVxyXG5cclxuY29uc3QgY29tbWFuZEF2YWlsYWJpbGl0eUNhY2hlOiBMUlVDYWNoZTxzdHJpbmcsIFByb21pc2U8Ym9vbGVhbj4+ID0gTFJVKHtcclxuICBtYXg6IDEwLFxyXG4gIC8vIFJlYWxpc3RpY2FsbHkgdGhpcyB3aWxsIG5vdCBjaGFuZ2UgdmVyeSBvZnRlbiBzbyB3ZSBjYW4gY2FjaGUgZm9yIGxvbmcgcGVyaW9kcyBvZiB0aW1lLiBXZVxyXG4gIC8vIHByb2JhYmx5IGNvdWxkIGp1c3QgY2hlY2sgYXQgc3RhcnR1cCBhbmQgZ2V0IGF3YXkgd2l0aCBpdCwgYnV0IG1heWJlIHNvbWVvbmUgd2lsbCBpbnN0YWxsXHJcbiAgLy8gYGlvbmljZWAgYW5kIGl0IHdvdWxkIGJlIG5pY2UgdG8gcGljayB0aGF0IHVwLlxyXG4gIG1heEFnZTogMTAwMCAqIDYwICogNSwgLy8gNSBtaW51dGVzXHJcbn0pO1xyXG5cclxuZnVuY3Rpb24gaGFzTmljZUNvbW1hbmQoKTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgcmV0dXJuIGhhc0NvbW1hbmQoTklDRV9DT01NQU5EKTtcclxufVxyXG5cclxuZnVuY3Rpb24gaGFzSW9uaWNlQ29tbWFuZCgpOiBQcm9taXNlPGJvb2xlYW4+IHtcclxuICByZXR1cm4gaGFzQ29tbWFuZChJT05JQ0VfQ09NTUFORCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhc0NvbW1hbmQoY29tbWFuZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgbGV0IHJlc3VsdDogP1Byb21pc2U8Ym9vbGVhbj4gPSBjb21tYW5kQXZhaWxhYmlsaXR5Q2FjaGUuZ2V0KGNvbW1hbmQpO1xyXG4gIGlmIChyZXN1bHQgPT0gbnVsbCkge1xyXG4gICAgcmVzdWx0ID0gd2hpY2goY29tbWFuZCkudGhlbih4ID0+IHggIT0gbnVsbCk7XHJcbiAgICBjb21tYW5kQXZhaWxhYmlsaXR5Q2FjaGUuc2V0KGNvbW1hbmQsIHJlc3VsdCk7XHJcbiAgfVxyXG4gIHJldHVybiByZXN1bHQ7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBuaWNlT2JzZXJ2ZVByb2Nlc3MoXHJcbiAgY29tbWFuZDogc3RyaW5nLFxyXG4gIGFyZ3M/OiBBcnJheTxzdHJpbmc+LFxyXG4gIG9wdGlvbnM/OiBPYnNlcnZlUHJvY2Vzc09wdGlvbnMsXHJcbik6IE9ic2VydmFibGU8UHJvY2Vzc01lc3NhZ2U+IHtcclxuICByZXR1cm4gT2JzZXJ2YWJsZS5kZWZlcigoKSA9PlxyXG4gICAgbmljaWZ5Q29tbWFuZChjb21tYW5kLCBhcmdzLCBvcHRpb25zKSxcclxuICApLnN3aXRjaE1hcChzcGF3bkFyZ3MgPT4gb2JzZXJ2ZVByb2Nlc3MoLi4uc3Bhd25BcmdzKSk7XHJcbn1cclxuIl19