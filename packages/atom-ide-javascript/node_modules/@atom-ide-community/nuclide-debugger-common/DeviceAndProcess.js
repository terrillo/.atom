"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.DeviceAndProcess = void 0;

var _idx = _interopRequireDefault(require("idx"));

var _nuclideAdb = require("@atom-ide-community/nuclide-adb");

var _AtomInput = require("@atom-ide-community/nuclide-commons-ui/AtomInput");

var _LoadingSpinner = require("@atom-ide-community/nuclide-commons-ui/LoadingSpinner");

var _Table = require("@atom-ide-community/nuclide-commons-ui/Table");

var _collection = require("@atom-ide-community/nuclide-commons/collection");

var _expected = require("@atom-ide-community/nuclide-commons/expected");

var _UniversalDisposable = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/UniversalDisposable"));

var React = _interopRequireWildcard(require("react"));

var _rxjsCompatUmdMin = require("rxjs-compat/bundles/rxjs-compat.umd.min.js");

var _AdbDeviceSelector = require("./AdbDeviceSelector");

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */
class DeviceAndProcess extends React.Component {
  constructor(props) {
    super(props);
    this._disposables = void 0;
    this._javaProcessSubscription = void 0;

    this._handleDeviceChange = device => {
      const oldDeviceSerial = this.state.selectedDeviceSerial;

      if (oldDeviceSerial != null && device != null && oldDeviceSerial === device.serial) {
        // Same device selected.
        return;
      }

      if (this._javaProcessSubscription != null) {
        this._javaProcessSubscription.unsubscribe();

        this._javaProcessSubscription = null;
      }

      this.setState({
        selectedDeviceSerial: device === null || device === void 0 ? void 0 : device.serial,
        javaProcesses: device == null ? _expected.Expect.value([]) : _expected.Expect.pending(),
        selectedProcess: null,
        selectedProcessName: this.props.deserialize()
      }, () => {
        if (device != null) {
          // If a device is selected, observe the Java processes on the device.
          const adbService = (0, _nuclideAdb.getAdbServiceByNuclideUri)(this.props.targetUri);
          this._javaProcessSubscription = _rxjsCompatUmdMin.Observable.interval(2000).startWith(0).switchMap(() => adbService.getJavaProcesses(device.serial).refCount()).distinctUntilChanged((a, b) => (0, _collection.arrayEqual)(a, b, (x, y) => {
            return x.user === y.user && x.pid === y.pid && x.name === y.name;
          })).subscribe(javaProcesses => {
            this._javaProcessListChanged(_expected.Expect.value(javaProcesses));
          });
        }
      });
    };

    this._handleFilterTextChange = filterText => {
      // Check if we've filtered down to one option and select if so
      const filteredProcesses = this._filterJavaProcesses(filterText); // TODO: (goom) this setState depends on current state
      // and should use an updater function rather than an object
      // eslint-disable-next-line react/no-access-state-in-setstate


      let selectedProcess = this.state.selectedProcess;

      if (filteredProcesses.length === 1) {
        // Check if we've filtered down to one option and select if so
        selectedProcess = filteredProcesses[0];
      } else if (filteredProcesses.findIndex(processRow => {
        var _selectedProcess;

        return ((_selectedProcess = selectedProcess) === null || _selectedProcess === void 0 ? void 0 : _selectedProcess.pid) === processRow.pid;
      }) === -1) {
        // If we filter out our current selection,
        //   set our current selection to null
        selectedProcess = null;
      }

      this.setState({
        filterText,
        selectedProcess
      });
    };

    this._handleSort = (sortedColumn, sortDescending) => {
      this.setState({
        sortedColumn,
        sortDescending
      });
    };

    this._sortRows = (processes, sortedColumnName, sortDescending) => {
      if (sortedColumnName == null) {
        return processes;
      } // Use a numerical comparison for the pid column, string compare for all the others.


      const compare = sortedColumnName === 'pid' ? (a, b, isAsc) => {
        const cmp = (a || 0) - (b || 0);
        return isAsc ? cmp : -cmp;
      } : (a, b, isAsc) => {
        const cmp = String(a).toLowerCase().localeCompare(String(b).toLowerCase());
        return isAsc ? cmp : -cmp;
      };

      const getter = row => row.data[sortedColumnName];

      return [...processes].sort((a, b) => {
        return compare(getter(a), getter(b), !sortDescending);
      });
    };

    this._handleSelectTableRow = (item, selectedIndex) => {
      this.setState({
        selectedProcess: item,
        selectedProcessName: (0, _idx.default)(item, _ => _.name)
      });
    };

    this._disposables = new _UniversalDisposable.default();
    this._javaProcessSubscription = null;

    this._disposables.add(() => {
      if (this._javaProcessSubscription != null) {
        this._javaProcessSubscription.unsubscribe();
      }
    });

    let _filterText = ''; // the file is not available. This causes confusions for the bundlers and analyzers
    // try {
    //   // $FlowFB
    //   filterText = require('./fb-isFBProcessName').FB_PROCESS_NAME_REGEX_STRING;
    // } catch (e) {}

    this.state = {
      selectedDeviceSerial: null,
      javaProcesses: _expected.Expect.value([]),
      selectedProcess: null,
      selectedProcessName: null,
      sortedColumn: 'name',
      sortDescending: false,
      filterText: _filterText
    };
  }

  componentWillUnmount() {
    this._disposables.dispose();
  }

  setState(partialState, callback) {
    const fullState = { ...this.state,
      ...partialState
    };
    super.setState(fullState, () => {
      this.props.onSelect(fullState.selectedDeviceSerial, fullState.selectedProcess);
      callback && callback();
    });
  }

  _javaProcessListChanged(javaProcesses) {
    var _this$state$selectedP;

    const selectedPid = (_this$state$selectedP = this.state.selectedProcess) === null || _this$state$selectedP === void 0 ? void 0 : _this$state$selectedP.pid;
    const selectedProcess = javaProcesses.getOrDefault([]).find(process => this.state.selectedProcessName != null ? process.name === this.state.selectedProcessName : process.pid === selectedPid);
    this.setState({
      javaProcesses,
      selectedProcess,
      selectedProcessName: selectedProcess === null || selectedProcess === void 0 ? void 0 : selectedProcess.name
    });
  }

  _filterJavaProcesses(filterText) {
    // Show all results if invalid regex
    let filterRegex;

    try {
      filterRegex = new RegExp(filterText, 'i');
    } catch (e) {
      return this.state.javaProcesses.getOrDefault([]);
    } // $FlowFixMe (>=0.85.0) (T35986896) Flow upgrade suppress


    return this.state.javaProcesses.getOrDefault([]).filter(item => filterRegex.test(item.user) || filterRegex.test(item.pid) || filterRegex.test(item.name));
  }

  _getColumns() {
    return [{
      key: 'pid',
      title: 'PID',
      width: 0.1
    }, {
      key: 'user',
      title: 'User',
      width: 0.1
    }, {
      key: 'name',
      title: 'Name',
      width: 0.8
    }];
  }

  render() {
    const emptyMessage = this.state.selectedDeviceSerial == null ? 'No device selected' : 'No debuggable Java processes found!';

    const emptyComponent = () => /*#__PURE__*/React.createElement("div", null, this.state.javaProcesses.isPending ? /*#__PURE__*/React.createElement(_LoadingSpinner.LoadingSpinner, {
      size: "EXTRA_SMALL"
    }) : emptyMessage);

    const processListRows = this._sortRows(this._filterJavaProcesses(this.state.filterText).map(processRow => {
      const data = {
        pid: processRow.pid,
        user: processRow.user,
        name: processRow.name
      };
      return {
        data
      };
    }), this.state.sortedColumn, this.state.sortDescending);

    const selectedRowIndex = processListRows.findIndex(row => {
      var _this$state$selectedP2, _this$state$selectedP3;

      return row.data.pid === ((_this$state$selectedP2 = this.state.selectedProcess) === null || _this$state$selectedP2 === void 0 ? void 0 : _this$state$selectedP2.pid) && row.data.name === ((_this$state$selectedP3 = this.state.selectedProcess) === null || _this$state$selectedP3 === void 0 ? void 0 : _this$state$selectedP3.name);
    });
    return /*#__PURE__*/React.createElement("div", {
      className: "block"
    }, /*#__PURE__*/React.createElement("label", null, "Device:"), /*#__PURE__*/React.createElement(_AdbDeviceSelector.AdbDeviceSelector, {
      onChange: this._handleDeviceChange,
      targetUri: this.props.targetUri
    }), /*#__PURE__*/React.createElement("label", null, "Debuggable Java processes: "), /*#__PURE__*/React.createElement(_AtomInput.AtomInput, {
      placeholderText: "Search with regular expression...",
      value: this.state.filterText,
      onDidChange: this._handleFilterTextChange,
      size: "sm",
      autofocus: true
    }), /*#__PURE__*/React.createElement(_Table.Table, {
      collapsable: false,
      columns: this._getColumns(),
      emptyComponent: emptyComponent,
      fixedHeader: true,
      maxBodyHeight: "30em",
      rows: processListRows,
      sortable: true,
      onSort: this._handleSort,
      sortedColumn: this.state.sortedColumn,
      sortDescending: this.state.sortDescending,
      selectable: true,
      selectedIndex: selectedRowIndex,
      onSelect: this._handleSelectTableRow
    }));
  }

}

exports.DeviceAndProcess = DeviceAndProcess;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1kZWJ1Z2dlci1jb21tb24vRGV2aWNlQW5kUHJvY2Vzcy5qcyJdLCJuYW1lcyI6WyJEZXZpY2VBbmRQcm9jZXNzIiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwiX2Rpc3Bvc2FibGVzIiwiX2phdmFQcm9jZXNzU3Vic2NyaXB0aW9uIiwiX2hhbmRsZURldmljZUNoYW5nZSIsImRldmljZSIsIm9sZERldmljZVNlcmlhbCIsInN0YXRlIiwic2VsZWN0ZWREZXZpY2VTZXJpYWwiLCJzZXJpYWwiLCJ1bnN1YnNjcmliZSIsInNldFN0YXRlIiwiamF2YVByb2Nlc3NlcyIsIkV4cGVjdCIsInZhbHVlIiwicGVuZGluZyIsInNlbGVjdGVkUHJvY2VzcyIsInNlbGVjdGVkUHJvY2Vzc05hbWUiLCJkZXNlcmlhbGl6ZSIsImFkYlNlcnZpY2UiLCJ0YXJnZXRVcmkiLCJPYnNlcnZhYmxlIiwiaW50ZXJ2YWwiLCJzdGFydFdpdGgiLCJzd2l0Y2hNYXAiLCJnZXRKYXZhUHJvY2Vzc2VzIiwicmVmQ291bnQiLCJkaXN0aW5jdFVudGlsQ2hhbmdlZCIsImEiLCJiIiwieCIsInkiLCJ1c2VyIiwicGlkIiwibmFtZSIsInN1YnNjcmliZSIsIl9qYXZhUHJvY2Vzc0xpc3RDaGFuZ2VkIiwiX2hhbmRsZUZpbHRlclRleHRDaGFuZ2UiLCJmaWx0ZXJUZXh0IiwiZmlsdGVyZWRQcm9jZXNzZXMiLCJfZmlsdGVySmF2YVByb2Nlc3NlcyIsImxlbmd0aCIsImZpbmRJbmRleCIsInByb2Nlc3NSb3ciLCJfaGFuZGxlU29ydCIsInNvcnRlZENvbHVtbiIsInNvcnREZXNjZW5kaW5nIiwiX3NvcnRSb3dzIiwicHJvY2Vzc2VzIiwic29ydGVkQ29sdW1uTmFtZSIsImNvbXBhcmUiLCJpc0FzYyIsImNtcCIsIlN0cmluZyIsInRvTG93ZXJDYXNlIiwibG9jYWxlQ29tcGFyZSIsImdldHRlciIsInJvdyIsImRhdGEiLCJzb3J0IiwiX2hhbmRsZVNlbGVjdFRhYmxlUm93IiwiaXRlbSIsInNlbGVjdGVkSW5kZXgiLCJfIiwiVW5pdmVyc2FsRGlzcG9zYWJsZSIsImFkZCIsImNvbXBvbmVudFdpbGxVbm1vdW50IiwiZGlzcG9zZSIsInBhcnRpYWxTdGF0ZSIsImNhbGxiYWNrIiwiZnVsbFN0YXRlIiwib25TZWxlY3QiLCJzZWxlY3RlZFBpZCIsImdldE9yRGVmYXVsdCIsImZpbmQiLCJwcm9jZXNzIiwiZmlsdGVyUmVnZXgiLCJSZWdFeHAiLCJlIiwiZmlsdGVyIiwidGVzdCIsIl9nZXRDb2x1bW5zIiwia2V5IiwidGl0bGUiLCJ3aWR0aCIsInJlbmRlciIsImVtcHR5TWVzc2FnZSIsImVtcHR5Q29tcG9uZW50IiwiaXNQZW5kaW5nIiwicHJvY2Vzc0xpc3RSb3dzIiwibWFwIiwic2VsZWN0ZWRSb3dJbmRleCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQWtCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7QUE1QkE7Ozs7Ozs7Ozs7O0FBZ0RPLE1BQU1BLGdCQUFOLFNBQStCQyxLQUFLLENBQUNDLFNBQXJDLENBQTZEO0FBSWxFQyxFQUFBQSxXQUFXLENBQUNDLEtBQUQsRUFBZTtBQUN4QixVQUFNQSxLQUFOO0FBRHdCLFNBSDFCQyxZQUcwQjtBQUFBLFNBRjFCQyx3QkFFMEI7O0FBQUEsU0ErQzFCQyxtQkEvQzBCLEdBK0NIQyxNQUFELElBQThCO0FBQ2xELFlBQU1DLGVBQWUsR0FBRyxLQUFLQyxLQUFMLENBQVdDLG9CQUFuQzs7QUFDQSxVQUNFRixlQUFlLElBQUksSUFBbkIsSUFDQUQsTUFBTSxJQUFJLElBRFYsSUFFQUMsZUFBZSxLQUFLRCxNQUFNLENBQUNJLE1BSDdCLEVBSUU7QUFDQTtBQUNBO0FBQ0Q7O0FBRUQsVUFBSSxLQUFLTix3QkFBTCxJQUFpQyxJQUFyQyxFQUEyQztBQUN6QyxhQUFLQSx3QkFBTCxDQUE4Qk8sV0FBOUI7O0FBQ0Es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QUEsWUFBWSxFQUFFLEtBQUtyQyxLQUFMLENBQVdzQyxZQVQzQjtBQVVFLE1BQUEsY0FBYyxFQUFFLEtBQUt0QyxLQUFMLENBQVd1QyxjQVY3QjtBQVdFLE1BQUEsVUFBVSxFQUFFLElBWGQ7QUFZRSxNQUFBLGFBQWEsRUFBRTZDLGdCQVpqQjtBQWFFLE1BQUEsUUFBUSxFQUFFLEtBQUsvQjtBQWJqQixNQWRGLENBREY7QUFnQ0Q7O0FBclNpRSIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTctcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cclxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuICpcclxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgQlNELXN0eWxlIGxpY2Vuc2UgZm91bmQgaW4gdGhlXHJcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4gQW4gYWRkaXRpb25hbCBncmFudFxyXG4gKiBvZiBwYXRlbnQgcmlnaHRzIGNhbiBiZSBmb3VuZCBpbiB0aGUgUEFURU5UUyBmaWxlIGluIHRoZSBzYW1lIGRpcmVjdG9yeS5cclxuICpcclxuICogQGZsb3dcclxuICogQGZvcm1hdFxyXG4gKi9cclxuXHJcbmltcG9ydCB0eXBlIHtBZGJEZXZpY2UsIEFuZHJvaWRKYXZhUHJvY2Vzc30gZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWFkYi9saWIvdHlwZXMnO1xyXG5pbXBvcnQgdHlwZSB7Q29sdW1uLCBSb3d9IGZyb20gJ0BhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1jb21tb25zLXVpL1RhYmxlJztcclxuaW1wb3J0IHR5cGUge0V4cGVjdGVkfSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy9leHBlY3RlZCc7XHJcbmltcG9ydCB0eXBlIHtOdWNsaWRlVXJpfSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy9udWNsaWRlVXJpJztcclxuaW1wb3J0IHR5cGUge1N1YnNjcmlwdGlvbn0gZnJvbSAncnhqcy1jb21wYXQvYnVuZGxlcy9yeGpzLWNvbXBhdC51bWQubWluLmpzJztcclxuXHJcbmltcG9ydCBpZHggZnJvbSAnaWR4JztcclxuaW1wb3J0IHtnZXRBZGJTZXJ2aWNlQnlOdWNsaWRlVXJpfSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtYWRiJztcclxuaW1wb3J0IHtBdG9tSW5wdXR9IGZyb20gJ0BhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1jb21tb25zLXVpL0F0b21JbnB1dCc7XHJcbmltcG9ydCB7TG9hZGluZ1NwaW5uZXJ9IGZyb20gJ0BhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1jb21tb25zLXVpL0xvYWRpbmdTcGlubmVyJztcclxuaW1wb3J0IHtUYWJsZX0gZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMtdWkvVGFibGUnO1xyXG5pbXBvcnQge2FycmF5RXF1YWx9IGZyb20gJ0BhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1jb21tb25zL2NvbGxlY3Rpb24nO1xyXG5pbXBvcnQge0V4cGVjdH0gZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvZXhwZWN0ZWQnO1xyXG5pbXBvcnQgVW5pdmVyc2FsRGlzcG9zYWJsZSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy9Vbml2ZXJzYWxEaXNwb3NhYmxlJztcclxuaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnO1xyXG5pbXBvcnQge09ic2VydmFibGV9IGZyb20gJ3J4anMtY29tcGF0L2J1bmRsZXMvcnhqcy1jb21wYXQudW1kLm1pbi5qcyc7XHJcbmltcG9ydCB7QWRiRGV2aWNlU2VsZWN0b3J9IGZyb20gJy4vQWRiRGV2aWNlU2VsZWN0b3InO1xyXG5cclxudHlwZSBDb2x1bW5OYW1lID0gJ3BpZCcgfCAndXNlcicgfCAnbmFtZSc7XHJcblxyXG50eXBlIFByb3BzID0ge3xcclxuICArdGFyZ2V0VXJpOiBOdWNsaWRlVXJpLFxyXG4gICtvblNlbGVjdDogKGRldmljZVNlcmlhbDogP3N0cmluZywgamF2YVByb2Nlc3M6ID9BbmRyb2lkSmF2YVByb2Nlc3MpID0+IHZvaWQsXHJcbiAgK2Rlc2VyaWFsaXplOiAoKSA9PiA/c3RyaW5nLFxyXG58fTtcclxuXHJcbnR5cGUgU3RhdGUgPSB7XHJcbiAgc2VsZWN0ZWREZXZpY2VTZXJpYWw6ID9zdHJpbmcsXHJcbiAgamF2YVByb2Nlc3NlczogRXhwZWN0ZWQ8QXJyYXk8QW5kcm9pZEphdmFQcm9jZXNzPj4sXHJcbiAgc2VsZWN0ZWRQcm9jZXNzOiA/QW5kcm9pZEphdmFQcm9jZXNzLFxyXG4gIHNlbGVjdGVkUHJvY2Vzc05hbWU6ID9zdHJpbmcsXHJcbiAgc29ydGVkQ29sdW1uOiA/Q29sdW1uTmFtZSxcclxuICBzb3J0RGVzY2VuZGluZzogYm9vbGVhbixcclxuICBmaWx0ZXJUZXh0OiBzdHJpbmcsXHJcbn07XHJcblxyXG5leHBvcnQgY2xhc3MgRGV2aWNlQW5kUHJvY2VzcyBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxQcm9wcywgU3RhdGU+IHtcclxuICBfZGlzcG9zYWJsZXM6IFVuaXZlcnNhbERpc3Bvc2FibGU7XHJcbiAgX2phdmFQcm9jZXNzU3Vic2NyaXB0aW9uOiA/U3Vic2NyaXB0aW9uO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcm9wczogUHJvcHMpIHtcclxuICAgIHN1cGVyKHByb3BzKTtcclxuXHJcbiAgICB0aGlzLl9kaXNwb3NhYmxlcyA9IG5ldyBVbml2ZXJzYWxEaXNwb3NhYmxlKCk7XHJcbiAgICB0aGlzLl9qYXZhUHJvY2Vzc1N1YnNjcmlwdGlvbiA9IG51bGw7XHJcbiAgICB0aGlzLl9kaXNwb3NhYmxlcy5hZGQoKCkgPT4ge1xyXG4gICAgICBpZiAodGhpcy5famF2YVByb2Nlc3NTdWJzY3JpcHRpb24gIT0gbnVsbCkge1xyXG4gICAgICAgIHRoaXMuX2phdmFQcm9jZXNzU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIGxldCBmaWx0ZXJUZXh0ID0gJyc7XHJcbiAgICAvLyB0aGUgZmlsZSBpcyBub3QgYXZhaWxhYmxlLiBUaGlzIGNhdXNlcyBjb25mdXNpb25zIGZvciB0aGUgYnVuZGxlcnMgYW5kIGFuYWx5emVyc1xyXG4gICAgLy8gdHJ5IHtcclxuICAgIC8vICAgLy8gJEZsb3dGQlxyXG4gICAgLy8gICBmaWx0ZXJUZXh0ID0gcmVxdWlyZSgnLi9mYi1pc0ZCUHJvY2Vzc05hbWUnKS5GQl9QUk9DRVNTX05BTUVfUkVHRVhfU1RSSU5HO1xyXG4gICAgLy8gfSBjYXRjaCAoZSkge31cclxuXHJcbiAgICB0aGlzLnN0YXRlID0ge1xyXG4gICAgICBzZWxlY3RlZERldmljZVNlcmlhbDogbnVsbCxcclxuICAgICAgamF2YVByb2Nlc3NlczogRXhwZWN0LnZhbHVlKFtdKSxcclxuICAgICAgc2VsZWN0ZWRQcm9jZXNzOiBudWxsLFxyXG4gICAgICBzZWxlY3RlZFByb2Nlc3NOYW1lOiBudWxsLFxyXG4gICAgICBzb3J0ZWRDb2x1bW46ICduYW1lJyxcclxuICAgICAgc29ydERlc2NlbmRpbmc6IGZhbHNlLFxyXG4gICAgICBmaWx0ZXJUZXh0LFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xyXG4gICAgdGhpcy5fZGlzcG9zYWJsZXMuZGlzcG9zZSgpO1xyXG4gIH1cclxuXHJcbiAgc2V0U3RhdGUocGFydGlhbFN0YXRlOiBPYmplY3QsIGNhbGxiYWNrPzogKCkgPT4gbWl4ZWQpOiB2b2lkIHtcclxuICAgIGNvbnN0IGZ1bGxTdGF0ZTogU3RhdGUgPSB7XHJcbiAgICAgIC4uLnRoaXMuc3RhdGUsXHJcbiAgICAgIC4uLnBhcnRpYWxTdGF0ZSxcclxuICAgIH07XHJcbiAgICBzdXBlci5zZXRTdGF0ZShmdWxsU3RhdGUsICgpID0+IHtcclxuICAgICAgdGhpcy5wcm9wcy5vblNlbGVjdChcclxuICAgICAgICBmdWxsU3RhdGUuc2VsZWN0ZWREZXZpY2VTZXJpYWwsXHJcbiAgICAgICAgZnVsbFN0YXRlLnNlbGVjdGVkUHJvY2VzcyxcclxuICAgICAgKTtcclxuICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2soKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgX2hhbmRsZURldmljZUNoYW5nZSA9IChkZXZpY2U6ID9BZGJEZXZpY2UpOiB2b2lkID0+IHtcclxuICAgIGNvbnN0IG9sZERldmljZVNlcmlhbCA9IHRoaXMuc3RhdGUuc2VsZWN0ZWREZXZpY2VTZXJpYWw7XHJcbiAgICBpZiAoXHJcbiAgICAgIG9sZERldmljZVNlcmlhbCAhPSBudWxsICYmXHJcbiAgICAgIGRldmljZSAhPSBudWxsICYmXHJcbiAgICAgIG9sZERldmljZVNlcmlhbCA9PT0gZGV2aWNlLnNlcmlhbFxyXG4gICAgKSB7XHJcbiAgICAgIC8vIFNhbWUgZGV2aWNlIHNlbGVjdGVkLlxyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMuX2phdmFQcm9jZXNzU3Vic2NyaXB0aW9uICE9IG51bGwpIHtcclxuICAgICAgdGhpcy5famF2YVByb2Nlc3NTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgICAgdGhpcy5famF2YVByb2Nlc3NTdWJzY3JpcHRpb24gPSBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuc2V0U3RhdGUoXHJcbiAgICAgIHtcclxuICAgICAgICBzZWxlY3RlZERldmljZVNlcmlhbDogZGV2aWNlPy5zZXJpYWwsXHJcbiAgICAgICAgamF2YVByb2Nlc3NlczogZGV2aWNlID09IG51bGwgPyBFeHBlY3QudmFsdWUoW10pIDogRXhwZWN0LnBlbmRpbmcoKSxcclxuICAgICAgICBzZWxlY3RlZFByb2Nlc3M6IG51bGwsXHJcbiAgICAgICAgc2VsZWN0ZWRQcm9jZXNzTmFtZTogdGhpcy5wcm9wcy5kZXNlcmlhbGl6ZSgpLFxyXG4gICAgICB9LFxyXG4gICAgICAoKSA9PiB7XHJcbiAgICAgICAgaWYgKGRldmljZSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAvLyBJZiBhIGRldmljZSBpcyBzZWxlY3RlZCwgb2JzZXJ2ZSB0aGUgSmF2YSBwcm9jZXNzZXMgb24gdGhlIGRldmljZS5cclxuICAgICAgICAgIGNvbnN0IGFkYlNlcnZpY2UgPSBnZXRBZGJTZXJ2aWNlQnlOdWNsaWRlVXJpKHRoaXMucHJvcHMudGFyZ2V0VXJpKTtcclxuICAgICAgICAgIHRoaXMuX2phdmFQcm9jZXNzU3Vic2NyaXB0aW9uID0gT2JzZXJ2YWJsZS5pbnRlcnZhbCgyMDAwKVxyXG4gICAgICAgICAgICAuc3RhcnRXaXRoKDApXHJcbiAgICAgICAgICAgIC5zd2l0Y2hNYXAoKCkgPT5cclxuICAgICAgICAgICAgICBhZGJTZXJ2aWNlLmdldEphdmFQcm9jZXNzZXMoZGV2aWNlLnNlcmlhbCkucmVmQ291bnQoKSxcclxuICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAuZGlzdGluY3RVbnRpbENoYW5nZWQoKGEsIGIpID0+XHJcbiAgICAgICAgICAgICAgYXJyYXlFcXVhbChhLCBiLCAoeCwgeSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIChcclxuICAgICAgICAgICAgICAgICAgeC51c2VyID09PSB5LnVzZXIgJiYgeC5waWQgPT09IHkucGlkICYmIHgubmFtZSA9PT0geS5uYW1lXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoamF2YVByb2Nlc3NlcyA9PiB7XHJcbiAgICAgICAgICAgICAgdGhpcy5famF2YVByb2Nlc3NMaXN0Q2hhbmdlZChFeHBlY3QudmFsdWUoamF2YVByb2Nlc3NlcykpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0sXHJcbiAgICApO1xyXG4gIH07XHJcblxyXG4gIF9qYXZhUHJvY2Vzc0xpc3RDaGFuZ2VkKGphdmFQcm9jZXNzZXM6IEV4cGVjdGVkPEFycmF5PEFuZHJvaWRKYXZhUHJvY2Vzcz4+KSB7XHJcbiAgICBjb25zdCBzZWxlY3RlZFBpZCA9IHRoaXMuc3RhdGUuc2VsZWN0ZWRQcm9jZXNzPy5waWQ7XHJcbiAgICBjb25zdCBzZWxlY3RlZFByb2Nlc3MgPSBqYXZhUHJvY2Vzc2VzXHJcbiAgICAgIC5nZXRPckRlZmF1bHQoW10pXHJcbiAgICAgIC5maW5kKFxyXG4gICAgICAgIHByb2Nlc3MgPT5cclxuICAgICAgICAgIHRoaXMuc3RhdGUuc2VsZWN0ZWRQcm9jZXNzTmFtZSAhPSBudWxsXHJcbiAgICAgICAgICAgID8gcHJvY2Vzcy5uYW1lID09PSB0aGlzLnN0YXRlLnNlbGVjdGVkUHJvY2Vzc05hbWVcclxuICAgICAgICAgICAgOiBwcm9jZXNzLnBpZCA9PT0gc2VsZWN0ZWRQaWQsXHJcbiAgICAgICk7XHJcblxyXG4gICAgdGhpcy5zZXRTdGF0ZSh7XHJcbiAgICAgIGphdmFQcm9jZXNzZXMsXHJcbiAgICAgIHNlbGVjdGVkUHJvY2VzcyxcclxuICAgICAgc2VsZWN0ZWRQcm9jZXNzTmFtZTogc2VsZWN0ZWRQcm9jZXNzPy5uYW1lLFxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBfZmlsdGVySmF2YVByb2Nlc3NlcyhmaWx0ZXJUZXh0OiBzdHJpbmcpIHtcclxuICAgIC8vIFNob3cgYWxsIHJlc3VsdHMgaWYgaW52YWxpZCByZWdleFxyXG4gICAgbGV0IGZpbHRlclJlZ2V4O1xyXG4gICAgdHJ5IHtcclxuICAgICAgZmlsdGVyUmVnZXggPSBuZXcgUmVnRXhwKGZpbHRlclRleHQsICdpJyk7XHJcbiAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLnN0YXRlLmphdmFQcm9jZXNzZXMuZ2V0T3JEZWZhdWx0KFtdKTtcclxuICAgIH1cclxuICAgIC8vICRGbG93Rml4TWUgKD49MC44NS4wKSAoVDM1OTg2ODk2KSBGbG93IHVwZ3JhZGUgc3VwcHJlc3NcclxuICAgIHJldHVybiB0aGlzLnN0YXRlLmphdmFQcm9jZXNzZXNcclxuICAgICAgLmdldE9yRGVmYXVsdChbXSlcclxuICAgICAgLmZpbHRlcihcclxuICAgICAgICBpdGVtID0+XHJcbiAgICAgICAgICBmaWx0ZXJSZWdleC50ZXN0KGl0ZW0udXNlcikgfHxcclxuICAgICAgICAgIGZpbHRlclJlZ2V4LnRlc3QoaXRlbS5waWQpIHx8XHJcbiAgICAgICAgICBmaWx0ZXJSZWdleC50ZXN0KGl0ZW0ubmFtZSksXHJcbiAgICAgICk7XHJcbiAgfVxyXG5cclxuICBfaGFuZGxlRmlsdGVyVGV4dENoYW5nZSA9IChmaWx0ZXJUZXh0OiBzdHJpbmcpOiB2b2lkID0+IHtcclxuICAgIC8vIENoZWNrIGlmIHdlJ3ZlIGZpbHRlcmVkIGRvd24gdG8gb25lIG9wdGlvbiBhbmQgc2VsZWN0IGlmIHNvXHJcblxyXG4gICAgY29uc3QgZmlsdGVyZWRQcm9jZXNzZXMgPSB0aGlzLl9maWx0ZXJKYXZhUHJvY2Vzc2VzKGZpbHRlclRleHQpO1xyXG4gICAgLy8gVE9ETzogKGdvb20pIHRoaXMgc2V0U3RhdGUgZGVwZW5kcyBvbiBjdXJyZW50IHN0YXRlXHJcbiAgICAvLyBhbmQgc2hvdWxkIHVzZSBhbiB1cGRhdGVyIGZ1bmN0aW9uIHJhdGhlciB0aGFuIGFuIG9iamVjdFxyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlYWN0L25vLWFjY2Vzcy1zdGF0ZS1pbi1zZXRzdGF0ZVxyXG4gICAgbGV0IHNlbGVjdGVkUHJvY2VzcyA9IHRoaXMuc3RhdGUuc2VsZWN0ZWRQcm9jZXNzO1xyXG4gICAgaWYgKGZpbHRlcmVkUHJvY2Vzc2VzLmxlbmd0aCA9PT0gMSkge1xyXG4gICAgICAvLyBDaGVjayBpZiB3ZSd2ZSBmaWx0ZXJlZCBkb3duIHRvIG9uZSBvcHRpb24gYW5kIHNlbGVjdCBpZiBzb1xyXG4gICAgICBzZWxlY3RlZFByb2Nlc3MgPSBmaWx0ZXJlZFByb2Nlc3Nlc1swXTtcclxuICAgIH0gZWxzZSBpZiAoXHJcbiAgICAgIGZpbHRlcmVkUHJvY2Vzc2VzLmZpbmRJbmRleChcclxuICAgICAgICBwcm9jZXNzUm93ID0+IHNlbGVjdGVkUHJvY2Vzcz8ucGlkID09PSBwcm9jZXNzUm93LnBpZCxcclxuICAgICAgKSA9PT0gLTFcclxuICAgICkge1xyXG4gICAgICAvLyBJZiB3ZSBmaWx0ZXIgb3V0IG91ciBjdXJyZW50IHNlbGVjdGlvbixcclxuICAgICAgLy8gICBzZXQgb3VyIGN1cnJlbnQgc2VsZWN0aW9uIHRvIG51bGxcclxuICAgICAgc2VsZWN0ZWRQcm9jZXNzID0gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLnNldFN0YXRlKHtcclxuICAgICAgZmlsdGVyVGV4dCxcclxuICAgICAgc2VsZWN0ZWRQcm9jZXNzLFxyXG4gICAgfSk7XHJcbiAgfTtcclxuXHJcbiAgX2dldENvbHVtbnMoKTogQXJyYXk8Q29sdW1uPCo+PiB7XHJcbiAgICByZXR1cm4gW1xyXG4gICAgICB7XHJcbiAgICAgICAga2V5OiAncGlkJyxcclxuICAgICAgICB0aXRsZTogJ1BJRCcsXHJcbiAgICAgICAgd2lkdGg6IDAuMSxcclxuICAgICAgfSxcclxuICAgICAge1xyXG4gICAgICAgIGtleTogJ3VzZXInLFxyXG4gICAgICAgIHRpdGxlOiAnVXNlcicsXHJcbiAgICAgICAgd2lkdGg6IDAuMSxcclxuICAgICAgfSxcclxuICAgICAge1xyXG4gICAgICAgIGtleTogJ25hbWUnLFxyXG4gICAgICAgIHRpdGxlOiAnTmFtZScsXHJcbiAgICAgICAgd2lkdGg6IDAuOCxcclxuICAgICAgfSxcclxuICAgIF07XHJcbiAgfVxyXG5cclxuICBfaGFuZGxlU29ydCA9IChzb3J0ZWRDb2x1bW46ID9Db2x1bW5OYW1lLCBzb3J0RGVzY2VuZGluZzogYm9vbGVhbik6IHZvaWQgPT4ge1xyXG4gICAgdGhpcy5zZXRTdGF0ZSh7c29ydGVkQ29sdW1uLCBzb3J0RGVzY2VuZGluZ30pO1xyXG4gIH07XHJcblxyXG4gIF9zb3J0Um93cyA9IChcclxuICAgIHByb2Nlc3NlczogQXJyYXk8Um93PCo+PixcclxuICAgIHNvcnRlZENvbHVtbk5hbWU6ID9Db2x1bW5OYW1lLFxyXG4gICAgc29ydERlc2NlbmRpbmc6IGJvb2xlYW4sXHJcbiAgKTogQXJyYXk8Um93PCo+PiA9PiB7XHJcbiAgICBpZiAoc29ydGVkQ29sdW1uTmFtZSA9PSBudWxsKSB7XHJcbiAgICAgIHJldHVybiBwcm9jZXNzZXM7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gVXNlIGEgbnVtZXJpY2FsIGNvbXBhcmlzb24gZm9yIHRoZSBwaWQgY29sdW1uLCBzdHJpbmcgY29tcGFyZSBmb3IgYWxsIHRoZSBvdGhlcnMuXHJcbiAgICBjb25zdCBjb21wYXJlOiBhbnkgPVxyXG4gICAgICBzb3J0ZWRDb2x1bW5OYW1lID09PSAncGlkJ1xyXG4gICAgICAgID8gKGE6ID9udW1iZXIsIGI6ID9udW1iZXIsIGlzQXNjOiBib29sZWFuKTogbnVtYmVyID0+IHtcclxuICAgICAgICAgICAgY29uc3QgY21wID0gKGEgfHwgMCkgLSAoYiB8fCAwKTtcclxuICAgICAgICAgICAgcmV0dXJuIGlzQXNjID8gY21wIDogLWNtcDtcclxuICAgICAgICAgIH1cclxuICAgICAgICA6IChhOiA/c3RyaW5nLCBiOiA/c3RyaW5nLCBpc0FzYzogYm9vbGVhbik6IG51bWJlciA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNtcCA9IFN0cmluZyhhKVxyXG4gICAgICAgICAgICAgIC50b0xvd2VyQ2FzZSgpXHJcbiAgICAgICAgICAgICAgLmxvY2FsZUNvbXBhcmUoU3RyaW5nKGIpLnRvTG93ZXJDYXNlKCkpO1xyXG4gICAgICAgICAgICByZXR1cm4gaXNBc2MgPyBjbXAgOiAtY21wO1xyXG4gICAgICAgICAgfTtcclxuXHJcbiAgICBjb25zdCBnZXR0ZXIgPSByb3cgPT4gcm93LmRhdGFbc29ydGVkQ29sdW1uTmFtZV07XHJcbiAgICByZXR1cm4gWy4uLnByb2Nlc3Nlc10uc29ydCgoYSwgYikgPT4ge1xyXG4gICAgICByZXR1cm4gY29tcGFyZShnZXR0ZXIoYSksIGdldHRlcihiKSwgIXNvcnREZXNjZW5kaW5nKTtcclxuICAgIH0pO1xyXG4gIH07XHJcblxyXG4gIF9oYW5kbGVTZWxlY3RUYWJsZVJvdyA9IChcclxuICAgIGl0ZW06ID9BbmRyb2lkSmF2YVByb2Nlc3MsXHJcbiAgICBzZWxlY3RlZEluZGV4OiBudW1iZXIsXHJcbiAgKTogdm9pZCA9PiB7XHJcbiAgICB0aGlzLnNldFN0YXRlKHtcclxuICAgICAgc2VsZWN0ZWRQcm9jZXNzOiBpdGVtLFxyXG4gICAgICBzZWxlY3RlZFByb2Nlc3NOYW1lOiBpZHgoaXRlbSwgXyA9PiBfLm5hbWUpLFxyXG4gICAgfSk7XHJcbiAgfTtcclxuXHJcbiAgcmVuZGVyKCk6IFJlYWN0Lk5vZGUge1xyXG4gICAgY29uc3QgZW1wdHlNZXNzYWdlOiBzdHJpbmcgPVxyXG4gICAgICB0aGlzLnN0YXRlLnNlbGVjdGVkRGV2aWNlU2VyaWFsID09IG51bGxcclxuICAgICAgICA/ICdObyBkZXZpY2Ugc2VsZWN0ZWQnXHJcbiAgICAgICAgOiAnTm8gZGVidWdnYWJsZSBKYXZhIHByb2Nlc3NlcyBmb3VuZCEnO1xyXG4gICAgY29uc3QgZW1wdHlDb21wb25lbnQgPSAoKSA9PiAoXHJcbiAgICAgIDxkaXY+XHJcbiAgICAgICAge3RoaXMuc3RhdGUuamF2YVByb2Nlc3Nlcy5pc1BlbmRpbmcgPyAoXHJcbiAgICAgICAgICA8TG9hZGluZ1NwaW5uZXIgc2l6ZT1cIkVYVFJBX1NNQUxMXCIgLz5cclxuICAgICAgICApIDogKFxyXG4gICAgICAgICAgZW1wdHlNZXNzYWdlXHJcbiAgICAgICAgKX1cclxuICAgICAgPC9kaXY+XHJcbiAgICApO1xyXG5cclxuICAgIGNvbnN0IHByb2Nlc3NMaXN0Um93cyA9IHRoaXMuX3NvcnRSb3dzKFxyXG4gICAgICB0aGlzLl9maWx0ZXJKYXZhUHJvY2Vzc2VzKHRoaXMuc3RhdGUuZmlsdGVyVGV4dCkubWFwKHByb2Nlc3NSb3cgPT4ge1xyXG4gICAgICAgIGNvbnN0IGRhdGEgPSB7XHJcbiAgICAgICAgICBwaWQ6IHByb2Nlc3NSb3cucGlkLFxyXG4gICAgICAgICAgdXNlcjogcHJvY2Vzc1Jvdy51c2VyLFxyXG4gICAgICAgICAgbmFtZTogcHJvY2Vzc1Jvdy5uYW1lLFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgIGRhdGEsXHJcbiAgICAgICAgfTtcclxuICAgICAgfSksXHJcbiAgICAgIHRoaXMuc3RhdGUuc29ydGVkQ29sdW1uLFxyXG4gICAgICB0aGlzLnN0YXRlLnNvcnREZXNjZW5kaW5nLFxyXG4gICAgKTtcclxuXHJcbiAgICBjb25zdCBzZWxlY3RlZFJvd0luZGV4ID0gcHJvY2Vzc0xpc3RSb3dzLmZpbmRJbmRleChcclxuICAgICAgcm93ID0+XHJcbiAgICAgICAgcm93LmRhdGEucGlkID09PSB0aGlzLnN0YXRlLnNlbGVjdGVkUHJvY2Vzcz8ucGlkICYmXHJcbiAgICAgICAgcm93LmRhdGEubmFtZSA9PT0gdGhpcy5zdGF0ZS5zZWxlY3RlZFByb2Nlc3M/Lm5hbWUsXHJcbiAgICApO1xyXG5cclxuICAgIHJldHVybiAoXHJcbiAgICAgIDxkaXYgY2xhc3NOYW1lPVwiYmxvY2tcIj5cclxuICAgICAgICA8bGFiZWw+RGV2aWNlOjwvbGFiZWw+XHJcbiAgICAgICAgPEFkYkRldmljZVNlbGVjdG9yXHJcbiAgICAgICAgICBvbkNoYW5nZT17dGhpcy5faGFuZGxlRGV2aWNlQ2hhbmdlfVxyXG4gICAgICAgICAgdGFyZ2V0VXJpPXt0aGlzLnByb3BzLnRhcmdldFVyaX1cclxuICAgICAgICAvPlxyXG4gICAgICAgIDxsYWJlbD5EZWJ1Z2dhYmxlIEphdmEgcHJvY2Vzc2VzOiA8L2xhYmVsPlxyXG4gICAgICAgIDxBdG9tSW5wdXRcclxuICAgICAgICAgIHBsYWNlaG9sZGVyVGV4dD1cIlNlYXJjaCB3aXRoIHJlZ3VsYXIgZXhwcmVzc2lvbi4uLlwiXHJcbiAgICAgICAgICB2YWx1ZT17dGhpcy5zdGF0ZS5maWx0ZXJUZXh0fVxyXG4gICAgICAgICAgb25EaWRDaGFuZ2U9e3RoaXMuX2hhbmRsZUZpbHRlclRleHRDaGFuZ2V9XHJcbiAgICAgICAgICBzaXplPVwic21cIlxyXG4gICAgICAgICAgYXV0b2ZvY3VzPXt0cnVlfVxyXG4gICAgICAgIC8+XHJcbiAgICAgICAgPFRhYmxlXHJcbiAgICAgICAgICBjb2xsYXBzYWJsZT17ZmFsc2V9XHJcbiAgICAgICAgICBjb2x1bW5zPXt0aGlzLl9nZXRDb2x1bW5zKCl9XHJcbiAgICAgICAgICBlbXB0eUNvbXBvbmVudD17ZW1wdHlDb21wb25lbnR9XHJcbiAgICAgICAgICBmaXhlZEhlYWRlcj17dHJ1ZX1cclxuICAgICAgICAgIG1heEJvZHlIZWlnaHQ9XCIzMGVtXCJcclxuICAgICAgICAgIHJvd3M9e3Byb2Nlc3NMaXN0Um93c31cclxuICAgICAgICAgIHNvcnRhYmxlPXt0cnVlfVxyXG4gICAgICAgICAgb25Tb3J0PXt0aGlzLl9oYW5kbGVTb3J0fVxyXG4gICAgICAgICAgc29ydGVkQ29sdW1uPXt0aGlzLnN0YXRlLnNvcnRlZENvbHVtbn1cclxuICAgICAgICAgIHNvcnREZXNjZW5kaW5nPXt0aGlzLnN0YXRlLnNvcnREZXNjZW5kaW5nfVxyXG4gICAgICAgICAgc2VsZWN0YWJsZT17dHJ1ZX1cclxuICAgICAgICAgIHNlbGVjdGVkSW5kZXg9e3NlbGVjdGVkUm93SW5kZXh9XHJcbiAgICAgICAgICBvblNlbGVjdD17dGhpcy5faGFuZGxlU2VsZWN0VGFibGVSb3d9XHJcbiAgICAgICAgLz5cclxuICAgICAgPC9kaXY+XHJcbiAgICApO1xyXG4gIH1cclxufVxyXG4iXX0=