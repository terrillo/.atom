"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var DebugProtocol = _interopRequireWildcard(require("vscode-debugprotocol"));

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */
const TWO_CRLF = '\r\n\r\n';
/**
 * JSON-RPC protocol implementation over a read and write buffers.
 */

class V8Protocol {
  constructor(id, logger, sendPreprocessors, receivePreprocessors) {
    this._id = void 0;
    this._output = void 0;
    this._sequence = void 0;
    this._pendingRequests = void 0;
    this._rawData = void 0;
    this._contentLength = void 0;
    this._logger = void 0;
    this._sendPreprocessors = void 0;
    this._receivePreprocessors = void 0;
    this._id = id;
    this._logger = logger;
    this._sendPreprocessors = sendPreprocessors;
    this._receivePreprocessors = receivePreprocessors;
    this._sequence = 1;
    this._contentLength = -1;
    this._pendingRequests = new Map();
    this._rawData = new Buffer(0);
  }

  getId() {
    return this._id;
  }

  onServerError(error) {
    throw new Error('No implementation found!');
  }

  onEvent(event) {
    throw new Error('No implementation found!');
  }

  async dispatchRequest(request, response) {
    throw new Error('No implementation found!');
  }

  setOutput(output) {
    this._output = output;
  }

  send(command, args) {
    return new Promise((resolve, reject) => {
      this._doSend(command, args, result => {
        if (result.success) {
          resolve(result);
        } else {
          reject(result);
        }
      });
    });
  }

  sendResponse(response) {
    if (response.seq > 0) {
      this._logger.error(`attempt to send more than one response for command ${response.command}`);
    } else {
      this._sendMessage('response', response);
    }
  }

  _doSend(command, args, clb) {
    const request = {
      command
    };

    if (args && Object.keys(args).length > 0) {
      request.arguments = args;
    }

    this._sendMessage('request', request);

    if (clb) {
      // store callback for this request
      this._pendingRequests.set(request.seq, clb);
    }
  }

  _sendMessage(typ, message) {
    message.type = typ;
    message.seq = this._sequence++;

    this._sendPreprocessors.forEach(processor => processor(message));

    const json = JSON.stringify(message);
    const length = Buffer.byteLength(json, 'utf8');
    const packet = `Content-Length: ${length.toString()}${TWO_CRLF}${json}`;

    this._logger.info(`Sending: ${packet}`);

    this._output(packet);
  }

  handleData(data) {
    this._rawData = Buffer.concat([this._rawData, data]);

    while (true) {
      if (this._contentLength >= 0) {
        if (this._rawData.length >= this._contentLength) {
          const message = this._rawData.toString('utf8', 0, this._contentLength);

          this._rawData = this._rawData.slice(this._contentLength);
          this._contentLength = -1;

          if (message.length > 0) {
            this._logger.info(`Received message: ${message}`);

            this._dispatch(message);
          }

          continue; // there may be more complete messages to process
        }
      } else {
        const s = this._rawData.toString('utf8', 0, this._rawData.length);

        const idx = s.indexOf(TWO_CRLF);

        if (idx !== -1) {
          const match = /Content-Length: (\d+)/.exec(s);

          if (match && match[1]) {
            this._contentLength = Number(match[1]);
            this._rawData = this._rawData.slice(idx + TWO_CRLF.length);
            continue; // try to handle a complete message
          }
        }
      }

      break;
    }
  }

  _dispatch(body) {
    try {
      const rawData = JSON.parse(body);

      this._receivePreprocessors.forEach(processor => processor(rawData));

      switch (rawData.type) {
        case 'event':
          this.onEvent(rawData);
          break;

        case 'response':
          const response = rawData;

          const clb = this._pendingRequests.get(response.request_seq);

          if (clb) {
            this._pendingRequests.delete(response.request_seq);

            clb(response);
          }

          break;

        case 'request':
          const request = rawData;
          const resp = {
            type: 'response',
            seq: 0,
            command: request.command,
            request_seq: request.seq,
            success: true
          };
          this.dispatchRequest(request, resp);
          break;
      }
    } catch (e) {
      this.onServerError(new Error(e.message || e));
    }
  }

}

exports.default = V8Protocol;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1kZWJ1Z2dlci1jb21tb24vVjhQcm90b2NvbC5qcyJdLCJuYW1lcyI6WyJUV09fQ1JMRiIsIlY4UHJvdG9jb2wiLCJjb25zdHJ1Y3RvciIsImlkIiwibG9nZ2VyIiwic2VuZFByZXByb2Nlc3NvcnMiLCJyZWNlaXZlUHJlcHJvY2Vzc29ycyIsIl9pZCIsIl9vdXRwdXQiLCJfc2VxdWVuY2UiLCJfcGVuZGluZ1JlcXVlc3RzIiwiX3Jhd0RhdGEiLCJfY29udGVudExlbmd0aCIsIl9sb2dnZXIiLCJfc2VuZFByZXByb2Nlc3NvcnMiLCJfcmVjZWl2ZVByZXByb2Nlc3NvcnMiLCJNYXAiLCJCdWZmZXIiLCJnZXRJZCIsIm9uU2VydmVyRXJyb3IiLCJlcnJvciIsIkVycm9yIiwib25FdmVudCIsImV2ZW50IiwiZGlzcGF0Y2hSZXF1ZXN0IiwicmVxdWVzdCIsInJlc3BvbnNlIiwic2V0T3V0cHV0Iiwib3V0cHV0Iiwic2VuZCIsImNvbW1hbmQiLCJhcmdzIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJfZG9TZW5kIiwicmVzdWx0Iiwic3VjY2VzcyIsInNlbmRSZXNwb25zZSIsInNlcSIsIl9zZW5kTWVzc2FnZSIsImNsYiIsIk9iamVjdCIsImtleXMiLCJsZW5ndGgiLCJhcmd1bWVudHMiLCJzZXQiLCJ0eXAiLCJtZXNzYWdlIiwidHlwZSIsImZvckVhY2giLCJwcm9jZXNzb3IiLCJqc29uIiwiSlNPTiIsInN0cmluZ2lmeSIsImJ5dGVMZW5ndGgiLCJwYWNrZXQiLCJ0b1N0cmluZyIsImluZm8iLCJoYW5kbGVEYXRhIiwiZGF0YSIsImNvbmNhdCIsInNsaWNlIiwiX2Rpc3BhdGNoIiwicyIsImlkeCIsImluZGV4T2YiLCJtYXRjaCIsImV4ZWMiLCJOdW1iZXIiLCJib2R5IiwicmF3RGF0YSIsInBhcnNlIiwiZ2V0IiwicmVxdWVzdF9zZXEiLCJkZWxldGUiLCJyZXNwIiwiZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7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QW1DQyxTQUFTLElBQUlBLFNBQVMsQ0FBQ29CLE9BQUQsQ0FBekQ7O0FBRUEsY0FBUUEsT0FBTyxDQUFDdEIsSUFBaEI7QUFDRSxhQUFLLE9BQUw7QUFDRSxlQUFLM0IsT0FBTCxDQUFjaUQsT0FBZDtBQUNBOztBQUNGLGFBQUssVUFBTDtBQUNFLGdCQUFNN0MsUUFBZ0MsR0FBRzZDLE9BQXpDOztBQUNBLGdCQUFNOUIsR0FBRyxHQUFHLEtBQUsvQixnQkFBTCxDQUFzQitELEdBQXRCLENBQTBCL0MsUUFBUSxDQUFDZ0QsV0FBbkMsQ0FBWjs7QUFDQSxjQUFJakMsR0FBSixFQUFTO0FBQ1AsaUJBQUsvQixnQkFBTCxDQUFzQmlFLE1BQXRCLENBQTZCakQsUUFBUSxDQUFDZ0QsV0FBdEM7O0FBQ0FqQyxZQUFBQSxHQUFHLENBQUNmLFFBQUQsQ0FBSDtBQUNEOztBQUNEOztBQUNGLGFBQUssU0FBTDtBQUNFLGdCQUFNRCxPQUE4QixHQUFHOEMsT0FBdkM7QUFDQSxnQkFBTUssSUFBNEIsR0FBRztBQUNuQzNCLFlBQUFBLElBQUksRUFBRSxVQUQ2QjtBQUVuQ1YsWUFBQUEsR0FBRyxFQUFFLENBRjhCO0FBR25DVCxZQUFBQSxPQUFPLEVBQUVMLE9BQU8sQ0FBQ0ssT0FIa0I7QUFJbkM0QyxZQUFBQSxXQUFXLEVBQUVqRCxPQUFPLENBQUNjLEdBSmM7QUFLbkNGLFlBQUFBLE9BQU8sRUFBRTtBQUwwQixXQUFyQztBQU9BLGVBQUtiLGVBQUwsQ0FBcUJDLE9BQXJCLEVBQThCbUQsSUFBOUI7QUFDQTtBQXRCSjtBQXdCRCxLQTVCRCxDQTRCRSxPQUFPQyxDQUFQLEVBQVU7QUFDVixXQUFLMUQsYUFBTCxDQUFtQixJQUFJRSxLQUFKLENBQVV3RCxDQUFDLENBQUM3QixPQUFGLElBQWE2QixDQUF2QixDQUFuQjtBQUNEO0FBQ0Y7O0FBbEw2QiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTctcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cclxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuICpcclxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgQlNELXN0eWxlIGxpY2Vuc2UgZm91bmQgaW4gdGhlXHJcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4gQW4gYWRkaXRpb25hbCBncmFudFxyXG4gKiBvZiBwYXRlbnQgcmlnaHRzIGNhbiBiZSBmb3VuZCBpbiB0aGUgUEFURU5UUyBmaWxlIGluIHRoZSBzYW1lIGRpcmVjdG9yeS5cclxuICpcclxuICogQGZsb3dcclxuICogQGZvcm1hdFxyXG4gKi9cclxuXHJcbmltcG9ydCB0eXBlIHtNZXNzYWdlUHJvY2Vzc29yfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0ICogYXMgRGVidWdQcm90b2NvbCBmcm9tICd2c2NvZGUtZGVidWdwcm90b2NvbCc7XHJcblxyXG5jb25zdCBUV09fQ1JMRiA9ICdcXHJcXG5cXHJcXG4nO1xyXG5cclxuLyoqXHJcbiAqIEpTT04tUlBDIHByb3RvY29sIGltcGxlbWVudGF0aW9uIG92ZXIgYSByZWFkIGFuZCB3cml0ZSBidWZmZXJzLlxyXG4gKi9cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVjhQcm90b2NvbCB7XHJcbiAgX2lkOiBzdHJpbmc7XHJcbiAgX291dHB1dDogKGlucHV0OiBzdHJpbmcpID0+IG1peGVkO1xyXG4gIF9zZXF1ZW5jZTogbnVtYmVyO1xyXG4gIF9wZW5kaW5nUmVxdWVzdHM6IE1hcDxudW1iZXIsIChlOiBEZWJ1Z1Byb3RvY29sLlJlc3BvbnNlKSA9PiB2b2lkPjtcclxuICBfcmF3RGF0YTogQnVmZmVyO1xyXG4gIF9jb250ZW50TGVuZ3RoOiBudW1iZXI7XHJcbiAgX2xvZ2dlcjogbG9nNGpzJExvZ2dlcjtcclxuICBfc2VuZFByZXByb2Nlc3NvcnM6IE1lc3NhZ2VQcm9jZXNzb3JbXTtcclxuICBfcmVjZWl2ZVByZXByb2Nlc3NvcnM6IE1lc3NhZ2VQcm9jZXNzb3JbXTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBpZDogc3RyaW5nLFxyXG4gICAgbG9nZ2VyOiBsb2c0anMkTG9nZ2VyLFxyXG4gICAgc2VuZFByZXByb2Nlc3NvcnM6IE1lc3NhZ2VQcm9jZXNzb3JbXSxcclxuICAgIHJlY2VpdmVQcmVwcm9jZXNzb3JzOiBNZXNzYWdlUHJvY2Vzc29yW10sXHJcbiAgKSB7XHJcbiAgICB0aGlzLl9pZCA9IGlkO1xyXG4gICAgdGhpcy5fbG9nZ2VyID0gbG9nZ2VyO1xyXG4gICAgdGhpcy5fc2VuZFByZXByb2Nlc3NvcnMgPSBzZW5kUHJlcHJvY2Vzc29ycztcclxuICAgIHRoaXMuX3JlY2VpdmVQcmVwcm9jZXNzb3JzID0gcmVjZWl2ZVByZXByb2Nlc3NvcnM7XHJcbiAgICB0aGlzLl9zZXF1ZW5jZSA9IDE7XHJcbiAgICB0aGlzLl9jb250ZW50TGVuZ3RoID0gLTE7XHJcbiAgICB0aGlzLl9wZW5kaW5nUmVxdWVzdHMgPSBuZXcgTWFwKCk7XHJcbiAgICB0aGlzLl9yYXdEYXRhID0gbmV3IEJ1ZmZlcigwKTtcclxuICB9XHJcblxyXG4gIGdldElkKCk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdGhpcy5faWQ7XHJcbiAgfVxyXG5cclxuICBvblNlcnZlckVycm9yKGVycm9yOiBFcnJvcik6IHZvaWQge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdObyBpbXBsZW1lbnRhdGlvbiBmb3VuZCEnKTtcclxuICB9XHJcblxyXG4gIG9uRXZlbnQoZXZlbnQ6IERlYnVnUHJvdG9jb2wuRXZlbnQpOiB2b2lkIHtcclxuICAgIHRocm93IG5ldyBFcnJvcignTm8gaW1wbGVtZW50YXRpb24gZm91bmQhJyk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBkaXNwYXRjaFJlcXVlc3QoXHJcbiAgICByZXF1ZXN0OiBEZWJ1Z1Byb3RvY29sLlJlcXVlc3QsXHJcbiAgICByZXNwb25zZTogRGVidWdQcm90b2NvbC5SZXNwb25zZSxcclxuICApOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHRocm93IG5ldyBFcnJvcignTm8gaW1wbGVtZW50YXRpb24gZm91bmQhJyk7XHJcbiAgfVxyXG5cclxuICBzZXRPdXRwdXQob3V0cHV0OiAoaW5wdXQ6IHN0cmluZykgPT4gbWl4ZWQpOiB2b2lkIHtcclxuICAgIHRoaXMuX291dHB1dCA9IG91dHB1dDtcclxuICB9XHJcblxyXG4gIHNlbmQoY29tbWFuZDogc3RyaW5nLCBhcmdzOiBhbnkpOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuUmVzcG9uc2U+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHRoaXMuX2RvU2VuZChjb21tYW5kLCBhcmdzLCByZXN1bHQgPT4ge1xyXG4gICAgICAgIGlmIChyZXN1bHQuc3VjY2Vzcykge1xyXG4gICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZWplY3QocmVzdWx0KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBzZW5kUmVzcG9uc2UocmVzcG9uc2U6IERlYnVnUHJvdG9jb2wuUmVzcG9uc2UpOiB2b2lkIHtcclxuICAgIGlmIChyZXNwb25zZS5zZXEgPiAwKSB7XHJcbiAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihcclxuICAgICAgICBgYXR0ZW1wdCB0byBzZW5kIG1vcmUgdGhhbiBvbmUgcmVzcG9uc2UgZm9yIGNvbW1hbmQgJHtcclxuICAgICAgICAgIHJlc3BvbnNlLmNvbW1hbmRcclxuICAgICAgICB9YCxcclxuICAgICAgKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuX3NlbmRNZXNzYWdlKCdyZXNwb25zZScsIHJlc3BvbnNlKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIF9kb1NlbmQoXHJcbiAgICBjb21tYW5kOiBzdHJpbmcsXHJcbiAgICBhcmdzOiBhbnksXHJcbiAgICBjbGI6IChyZXN1bHQ6IERlYnVnUHJvdG9jb2wuUmVzcG9uc2UpID0+IHZvaWQsXHJcbiAgKTogdm9pZCB7XHJcbiAgICBjb25zdCByZXF1ZXN0OiBhbnkgPSB7XHJcbiAgICAgIGNvbW1hbmQsXHJcbiAgICB9O1xyXG4gICAgaWYgKGFyZ3MgJiYgT2JqZWN0LmtleXMoYXJncykubGVuZ3RoID4gMCkge1xyXG4gICAgICByZXF1ZXN0LmFyZ3VtZW50cyA9IGFyZ3M7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5fc2VuZE1lc3NhZ2UoJ3JlcXVlc3QnLCByZXF1ZXN0KTtcclxuXHJcbiAgICBpZiAoY2xiKSB7XHJcbiAgICAgIC8vIHN0b3JlIGNhbGxiYWNrIGZvciB0aGlzIHJlcXVlc3RcclxuICAgICAgdGhpcy5fcGVuZGluZ1JlcXVlc3RzLnNldChyZXF1ZXN0LnNlcSwgY2xiKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIF9zZW5kTWVzc2FnZShcclxuICAgIHR5cDogJ3JlcXVlc3QnIHwgJ3Jlc3BvbnNlJyB8ICdldmVudCcsXHJcbiAgICBtZXNzYWdlOiBEZWJ1Z1Byb3RvY29sLlByb3RvY29sTWVzc2FnZSxcclxuICApOiB2b2lkIHtcclxuICAgIG1lc3NhZ2UudHlwZSA9ICh0eXA6IGFueSk7XHJcbiAgICBtZXNzYWdlLnNlcSA9IHRoaXMuX3NlcXVlbmNlKys7XHJcblxyXG4gICAgdGhpcy5fc2VuZFByZXByb2Nlc3NvcnMuZm9yRWFjaChwcm9jZXNzb3IgPT4gcHJvY2Vzc29yKG1lc3NhZ2UpKTtcclxuICAgIGNvbnN0IGpzb24gPSBKU09OLnN0cmluZ2lmeShtZXNzYWdlKTtcclxuICAgIGNvbnN0IGxlbmd0aCA9IEJ1ZmZlci5ieXRlTGVuZ3RoKGpzb24sICd1dGY4Jyk7XHJcblxyXG4gICAgY29uc3QgcGFja2V0ID0gYENvbnRlbnQtTGVuZ3RoOiAke2xlbmd0aC50b1N0cmluZygpfSR7VFdPX0NSTEZ9JHtqc29ufWA7XHJcblxyXG4gICAgdGhpcy5fbG9nZ2VyLmluZm8oYFNlbmRpbmc6ICR7cGFja2V0fWApO1xyXG5cclxuICAgIHRoaXMuX291dHB1dChwYWNrZXQpO1xyXG4gIH1cclxuXHJcbiAgaGFuZGxlRGF0YShkYXRhOiBCdWZmZXIpOiB2b2lkIHtcclxuICAgIHRoaXMuX3Jhd0RhdGEgPSBCdWZmZXIuY29uY2F0KFt0aGlzLl9yYXdEYXRhLCBkYXRhXSk7XHJcbiAgICB3aGlsZSAodHJ1ZSkge1xyXG4gICAgICBpZiAodGhpcy5fY29udGVudExlbmd0aCA+PSAwKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuX3Jhd0RhdGEubGVuZ3RoID49IHRoaXMuX2NvbnRlbnRMZW5ndGgpIHtcclxuICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSB0aGlzLl9yYXdEYXRhLnRvU3RyaW5nKFxyXG4gICAgICAgICAgICAndXRmOCcsXHJcbiAgICAgICAgICAgIDAsXHJcbiAgICAgICAgICAgIHRoaXMuX2NvbnRlbnRMZW5ndGgsXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgICAgdGhpcy5fcmF3RGF0YSA9IHRoaXMuX3Jhd0RhdGEuc2xpY2UodGhpcy5fY29udGVudExlbmd0aCk7XHJcbiAgICAgICAgICB0aGlzLl9jb250ZW50TGVuZ3RoID0gLTE7XHJcbiAgICAgICAgICBpZiAobWVzc2FnZS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5pbmZvKGBSZWNlaXZlZCBtZXNzYWdlOiAke21lc3NhZ2V9YCk7XHJcbiAgICAgICAgICAgIHRoaXMuX2Rpc3BhdGNoKG1lc3NhZ2UpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgY29udGludWU7IC8vIHRoZXJlIG1heSBiZSBtb3JlIGNvbXBsZXRlIG1lc3NhZ2VzIHRvIHByb2Nlc3NcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY29uc3QgcyA9IHRoaXMuX3Jhd0RhdGEudG9TdHJpbmcoJ3V0ZjgnLCAwLCB0aGlzLl9yYXdEYXRhLmxlbmd0aCk7XHJcbiAgICAgICAgY29uc3QgaWR4ID0gcy5pbmRleE9mKFRXT19DUkxGKTtcclxuICAgICAgICBpZiAoaWR4ICE9PSAtMSkge1xyXG4gICAgICAgICAgY29uc3QgbWF0Y2ggPSAvQ29udGVudC1MZW5ndGg6IChcXGQrKS8uZXhlYyhzKTtcclxuICAgICAgICAgIGlmIChtYXRjaCAmJiBtYXRjaFsxXSkge1xyXG4gICAgICAgICAgICB0aGlzLl9jb250ZW50TGVuZ3RoID0gTnVtYmVyKG1hdGNoWzFdKTtcclxuICAgICAgICAgICAgdGhpcy5fcmF3RGF0YSA9IHRoaXMuX3Jhd0RhdGEuc2xpY2UoaWR4ICsgVFdPX0NSTEYubGVuZ3RoKTtcclxuICAgICAgICAgICAgY29udGludWU7IC8vIHRyeSB0byBoYW5kbGUgYSBjb21wbGV0ZSBtZXNzYWdlXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgX2Rpc3BhdGNoKGJvZHk6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgcmF3RGF0YSA9IEpTT04ucGFyc2UoYm9keSk7XHJcbiAgICAgIHRoaXMuX3JlY2VpdmVQcmVwcm9jZXNzb3JzLmZvckVhY2gocHJvY2Vzc29yID0+IHByb2Nlc3NvcihyYXdEYXRhKSk7XHJcblxyXG4gICAgICBzd2l0Y2ggKHJhd0RhdGEudHlwZSkge1xyXG4gICAgICAgIGNhc2UgJ2V2ZW50JzpcclxuICAgICAgICAgIHRoaXMub25FdmVudCgocmF3RGF0YTogRGVidWdQcm90b2NvbC5FdmVudCkpO1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAncmVzcG9uc2UnOlxyXG4gICAgICAgICAgY29uc3QgcmVzcG9uc2U6IERlYnVnUHJvdG9jb2wuUmVzcG9uc2UgPSByYXdEYXRhO1xyXG4gICAgICAgICAgY29uc3QgY2xiID0gdGhpcy5fcGVuZGluZ1JlcXVlc3RzLmdldChyZXNwb25zZS5yZXF1ZXN0X3NlcSk7XHJcbiAgICAgICAgICBpZiAoY2xiKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX3BlbmRpbmdSZXF1ZXN0cy5kZWxldGUocmVzcG9uc2UucmVxdWVzdF9zZXEpO1xyXG4gICAgICAgICAgICBjbGIocmVzcG9uc2UpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAncmVxdWVzdCc6XHJcbiAgICAgICAgICBjb25zdCByZXF1ZXN0OiBEZWJ1Z1Byb3RvY29sLlJlcXVlc3QgPSByYXdEYXRhO1xyXG4gICAgICAgICAgY29uc3QgcmVzcDogRGVidWdQcm90b2NvbC5SZXNwb25zZSA9IHtcclxuICAgICAgICAgICAgdHlwZTogJ3Jlc3BvbnNlJyxcclxuICAgICAgICAgICAgc2VxOiAwLFxyXG4gICAgICAgICAgICBjb21tYW5kOiByZXF1ZXN0LmNvbW1hbmQsXHJcbiAgICAgICAgICAgIHJlcXVlc3Rfc2VxOiByZXF1ZXN0LnNlcSxcclxuICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICB0aGlzLmRpc3BhdGNoUmVxdWVzdChyZXF1ZXN0LCByZXNwKTtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcbiAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgIHRoaXMub25TZXJ2ZXJFcnJvcihuZXcgRXJyb3IoZS5tZXNzYWdlIHx8IGUpKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19