#!/usr/bin/env node

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */
'use strict';
/* eslint nuclide-internal/no-commonjs: 0 */

/* eslint-disable no-console */
// This file is both the main and worker process.

if (process.send) {
  runChild();
} else {
  runParent();
}

function runParent() {
  const argv = require('yargs').usage('Usage: $0 [directory] [options]').option('overwrite', {
    describe: 'Overwrite original files with transpile output.',
    type: 'boolean'
  }).help('help').argv;

  const assert = require('assert');

  const child_process = require('child_process');

  const fs = require('fs');

  const os = require('os');

  const path = require('path');

  const pathRules = require('../lib/path-rules');

  const developmentFilePath = path.join(__dirname, '../../../DEVELOPMENT');
  const cpus = os.cpus();
  const numWorkers = cpus ? Math.max(cpus.length - 1, 1) : 1;
  const count = {
    skipped: 0,
    transpiled: 0
  };
  const directory = argv._[0] && path.resolve(argv._[0]);
  const jsFiles = pathRules.getIncludedFiles(directory); // Sanity checks

  jsFiles.forEach(filename => {
    assert(path.isAbsolute(filename));
  });
  console.log('%s workers. %s files...', numWorkers, jsFiles.length);

  const ProgressBar = require('progress');

  const progressBar = new ProgressBar('transpiling [:bar] (:current/:total) :etas', {
    complete: '=',
    incomplete: ' ',
    width: 20,
    total: jsFiles.length
  });

  for (let i = 0; i < numWorkers; i++) {
    child_process.fork(__filename).on('message', function (m) {
      if (m.transpiled === true) {
        count.transpiled++;
        progressBar.tick();
      } else if (m.skipped === true) {
        count.skipped++;
        progressBar.tick();
      }

      if (jsFiles.length) {
        this.send({
          cmd: 'next',
          filename: jsFiles.pop()
        });
      } else {
        this.kill();
      }
    }).on('exit', code => {
      if (code) {
        process.exit(code);
      }
    }).send({
      cmd: 'init',
      overwrite: argv.overwrite
    });
  }

  process.once('exit', code => {
    if (code !== 0) {
      return;
    }

    if (argv.overwrite && !directory && fs.existsSync(developmentFilePath)) {
      fs.unlinkSync(developmentFilePath);
    }

    console.log('transpiled: %s | skipped: %s | %ds', count.transpiled, count.skipped, process.uptime().toFixed(2));
  });
}

function runChild() {
  const fs = require('fs');

  const NodeTranspiler = require('../lib/NodeTranspiler');

  const nodeTranspiler = new NodeTranspiler();
  let overwrite;
  process.on('message', m => {
    const res = {};

    if (m.cmd === 'next' && fs.lstatSync(m.filename).isFile()) {
      const src = fs.readFileSync(m.filename);

      if (NodeTranspiler.shouldCompile(src)) {
        const code = nodeTranspiler.transformWithCache(src, m.filename);

        if (overwrite) {
          fs.writeFileSync(m.filename, code);
        }

        res.transpiled = true;
      } else {
        res.skipped = true;
      }
    } else if (m.cmd === 'init') {
      overwrite = m.overwrite;
    }

    process.send(res);
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL251Y2xpZGUvbnVjbGlkZS1ub2RlLXRyYW5zcGlsZXIvYmluL3JlbGVhc2UtdHJhbnNwaWxlLmpzIl0sIm5hbWVzIjpbInByb2Nlc3MiLCJzZW5kIiwicnVuQ2hpbGQiLCJydW5QYXJlbnQiLCJhcmd2IiwicmVxdWlyZSIsInVzYWdlIiwib3B0aW9uIiwiZGVzY3JpYmUiLCJ0eXBlIiwiaGVscCIsImFzc2VydCIsImNoaWxkX3Byb2Nlc3MiLCJmcyIsIm9zIiwicGF0aCIsInBhdGhSdWxlcyIsImRldmVsb3BtZW50RmlsZVBhdGgiLCJqb2luIiwiX19kaXJuYW1lIiwiY3B1cyIsIm51bVdvcmtlcnMiLCJNYXRoIiwibWF4IiwibGVuZ3RoIiwiY291bnQiLCJza2lwcGVkIiwidHJhbnNwaWxlZCIsImRpcmVjdG9yeSIsIl8iLCJyZXNvbHZlIiwianNGaWxlcyIsImdldEluY2x1ZGVkRmlsZXMiLCJmb3JFYWNoIiwiZmlsZW5hbWUiLCJpc0Fic29sdXRlIiwiY29uc29sZSIsImxvZyIsIlByb2dyZXNzQmFyIiwicHJvZ3Jlc3NCYXIiLCJjb21wbGV0ZSIsImluY29tcGxldGUiLCJ3aWR0aCIsInRvdGFsIiwiaSIsImZvcmsiLCJfX2ZpbGVuYW1lIiwib24iLCJtIiwidGljayIsImNtZCIsInBvcCIsImtpbGwiLCJjb2RlIiwiZXhpdCIsIm92ZXJ3cml0ZSIsIm9uY2UiLCJleGlzdHNTeW5jIiwidW5saW5rU3luYyIsInVwdGltZSIsInRvRml4ZWQiLCJOb2RlVHJhbnNwaWxlciIsIm5vZGVUcmFuc3BpbGVyIiwicmVzIiwibHN0YXRTeW5jIiwiaXNGaWxlIiwic3JjIiwicmVhZEZpbGVTeW5jIiwic2hvdWxkQ29tcGlsZSIsInRyYW5zZm9ybVdpdGhDYWNoZSIsIndyaXRlRmlsZVN5bmMiXSwibWFwcGluZ3MiOiJBQUFBOztBQUNBOzs7Ozs7Ozs7OztBQVdBO0FBRUE7O0FBQ0E7QUFFQTs7QUFDQSxJQUFJQSxPQUFPLENBQUNDLElBQVosRUFB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IjpbIiMhL3Vzci9iaW4vZW52IG5vZGVcclxuLyoqXHJcbiAqIENvcHlyaWdodCAoYykgMjAxNy1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxyXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4gKlxyXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBCU0Qtc3R5bGUgbGljZW5zZSBmb3VuZCBpbiB0aGVcclxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLiBBbiBhZGRpdGlvbmFsIGdyYW50XHJcbiAqIG9mIHBhdGVudCByaWdodHMgY2FuIGJlIGZvdW5kIGluIHRoZSBQQVRFTlRTIGZpbGUgaW4gdGhlIHNhbWUgZGlyZWN0b3J5LlxyXG4gKlxyXG4gKiBAbm9mbG93XHJcbiAqIEBmb3JtYXRcclxuICovXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbi8qIGVzbGludCBudWNsaWRlLWludGVybmFsL25vLWNvbW1vbmpzOiAwICovXHJcbi8qIGVzbGludC1kaXNhYmxlIG5vLWNvbnNvbGUgKi9cclxuXHJcbi8vIFRoaXMgZmlsZSBpcyBib3RoIHRoZSBtYWluIGFuZCB3b3JrZXIgcHJvY2Vzcy5cclxuaWYgKHByb2Nlc3Muc2VuZCkge1xyXG4gIHJ1bkNoaWxkKCk7XHJcbn0gZWxzZSB7XHJcbiAgcnVuUGFyZW50KCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJ1blBhcmVudCgpIHtcclxuICBjb25zdCBhcmd2ID0gcmVxdWlyZSgneWFyZ3MnKVxyXG4gICAgLnVzYWdlKCdVc2FnZTogJDAgW2RpcmVjdG9yeV0gW29wdGlvbnNdJylcclxuICAgIC5vcHRpb24oJ292ZXJ3cml0ZScsIHtcclxuICAgICAgZGVzY3JpYmU6ICdPdmVyd3JpdGUgb3JpZ2luYWwgZmlsZXMgd2l0aCB0cmFuc3BpbGUgb3V0cHV0LicsXHJcbiAgICAgIHR5cGU6ICdib29sZWFuJyxcclxuICAgIH0pXHJcbiAgICAuaGVscCgnaGVscCcpLmFyZ3Y7XHJcblxyXG4gIGNvbnN0IGFzc2VydCA9IHJlcXVpcmUoJ2Fzc2VydCcpO1xyXG4gIGNvbnN0IGNoaWxkX3Byb2Nlc3MgPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJyk7XHJcbiAgY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xyXG4gIGNvbnN0IG9zID0gcmVxdWlyZSgnb3MnKTtcclxuICBjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xyXG5cclxuICBjb25zdCBwYXRoUnVsZXMgPSByZXF1aXJlKCcuLi9saWIvcGF0aC1ydWxlcycpO1xyXG5cclxuICBjb25zdCBkZXZlbG9wbWVudEZpbGVQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uLy4uLy4uL0RFVkVMT1BNRU5UJyk7XHJcblxyXG4gIGNvbnN0IGNwdXMgPSBvcy5jcHVzKCk7XHJcbiAgY29uc3QgbnVtV29ya2VycyA9IGNwdXMgPyBNYXRoLm1heChjcHVzLmxlbmd0aCAtIDEsIDEpIDogMTtcclxuXHJcbiAgY29uc3QgY291bnQgPSB7XHJcbiAgICBza2lwcGVkOiAwLFxyXG4gICAgdHJhbnNwaWxlZDogMCxcclxuICB9O1xyXG5cclxuICBjb25zdCBkaXJlY3RvcnkgPSBhcmd2Ll9bMF0gJiYgcGF0aC5yZXNvbHZlKGFyZ3YuX1swXSk7XHJcbiAgY29uc3QganNGaWxlcyA9IHBhdGhSdWxlcy5nZXRJbmNsdWRlZEZpbGVzKGRpcmVjdG9yeSk7XHJcblxyXG4gIC8vIFNhbml0eSBjaGVja3NcclxuICBqc0ZpbGVzLmZvckVhY2goZmlsZW5hbWUgPT4ge1xyXG4gICAgYXNzZXJ0KHBhdGguaXNBYnNvbHV0ZShmaWxlbmFtZSkpO1xyXG4gIH0pO1xyXG5cclxuICBjb25zb2xlLmxvZygnJXMgd29ya2Vycy4gJXMgZmlsZXMuLi4nLCBudW1Xb3JrZXJzLCBqc0ZpbGVzLmxlbmd0aCk7XHJcblxyXG4gIGNvbnN0IFByb2dyZXNzQmFyID0gcmVxdWlyZSgncHJvZ3Jlc3MnKTtcclxuICBjb25zdCBwcm9ncmVzc0JhciA9IG5ldyBQcm9ncmVzc0JhcihcclxuICAgICd0cmFuc3BpbGluZyBbOmJhcl0gKDpjdXJyZW50Lzp0b3RhbCkgOmV0YXMnLFxyXG4gICAge1xyXG4gICAgICBjb21wbGV0ZTogJz0nLFxyXG4gICAgICBpbmNvbXBsZXRlOiAnICcsXHJcbiAgICAgIHdpZHRoOiAyMCxcclxuICAgICAgdG90YWw6IGpzRmlsZXMubGVuZ3RoLFxyXG4gICAgfSxcclxuICApO1xyXG5cclxuICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVdvcmtlcnM7IGkrKykge1xyXG4gICAgY2hpbGRfcHJvY2Vzc1xyXG4gICAgICAuZm9yayhfX2ZpbGVuYW1lKVxyXG4gICAgICAub24oJ21lc3NhZ2UnLCBmdW5jdGlvbihtKSB7XHJcbiAgICAgICAgaWYgKG0udHJhbnNwaWxlZCA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgY291bnQudHJhbnNwaWxlZCsrO1xyXG4gICAgICAgICAgcHJvZ3Jlc3NCYXIudGljaygpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAobS5za2lwcGVkID09PSB0cnVlKSB7XHJcbiAgICAgICAgICBjb3VudC5za2lwcGVkKys7XHJcbiAgICAgICAgICBwcm9ncmVzc0Jhci50aWNrKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChqc0ZpbGVzLmxlbmd0aCkge1xyXG4gICAgICAgICAgdGhpcy5zZW5kKHtjbWQ6ICduZXh0JywgZmlsZW5hbWU6IGpzRmlsZXMucG9wKCl9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhpcy5raWxsKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgICAub24oJ2V4aXQnLCBjb2RlID0+IHtcclxuICAgICAgICBpZiAoY29kZSkge1xyXG4gICAgICAgICAgcHJvY2Vzcy5leGl0KGNvZGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgICAgLnNlbmQoe2NtZDogJ2luaXQnLCBvdmVyd3JpdGU6IGFyZ3Yub3ZlcndyaXRlfSk7XHJcbiAgfVxyXG5cclxuICBwcm9jZXNzLm9uY2UoJ2V4aXQnLCBjb2RlID0+IHtcclxuICAgIGlmIChjb2RlICE9PSAwKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmIChhcmd2Lm92ZXJ3cml0ZSAmJiAhZGlyZWN0b3J5ICYmIGZzLmV4aXN0c1N5bmMoZGV2ZWxvcG1lbnRGaWxlUGF0aCkpIHtcclxuICAgICAgZnMudW5saW5rU3luYyhkZXZlbG9wbWVudEZpbGVQYXRoKTtcclxuICAgIH1cclxuICAgIGNvbnNvbGUubG9nKFxyXG4gICAgICAndHJhbnNwaWxlZDogJXMgfCBza2lwcGVkOiAlcyB8ICVkcycsXHJcbiAgICAgIGNvdW50LnRyYW5zcGlsZWQsXHJcbiAgICAgIGNvdW50LnNraXBwZWQsXHJcbiAgICAgIHByb2Nlc3MudXB0aW1lKCkudG9GaXhlZCgyKSxcclxuICAgICk7XHJcbiAgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJ1bkNoaWxkKCkge1xyXG4gIGNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcclxuXHJcbiAgY29uc3QgTm9kZVRyYW5zcGlsZXIgPSByZXF1aXJlKCcuLi9saWIvTm9kZVRyYW5zcGlsZXInKTtcclxuICBjb25zdCBub2RlVHJhbnNwaWxlciA9IG5ldyBOb2RlVHJhbnNwaWxlcigpO1xyXG5cclxuICBsZXQgb3ZlcndyaXRlO1xyXG5cclxuICBwcm9jZXNzLm9uKCdtZXNzYWdlJywgbSA9PiB7XHJcbiAgICBjb25zdCByZXMgPSB7fTtcclxuICAgIGlmIChtLmNtZCA9PT0gJ25leHQnICYmIGZzLmxzdGF0U3luYyhtLmZpbGVuYW1lKS5pc0ZpbGUoKSkge1xyXG4gICAgICBjb25zdCBzcmMgPSBmcy5yZWFkRmlsZVN5bmMobS5maWxlbmFtZSk7XHJcbiAgICAgIGlmIChOb2RlVHJhbnNwaWxlci5zaG91bGRDb21waWxlKHNyYykpIHtcclxuICAgICAgICBjb25zdCBjb2RlID0gbm9kZVRyYW5zcGlsZXIudHJhbnNmb3JtV2l0aENhY2hlKHNyYywgbS5maWxlbmFtZSk7XHJcbiAgICAgICAgaWYgKG92ZXJ3cml0ZSkge1xyXG4gICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhtLmZpbGVuYW1lLCBjb2RlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmVzLnRyYW5zcGlsZWQgPSB0cnVlO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJlcy5za2lwcGVkID0gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIGlmIChtLmNtZCA9PT0gJ2luaXQnKSB7XHJcbiAgICAgIG92ZXJ3cml0ZSA9IG0ub3ZlcndyaXRlO1xyXG4gICAgfVxyXG4gICAgcHJvY2Vzcy5zZW5kKHJlcyk7XHJcbiAgfSk7XHJcbn1cclxuIl19