"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.setRpcService = setRpcService;
exports.listenToRemoteDebugCommands = listenToRemoteDebugCommands;
exports.getRemoteDebuggerCommandServiceByNuclideUri = getRemoteDebuggerCommandServiceByNuclideUri;

var _debugger = require("@atom-ide-community/nuclide-commons-atom/debugger");

var _projects = require("@atom-ide-community/nuclide-commons-atom/projects");

var _nuclideUri = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/nuclideUri"));

var _observable = require("@atom-ide-community/nuclide-commons/observable");

var _UniversalDisposable = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/UniversalDisposable"));

var _rxjsCompatUmdMin = require("rxjs-compat/bundles/rxjs-compat.umd.min.js");

var _analytics = require("@atom-ide-community/nuclide-commons/analytics");

var _nullthrows = _interopRequireDefault(require("nullthrows"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let _rpcService = null;

function getPythonAttachTargetProcessConfig(targetRootUri, target) {
  return {
    targetUri: targetRootUri,
    debugMode: "attach",
    adapterType: "python",
    config: getPythonAttachTargetConfig(target),
    servicedFileExtensions: ["py"]
  };
}

function getPythonAttachTargetConfig(target) {
  return {
    localRoot: target.localRoot,
    remoteRoot: target.remoteRoot,
    port: target.port,
    host: "127.0.0.1"
  };
}

function setRpcService(rpcService) {
  _rpcService = rpcService;
  return new _UniversalDisposable.default(() => {
    _rpcService = null;
  });
}

function listenToRemoteDebugCommands() {
  const addedHostnames = (0, _projects.observeAddedHostnames)().startWith("local");
  const remoteDebuggerServices = addedHostnames.flatMap(hostname => {
    const rootUri = hostname === "local" ? "" : _nuclideUri.default.createRemoteUri(hostname, "/");
    const service = getRemoteDebuggerCommandServiceByNuclideUri(rootUri);

    if (service == null) {
      const {
        getLogger
      } = require("log4js");

      getLogger().error("null remote command service for uri:", rootUri);
      return _rxjsCompatUmdMin.Observable.empty();
    } else {
      return _rxjsCompatUmdMin.Observable.of({
        service,
        rootUri
      });
    }
  });
  return new _UniversalDisposable.default(remoteDebuggerServices.flatMap(({
    service,
    rootUri
  }) => {
    return service.observeAttachDebugTargets().refCount().map(targets => findDuplicateAttachTargetIds(targets));
  }).subscribe(duplicateTargetIds => notifyDuplicateDebugTargets(duplicateTargetIds)), remoteDebuggerServices.flatMap(({
    service,
    rootUri
  }) => {
    return service.observeRemoteDebugCommands().refCount().catch(error => {
      // eslint-disable-next-line no-console
      console.warn("Failed to listen to remote debug commands - " + "You could be running locally with two Atom windows. " + `IsLocal: ${String(rootUri === "")}`);
      return _rxjsCompatUmdMin.Observable.empty();
    }).map(command => ({
      rootUri,
      command
    }));
  }).let((0, _observable.fastDebounce)(500)).subscribe(async ({
    rootUri,
    command
  }) => {
    const attachProcessConfig = getPythonAttachTargetProcessConfig(rootUri, command.target);
    const debuggerService = await (0, _debugger.getDebuggerService)();
    (0, _analytics.track)("fb-python-debugger-auto-attach");
    debuggerService.startVspDebugging(attachProcessConfig); // Otherwise, we're already debugging that target.
  }));
}

let shouldNotifyDuplicateTargets = true;
let duplicateTargetsNotification;

function notifyDuplicateDebugTargets(duplicateTargetIds) {
  if (duplicateTargetIds.size > 0 && shouldNotifyDuplicateTargets && duplicateTargetsNotification == null) {
    const formattedIds = Array.from(duplicateTargetIds).join(", ");
    duplicateTargetsNotification = atom.notifications.addInfo(`Debugger: duplicate attach targets: \`${formattedIds}\``, {
      buttons: [{
        onDidClick: () => {
          shouldNotifyDuplicateTargets = false;

          if (duplicateTargetsNotification != null) {
            duplicateTargetsNotification.dismiss();
          }
        },
        text: "Ignore"
      }],
      description: `Nuclide debugger detected duplicate attach targets with ids (${formattedIds}) ` + "That could be instagram running multiple processes - check out https://our.intern.facebook.com/intern/dex/instagram-server/debugging-with-nuclide/",
      dismissable: true
    });
    duplicateTargetsNotification.onDidDismiss(() => {
      duplicateTargetsNotification = null;
    });
  }
}

function findDuplicateAttachTargetIds(targets) {
  const targetIds = new Set();
  const duplicateTargetIds = new Set();
  targets.forEach(target => {
    const {
      id
    } = target;

    if (id == null) {
      return;
    }

    if (targetIds.has(id)) {
      duplicateTargetIds.add(id);
    } else {
      targetIds.add(id);
    }
  });
  return duplicateTargetIds;
}

function getRemoteDebuggerCommandServiceByNuclideUri(uri) {
  const RemoteDebuggerCommandServiceLocal = require("./RemoteDebuggerCommandService");

  if (_rpcService == null && !_nuclideUri.default.isRemote(uri)) {
    return RemoteDebuggerCommandServiceLocal;
  }

  return (0, _nullthrows.default)(_rpcService).getServiceByNuclideUri("RemoteDebuggerCommandService", uri);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInV0aWxzLmpzIl0sIm5hbWVzIjpbIl9ycGNTZXJ2aWNlIiwiZ2V0UHl0aG9uQXR0YWNoVGFyZ2V0UHJvY2Vzc0NvbmZpZyIsInRhcmdldFJvb3RVcmkiLCJ0YXJnZXQiLCJ0YXJnZXRVcmkiLCJkZWJ1Z01vZGUiLCJhZGFwdGVyVHlwZSIsImNvbmZpZyIsImdldFB5dGhvbkF0dGFjaFRhcmdldENvbmZpZyIsInNlcnZpY2VkRmlsZUV4dGVuc2lvbnMiLCJsb2NhbFJvb3QiLCJyZW1vdGVSb290IiwicG9ydCIsImhvc3QiLCJzZXRScGNTZXJ2aWNlIiwicnBjU2VydmljZSIsIlVuaXZlcnNhbERpc3Bvc2FibGUiLCJsaXN0ZW5Ub1JlbW90ZURlYnVnQ29tbWFuZHMiLCJhZGRlZEhvc3RuYW1lcyIsInN0YXJ0V2l0aCIsInJlbW90ZURlYnVnZ2VyU2VydmljZXMiLCJmbGF0TWFwIiwiaG9zdG5hbWUiLCJyb290VXJpIiwibnVjbGlkZVVyaSIsImNyZWF0ZVJlbW90ZVVyaSIsInNlcnZpY2UiLCJnZXRSZW1vdGVEZWJ1Z2dlckNvbW1hbmRTZXJ2aWNlQnlOdWNsaWRlVXJpIiwiZ2V0TG9nZ2VyIiwicmVxdWlyZSIsImVycm9yIiwiT2JzZXJ2YWJsZSIsImVtcHR5Iiwib2YiLCJvYnNlcnZlQXR0YWNoRGVidWdUYXJnZXRzIiwicmVmQ291bnQiLCJtYXAiLCJ0YXJnZXRzIiwiZmluZER1cGxpY2F0ZUF0dGFjaFRhcmdldElkcyIsInN1YnNjcmliZSIsImR1cGxpY2F0ZVRhcmdldElkcyIsIm5vdGlmeUR1cGxpY2F0ZURlYnVnVGFyZ2V0cyIsIm9ic2VydmVSZW1vdGVEZWJ1Z0NvbW1hbmRzIiwiY2F0Y2giLCJjb25zb2xlIiwid2FybiIsIlN0cmluZyIsImNvbW1hbmQiLCJsZXQiLCJhdHRhY2hQcm9jZXNzQ29uZmlnIiwiZGVidWdnZXJTZXJ2aWNlIiwic3RhcnRWc3BEZWJ1Z2dpbmciLCJzaG91bGROb3RpZnlEdXBsaWNhdGVUYXJnZXRzIiwiZHVwbGljYXRlVGFyZ2V0c05vdGlmaWNhdGlvbiIsInNpemUiLCJmb3JtYXR0ZWRJZHMiLCJBcnJheSIsImZyb20iLCJqb2luIiwiYXRvbSIsIm5vdGlmaWNhdGlvbnMiLCJhZGRJbmZvIiwiYnV0dG9ucyIsIm9uRGlkQ2xpY2siLCJkaXNtaXNzIiwidGV4dCIsImRlc2NyaXB0aW9uIiwiZGlzbWlzc2FibGUiLCJvbkRpZERpc21pc3MiLCJ0YXJnZXRJZHMiLCJTZXQiLCJmb3JFYWNoIiwiaWQiLCJoYXMiLCJhZGQiLCJ1cmkiLCJSZW1vdGVEZWJ1Z2dlckNvbW1hbmRTZXJ2aWNlTG9jYWwiLCJpc1JlbW90ZSIsImdldFNlcnZpY2VCeU51Y2xpZGVVcmkiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUtBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRUEsSUFBSUEsV0FBZ0MsR0FBRyxJQUF2Qzs7QUFFQSxTQUFTQyxrQ0FBVCxDQUNFQyxhQURGLEVBRUVDLE1BRkYsRUFHa0I7QUFDaEIsU0FBTztBQUNMQyxJQUFBQSxTQUFTLEVBQUVGLGFBRE47QUFFTEcsSUFBQUEsU0FBUyxFQUFFLFFBRk47QUFHTEMsSUFBQUEsV0FBVyxFQUFFLFFBSFI7QUFJTEMsSUFBQUEsTUFBTSxFQUFFQywyQkFBMkIsQ0FBQ0wsTUFBRCxDQUo5QjtBQUtMTSxJQUFBQSxzQkFBc0IsRUFBRSxDQUFDLElBQUQ7QUFMbkIsR0FBUDtBQU9EOztBQUVELFNBQVNELDJCQUFULENBQXFDTCxNQUFyQyxFQUFpRjtBQUMvRSxTQUFPO0FBQ0xPLElBQUFBLFNBQVMsRUFBRVAsTUFBTSxDQUFDTyxTQURiO0FBRUxDLElBQUFBLFVBQVUsRUFBRVIsTUFBTSxDQUFDUSxVQUZkO0FBR0xDLElBQUFBLElBQUksRUFBRVQsTUFBTSxDQUFDUyxJQUhSO0FBSUxDLElBQUFBLElBQUksRUFBRTtBQUpELEdBQVA7QUFNRDs7QUFFTSxTQUFTQyxhQUFULENBQXVCQyxVQUF2QixFQUFvRTtBQUN6RWYsRUFBQUEsV0FBVyxHQUFH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RCxLQUZELE1BRU87QUFDTEgsTUFBQUEsU0FBUyxDQUFDSyxHQUFWLENBQWNGLEVBQWQ7QUFDRDtBQUNGLEdBVkQ7QUFXQSxTQUFPaEMsa0JBQVA7QUFDRDs7QUFFTSxTQUFTYiwyQ0FBVCxDQUFxRGdELEdBQXJELEVBQW9HO0FBQ3pHLFFBQU1DLGlDQUFpQyxHQUFHL0MsT0FBTyxDQUFDLGdDQUFELENBQWpEOztBQUNBLE1BQUk3QixXQUFXLElBQUksSUFBZixJQUF1QixDQUFDd0Isb0JBQVdxRCxRQUFYLENBQW9CRixHQUFwQixDQUE1QixFQUFzRDtBQUNwRCxXQUFPQyxpQ0FBUDtBQUNEOztBQUVELFNBQU8seUJBQVc1RSxXQUFYLEVBQXdCOEUsc0JBQXhCLENBQStDLDhCQUEvQyxFQUErRUgsR0FBL0UsQ0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBOdWNsaWRlVXJpIH0gZnJvbSBcIkBhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1jb21tb25zL251Y2xpZGVVcmlcIlxuaW1wb3J0IHR5cGUgeyBQeXRob25EZWJ1Z2dlckF0dGFjaFRhcmdldCwgUmVtb3RlRGVidWdDb21tYW5kUmVxdWVzdCB9IGZyb20gXCIuL1JlbW90ZURlYnVnZ2VyQ29tbWFuZFNlcnZpY2VcIlxuaW1wb3J0IHR5cGUgeyBJUHJvY2Vzc0NvbmZpZyB9IGZyb20gXCJAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtZGVidWdnZXItY29tbW9uXCJcbmltcG9ydCB0eXBlb2YgKiBhcyBSZW1vdGVEZWJ1Z2dlckNvbW1hbmRTZXJ2aWNlIGZyb20gXCIuL1JlbW90ZURlYnVnZ2VyQ29tbWFuZFNlcnZpY2VcIlxuXG5pbXBvcnQgeyBnZXREZWJ1Z2dlclNlcnZpY2UgfSBmcm9tIFwiQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMtYXRvbS9kZWJ1Z2dlclwiXG5pbXBvcnQgeyBvYnNlcnZlQWRkZWRIb3N0bmFtZXMgfSBmcm9tIFwiQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMtYXRvbS9wcm9qZWN0c1wiXG5pbXBvcnQgbnVjbGlkZVVyaSBmcm9tIFwiQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvbnVjbGlkZVVyaVwiXG5pbXBvcnQgeyBmYXN0RGVib3VuY2UgfSBmcm9tIFwiQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvb2JzZXJ2YWJsZVwiXG5pbXBvcnQgVW5pdmVyc2FsRGlzcG9zYWJsZSBmcm9tIFwiQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvVW5pdmVyc2FsRGlzcG9zYWJsZVwiXG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSBcInJ4anMtY29tcGF0L2J1bmRsZXMvcnhqcy1jb21wYXQudW1kLm1pbi5qc1wiXG5pbXBvcnQgeyB0cmFjayB9IGZyb20gXCJAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy9hbmFseXRpY3NcIlxuaW1wb3J0IG51bGx0aHJvd3MgZnJvbSBcIm51bGx0aHJvd3NcIlxuXG5sZXQgX3JwY1NlcnZpY2U6ID9udWNsaWRlJFJwY1NlcnZpY2UgPSBudWxsXG5cbmZ1bmN0aW9uIGdldFB5dGhvbkF0dGFjaFRhcmdldFByb2Nlc3NDb25maWcoXG4gIHRhcmdldFJvb3RVcmk6IE51Y2xpZGVVcmksXG4gIHRhcmdldDogUHl0aG9uRGVidWdnZXJBdHRhY2hUYXJnZXRcbik6IElQcm9jZXNzQ29uZmlnIHtcbiAgcmV0dXJuIHtcbiAgICB0YXJnZXRVcmk6IHRhcmdldFJvb3RVcmksXG4gICAgZGVidWdNb2RlOiBcImF0dGFjaFwiLFxuICAgIGFkYXB0ZXJUeXBlOiBcInB5dGhvblwiLFxuICAgIGNvbmZpZzogZ2V0UHl0aG9uQXR0YWNoVGFyZ2V0Q29uZmlnKHRhcmdldCksXG4gICAgc2VydmljZWRGaWxlRXh0ZW5zaW9uczogW1wicHlcIl0sXG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0UHl0aG9uQXR0YWNoVGFyZ2V0Q29uZmlnKHRhcmdldDogUHl0aG9uRGVidWdnZXJBdHRhY2hUYXJnZXQpOiBPYmplY3Qge1xuICByZXR1cm4ge1xuICAgIGxvY2FsUm9vdDogdGFyZ2V0LmxvY2FsUm9vdCxcbiAgICByZW1vdGVSb290OiB0YXJnZXQucmVtb3RlUm9vdCxcbiAgICBwb3J0OiB0YXJnZXQucG9ydCxcbiAgICBob3N0OiBcIjEyNy4wLjAuMVwiLFxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXRScGNTZXJ2aWNlKHJwY1NlcnZpY2U6IG51Y2xpZGUkUnBjU2VydmljZSk6IElEaXNwb3NhYmxlIHtcbiAgX3JwY1NlcnZpY2UgPSBycGNTZXJ2aWNlXG4gIHJldHVybiBuZXcgVW5pdmVyc2FsRGlzcG9zYWJsZSgoKSA9PiB7XG4gICAgX3JwY1NlcnZpY2UgPSBudWxsXG4gIH0pXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBsaXN0ZW5Ub1JlbW90ZURlYnVnQ29tbWFuZHMoKTogSURpc3Bvc2FibGUge1xuICBjb25zdCBhZGRlZEhvc3RuYW1lcyA9IG9ic2VydmVBZGRlZEhvc3RuYW1lcygpLnN0YXJ0V2l0aChcImxvY2FsXCIpXG5cbiAgY29uc3QgcmVtb3RlRGVidWdnZXJTZXJ2aWNlcyA9IGFkZGVkSG9zdG5hbWVzLmZsYXRNYXAoKGhvc3RuYW1lKSA9PiB7XG4gICAgY29uc3Qgcm9vdFVyaSA9IGhvc3RuYW1lID09PSBcImxvY2FsXCIgPyBcIlwiIDogbnVjbGlkZVVyaS5jcmVhdGVSZW1vdGVVcmkoaG9zdG5hbWUsIFwiL1wiKVxuICAgIGNvbnN0IHNlcnZpY2UgPSBnZXRSZW1vdGVEZWJ1Z2dlckNvbW1hbmRTZXJ2aWNlQnlOdWNsaWRlVXJpKHJvb3RVcmkpXG4gICAgaWYgKHNlcnZpY2UgPT0gbnVsbCkge1xuICAgICAgY29uc3QgeyBnZXRMb2dnZXIgfSA9IHJlcXVpcmUoXCJsb2c0anNcIilcbiAgICAgIGdldExvZ2dlcigpLmVycm9yKFwibnVsbCByZW1vdGUgY29tbWFuZCBzZXJ2aWNlIGZvciB1cmk6XCIsIHJvb3RVcmkpXG4gICAgICByZXR1cm4gT2JzZXJ2YWJsZS5lbXB0eSgpXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBPYnNlcnZhYmxlLm9mKHsgc2VydmljZSwgcm9vdFVyaSB9KVxuICAgIH1cbiAgfSlcblxuICByZXR1cm4gbmV3IFVuaXZlcnNhbERpc3Bvc2FibGUoXG4gICAgcmVtb3RlRGVidWdnZXJTZXJ2aWNlc1xuICAgICAgLmZsYXRNYXAoKHsgc2VydmljZSwgcm9vdFVyaSB9KSA9PiB7XG4gICAgICAgIHJldHVybiBzZXJ2aWNlXG4gICAgICAgICAgLm9ic2VydmVBdHRhY2hEZWJ1Z1RhcmdldHMoKVxuICAgICAgICAgIC5yZWZDb3VudCgpXG4gICAgICAgICAgLm1hcCgodGFyZ2V0cykgPT4gZmluZER1cGxpY2F0ZUF0dGFjaFRhcmdldElkcyh0YXJnZXRzKSlcbiAgICAgIH0pXG5cbiAgICAgIC5zdWJzY3JpYmUoKGR1cGxpY2F0ZVRhcmdldElkcykgPT4gbm90aWZ5RHVwbGljYXRlRGVidWdUYXJnZXRzKGR1cGxpY2F0ZVRhcmdldElkcykpLFxuICAgIHJlbW90ZURlYnVnZ2VyU2VydmljZXNcbiAgICAgIC5mbGF0TWFwKCh7IHNlcnZpY2UsIHJvb3RVcmkgfSkgPT4ge1xuICAgICAgICByZXR1cm4gc2VydmljZVxuICAgICAgICAgIC5vYnNlcnZlUmVtb3RlRGVidWdDb21tYW5kcygpXG4gICAgICAgICAgLnJlZkNvdW50KClcbiAgICAgICAgICAuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgICAgICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICAgICAgICBcIkZhaWxlZCB0byBsaXN0ZW4gdG8gcmVtb3RlIGRlYnVnIGNvbW1hbmRzIC0gXCIgK1xuICAgICAgICAgICAgICAgIFwiWW91IGNvdWxkIGJlIHJ1bm5pbmcgbG9jYWxseSB3aXRoIHR3byBBdG9tIHdpbmRvd3MuIFwiICtcbiAgICAgICAgICAgICAgICBgSXNMb2NhbDogJHtTdHJpbmcocm9vdFVyaSA9PT0gXCJcIil9YFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuZW1wdHkoKVxuICAgICAgICAgIH0pXG4gICAgICAgICAgLm1hcCgoY29tbWFuZDogUmVtb3RlRGVidWdDb21tYW5kUmVxdWVzdCkgPT4gKHsgcm9vdFVyaSwgY29tbWFuZCB9KSlcbiAgICAgIH0pXG4gICAgICAubGV0KGZhc3REZWJvdW5jZSg1MDApKVxuICAgICAgLnN1YnNjcmliZShhc3luYyAoeyByb290VXJpLCBjb21tYW5kIH0pID0+IHtcbiAgICAgICAgY29uc3QgYXR0YWNoUHJvY2Vzc0NvbmZpZyA9IGdldFB5dGhvbkF0dGFjaFRhcmdldFByb2Nlc3NDb25maWcocm9vdFVyaSwgY29tbWFuZC50YXJnZXQpXG4gICAgICAgIGNvbnN0IGRlYnVnZ2VyU2VydmljZSA9IGF3YWl0IGdldERlYnVnZ2VyU2VydmljZSgpXG4gICAgICAgIHRyYWNrKFwiZmItcHl0aG9uLWRlYnVnZ2VyLWF1dG8tYXR0YWNoXCIpXG4gICAgICAgIGRlYnVnZ2VyU2VydmljZS5zdGFydFZzcERlYnVnZ2luZyhhdHRhY2hQcm9jZXNzQ29uZmlnKVxuICAgICAgICAvLyBPdGhlcndpc2UsIHdlJ3JlIGFscmVhZHkgZGVidWdnaW5nIHRoYXQgdGFyZ2V0LlxuICAgICAgfSlcbiAgKVxufVxuXG5sZXQgc2hvdWxkTm90aWZ5RHVwbGljYXRlVGFyZ2V0cyA9IHRydWVcbmxldCBkdXBsaWNhdGVUYXJnZXRzTm90aWZpY2F0aW9uXG5cbmZ1bmN0aW9uIG5vdGlmeUR1cGxpY2F0ZURlYnVnVGFyZ2V0cyhkdXBsaWNhdGVUYXJnZXRJZHM6IFNldDxzdHJpbmc+KTogdm9pZCB7XG4gIGlmIChkdXBsaWNhdGVUYXJnZXRJZHMuc2l6ZSA+IDAgJiYgc2hvdWxkTm90aWZ5RHVwbGljYXRlVGFyZ2V0cyAmJiBkdXBsaWNhdGVUYXJnZXRzTm90aWZpY2F0aW9uID09IG51bGwpIHtcbiAgICBjb25zdCBmb3JtYXR0ZWRJZHMgPSBBcnJheS5mcm9tKGR1cGxpY2F0ZVRhcmdldElkcykuam9pbihcIiwgXCIpXG4gICAgZHVwbGljYXRlVGFyZ2V0c05vdGlmaWNhdGlvbiA9IGF0b20ubm90aWZpY2F0aW9ucy5hZGRJbmZvKFxuICAgICAgYERlYnVnZ2VyOiBkdXBsaWNhdGUgYXR0YWNoIHRhcmdldHM6IFxcYCR7Zm9ybWF0dGVkSWRzfVxcYGAsXG4gICAgICB7XG4gICAgICAgIGJ1dHRvbnM6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBvbkRpZENsaWNrOiAoKSA9PiB7XG4gICAgICAgICAgICAgIHNob3VsZE5vdGlmeUR1cGxpY2F0ZVRhcmdldHMgPSBmYWxzZVxuICAgICAgICAgICAgICBpZiAoZHVwbGljYXRlVGFyZ2V0c05vdGlmaWNhdGlvbiAhPSBudWxsKSB7XG4gICAgICAgICAgICAgICAgZHVwbGljYXRlVGFyZ2V0c05vdGlmaWNhdGlvbi5kaXNtaXNzKClcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHRleHQ6IFwiSWdub3JlXCIsXG4gICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgICAgZGVzY3JpcHRpb246XG4gICAgICAgICAgYE51Y2xpZGUgZGVidWdnZXIgZGV0ZWN0ZWQgZHVwbGljYXRlIGF0dGFjaCB0YXJnZXRzIHdpdGggaWRzICgke2Zvcm1hdHRlZElkc30pIGAgK1xuICAgICAgICAgIFwiVGhhdCBjb3VsZCBiZSBpbnN0YWdyYW0gcnVubmluZyBtdWx0aXBsZSBwcm9jZXNzZXMgLSBjaGVjayBvdXQgaHR0cHM6Ly9vdXIuaW50ZXJuLmZhY2Vib29rLmNvbS9pbnRlcm4vZGV4L2luc3RhZ3JhbS1zZXJ2ZXIvZGVidWdnaW5nLXdpdGgtbnVjbGlkZS9cIixcbiAgICAgICAgZGlzbWlzc2FibGU6IHRydWUsXG4gICAgICB9XG4gICAgKVxuICAgIGR1cGxpY2F0ZVRhcmdldHNOb3RpZmljYXRpb24ub25EaWREaXNtaXNzKCgpID0+IHtcbiAgICAgIGR1cGxpY2F0ZVRhcmdldHNOb3RpZmljYXRpb24gPSBudWxsXG4gICAgfSlcbiAgfVxufVxuXG5mdW5jdGlvbiBmaW5kRHVwbGljYXRlQXR0YWNoVGFyZ2V0SWRzKHRhcmdldHM6IEFycmF5PFB5dGhvbkRlYnVnZ2VyQXR0YWNoVGFyZ2V0Pik6IFNldDxzdHJpbmc+IHtcbiAgY29uc3QgdGFyZ2V0SWRzID0gbmV3IFNldCgpXG4gIGNvbnN0IGR1cGxpY2F0ZVRhcmdldElkcyA9IG5ldyBTZXQoKVxuICB0YXJnZXRzLmZvckVhY2goKHRhcmdldCkgPT4ge1xuICAgIGNvbnN0IHsgaWQgfSA9IHRhcmdldFxuICAgIGlmIChpZCA9PSBudWxsKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgaWYgKHRhcmdldElkcy5oYXMoaWQpKSB7XG4gICAgICBkdXBsaWNhdGVUYXJnZXRJZHMuYWRkKGlkKVxuICAgIH0gZWxzZSB7XG4gICAgICB0YXJnZXRJZHMuYWRkKGlkKVxuICAgIH1cbiAgfSlcbiAgcmV0dXJuIGR1cGxpY2F0ZVRhcmdldElkc1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UmVtb3RlRGVidWdnZXJDb21tYW5kU2VydmljZUJ5TnVjbGlkZVVyaSh1cmk6IE51Y2xpZGVVcmkpOiBSZW1vdGVEZWJ1Z2dlckNvbW1hbmRTZXJ2aWNlIHtcbiAgY29uc3QgUmVtb3RlRGVidWdnZXJDb21tYW5kU2VydmljZUxvY2FsID0gcmVxdWlyZShcIi4vUmVtb3RlRGVidWdnZXJDb21tYW5kU2VydmljZVwiKVxuICBpZiAoX3JwY1NlcnZpY2UgPT0gbnVsbCAmJiAhbnVjbGlkZVVyaS5pc1JlbW90ZSh1cmkpKSB7XG4gICAgcmV0dXJuIFJlbW90ZURlYnVnZ2VyQ29tbWFuZFNlcnZpY2VMb2NhbFxuICB9XG5cbiAgcmV0dXJuIG51bGx0aHJvd3MoX3JwY1NlcnZpY2UpLmdldFNlcnZpY2VCeU51Y2xpZGVVcmkoXCJSZW1vdGVEZWJ1Z2dlckNvbW1hbmRTZXJ2aWNlXCIsIHVyaSlcbn1cbiJdfQ==