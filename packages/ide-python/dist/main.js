"use strict";

var _main = require("./debugger/main");

const {
  shell
} = require("electron");

const whichSync = require("which").sync;

const {
  AutoLanguageClient
} = require("atom-languageclient");

const {
  detectVirtualEnv,
  detectPipEnv,
  replacePipEnvPathVar,
  sanitizeConfig
} = require("./utils");

// Ref: https://github.com/nteract/hydrogen/blob/master/lib/autocomplete-provider.js#L33
// adapted from http://stackoverflow.com/q/5474008
const PYTHON_REGEX = /(([^\W\d]|[\u00A0-\uFFFF])[\w.\u00A0-\uFFFF]*)|\.$/;

class PythonLanguageClient extends AutoLanguageClient {
  activate() {
    super.activate();

    if (!atom.packages.isPackageLoaded("atom-ide-base")) {
      // install if not installed
      // eslint-disable-next-line @typescript-eslint/no-var-requires
      require("atom-package-deps").install("ide-python", true).then(() => {
        // enable if disabled
        atom.packages.enablePackage("atom-ide-base");
        atom.notifications.addSuccess("ide-python: atom-ide-base was installed and enabled...");
      });
    } // Remove deprecated option


    atom.config.unset("ide-python.pylsPath");
    (0, _main.activate)();
  }
  /* eslint-disable class-methods-use-this */


  getGrammarScopes() {
    return ["source.python", "python"];
  }

  getLanguageName() {
    return "Python";
  }

  getServerName() {
    return "pyls";
  }

  getRootConfigurationKey() {
    return "ide-python";
  }

  getPyLs() {
    if (this.pyls === undefined) {
      let pyls = atom.config.get("ide-python.pyls") || "pylsp"; // check if it exists

      if (whichSync(pyls, {
        nothrow: true
      }) === null) {
        // use the other one if it doesn't exist
        pyls = pyls === "pylsp" ? "pyls" : "pylsp";
      } // cache


      this.pyls = pyls;
    }

    return this.pyls;
  }

  mapConfigurationObject(configuration) {
    const lsp = this.getPyLs();
    return {
      [lsp]: {
        configurationSources: configuration.pylsConfigurationSources,
        rope: sanitizeConfig(configuration.rope),
        plugins: configuration.pylsPlugins
      }
    };
  }
  /* eslint-enable class-methods-use-this */


  async startServerProcess(projectPath) {
    const venvPath = (await detectPipEnv(projectPath)) || (await detectVirtualEnv(projectPath));
    const pylsEnvironment = Object.assign({}, process.env);

    if (venvPath) {
      pylsEnvironment.VIRTUAL_ENV = venvPath;
    }

    let pythonBin = atom.config.get("ide-python.python") || "python3"; // replace $PIPENV_PATH in the path

    pythonBin = replacePipEnvPathVar(pythonBin, venvPath); // check if it exists

    if (whichSync(pythonBin, {
      nothrow: true
    }) === null) {
      pythonBin = "python";
    }

    this.python = pythonBin;
    const childProcess = super.spawn(this.python, ["-m", this.getPyLs()], {
      cwd: projectPath,
      env: pylsEnvironment
    });
    return childProcess;
  }

  onSpawnError(err) {
    const description = err.code === "ENOENT" ? `No Python interpreter found at \`${this.python}\`.` : `Could not spawn the Python interpreter \`${this.python}\`.`;
    atom.notifications.addError("`ide-python` could not launch your Python runtime.", {
      dismissable: true,
      description: `${description}<p>If you have Python installed please set "Python Executable" setting correctly. If you do not please install Python.</p>`
    });
  }

  onSpawnClose(code, signal) {
    if (code !== 0 && signal === null) {
      atom.notifications.addError("Unable to start the Python language server.", {
        dismissable: true,
        buttons: [{
          text: "Install Instructions",
          onDidClick: () => atom.workspace.open("atom://config/packages/ide-python")
        }, {
          text: "Download Python",
          onDidClick: () => shell.openExternal("https://www.python.org/downloads/")
        }],
        description: "Make sure to install `pylsp` 0.19 or newer by running:\n" + "```\n" + `${this.python} -m pip install 'python-lsp-server[all]'\n` + `${this.python} -m pip install git+https://github.com/tomv564/pyls-mypy.git\n` + "```"
      });
    }
  }

  getSuggestions(request) {
    if (!PYTHON_REGEX.test(request.prefix)) {
      return null;
    }

    return super.getSuggestions(request);
  }

  deactivate() {
    (0, _main.dispose)();
    return Promise.race([super.deactivate(), this.createTimeoutPromise(2000)]);
  }

  createTimeoutPromise(milliseconds) {
    return new Promise(resolve => {
      const timeout = setTimeout(() => {
        clearTimeout(timeout);
        this.logger.error(`Server failed to shutdown in ${milliseconds}ms, forcing termination`);
        resolve();
      }, milliseconds);
    });
  }

}

const pythonClient = new PythonLanguageClient();
pythonClient.createDebuggerProvider = _main.createDebuggerProvider; // add the debugger

module.exports = pythonClient;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4uanMiXSwibmFtZXMiOlsic2hlbGwiLCJyZXF1aXJlIiwid2hpY2hTeW5jIiwic3luYyIsIkF1dG9MYW5ndWFnZUNsaWVudCIsImRldGVjdFZpcnR1YWxFbnYiLCJkZXRlY3RQaXBFbnYiLCJyZXBsYWNlUGlwRW52UGF0aFZhciIsInNhbml0aXplQ29uZmlnIiwiUFlUSE9OX1JFR0VYIiwiUHl0aG9uTGFuZ3VhZ2VDbGllbnQiLCJhY3RpdmF0ZSIsImF0b20iLCJwYWNrYWdlcyIsImlzUGFja2FnZUxvYWRlZCIsImluc3RhbGwiLCJ0aGVuIiwiZW5hYmxlUGFja2FnZSIsIm5vdGlmaWNhdGlvbnMiLCJhZGRTdWNjZXNzIiwiY29uZmlnIiwidW5zZXQiLCJnZXRHcmFtbWFyU2NvcGVzIiwiZ2V0TGFuZ3VhZ2VOYW1lIiwiZ2V0U2VydmVyTmFtZSIsImdldFJvb3RDb25maWd1cmF0aW9uS2V5IiwiZ2V0UHlMcyIsInB5bHMiLCJ1bmRlZmluZWQiLCJnZXQiLCJub3Rocm93IiwibWFwQ29uZmlndXJhdGlvbk9iamVjdCIsImNvbmZpZ3VyYXRpb24iLCJsc3AiLCJjb25maWd1cmF0aW9uU291cmNlcyIsInB5bHNDb25maWd1cmF0aW9uU291cmNlcyIsInJvcGUiLCJwbHVnaW5zIiwicHlsc1BsdWdpbnMiLCJzdGFydFNlcnZlclByb2Nlc3MiLCJwcm9qZWN0UGF0aCIsInZlbnZQYXRoIiwicHlsc0Vudmlyb25tZW50IiwiT2JqZWN0IiwiYXNzaWduIiwicHJvY2VzcyIsImVudiIsIlZJUlRVQUxfRU5WIiwicHl0aG9uQmluIiwicHl0aG9uIiwiY2hpbGRQcm9jZXNzIiwic3Bhd24iLCJjd2QiLCJvblNwYXduRXJyb3IiLCJlcnIiLCJkZXNjcmlwdGlvbiIsImNvZGUiLCJhZGRFcnJvciIsImRpc21pc3NhYmxlIiwib25TcGF3bkNsb3NlIiwic2lnbmFsIiwiYnV0dG9ucyIsInRleHQiLCJvbkRpZENsaWNrIiwid29ya3NwYWNlIiwib3BlbiIsIm9wZW5FeHRlcm5hbCIsImdldFN1Z2dlc3Rpb25zIiwicmVxdWVzdCIsInRlc3QiLCJwcmVmaXgiLCJkZWFjdGl2YXRlIiwiUHJvbWlzZSIsInJhY2UiLCJjcmVhdGVUaW1lb3V0UHJvbWlzZSIsIm1pbGxpc2Vjb25kcyIsInJlc29sdmUiLCJ0aW1lb3V0Iiwic2V0VGltZW91dCIsImNsZWFyVGltZW91dCIsImxvZ2dlciIsImVycm9yIiwicHl0aG9uQ2xpZW50IiwiY3JlYXRlRGVidWdnZXJQcm92aWRlciIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBS0E7O0FBTEEsTUFBTTtBQUFFQSxFQUFBQTtBQUFGLElBQVlDLE9BQU8sQ0FBQyxVQUFELENBQXpCOztBQUNBLE1BQU1DLFNBQVMsR0FBR0QsT0FBTyxDQUFDLE9BQUQsQ0FBUCxDQUFpQkUsSUFBbkM7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQXlCSCxPQUFPLENBQUMscUJBQUQsQ0FBdEM7O0FBQ0EsTUFBTTtBQUFFSSxFQUFBQSxnQkFBRjtBQUFvQkMsRUFBQUEsWUFBcEI7QUFBa0NDLEVBQUFBLG9CQUFsQztBQUF3REMsRUFBQUE7QUFBeEQsSUFBMkVQLE9BQU8sQ0FBQyxTQUFELENBQXhGOztBQUlBO0FBQ0E7QUFDQSxNQUFNUSxZQUFZLEdBQUcsb0RBQXJCOztBQUVBLE1BQU1DLG9CQUFOLFNBQW1DTixrQkFBbkMsQ0FBc0Q7QUFDcERPLEVBQUFBLFFBQVEsR0FBRztBQUNULFVBQU1BLFFBQU47O0FBQ0EsUUFBSSxDQUFDQyxJQUFJLENBQUNDLFFBQUwsQ0FBY0MsZUFBZCxDQUE4QixlQUE5QixDQUFMLEVBQXFEO0FBQ25EO0FBQ0E7QUFDQWIsTUFBQUEsT0FBTyxDQUFDLG1CQUFELENBQVAsQ0FDR2MsT0FESCxDQUNXLFlBRFgsRUFDeUIsSUFEekIsRUFFR0MsSUFGSCxDQUVRLE1BQU07QUFDVjtBQUNBSixRQUFBQSxJQUFJLENBQUNDLFFBQUwsQ0FBY0ksYUFBZCxDQUE0QixlQUE1QjtBQUNBTCxRQUFBQSxJQUFJ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QUFDRSxNQUExQixDQUFMLEVBQXdDO0FBQ3RDLGFBQU8sSUFBUDtBQUNEOztBQUNELFdBQU8sTUFBTUgsY0FBTixDQUFxQkMsT0FBckIsQ0FBUDtBQUNEOztBQUVERyxFQUFBQSxVQUFVLEdBQUc7QUFDWDtBQUNBLFdBQU9DLE9BQU8sQ0FBQ0MsSUFBUixDQUFhLENBQUMsTUFBTUYsVUFBTixFQUFELEVBQXFCLEtBQUtHLG9CQUFMLENBQTBCLElBQTFCLENBQXJCLENBQWIsQ0FBUDtBQUNEOztBQUVEQSxFQUFBQSxvQkFBb0IsQ0FBQ0MsWUFBRCxFQUFlO0FBQ2pDLFdBQU8sSUFBSUgsT0FBSixDQUFhSSxPQUFELElBQWE7QUFDOUIsWUFBTUMsT0FBTyxHQUFHQyxVQUFVLENBQUMsTUFBTTtBQUMvQkMsUUFBQUEsWUFBWSxDQUFDRixPQUFELENBQVo7QUFDQSxhQUFLRyxNQUFMLENBQVlDLEtBQVosQ0FBbUIsZ0NBQStCTixZQUFhLHlCQUEvRDtBQUNBQyxRQUFBQSxPQUFPO0FBQ1IsT0FKeUIsRUFJdkJELFlBSnVCLENBQTFCO0FBS0QsS0FOTSxDQUFQO0FBT0Q7O0FBOUltRDs7QUFpSnRELE1BQU1PLFlBQVksR0FBRyxJQUFJeEUsb0JBQUosRUFBckI7QUFDQXdFLFlBQVksQ0FBQ0Msc0JBQWIsR0FBc0NBLDRCQUF0QyxDLENBQTZEOztBQUM3REMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCSCxZQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgc2hlbGwgfSA9IHJlcXVpcmUoXCJlbGVjdHJvblwiKVxuY29uc3Qgd2hpY2hTeW5jID0gcmVxdWlyZShcIndoaWNoXCIpLnN5bmNcbmNvbnN0IHsgQXV0b0xhbmd1YWdlQ2xpZW50IH0gPSByZXF1aXJlKFwiYXRvbS1sYW5ndWFnZWNsaWVudFwiKVxuY29uc3QgeyBkZXRlY3RWaXJ0dWFsRW52LCBkZXRlY3RQaXBFbnYsIHJlcGxhY2VQaXBFbnZQYXRoVmFyLCBzYW5pdGl6ZUNvbmZpZyB9ID0gcmVxdWlyZShcIi4vdXRpbHNcIilcblxuaW1wb3J0IHsgY3JlYXRlRGVidWdnZXJQcm92aWRlciwgYWN0aXZhdGUgYXMgZGVidWdnZXJBY3RpdmF0ZSwgZGlzcG9zZSBhcyBkZWJ1Z2dlckRpc3Bvc2UgfSBmcm9tIFwiLi9kZWJ1Z2dlci9tYWluXCJcblxuLy8gUmVmOiBodHRwczovL2dpdGh1Yi5jb20vbnRlcmFjdC9oeWRyb2dlbi9ibG9iL21hc3Rlci9saWIvYXV0b2NvbXBsZXRlLXByb3ZpZGVyLmpzI0wzM1xuLy8gYWRhcHRlZCBmcm9tIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xLzU0NzQwMDhcbmNvbnN0IFBZVEhPTl9SRUdFWCA9IC8oKFteXFxXXFxkXXxbXFx1MDBBMC1cXHVGRkZGXSlbXFx3LlxcdTAwQTAtXFx1RkZGRl0qKXxcXC4kL1xuXG5jbGFzcyBQeXRob25MYW5ndWFnZUNsaWVudCBleHRlbmRzIEF1dG9MYW5ndWFnZUNsaWVudCB7XG4gIGFjdGl2YXRlKCkge1xuICAgIHN1cGVyLmFjdGl2YXRlKClcbiAgICBpZiAoIWF0b20ucGFja2FnZXMuaXNQYWNrYWdlTG9hZGVkKFwiYXRvbS1pZGUtYmFzZVwiKSkge1xuICAgICAgLy8gaW5zdGFsbCBpZiBub3QgaW5zdGFsbGVkXG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXZhci1yZXF1aXJlc1xuICAgICAgcmVxdWlyZShcImF0b20tcGFja2FnZS1kZXBzXCIpXG4gICAgICAgIC5pbnN0YWxsKFwiaWRlLXB5dGhvblwiLCB0cnVlKVxuICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgLy8gZW5hYmxlIGlmIGRpc2FibGVkXG4gICAgICAgICAgYXRvbS5wYWNrYWdlcy5lbmFibGVQYWNrYWdlKFwiYXRvbS1pZGUtYmFzZVwiKVxuICAgICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRTdWNjZXNzKFwiaWRlLXB5dGhvbjogYXRvbS1pZGUtYmFzZSB3YXMgaW5zdGFsbGVkIGFuZCBlbmFibGVkLi4uXCIpXG4gICAgICAgIH0pXG4gICAgfVxuICAgIC8vIFJlbW92ZSBkZXByZWNhdGVkIG9wdGlvblxuICAgIGF0b20uY29uZmlnLnVuc2V0KFwiaWRlLXB5dGhvbi5weWxzUGF0aFwiKVxuICAgIGRlYnVnZ2VyQWN0aXZhdGUoKVxuICB9XG5cbiAgLyogZXNsaW50LWRpc2FibGUgY2xhc3MtbWV0aG9kcy11c2UtdGhpcyAqL1xuICBnZXRHcmFtbWFyU2NvcGVzKCkge1xuICAgIHJldHVybiBbXCJzb3VyY2UucHl0aG9uXCIsIFwicHl0aG9uXCJdXG4gIH1cblxuICBnZXRMYW5ndWFnZU5hbWUoKSB7XG4gICAgcmV0dXJuIFwiUHl0aG9uXCJcbiAgfVxuXG4gIGdldFNlcnZlck5hbWUoKSB7XG4gICAgcmV0dXJuIFwicHlsc1wiXG4gIH1cblxuICBnZXRSb290Q29uZmlndXJhdGlvbktleSgpIHtcbiAgICByZXR1cm4gXCJpZGUtcHl0aG9uXCJcbiAgfVxuXG4gIGdldFB5THMoKSB7XG4gICAgaWYgKHRoaXMucHlscyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBsZXQgcHlscyA9IGF0b20uY29uZmlnLmdldChcImlkZS1weXRob24ucHlsc1wiKSB8fCBcInB5bHNwXCJcbiAgICAgIC8vIGNoZWNrIGlmIGl0IGV4aXN0c1xuICAgICAgaWYgKHdoaWNoU3luYyhweWxzLCB7IG5vdGhyb3c6IHRydWUgfSkgPT09IG51bGwpIHtcbiAgICAgICAgLy8gdXNlIHRoZSBvdGhlciBvbmUgaWYgaXQgZG9lc24ndCBleGlzdFxuICAgICAgICBweWxzID0gcHlscyA9PT0gXCJweWxzcFwiID8gXCJweWxzXCIgOiBcInB5bHNwXCJcbiAgICAgIH1cbiAgICAgIC8vIGNhY2hlXG4gICAgICB0aGlzLnB5bHMgPSBweWxzXG4gICAgfVxuICAgIHJldHVybiB0aGlzLnB5bHNcbiAgfVxuXG4gIG1hcENvbmZpZ3VyYXRpb25PYmplY3QoY29uZmlndXJhdGlvbikge1xuICAgIGNvbnN0IGxzcCA9IHRoaXMuZ2V0UHlMcygpXG4gICAgcmV0dXJuIHtcbiAgICAgIFtsc3BdOiB7XG4gICAgICAgIGNvbmZpZ3VyYXRpb25Tb3VyY2VzOiBjb25maWd1cmF0aW9uLnB5bHNDb25maWd1cmF0aW9uU291cmNlcyxcbiAgICAgICAgcm9wZTogc2FuaXRpemVDb25maWcoY29uZmlndXJhdGlvbi5yb3BlKSxcbiAgICAgICAgcGx1Z2luczogY29uZmlndXJhdGlvbi5weWxzUGx1Z2lucyxcbiAgICAgIH0sXG4gICAgfVxuICB9XG4gIC8qIGVzbGludC1lbmFibGUgY2xhc3MtbWV0aG9kcy11c2UtdGhpcyAqL1xuXG4gIGFzeW5jIHN0YXJ0U2VydmVyUHJvY2Vzcyhwcm9qZWN0UGF0aCkge1xuICAgIGNvbnN0IHZlbnZQYXRoID0gKGF3YWl0IGRldGVjdFBpcEVudihwcm9qZWN0UGF0aCkpIHx8IChhd2FpdCBkZXRlY3RWaXJ0dWFsRW52KHByb2plY3RQYXRoKSlcbiAgICBjb25zdCBweWxzRW52aXJvbm1lbnQgPSBPYmplY3QuYXNzaWduKHt9LCBwcm9jZXNzLmVudilcbiAgICBpZiAodmVudlBhdGgpIHtcbiAgICAgIHB5bHNFbnZpcm9ubWVudC5WSVJUVUFMX0VOViA9IHZlbnZQYXRoXG4gICAgfVxuXG4gICAgbGV0IHB5dGhvbkJpbiA9IGF0b20uY29uZmlnLmdldChcImlkZS1weXRob24ucHl0aG9uXCIpIHx8IFwicHl0aG9uM1wiXG5cbiAgICAvLyByZXBsYWNlICRQSVBFTlZfUEFUSCBpbiB0aGUgcGF0aFxuICAgIHB5dGhvbkJpbiA9IHJlcGxhY2VQaXBFbnZQYXRoVmFyKHB5dGhvbkJpbiwgdmVudlBhdGgpXG5cbiAgICAvLyBjaGVjayBpZiBpdCBleGlzdHNcbiAgICBpZiAod2hpY2hTeW5jKHB5dGhvbkJpbiwgeyBub3Rocm93OiB0cnVlIH0pID09PSBudWxsKSB7XG4gICAgICBweXRob25CaW4gPSBcInB5dGhvblwiXG4gICAgfVxuICAgIHRoaXMucHl0aG9uID0gcHl0aG9uQmluXG5cbiAgICBjb25zdCBjaGlsZFByb2Nlc3MgPSBzdXBlci5zcGF3bih0aGlzLnB5dGhvbiwgW1wiLW1cIiwgdGhpcy5nZXRQeUxzKCldLCB7XG4gICAgICBjd2Q6IHByb2plY3RQYXRoLFxuICAgICAgZW52OiBweWxzRW52aXJvbm1lbnQsXG4gICAgfSlcbiAgICByZXR1cm4gY2hpbGRQcm9jZXNzXG4gIH1cblxuICBvblNwYXduRXJyb3IoZXJyKSB7XG4gICAgY29uc3QgZGVzY3JpcHRpb24gPVxuICAgICAgZXJyLmNvZGUgPT09IFwiRU5PRU5UXCJcbiAgICAgICAgPyBgTm8gUHl0aG9uIGludGVycHJldGVyIGZvdW5kIGF0IFxcYCR7dGhpcy5weXRob259XFxgLmBcbiAgICAgICAgOiBgQ291bGQgbm90IHNwYXduIHRoZSBQeXRob24gaW50ZXJwcmV0ZXIgXFxgJHt0aGlzLnB5dGhvbn1cXGAuYFxuICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihcImBpZGUtcHl0aG9uYCBjb3VsZCBub3QgbGF1bmNoIHlvdXIgUHl0aG9uIHJ1bnRpbWUuXCIsIHtcbiAgICAgIGRpc21pc3NhYmxlOiB0cnVlLFxuICAgICAgZGVzY3JpcHRpb246IGAke2Rlc2NyaXB0aW9ufTxwPklmIHlvdSBoYXZlIFB5dGhvbiBpbnN0YWxsZWQgcGxlYXNlIHNldCBcIlB5dGhvbiBFeGVjdXRhYmxlXCIgc2V0dGluZyBjb3JyZWN0bHkuIElmIHlvdSBkbyBub3QgcGxlYXNlIGluc3RhbGwgUHl0aG9uLjwvcD5gLFxuICAgIH0pXG4gIH1cblxuICBvblNwYXduQ2xvc2UoY29kZSwgc2lnbmFsKSB7XG4gICAgaWYgKGNvZGUgIT09IDAgJiYgc2lnbmFsID09PSBudWxsKSB7XG4gICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoXCJVbmFibGUgdG8gc3RhcnQgdGhlIFB5dGhvbiBsYW5ndWFnZSBzZXJ2ZXIuXCIsIHtcbiAgICAgICAgZGlzbWlzc2FibGU6IHRydWUsXG4gICAgICAgIGJ1dHRvbnM6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICB0ZXh0OiBcIkluc3RhbGwgSW5zdHJ1Y3Rpb25zXCIsXG4gICAgICAgICAgICBvbkRpZENsaWNrOiAoKSA9PiBhdG9tLndvcmtzcGFjZS5vcGVuKFwiYXRvbTovL2NvbmZpZy9wYWNrYWdlcy9pZGUtcHl0aG9uXCIpLFxuICAgICAgICAgIH0sXG4gICAgICAgICAge1xuICAgICAgICAgICAgdGV4dDogXCJEb3dubG9hZCBQeXRob25cIixcbiAgICAgICAgICAgIG9uRGlkQ2xpY2s6ICgpID0+IHNoZWxsLm9wZW5FeHRlcm5hbChcImh0dHBzOi8vd3d3LnB5dGhvbi5vcmcvZG93bmxvYWRzL1wiKSxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgICBkZXNjcmlwdGlvbjpcbiAgICAgICAgICBcIk1ha2Ugc3VyZSB0byBpbnN0YWxsIGBweWxzcGAgMC4xOSBvciBuZXdlciBieSBydW5uaW5nOlxcblwiICtcbiAgICAgICAgICBcImBgYFxcblwiICtcbiAgICAgICAgICBgJHt0aGlzLnB5dGhvbn0gLW0gcGlwIGluc3RhbGwgJ3B5dGhvbi1sc3Atc2VydmVyW2FsbF0nXFxuYCArXG4gICAgICAgICAgYCR7dGhpcy5weXRob259IC1tIHBpcCBpbnN0YWxsIGdpdCtodHRwczovL2dpdGh1Yi5jb20vdG9tdjU2NC9weWxzLW15cHkuZ2l0XFxuYCArXG4gICAgICAgICAgXCJgYGBcIixcbiAgICAgIH0pXG4gICAgfVxuICB9XG5cbiAgZ2V0U3VnZ2VzdGlvbnMocmVxdWVzdCkge1xuICAgIGlmICghUFlUSE9OX1JFR0VYLnRlc3QocmVxdWVzdC5wcmVmaXgpKSB7XG4gICAgICByZXR1cm4gbnVsbFxuICAgIH1cbiAgICByZXR1cm4gc3VwZXIuZ2V0U3VnZ2VzdGlvbnMocmVxdWVzdClcbiAgfVxuXG4gIGRlYWN0aXZhdGUoKSB7XG4gICAgZGVidWdnZXJEaXNwb3NlKClcbiAgICByZXR1cm4gUHJvbWlzZS5yYWNlKFtzdXBlci5kZWFjdGl2YXRlKCksIHRoaXMuY3JlYXRlVGltZW91dFByb21pc2UoMjAwMCldKVxuICB9XG5cbiAgY3JlYXRlVGltZW91dFByb21pc2UobWlsbGlzZWNvbmRzKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICBjb25zdCB0aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KVxuICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihgU2VydmVyIGZhaWxlZCB0byBzaHV0ZG93biBpbiAke21pbGxpc2Vjb25kc31tcywgZm9yY2luZyB0ZXJtaW5hdGlvbmApXG4gICAgICAgIHJlc29sdmUoKVxuICAgICAgfSwgbWlsbGlzZWNvbmRzKVxuICAgIH0pXG4gIH1cbn1cblxuY29uc3QgcHl0aG9uQ2xpZW50ID0gbmV3IFB5dGhvbkxhbmd1YWdlQ2xpZW50KClcbnB5dGhvbkNsaWVudC5jcmVhdGVEZWJ1Z2dlclByb3ZpZGVyID0gY3JlYXRlRGVidWdnZXJQcm92aWRlciAvLyBhZGQgdGhlIGRlYnVnZ2VyXG5tb2R1bGUuZXhwb3J0cyA9IHB5dGhvbkNsaWVudFxuIl19