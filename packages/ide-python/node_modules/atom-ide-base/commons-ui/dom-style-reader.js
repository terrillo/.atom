"use strict";
/**
 * This class is used to read the styles informations (e.g. color and background-color) from the DOM to use when
 * rendering canvas. This is used in Minimap and Terminal It attaches a dummyNode to the targetNode, renders them, and
 * finds the computed style back.
 */

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.StyleReader = void 0;

class StyleReader {
  constructor() {
    this.domStylesCache = new Map();
    this.dummyNode = void 0;
    this.targetNode = void 0;
  }

  /** Set to true once tokenized */
  // private hasTokenizedOnce = false

  /**
   * Returns the computed values for the given property and scope in the DOM.
   *
   * This function insert a dummy element in the DOM to compute its style, return the specified property, and clear the
   * content of the dummy element.
   *
   * @param scopes A list of classes reprensenting the scope to build
   * @param property The name of the style property to compute
   * @param targetNode
   * @param getFromCache Whether to cache the computed value or not
   * @returns The computed property's value used in CanvasDrawer
   */
  retrieveStyleFromDom(scopes, property, targetNode, getFromCache = true) {
    if (scopes.length === 0) {
      return "";
    } // no scopes


    const key = scopes.join(" ");
    let cachedData = this.domStylesCache.get(key);

    if (cachedData !== undefined) {
      if (getFromCache) {
        // if should get the value from the cache
        const value = cachedData[property];

        if (value !== undefined) {
          // value exists
          return value;
        } // value not in the cache - get fresh value

      } // don't use cache - get fresh value

    } else {
      // key did not exist. create it
      cachedData = {};
    }

    this.ensureDummyNodeExistence(targetNode);
    const dummyNode = this.dummyNode;
    let parent = dummyNode;

    for (let i = 0, len = scopes.length; i < len; i++) {
      const scope = scopes[i];
      const node = document.createElement("span");
      node.className = scope.replace(dotRegexp, " "); // TODO why replace is needed?

      parent.appendChild(node);
      parent = node;
    }

    const style = window.getComputedStyle(parent);
    let value = style.getPropertyValue(property); // rotate hue if webkit-filter available

    const filter = style.getPropertyValue("-webkit-filter");

    if (filter.includes("hue-rotate")) {
      value = rotateHue(value, filter);
    }

    if (value !== "") {
      cachedData[property] = value;
      this.domStylesCache.set(key, cachedData);
    }

    dummyNode.innerHTML = "";
    return value;
  }
  /**
   * Creates a DOM node container for all the operations that need to read styles properties from DOM.
   *
   * @param targetNode
   */


  ensureDummyNodeExistence(targetNode) {
    if (this.targetNode !== targetNode || this.dummyNode === undefined) {
      this.dummyNode = document.createElement("span");
      this.dummyNode.style.visibility = "hidden"; // attach to the target node

      targetNode.appendChild(this.dummyNode);
      this.targetNode = targetNode;
    }
  }
  /** Invalidates the cache by emptying the cache object. used in MinimapElement */


  invalidateDOMStylesCache() {
    this.domStylesCache.clear();
  }
  /** Invalidates the cache only for the first tokenization event. */

  /*
  private invalidateIfFirstTokenization () {
    if (this.hasTokenizedOnce) {
      return
    }
    this.invalidateDOMStylesCache()
    this.hasTokenizedOnce = true
  }
  */


} //    ##     ## ######## ##       ########  ######## ########   ######
//    ##     ## ##       ##       ##     ## ##       ##     ## ##    ##
//    ##     ## ##       ##       ##     ## ##       ##     ## ##
//    ######### ######   ##       ########  ######   ########   ######
//    ##     ## ##       ##       ##        ##       ##   ##         ##
//    ##     ## ##       ##       ##        ##       ##    ##  ##    ##
//    ##     ## ######## ######## ##        ######## ##     ##  ######


exports.StyleReader = StyleReader;
const dotRegexp = /\.+/g;
const rgbExtractRegexp = /rgb(a?)\((\d+), (\d+), (\d+)(, (\d+(\.\d+)?))?\)/;
const hueRegexp = /hue-rotate\((-?\d+)deg\)/;
/**
 * Computes the output color of `value` with a rotated hue defined in `filter`.
 *
 * @param value The CSS color to apply the rotation on
 * @param filter The CSS hue rotate filter declaration
 * @returns The rotated CSS color
 */

function rotateHue(value, filter) {
  const match = value.match(rgbExtractRegexp);

  if (match === null) {
    return "";
  }

  const [,, rStr, gStr, bStr,, aStr] = match;
  const hueMatch = filter.match(hueRegexp);

  if (hueMatch === null) {
    return "";
  }

  const [, hueStr] = hueMatch;
  let [r, g, b, a, hue] = [rStr, gStr, bStr, aStr, hueStr].map(Number);
  [r, g, b] = rotate(r, g, b, hue);

  if (isNaN(a)) {
    return `rgb(${r}, ${g}, ${b})`;
  } else {
    return `rgba(${r}, ${g}, ${b}, ${a})`;
  }
}
/**
 * Computes the hue rotation on the provided `r`, `g` and `b` channels by the amount of `angle`.
 *
 * @param r The red channel of the color to rotate
 * @param g The green channel of the color to rotate
 * @param b The blue channel of the color to rotate
 * @param angle The angle to rotate the hue with
 * @returns The rotated color channels
 */


function rotate(r, g, b, angle) {
  const matrix = [1, 0, 0, 0, 1, 0, 0, 0, 1];
  const lumR = 0.2126;
  const lumG = 0.7152;
  const lumB = 0.0722;
  const hueRotateR = 0.143;
  const hueRotateG = 0.14;
  const hueRotateB = 0.283;
  const cos = Math.cos(angle * Math.PI / 180);
  const sin = Math.sin(angle * Math.PI / 180);
  matrix[0] = lumR + (1 - lumR) * cos - lumR * sin;
  matrix[1] = lumG - lumG * cos - lumG * sin;
  matrix[2] = lumB - lumB * cos + (1 - lumB) * sin;
  matrix[3] = lumR - lumR * cos + hueRotateR * sin;
  matrix[4] = lumG + (1 - lumG) * cos + hueRotateG * sin;
  matrix[5] = lumB - lumB * cos - hueRotateB * sin;
  matrix[6] = lumR - lumR * cos - (1 - lumR) * sin;
  matrix[7] = lumG - lumG * cos + lumG * sin;
  matrix[8] = lumB + (1 - lumB) * cos + lumB * sin;
  return [clamp(matrix[0] * r + matrix[1] * g + matrix[2] * b), clamp(matrix[3] * r + matrix[4] * g + matrix[5] * b), clamp(matrix[6] * r + matrix[7] * g + matrix[8] * b)];
}

function clamp(num) {
  return Math.ceil(Math.max(0, Math.min(255, num)));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy1jb21tb25zLXVpL2RvbS1zdHlsZS1yZWFkZXIudHMiXSwibmFtZXMiOlsiU3R5bGVSZWFkZXIiLCJkb21TdHlsZXNDYWNoZSIsIk1hcCIsImR1bW15Tm9kZSIsInRhcmdldE5vZGUiLCJyZXRyaWV2ZVN0eWxlRnJvbURvbSIsInNjb3BlcyIsInByb3BlcnR5IiwiZ2V0RnJvbUNhY2hlIiwibGVuZ3RoIiwia2V5Iiwiam9pbiIsImNhY2hlZERhdGEiLCJnZXQiLCJ1bmRlZmluZWQiLCJ2YWx1ZSIsImVuc3VyZUR1bW15Tm9kZUV4aXN0ZW5jZSIsInBhcmVudCIsImkiLCJsZW4iLCJzY29wZSIsIm5vZGUiLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJjbGFzc05hbWUiLCJyZXBsYWNlIiwiZG90UmVnZXhwIiwiYXBwZW5kQ2hpbGQiLCJzdHlsZSIsIndpbmRvdyIsImdldENvbXB1dGVkU3R5bGUiLCJnZXRQcm9wZXJ0eVZhbHVlIiwiZmlsdGVyIiwiaW5jbHVkZXMiLCJyb3RhdGVIdWUiLCJzZXQiLCJpbm5lckhUTUwiLCJ2aXNpYmlsaXR5IiwiaW52YWxpZGF0ZURPTVN0eWxlc0NhY2hlIiwiY2xlYXIiLCJyZ2JFeHRyYWN0UmVnZXhwIiwiaHVlUmVnZXhwIiwibWF0Y2giLCJyU3RyIiwiZ1N0ciIsImJTdHIiLCJhU3RyIiwiaHVlTWF0Y2giLCJodWVTdHIiLCJyIiwiZyIsImIiLCJhIiwiaHVlIiwibWFwIiwiTnVtYmVyIiwicm90YXRlIiwiaXNOYU4iLCJhbmdsZSIsIm1hdHJpeCIsImx1bVIiLCJsdW1HIiwibHVtQiIsImh1ZVJvdGF0ZVIiLCJodWVSb3RhdGVHIiwiaHVlUm90YXRlQiIsImNvcyIsIk1hdGgiLCJQSSIsInNpbiIsImNsYW1wIiwibnVtIiwiY2VpbCIsIm1heCIsIm1pbiJdLCJtYXBwaW5ncyI6IkFBQUE7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7Ozs7O0FBQ08sTUFBTUEsV0FBTixDQUFrQjtBQUFBO0FBQUEs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QSxJQUFMLElBQWFJLEdBQXBCLEdBQTBCSixJQUFJLEdBQUdPLEdBQTdDO0FBRUEsU0FBTyxDQUNMQyxLQUFLLENBQUNYLE1BQU0sQ0FBQyxDQUFELENBQU4sR0FBWVYsQ0FBWixHQUFnQlUsTUFBTSxDQUFDLENBQUQsQ0FBTixHQUFZVCxDQUE1QixHQUFnQ1MsTUFBTSxDQUFDLENBQUQsQ0FBTixHQUFZUixDQUE3QyxDQURBLEVBRUxtQixLQUFLLENBQUNYLE1BQU0sQ0FBQyxDQUFELENBQU4sR0FBWVYsQ0FBWixHQUFnQlUsTUFBTSxDQUFDLENBQUQsQ0FBTixHQUFZVCxDQUE1QixHQUFnQ1MsTUFBTSxDQUFDLENBQUQsQ0FBTixHQUFZUixDQUE3QyxDQUZBLEVBR0xtQixLQUFLLENBQUNYLE1BQU0sQ0FBQyxDQUFELENBQU4sR0FBWVYsQ0FBWixHQUFnQlUsTUFBTSxDQUFDLENBQUQsQ0FBTixHQUFZVCxDQUE1QixHQUFnQ1MsTUFBTSxDQUFDLENBQUQsQ0FBTixHQUFZUixDQUE3QyxDQUhBLENBQVA7QUFLRDs7QUFFRCxTQUFTbUIsS0FBVCxDQUFlQyxHQUFmLEVBQTRCO0FBQzFCLFNBQU9KLElBQUksQ0FBQ0ssSUFBTCxDQUFVTCxJQUFJLENBQUNNLEdBQUwsQ0FBUyxDQUFULEVBQVlOLElBQUksQ0FBQ08sR0FBTCxDQUFTLEdBQVQsRUFBY0gsR0FBZCxDQUFaLENBQVYsQ0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCJcblxuLyoqXG4gKiBUaGlzIGNsYXNzIGlzIHVzZWQgdG8gcmVhZCB0aGUgc3R5bGVzIGluZm9ybWF0aW9ucyAoZS5nLiBjb2xvciBhbmQgYmFja2dyb3VuZC1jb2xvcikgZnJvbSB0aGUgRE9NIHRvIHVzZSB3aGVuXG4gKiByZW5kZXJpbmcgY2FudmFzLiBUaGlzIGlzIHVzZWQgaW4gTWluaW1hcCBhbmQgVGVybWluYWwgSXQgYXR0YWNoZXMgYSBkdW1teU5vZGUgdG8gdGhlIHRhcmdldE5vZGUsIHJlbmRlcnMgdGhlbSwgYW5kXG4gKiBmaW5kcyB0aGUgY29tcHV0ZWQgc3R5bGUgYmFjay5cbiAqL1xuZXhwb3J0IGNsYXNzIFN0eWxlUmVhZGVyIHtcbiAgLyoqIFRoZSBjYWNoZSBvYmplY3QgKi9cbiAgcHJpdmF0ZSBkb21TdHlsZXNDYWNoZSA9IG5ldyBNYXA8c3RyaW5nLCBSZWNvcmQ8c3RyaW5nLCBzdHJpbmcgfCB1bmRlZmluZWQ+PigpXG5cbiAgcHJpdmF0ZSBkdW1teU5vZGU/OiBIVE1MRWxlbWVudFxuXG4gIC8qKiBVc2VkIHRvIGNoZWNrIGlmIHRoZSBkdW1teU5vZGUgaXMgb24gdGhlIGN1cnJlbnQgdGFyZ2V0Tm9kZSAqL1xuICBwcml2YXRlIHRhcmdldE5vZGU/OiBIVE1MRWxlbWVudFxuXG4gIC8qKiBTZXQgdG8gdHJ1ZSBvbmNlIHRva2VuaXplZCAqL1xuICAvLyBwcml2YXRlIGhhc1Rva2VuaXplZE9uY2UgPSBmYWxzZVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBjb21wdXRlZCB2YWx1ZXMgZm9yIHRoZSBnaXZlbiBwcm9wZXJ0eSBhbmQgc2NvcGUgaW4gdGhlIERPTS5cbiAgICpcbiAgICogVGhpcyBmdW5jdGlvbiBpbnNlcnQgYSBkdW1teSBlbGVtZW50IGluIHRoZSBET00gdG8gY29tcHV0ZSBpdHMgc3R5bGUsIHJldHVybiB0aGUgc3BlY2lmaWVkIHByb3BlcnR5LCBhbmQgY2xlYXIgdGhlXG4gICAqIGNvbnRlbnQgb2YgdGhlIGR1bW15IGVsZW1lbnQuXG4gICAqXG4gICAqIEBwYXJhbSBzY29wZXMgQSBsaXN0IG9mIGNsYXNzZXMgcmVwcmVuc2VudGluZyB0aGUgc2NvcGUgdG8gYnVpbGRcbiAgICogQHBhcmFtIHByb3BlcnR5IFRoZSBuYW1lIG9mIHRoZSBzdHlsZSBwcm9wZXJ0eSB0byBjb21wdXRlXG4gICAqIEBwYXJhbSB0YXJnZXROb2RlXG4gICAqIEBwYXJhbSBnZXRGcm9tQ2FjaGUgV2hldGhlciB0byBjYWNoZSB0aGUgY29tcHV0ZWQgdmFsdWUgb3Igbm90XG4gICAqIEByZXR1cm5zIFRoZSBjb21wdXRlZCBwcm9wZXJ0eSdzIHZhbHVlIHVzZWQgaW4gQ2FudmFzRHJhd2VyXG4gICAqL1xuICByZXRyaWV2ZVN0eWxlRnJvbURvbShcbiAgICBzY29wZXM6IHN0cmluZ1tdLFxuICAgIHByb3BlcnR5OiBzdHJpbmcsXG4gICAgdGFyZ2V0Tm9kZTogSFRNTEVsZW1lbnQsXG4gICAgZ2V0RnJvbUNhY2hlOiBib29sZWFuID0gdHJ1ZVxuICApOiBzdHJpbmcge1xuICAgIGlmIChzY29wZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gXCJcIlxuICAgIH0gLy8gbm8gc2NvcGVzXG4gICAgY29uc3Qga2V5ID0gc2NvcGVzLmpvaW4oXCIgXCIpXG4gICAgbGV0IGNhY2hlZERhdGEgPSB0aGlzLmRvbVN0eWxlc0NhY2hlLmdldChrZXkpXG5cbiAgICBpZiAoY2FjaGVkRGF0YSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBpZiAoZ2V0RnJvbUNhY2hlKSB7XG4gICAgICAgIC8vIGlmIHNob3VsZCBnZXQgdGhlIHZhbHVlIGZyb20gdGhlIGNhY2hlXG4gICAgICAgIGNvbnN0IHZhbHVlID0gY2FjaGVkRGF0YVtwcm9wZXJ0eV1cbiAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAvLyB2YWx1ZSBleGlzdHNcbiAgICAgICAgICByZXR1cm4gdmFsdWVcbiAgICAgICAgfSAvLyB2YWx1ZSBub3QgaW4gdGhlIGNhY2hlIC0gZ2V0IGZyZXNoIHZhbHVlXG4gICAgICB9IC8vIGRvbid0IHVzZSBjYWNoZSAtIGdldCBmcmVzaCB2YWx1ZVxuICAgIH0gZWxzZSB7XG4gICAgICAvLyBrZXkgZGlkIG5vdCBleGlzdC4gY3JlYXRlIGl0XG4gICAgICBjYWNoZWREYXRhID0ge31cbiAgICB9XG5cbiAgICB0aGlzLmVuc3VyZUR1bW15Tm9kZUV4aXN0ZW5jZSh0YXJnZXROb2RlKVxuICAgIGNvbnN0IGR1bW15Tm9kZSA9IHRoaXMuZHVtbXlOb2RlIGFzIEhUTUxFbGVtZW50XG5cbiAgICBsZXQgcGFyZW50ID0gZHVtbXlOb2RlXG4gICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IHNjb3Blcy5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgY29uc3Qgc2NvcGUgPSBzY29wZXNbaV1cbiAgICAgIGNvbnN0IG5vZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwic3BhblwiKVxuICAgICAgbm9kZS5jbGFzc05hbWUgPSBzY29wZS5yZXBsYWNlKGRvdFJlZ2V4cCwgXCIgXCIpIC8vIFRPRE8gd2h5IHJlcGxhY2UgaXMgbmVlZGVkP1xuICAgICAgcGFyZW50LmFwcGVuZENoaWxkKG5vZGUpXG4gICAgICBwYXJlbnQgPSBub2RlXG4gICAgfVxuXG4gICAgY29uc3Qgc3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShwYXJlbnQpXG4gICAgbGV0IHZhbHVlID0gc3R5bGUuZ2V0UHJvcGVydHlWYWx1ZShwcm9wZXJ0eSlcblxuICAgIC8vIHJvdGF0ZSBodWUgaWYgd2Via2l0LWZpbHRlciBhdmFpbGFibGVcbiAgICBjb25zdCBmaWx0ZXIgPSBzdHlsZS5nZXRQcm9wZXJ0eVZhbHVlKFwiLXdlYmtpdC1maWx0ZXJcIilcbiAgICBpZiAoZmlsdGVyLmluY2x1ZGVzKFwiaHVlLXJvdGF0ZVwiKSkge1xuICAgICAgdmFsdWUgPSByb3RhdGVIdWUodmFsdWUsIGZpbHRlcilcbiAgICB9XG5cbiAgICBpZiAodmFsdWUgIT09IFwiXCIpIHtcbiAgICAgIGNhY2hlZERhdGFbcHJvcGVydHldID0gdmFsdWVcbiAgICAgIHRoaXMuZG9tU3R5bGVzQ2FjaGUuc2V0KGtleSwgY2FjaGVkRGF0YSlcbiAgICB9XG5cbiAgICBkdW1teU5vZGUuaW5uZXJIVE1MID0gXCJcIlxuICAgIHJldHVybiB2YWx1ZVxuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYSBET00gbm9kZSBjb250YWluZXIgZm9yIGFsbCB0aGUgb3BlcmF0aW9ucyB0aGF0IG5lZWQgdG8gcmVhZCBzdHlsZXMgcHJvcGVydGllcyBmcm9tIERPTS5cbiAgICpcbiAgICogQHBhcmFtIHRhcmdldE5vZGVcbiAgICovXG4gIHByaXZhdGUgZW5zdXJlRHVtbXlOb2RlRXhpc3RlbmNlKHRhcmdldE5vZGU6IEhUTUxFbGVtZW50KSB7XG4gICAgaWYgKHRoaXMudGFyZ2V0Tm9kZSAhPT0gdGFyZ2V0Tm9kZSB8fCB0aGlzLmR1bW15Tm9kZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLmR1bW15Tm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJzcGFuXCIpXG4gICAgICB0aGlzLmR1bW15Tm9kZS5zdHlsZS52aXNpYmlsaXR5ID0gXCJoaWRkZW5cIlxuXG4gICAgICAvLyBhdHRhY2ggdG8gdGhlIHRhcmdldCBub2RlXG4gICAgICB0YXJnZXROb2RlLmFwcGVuZENoaWxkKHRoaXMuZHVtbXlOb2RlKVxuICAgICAgdGhpcy50YXJnZXROb2RlID0gdGFyZ2V0Tm9kZVxuICAgIH1cbiAgfVxuXG4gIC8qKiBJbnZhbGlkYXRlcyB0aGUgY2FjaGUgYnkgZW1wdHlpbmcgdGhlIGNhY2hlIG9iamVjdC4gdXNlZCBpbiBNaW5pbWFwRWxlbWVudCAqL1xuICBpbnZhbGlkYXRlRE9NU3R5bGVzQ2FjaGUoKSB7XG4gICAgdGhpcy5kb21TdHlsZXNDYWNoZS5jbGVhcigpXG4gIH1cblxuICAvKiogSW52YWxpZGF0ZXMgdGhlIGNhY2hlIG9ubHkgZm9yIHRoZSBmaXJzdCB0b2tlbml6YXRpb24gZXZlbnQuICovXG4gIC8qXG4gIHByaXZhdGUgaW52YWxpZGF0ZUlmRmlyc3RUb2tlbml6YXRpb24gKCkge1xuICAgIGlmICh0aGlzLmhhc1Rva2VuaXplZE9uY2UpIHtcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICB0aGlzLmludmFsaWRhdGVET01TdHlsZXNDYWNoZSgpXG4gICAgdGhpcy5oYXNUb2tlbml6ZWRPbmNlID0gdHJ1ZVxuICB9XG4gICovXG59XG5cbi8vICAgICMjICAgICAjIyAjIyMjIyMjIyAjIyAgICAgICAjIyMjIyMjIyAgIyMjIyMjIyMgIyMjIyMjIyMgICAjIyMjIyNcbi8vICAgICMjICAgICAjIyAjIyAgICAgICAjIyAgICAgICAjIyAgICAgIyMgIyMgICAgICAgIyMgICAgICMjICMjICAgICMjXG4vLyAgICAjIyAgICAgIyMgIyMgICAgICAgIyMgICAgICAgIyMgICAgICMjICMjICAgICAgICMjICAgICAjIyAjI1xuLy8gICAgIyMjIyMjIyMjICMjIyMjIyAgICMjICAgICAgICMjIyMjIyMjICAjIyMjIyMgICAjIyMjIyMjIyAgICMjIyMjI1xuLy8gICAgIyMgICAgICMjICMjICAgICAgICMjICAgICAgICMjICAgICAgICAjIyAgICAgICAjIyAgICMjICAgICAgICAgIyNcbi8vICAgICMjICAgICAjIyAjIyAgICAgICAjIyAgICAgICAjIyAgICAgICAgIyMgICAgICAgIyMgICAgIyMgICMjICAgICMjXG4vLyAgICAjIyAgICAgIyMgIyMjIyMjIyMgIyMjIyMjIyMgIyMgICAgICAgICMjIyMjIyMjICMjICAgICAjIyAgIyMjIyMjXG5cbmNvbnN0IGRvdFJlZ2V4cCA9IC9cXC4rL2dcbmNvbnN0IHJnYkV4dHJhY3RSZWdleHAgPSAvcmdiKGE/KVxcKChcXGQrKSwgKFxcZCspLCAoXFxkKykoLCAoXFxkKyhcXC5cXGQrKT8pKT9cXCkvXG5jb25zdCBodWVSZWdleHAgPSAvaHVlLXJvdGF0ZVxcKCgtP1xcZCspZGVnXFwpL1xuXG4vKipcbiAqIENvbXB1dGVzIHRoZSBvdXRwdXQgY29sb3Igb2YgYHZhbHVlYCB3aXRoIGEgcm90YXRlZCBodWUgZGVmaW5lZCBpbiBgZmlsdGVyYC5cbiAqXG4gKiBAcGFyYW0gdmFsdWUgVGhlIENTUyBjb2xvciB0byBhcHBseSB0aGUgcm90YXRpb24gb25cbiAqIEBwYXJhbSBmaWx0ZXIgVGhlIENTUyBodWUgcm90YXRlIGZpbHRlciBkZWNsYXJhdGlvblxuICogQHJldHVybnMgVGhlIHJvdGF0ZWQgQ1NTIGNvbG9yXG4gKi9cbmZ1bmN0aW9uIHJvdGF0ZUh1ZSh2YWx1ZTogc3RyaW5nLCBmaWx0ZXI6IHN0cmluZyk6IHN0cmluZyB7XG4gIGNvbnN0IG1hdGNoID0gdmFsdWUubWF0Y2gocmdiRXh0cmFjdFJlZ2V4cClcbiAgaWYgKG1hdGNoID09PSBudWxsKSB7XG4gICAgcmV0dXJuIFwiXCJcbiAgfVxuICBjb25zdCBbLCAsIHJTdHIsIGdTdHIsIGJTdHIsICwgYVN0cl0gPSBtYXRjaFxuXG4gIGNvbnN0IGh1ZU1hdGNoID0gZmlsdGVyLm1hdGNoKGh1ZVJlZ2V4cClcbiAgaWYgKGh1ZU1hdGNoID09PSBudWxsKSB7XG4gICAgcmV0dXJuIFwiXCJcbiAgfVxuXG4gIGNvbnN0IFssIGh1ZVN0cl0gPSBodWVNYXRjaFxuXG4gIGxldCBbciwgZywgYiwgYSwgaHVlXSA9IFtyU3RyLCBnU3RyLCBiU3RyLCBhU3RyLCBodWVTdHJdLm1hcChOdW1iZXIpXG4gIDtbciwgZywgYl0gPSByb3RhdGUociwgZywgYiwgaHVlKVxuXG4gIGlmIChpc05hTihhKSkge1xuICAgIHJldHVybiBgcmdiKCR7cn0sICR7Z30sICR7Yn0pYFxuICB9IGVsc2Uge1xuICAgIHJldHVybiBgcmdiYSgke3J9LCAke2d9LCAke2J9LCAke2F9KWBcbiAgfVxufVxuXG4vKipcbiAqIENvbXB1dGVzIHRoZSBodWUgcm90YXRpb24gb24gdGhlIHByb3ZpZGVkIGByYCwgYGdgIGFuZCBgYmAgY2hhbm5lbHMgYnkgdGhlIGFtb3VudCBvZiBgYW5nbGVgLlxuICpcbiAqIEBwYXJhbSByIFRoZSByZWQgY2hhbm5lbCBvZiB0aGUgY29sb3IgdG8gcm90YXRlXG4gKiBAcGFyYW0gZyBUaGUgZ3JlZW4gY2hhbm5lbCBvZiB0aGUgY29sb3IgdG8gcm90YXRlXG4gKiBAcGFyYW0gYiBUaGUgYmx1ZSBjaGFubmVsIG9mIHRoZSBjb2xvciB0byByb3RhdGVcbiAqIEBwYXJhbSBhbmdsZSBUaGUgYW5nbGUgdG8gcm90YXRlIHRoZSBodWUgd2l0aFxuICogQHJldHVybnMgVGhlIHJvdGF0ZWQgY29sb3IgY2hhbm5lbHNcbiAqL1xuZnVuY3Rpb24gcm90YXRlKHI6IG51bWJlciwgZzogbnVtYmVyLCBiOiBudW1iZXIsIGFuZ2xlOiBudW1iZXIpOiBudW1iZXJbXSB7XG4gIGNvbnN0IG1hdHJpeCA9IFsxLCAwLCAwLCAwLCAxLCAwLCAwLCAwLCAxXVxuICBjb25zdCBsdW1SID0gMC4yMTI2XG4gIGNvbnN0IGx1bUcgPSAwLjcxNTJcbiAgY29uc3QgbHVtQiA9IDAuMDcyMlxuICBjb25zdCBodWVSb3RhdGVSID0gMC4xNDNcbiAgY29uc3QgaHVlUm90YXRlRyA9IDAuMTRcbiAgY29uc3QgaHVlUm90YXRlQiA9IDAuMjgzXG4gIGNvbnN0IGNvcyA9IE1hdGguY29zKChhbmdsZSAqIE1hdGguUEkpIC8gMTgwKVxuICBjb25zdCBzaW4gPSBNYXRoLnNpbigoYW5nbGUgKiBNYXRoLlBJKSAvIDE4MClcblxuICBtYXRyaXhbMF0gPSBsdW1SICsgKDEgLSBsdW1SKSAqIGNvcyAtIGx1bVIgKiBzaW5cbiAgbWF0cml4WzFdID0gbHVtRyAtIGx1bUcgKiBjb3MgLSBsdW1HICogc2luXG4gIG1hdHJpeFsyXSA9IGx1bUIgLSBsdW1CICogY29zICsgKDEgLSBsdW1CKSAqIHNpblxuICBtYXRyaXhbM10gPSBsdW1SIC0gbHVtUiAqIGNvcyArIGh1ZVJvdGF0ZVIgKiBzaW5cbiAgbWF0cml4WzRdID0gbHVtRyArICgxIC0gbHVtRykgKiBjb3MgKyBodWVSb3RhdGVHICogc2luXG4gIG1hdHJpeFs1XSA9IGx1bUIgLSBsdW1CICogY29zIC0gaHVlUm90YXRlQiAqIHNpblxuICBtYXRyaXhbNl0gPSBsdW1SIC0gbHVtUiAqIGNvcyAtICgxIC0gbHVtUikgKiBzaW5cbiAgbWF0cml4WzddID0gbHVtRyAtIGx1bUcgKiBjb3MgKyBsdW1HICogc2luXG4gIG1hdHJpeFs4XSA9IGx1bUIgKyAoMSAtIGx1bUIpICogY29zICsgbHVtQiAqIHNpblxuXG4gIHJldHVybiBbXG4gICAgY2xhbXAobWF0cml4WzBdICogciArIG1hdHJpeFsxXSAqIGcgKyBtYXRyaXhbMl0gKiBiKSxcbiAgICBjbGFtcChtYXRyaXhbM10gKiByICsgbWF0cml4WzRdICogZyArIG1hdHJpeFs1XSAqIGIpLFxuICAgIGNsYW1wKG1hdHJpeFs2XSAqIHIgKyBtYXRyaXhbN10gKiBnICsgbWF0cml4WzhdICogYiksXG4gIF1cbn1cblxuZnVuY3Rpb24gY2xhbXAobnVtOiBudW1iZXIpIHtcbiAgcmV0dXJuIE1hdGguY2VpbChNYXRoLm1heCgwLCBNYXRoLm1pbigyNTUsIG51bSkpKVxufVxuIl19